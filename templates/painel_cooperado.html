<!-- MENU lateral + TOAST avisos + SOM ao chegar -->
<script>
  (function(){
    // === MENU LATERAL ===
    const menuLateral = document.getElementById('menuLateral');
    const fundoMenu = document.getElementById('fundoMenu');
    const abrir = document.getElementById('abrirMenu');
    const fechar = document.getElementById('fecharMenu');

    abrir?.addEventListener('click', () => {
      menuLateral?.classList.add('aberto');
      fundoMenu?.classList.add('aberto');
    });
    fechar?.addEventListener('click', () => {
      menuLateral?.classList.remove('aberto');
      fundoMenu?.classList.remove('aberto');
    });
    fundoMenu?.addEventListener('click', () => {
      menuLateral?.classList.remove('aberto');
      fundoMenu?.classList.remove('aberto');
    });
  })();

  document.addEventListener('DOMContentLoaded', function () {
    // === TOAST / AVISOS ===
    const toastEl = document.getElementById('toastAvisos');
    const toastBody = toastEl?.querySelector('.toast-body');
    const toastCountEl = toastEl?.querySelector('.toast-count');
    const toastTimeEl = toastEl?.querySelector('.toast-time');
    const endpoint = toastEl?.getAttribute('data-unread-endpoint') || '/avisos/unread_count';

    const unreadInitial = Number('{{ unread }}') || 0;
    const UID = Number('{{ cooperado.id if cooperado and cooperado.id else 0 }}') || 0;
    const LS_KEY = `COOPEX_AVISOS_LAST_${UID}`;
    const audio = document.getElementById('avisoSound');

    function showToast(count) {
      if (!window.bootstrap?.Toast || !toastEl) return;
      if (toastCountEl) toastCountEl.textContent = String(count);
      if (toastTimeEl) toastTimeEl.textContent = 'agora';
      new bootstrap.Toast(toastEl).show();
    }

    async function playAvisoSound() {
      if (!audio) return;
      try {
        await audio.play();
      } catch (err) {
        // Desbloqueia na primeira interação
        const enable = async () => { try { await audio.play(); } catch(_) {} };
        document.addEventListener('click', enable, { once:true });
        document.addEventListener('keydown', enable, { once:true });
        document.addEventListener('touchstart', enable, { once:true });
      }
    }

    // Exibe na carga se houver novos
    const lastSeen = Number(localStorage.getItem(LS_KEY) || 0);
    if (unreadInitial > 0 && (unreadInitial > lastSeen || lastSeen === 0)) {
      // Atualiza texto sem quebrar o link
      if (toastBody && toastBody.firstChild && toastBody.firstChild.nodeType === Node.TEXT_NODE) {
        toastBody.firstChild.nodeValue = `Você tem ${unreadInitial} aviso(s) não lido(s). `;
      }
      showToast(unreadInitial);
      playAvisoSound();
      localStorage.setItem(LS_KEY, String(unreadInitial));
    }

    // Polling periódico
    async function checkUnread(){
      try {
        const resp = await fetch(endpoint, {
          headers: { 'Accept':'application/json' },
          cache:'no-store',
          credentials: 'same-origin'
        });
        if (!resp.ok) return;
        const data = await resp.json();
        const count = Number(data.unread ?? data.count ?? 0);
        const current = Number(localStorage.getItem(LS_KEY) || 0);

        if (Number.isFinite(count) && count > current) {
          if (toastBody && toastBody.firstChild && toastBody.firstChild.nodeType === Node.TEXT_NODE) {
            toastBody.firstChild.nodeValue = `Você tem ${count} aviso(s) não lido(s). `;
          }
          showToast(count);
          playAvisoSound();
          localStorage.setItem(LS_KEY, String(count));
        }
      } catch (_) { /* silencioso */ }
    }

    setInterval(checkUnread, 20000);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') checkUnread();
    });

    // Broadcast da página de avisos
    try {
      const ch = new BroadcastChannel('coopex_avisos');
      ch.onmessage = (ev) => {
        const count = Number(ev.data?.unread || 0);
        const current = Number(localStorage.getItem(LS_KEY) || 0);
        if (Number.isFinite(count) && count > current) {
          showToast(count);
          playAvisoSound();
          localStorage.setItem(LS_KEY, String(count));
        }
      };
      window.coopAvisosNotify = function(count) {
        const n = Number(count || 0);
        const current = Number(localStorage.getItem(LS_KEY) || 0);
        if (Number.isFinite(n) && n > current) {
          showToast(n);
          playAvisoSound();
          localStorage.setItem(LS_KEY, String(n));
        }
      };
    } catch (_) {}
  });
</script>
