<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Meu Painel - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root { --royal-blue:#2747d9; --hover-blue:#3b61e3; --bg:#f7f9fc; }
    html,body{height:100%; overflow-x:hidden;}
    body { background: var(--bg); font-family: 'Roboto', sans-serif; color:#1a1f2b; }
    .navbar { background: var(--royal-blue); }
    .navbar-brand { font-family:'Orbitron',sans-serif; font-size:1.2rem; color:#fff; letter-spacing:1px; }
    .btn-royal { background: var(--royal-blue); color:#fff; }
    .btn-royal:hover { background: var(--hover-blue); color:#fff; }
    .card { border-radius:14px; box-shadow:0 2px 10px #0001; border:0; }
    .summary .label { color:#556; font-weight:600; }
    .chip { display:inline-block; font-size:.75rem; padding:.2rem .55rem; border-radius:20px; background:#eef2ff; color:#223; }
    .list-item-title { font-weight:600; }
    .value { font-weight:700; }
    .muted { color:#6c757d; }
    .sticky-tabs { position:sticky; top:0; z-index:10; background:var(--bg); }
    .nav-tabs .nav-link{ color:#39465e; font-weight:600; border:0; }
    .nav-tabs .nav-link.active{ background: var(--royal-blue); color:#fff; border-radius:10px 10px 0 0; }
    .kpi{display:flex;justify-content:space-between;align-items:center;padding:.35rem 0}
    .kpi .label{font-size:.95rem}
    .kpi .value{font-size:1.05rem}
    .mono{font-variant-numeric: tabular-nums;}
    .mobile-wrap{ max-width:520px; margin:0 auto; }
    .desktop-warning { display:none; }
    @media (min-width: 992px){ .desktop-warning { display:block; } }
    .card-list .card + .card{ margin-top:.6rem; }

    /* Documentos */
    .doc-ok{background:#e8fff1;border:1px solid #bff0d1}
    .doc-bad{background:#ffecec;border:1px solid #ffb3b3}
    .badge-soft{background:#eef2ff;color:#223;border-radius:999px;padding:.15rem .5rem}
    .countdown{font-weight:700}

    /* Escala (tabela fixa, sem scroll lateral) */
    .table-escala{ table-layout: fixed; width:100%; }
    .table-escala thead{ background:#eef2ff }
    .table-escala th, .table-escala td{ word-break:break-word; vertical-align:middle; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.85rem; max-width:100%; overflow:hidden; text-overflow:ellipsis; }
    .cell-horario{ font-variant-numeric: tabular-nums; white-space: normal; }
    .row-stripe{ border-left:10px solid transparent; }
    .btn-xs{ padding:2px 8px; font-size:.75rem; line-height:1.2; border-radius:8px; }
    .date-wrap{ display:flex; align-items:center; gap:.35rem; flex-wrap:wrap; }
    .actions-inline{ margin-top:.35rem; }
    img, video, iframe { max-width:100%; height:auto; }

    /* fundos por status */
    .esc-past{background:rgba(239,68,68,.07)}
    .esc-today{background:rgba(34,197,94,.10)}
    .esc-tomorrow,.esc-future{background:rgba(59,130,246,.08)}

    /* Trocas */
    .badge-status{font-size:.75rem;padding:.2rem .5rem;border-radius:999px}
    .no-x-scroll{overflow-x:hidden}
  </style>
</head>
<body>

  <div class="desktop-warning text-center p-2" style="background:#fff4d6;border-bottom:1px solid #ffe6a3">
    <small><i class="bi bi-phone"></i> Painel otimizado para celular.</small>
  </div>

  <div class="mobile-wrap">
    <!-- Topo -->
    <nav class="navbar navbar-dark">
      <div class="container-fluid">
        <div class="d-flex align-items-center gap-2">
          <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" style="width:28px;height:28px;object-fit:contain;filter:brightness(0) invert(1)">
          <span class="navbar-brand m-0">COOPEX</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <img src="{{ cooperado.foto_url or url_for('static', filename='img/default.png') }}"
               alt="Foto" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid #fff">
          <a href="{{ url_for('logout') }}" class="btn btn-sm btn-light">Sair</a>
        </div>
      </div>
    </nav>

    <!-- Filtro por período -->
    <form class="card p-3 m-2 mt-3" method="GET" action="{{ url_for('coop_dashboard') }}">
      <div class="row g-2 align-items-end">
        <div class="col-6">
          <label class="form-label mb-0">Início</label>
          <input type="date" class="form-control" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-6">
          <label class="form-label mb-0">Fim</label>
          <input type="date" class="form-control" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar Período</button>
        </div>
      </div>
      <small class="muted">Os totais abaixo consideram o período filtrado.</small>
    </form>

    <!-- Abas -->
    <div class="sticky-tabs px-2">
      <ul class="nav nav-tabs nav-fill" id="painelTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#resumo">Resumo</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#producoes">Produções</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ajustes">Ajustes Coop</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#escalas">Escalas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#trocas">Trocas</button></li>
      </ul>
    </div>

    <div class="tab-content p-2 pb-4">

      <!-- RESUMO -->
      <div class="tab-pane fade show active" id="resumo" role="tabpanel">
        <div class="card p-3 summary">
          <div class="d-flex align-items-center mb-2">
            <img src="{{ cooperado.foto_url or url_for('static', filename='img/default.png') }}"
                 style="width:46px;height:46px;border-radius:50%;object-fit:cover;border:3px solid var(--royal-blue);margin-right:10px" alt="">
            <div>
              <div class="fw-bold">{{ cooperado.nome }}</div>
              <small class="muted">{{ cooperado.usuario }}</small>
            </div>
          </div>

          <div class="kpi"><span class="label">Total Bruto</span><span class="value mono">R$ {{ "%.2f"|format(total_bruto|default(0)) }}</span></div>
          <div class="kpi"><span class="label">Total Descontos Individuais</span><span class="value mono">R$ {{ "%.2f"|format(total_descontos|default(0)) }}</span></div>
          <hr class="my-2">
          <div class="kpi"><span class="label">INSS (4,5%)</span><span class="value mono">R$ {{ "%.2f"|format(inss_valor|default(0)) }}</span></div>
          <div class="kpi"><span class="label">Complemento INSS (meta)</span><span class="value mono">R$ {{ "%.2f"|format(inss_complemento|default(0)) }}</span></div>
          <hr class="my-2">
          <div class="kpi"><span class="label">Total Líquido</span><span class="value mono text-success">R$ {{ "%.2f"|format(total_liquido|default(0)) }}</span></div>
          <small class="muted d-block mt-1">Fórmula: <b>Líquido = Bruto – Descontos Individuais – INSS</b>.</small>
          <small class="muted">Salário mínimo configurado pelo admin: R$ {{ "%.2f"|format(salario_minimo|default(0)) }}</small>
        </div>
      </div>

      <!-- PRODUÇÕES -->
      <div class="tab-pane fade" id="producoes" role="tabpanel">
        <div class="card p-3 mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Produções no período</h6>
            <span class="chip mono">Total: R$ {{ "%.2f"|format(total_bruto|default(0)) }}</span>
          </div>
        </div>

        <div class="card-list">
          {% for lanc in producoes %}
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="list-item-title">{{ lanc.descricao }}</div>
                <div class="muted">
                  <i class="bi bi-shop"></i> {{ lanc.restaurante.nome }}
                  &nbsp;·&nbsp; <i class="bi bi-calendar-event"></i> {{ lanc.data.strftime('%d/%m/%Y') }}
                </div>
                {% if lanc.hora_inicio or lanc.hora_fim %}
                <small class="muted"><i class="bi bi-clock"></i> {{ lanc.hora_inicio }}{% if lanc.hora_fim %} às {{ lanc.hora_fim }}{% endif %}</small>
                {% endif %}
              </div>
              <div class="text-end">
                <div class="value mono">R$ {{ "%.2f"|format(lanc.valor) }}</div>
                <small class="muted">INSS (4,5%): R$ {{ "%.2f"|format((lanc.valor or 0)*0.045) }}</small>
              </div>
            </div>
          </div>
          {% else %}
          <div class="card p-3 text-center muted">Nenhuma produção neste período.</div>
          {% endfor %}
        </div>
      </div>

      <!-- AJUSTES -->
      <div class="tab-pane fade" id="ajustes" role="tabpanel">
        <!-- Créditos -->
        <div class="card p-3 mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Créditos da Cooperativa</h6>
            <span class="chip mono">Total: R$ {{ "%.2f"|format((receitas_coop|sum(attribute='valor'))|default(0)) }}</span>
          </div>
        </div>
        <div class="card-list mb-3">
          {% for rc in receitas_coop %}
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="list-item-title"><i class="bi bi-plus-circle"></i> {{ rc.descricao }}</div>
                {% if rc.data %}<small class="muted"><i class="bi bi-calendar-event"></i> {{ rc.data.strftime('%d/%m/%Y') }}</small>{% endif %}
              </div>
              <div class="text-end value mono text-success">+ R$ {{ "%.2f"|format(rc.valor) }}</div>
            </div>
          </div>
          {% else %}
          <div class="card p-3 text-center muted">Nenhum crédito lançado para você.</div>
          {% endfor %}
        </div>

        <!-- Descontos -->
        <div class="card p-3 mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Descontos / Despesas da Cooperativa</h6>
            <span class="chip mono">Total: R$ {{ "%.2f"|format((despesas_coop|sum(attribute='valor'))|default(0)) }}</span>
          </div>
        </div>
        <div class="card-list">
          {% for d in despesas_coop %}
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="list-item-title"><i class="bi bi-dash-circle"></i> {{ d.descricao }}</div>
                {% if d.data %}<small class="muted"><i class="bi bi-calendar-event"></i> {{ d.data.strftime('%d/%m/%Y') }}</small>{% endif %}
              </div>
              <div class="text-end value mono text-danger">− R$ {{ "%.2f"|format(d.valor) }}</div>
            </div>
          </div>
          {% else %}
          <div class="card p-3 text-center muted">Nenhum desconto aplicado no período.</div>
          {% endfor %}
        </div>
      </div>

      <!-- ESCALAS -->
      <div class="tab-pane fade" id="escalas" role="tabpanel">
        <!-- Documentos -->
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0"><i class="bi bi-file-earmark-check"></i> Documentos</h6>
            <span class="badge-soft">Prazo Final: 31 de Dez · faltam <span class="countdown">{{ doc_cnh.dias_para_prazo }}</span> dias</span>
          </div>

          {% set cnh_ok = doc_cnh.ok %}
          {% set placa_ok = doc_placa.ok %}

          <div class="p-3 rounded mb-2 {{ 'doc-ok' if cnh_ok else 'doc-bad' }}">
            <div class="d-flex align-items-start">
              <div class="me-2" style="font-size:1.25rem">
                {% if cnh_ok %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}
              </div>
              <div class="flex-fill">
                <div class="fw-bold mb-1">CNH — {{ 'Em dia' if cnh_ok else 'Vencida ou pendente' }}</div>
                <div class="small muted">
                  Nº: <b>{{ doc_cnh.numero or '—' }}</b> ·
                  Validade: <b>{{ doc_cnh.vencimento.strftime('%d/%m/%Y') if doc_cnh.vencimento else '—' }}</b>
                </div>
                {% if not cnh_ok %}
                  <div class="small text-danger mt-1"><i class="bi bi-exclamation-triangle-fill"></i> Regularize para não travar repasses.</div>
                {% else %}
                  <div class="small text-success mt-1"><i class="bi bi-shield-check"></i> Tudo certo com a CNH.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="p-3 rounded {{ 'doc-ok' if placa_ok else 'doc-bad' }}">
            <div class="d-flex align-items-start">
              <div class="me-2" style="font-size:1.25rem">
                {% if placa_ok %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}
              </div>
              <div class="flex-fill">
                <div class="fw-bold mb-1">Placa — {{ 'Em dia' if placa_ok else 'Vencida ou pendente' }}</div>
                <div class="small muted">
                  Nº: <b>{{ doc_placa.numero or '—' }}</b> ·
                  Validade: <b>{{ doc_placa.vencimento.strftime('%d/%m/%Y') if doc_placa.vencimento else '—' }}</b>
                </div>
                {% if not placa_ok %}
                  <div class="small text-danger mt-1"><i class="bi bi-exclamation-triangle-fill"></i> Atualize a placa/validade para evitar bloqueios.</div>
                {% else %}
                  <div class="small text-success mt-1"><i class="bi bi-shield-check"></i> Tudo certo com a placa.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Minha escala -->
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0"><i class="bi bi-calendar2-week"></i> Minha Escala</h6>
            <span class="badge-soft">{{ (minha_escala|length) if minha_escala else 0 }} itens</span>
          </div>

          <table class="table table-bordered table-escala align-middle">
            <thead>
              <tr>
                <th style="min-width:96px">Data</th>
                <th>Turno</th>
                <th>Horário</th>
                <th>Contrato</th>
              </tr>
            </thead>
            <tbody>
              {% if minha_escala %}
                {% for e in minha_escala %}
                  {% set colors = (e.cor or '')|string %}
                  {% set has_multi = '|' in colors %}
                  {% set cs = colors.split('|') if has_multi else [] %}
                  {% set stripe = (colors if not has_multi else (cs[0] if cs|length>0 else '')) or e.status_color %}
                  <tr class="row-stripe esc-{{ e.status }}" style="border-left-color: {{ stripe }}">
                    <td>
                      <div class="date-wrap">
                        {% if has_multi %}
                          <span class="pill" style="background:{{ cs[0] if cs|length>0 else '#fff' }};color:#111; border:1px solid #0001">{{ e.data or '' }}</span>
                        {% elif colors %}
                          <span class="pill" style="background:{{ colors }};color:#111; border:1px solid #0001">{{ e.data or '' }}</span>
                        {% else %}
                          <span class="pill" style="background:#fff;border:1px solid #0001">{{ e.data or '' }}</span>
                        {% endif %}

                        {% if e.status == 'today' %}
                          <span class="badge rounded-pill bg-success-subtle text-success">HOJE</span>
                        {% elif e.status == 'tomorrow' %}
                          <span class="badge rounded-pill bg-primary-subtle text-primary">AMANHÃ</span>
                        {% elif e.status == 'past' %}
                          <span class="badge rounded-pill bg-danger-subtle text-danger">PASSADO</span>
                        {% else %}
                          <span class="badge rounded-pill bg-primary-subtle text-primary">FUTURO</span>
                        {% endif %}
                      </div>

                      <div class="actions-inline">
                        <button
                          type="button"
                          class="btn btn-xs btn-outline-primary"
                          data-bs-toggle="modal"
                          data-bs-target="#trocaModal"
                          data-escala-id="{{ e.id }}"
                          data-escala-desc="{{ (e.data or '') ~ ' • ' ~ (e.turno or '') ~ ' • ' ~ (e.horario or '') ~ ' • ' ~ (e.contrato or '') }}"
                        >
                          <i class="bi bi-arrow-left-right"></i> Trocar
                        </button>
                      </div>
                    </td>
                    <td>
                      {% if has_multi and cs|length>1 %}
                        <span class="pill" style="background:{{ cs[1] }};color:#111; border:1px solid #0001">{{ e.turno or '' }}</span>
                      {% else %}
                        {{ e.turno or '' }}
                      {% endif %}
                    </td>
                    <td class="cell-horario">
                      {% if has_multi and cs|length>2 %}
                        <span class="pill" style="background:{{ cs[2] }};color:#111; border:1px solid #0001">{{ e.horario or '' }}</span>
                      {% else %}
                        {{ e.horario or '' }}
                      {% endif %}
                    </td>
                    <td>
                      {% if has_multi and cs|length>3 %}
                        <span class="pill" style="background:{{ cs[3] }};color:#111; border:1px solid #0001">{{ e.contrato or '' }}</span>
                      {% else %}
                        {{ e.contrato or '' }}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="text-center muted">Nenhuma escala disponível.</td></tr>
              {% endif %}
            </tbody>
          </table>

          <div class="mt-1 small text-muted">
            <i class="bi bi-info-circle"></i> As solicitações de troca ficam visíveis para o administrador.
          </div>
        </div>
      </div> <!-- /tab escalas -->

      <!-- TROCAS -->
      <div class="tab-pane fade" id="trocas" role="tabpanel">
        <div class="card p-3 mb-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0"><i class="bi bi-inbox"></i> Solicitações recebidas</h6>
            <span class="badge-soft">{{ trocas_recebidas_pendentes|length }} pendente(s)</span>
          </div>
          <div class="mt-2">
            {% if trocas_recebidas_pendentes %}
              {% for t in trocas_recebidas_pendentes %}
                <div class="border rounded p-2 mb-2 no-x-scroll">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="me-2">
                      <div class="fw-semibold">{{ t.solicitante.nome }}</div>
                      <div class="small text-muted">{{ t.origem_desc }}</div>
                      {% if t.mensagem %}<div class="small">{{ t.mensagem }}</div>{% endif %}
                      <div class="small text-muted"><i class="bi bi-clock"></i> {{ t.criada_em.strftime('%d/%m/%Y %H:%M') }}</div>
                    </div>
                    <div class="text-end">
                      <button
                        class="btn btn-sm btn-success mb-1"
                        data-bs-toggle="modal"
                        data-bs-target="#aceitarTrocaModal"
                        data-troca-id="{{ t.id }}"
                        data-origem-desc="{{ t.origem_desc }}"
                        data-origem-weekday="{{ t.origem_weekday }}"
                        data-origem-bucket="{{ t.origem_turno_bucket }}"
                      ><i class="bi bi-check2"></i> Aceitar</button>
                      <form class="d-inline" method="POST" action="{{ url_for('recusar_troca', troca_id=t.id) }}">
                        <button class="btn btn-sm btn-outline-danger"><i class="bi bi-x"></i> Recusar</button>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center text-muted">Nenhuma solicitação recebida.</div>
            {% endif %}
          </div>
        </div>

        <div class="card p-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0"><i class="bi bi-send"></i> Minhas solicitações enviadas</h6>
            <span class="badge-soft">{{ trocas_enviadas|length }}</span>
          </div>

          <div class="mt-2">
            {% if trocas_enviadas %}
              {% for t in trocas_enviadas %}
                <div class="border rounded p-2 mb-2 no-x-scroll">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="me-2">
                      <div class="fw-semibold">Para: {{ t.destino.nome }}</div>
                      <div class="small text-muted">{{ t.origem_desc }}</div>
                      {% if t.mensagem %}<div class="small">{{ t.mensagem }}</div>{% endif %}
                      <div class="small text-muted"><i class="bi bi-clock"></i> {{ t.criada_em.strftime('%d/%m/%Y %H:%M') }}</div>
                    </div>
                    <div class="text-end">
                      {% if t.status == 'pendente' %}
                        <span class="badge-status bg-warning-subtle text-warning">Pendente</span>
                      {% elif t.status == 'aprovada' %}
                        <span class="badge-status bg-success-subtle text-success">Aprovada</span>
                      {% else %}
                        <span class="badge-status bg-danger-subtle text-danger">Recusada</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-center text-muted">Nenhuma solicitação enviada.</div>
            {% endif %}
          </div>
        </div>
      </div> <!-- /tab trocas -->

    </div>

    <!-- Rodapé -->
    <div class="text-center py-3 muted">
      <small>© {{ current_year|default('') }} Coopex</small>
    </div>
  </div>

  <!-- MODAL: Solicitar troca de escala -->
  <div class="modal fade" id="trocaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="trocaForm" method="POST" action="{{ url_for('solicitar_troca') }}">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> Solicitar troca de escala</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="from_escala_id" id="fromEscalaId">
            <input type="hidden" name="to_cooperado_id" id="toCooperadoId">

            <div class="mb-2">
              <div class="small text-muted">Seu plantão</div>
              <div class="fw-semibold" id="fromEscalaDesc">—</div>
            </div>

            <hr>

            <div class="mb-2">
              <label class="form-label mb-1">Escolha o cooperado para propor a troca</label>
              <input type="text" class="form-control form-control-sm" id="coopSearch" placeholder="Buscar por nome...">
              <div class="border rounded mt-2" style="max-height: 220px; overflow:auto">
                <ul class="list-group list-group-flush" id="coopList"></ul>
              </div>
              <small class="text-muted">A pessoa selecionada receberá esta proposta.</small>
            </div>

            <div class="mb-2">
              <label class="form-label mb-1">Mensagem (opcional)</label>
              <textarea name="mensagem" class="form-control" rows="2" placeholder="Ex.: posso assumir seu turno e você assume o meu?"></textarea>
            </div>
          </div>
          <div class="modal-footer d-flex justify-content-between">
            <small class="text-muted"><i class="bi bi-eye"></i> O admin visualiza as solicitações.</small>
            <div>
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-royal" id="btnEnviarTroca" disabled>Enviar solicitação</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Aceitar troca (sem scroll lateral) -->
  <div class="modal fade" id="aceitarTrocaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="aceitarTrocaForm" method="POST">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-check2-circle"></i> Aceitar troca</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="destino_escala_id" id="destinoEscalaId">
            <div class="mb-2 small text-muted">Plantão do solicitante</div>
            <div class="fw-semibold" id="origemTrocaDesc">—</div>
            <hr>
            <div class="mb-2">
              <div class="form-label mb-1">Escolha um <b>plantão seu compatível</b> (mesmo dia da semana e mesmo turno)</div>
              <div class="border rounded" style="max-height:260px; overflow:auto; overflow-x:hidden;">
                <ul class="list-group list-group-flush" id="minhaEscalaCompatList"></ul>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-royal" id="btnConfirmarAceite" disabled>Confirmar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script: Solicitar troca -->
  <script>
    const COOPS_FINAL = {{ cooperados_json | default('[]') | safe }};
    const MY_ESCALA = {{ minha_escala_json | default('[]') | safe }};

    const coopListEl = document.getElementById('coopList');
    const coopSearchEl = document.getElementById('coopSearch');
    const fromEscalaIdEl = document.getElementById('fromEscalaId');
    const fromEscalaDescEl = document.getElementById('fromEscalaDesc');
    const toCooperadoIdEl = document.getElementById('toCooperadoId');
    const btnEnviarTroca = document.getElementById('btnEnviarTroca');

    function renderCoops(filter = '') {
      const q = (filter || '').trim().toLowerCase();
      coopListEl.innerHTML = '';
      const base = Array.isArray(COOPS_FINAL) ? COOPS_FINAL : [];
      if (!base.length) {
        coopListEl.innerHTML = '<li class="list-group-item text-muted">Nenhum cooperado disponível para troca.</li>';
        return;
      }
      const filtered = base.filter(c => !q || (String(c.nome || '').toLowerCase().includes(q))).slice(0, 200);
      if (!filtered.length) {
        coopListEl.innerHTML = '<li class="list-group-item text-muted">Nenhum resultado.</li>';
        return;
      }
      filtered.forEach(c => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center';
        li.style.cursor = 'pointer';

        const avatar = document.createElement('img');
        avatar.src = c.foto_url || '{{ url_for("static", filename="img/default.png") }}';
        avatar.alt = '';
        avatar.style.width = '28px';
        avatar.style.height = '28px';
        avatar.style.objectFit = 'cover';
        avatar.style.borderRadius = '50%';
        avatar.style.border = '1px solid #0001';
        avatar.style.marginRight = '.5rem';

        const name = document.createElement('div');
        name.className = 'flex-fill';
        name.innerHTML = `<div class="fw-semibold">${c.nome || '—'}</div>`;

        const choose = document.createElement('button');
        choose.type = 'button';
        choose.className = 'btn btn-sm btn-outline-primary';
        choose.innerHTML = '<i class="bi bi-person-arrows"></i> Selecionar';
        choose.addEventListener('click', () => {
          const escala = fromEscalaDescEl.textContent || '';
          const msg = `Deseja solicitar a troca deste plantão:\n\n${escala}\n\ncom o cooperado "${c.nome}"?`;
          if (confirm(msg)) {
            toCooperadoIdEl.value = c.id;
            btnEnviarTroca.disabled = false;
            [...coopListEl.querySelectorAll('.list-group-item')].forEach(x => x.classList.remove('active'));
            li.classList.add('active');
          }
        });

        li.appendChild(avatar);
        li.appendChild(name);
        li.appendChild(choose);
        coopListEl.appendChild(li);
      });
    }

    coopSearchEl?.addEventListener('input', () => renderCoops(coopSearchEl.value));

    const trocaModalEl = document.getElementById('trocaModal');
    trocaModalEl.addEventListener('show.bs.modal', (ev) => {
      const btn = ev.relatedTarget;
      const escalaId = btn?.getAttribute('data-escala-id') || '';
      const escalaDesc = btn?.getAttribute('data-escala-desc') || '';

      fromEscalaIdEl.value = escalaId;
      fromEscalaDescEl.textContent = escalaDesc;
      toCooperadoIdEl.value = '';
      btnEnviarTroca.disabled = true;

      coopSearchEl.value = '';
      renderCoops('');
    });

    document.getElementById('trocaForm').addEventListener('submit', (e) => {
      if (!fromEscalaIdEl.value || !toCooperadoIdEl.value) {
        e.preventDefault();
        alert('Selecione um cooperado para enviar a solicitação.');
      }
    });
  </script>

  <!-- Helpers: bucket de turno também via horário -->
  <script>
    function turnoBucket(turno, horario) {
      const t = String(turno || "").toLowerCase().normalize("NFD").replace(/\p{Mn}/gu, "");
      if (t.includes("noite") || t.includes("noturn")) return "noite";
      if (t.includes("dia") || t.includes("diurn") || t.includes("manha") || t.includes("tarde")) return "dia";
      const m = String(horario || "").match(/(\d{1,2}):(\d{2})/);
      if (m) {
        const h = parseInt(m[1], 10);
        if (h >= 17 || h <= 6) return "noite";
        return "dia";
      }
      return "dia";
    }
  </script>

  <!-- Script: Aceitar troca (sem scroll lateral) -->
  <script>
    const aceitarModalEl = document.getElementById('aceitarTrocaModal');
    const origemTrocaDescEl = document.getElementById('origemTrocaDesc');
    const minhaEscalaCompatListEl = document.getElementById('minhaEscalaCompatList');
    const destinoEscalaIdEl = document.getElementById('destinoEscalaId');
    const btnConfirmarAceite = document.getElementById('btnConfirmarAceite');
    const aceitarForm = document.getElementById('aceitarTrocaForm');

    aceitarModalEl.addEventListener('show.bs.modal', (ev) => {
      const btn = ev.relatedTarget;
      const trocaId = btn?.getAttribute('data-troca-id');
      const origemDesc = btn?.getAttribute('data-origem-desc') || '—';
      const origemWeekday = parseInt(btn?.getAttribute('data-origem-weekday'));
      const origemBucket = btn?.getAttribute('data-origem-bucket');

      origemTrocaDescEl.textContent = origemDesc;
      aceitarForm.action = `/trocas/${trocaId}/aceitar`;
      destinoEscalaIdEl.value = '';
      btnConfirmarAceite.disabled = true;

      const base = Array.isArray(MY_ESCALA) ? MY_ESCALA : [];
      const compativeis = base.filter(e => {
        const bucket = e.turno_bucket || turnoBucket(e.turno, e.horario);
        return e.weekday === origemWeekday && bucket === origemBucket;
      });

      minhaEscalaCompatListEl.innerHTML = '';
      if (!compativeis.length) {
        minhaEscalaCompatListEl.innerHTML = '<li class="list-group-item text-muted">Você não tem plantões compatíveis (mesmo dia da semana e turno).</li>';
        return;
      }

      compativeis.forEach(e => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        li.innerHTML = `
          <div class="me-2">
            <div class="fw-semibold">${e.data} • ${e.turno || ''} • ${e.horario || ''} • ${e.contrato || ''}</div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary">Trocar com este</button>
        `;
        li.querySelector('button').addEventListener('click', () => {
          destinoEscalaIdEl.value = e.id;
          btnConfirmarAceite.disabled = false;
          [...minhaEscalaCompatListEl.querySelectorAll('.list-group-item')].forEach(x => x.classList.remove('active'));
          li.classList.add('active');
        });
        minhaEscalaCompatListEl.appendChild(li);
      });
    });

    aceitarForm.addEventListener('submit', (e) => {
      if (!destinoEscalaIdEl.value) {
        e.preventDefault();
        alert('Escolha um plantão seu compatível para concluir a troca.');
      }
    });
  </script>
</body>
</html>
