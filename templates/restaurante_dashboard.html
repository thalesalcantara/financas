<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Portal do Estabelecimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --royal:#2141d9; --royal-2:#3654e6; --royal-3:#eaf0ff;
      --ink:#0b1220; --muted:#6b7280; --soft:#f5f7ff; --danger:#e74c3c; --ok:#16a34a;
      --border:#e6e9f2; --chip:#eef1ff; --card:#fff; --bg:#fff; --text:#111827;
      --aside-grad1: var(--royal); --aside-grad2: var(--royal-2);
    }
    :root[data-theme="dark"]{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a;
      --border:#1f2a44; --chip:#132040; --royal:#3b82f6; --royal-2:#2563eb; --royal-3:#0b2447;
      --aside-grad1:#0b2a6b; --aside-grad2:#143d86;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    a{text-decoration:none}
    .shell{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
    .aside{
      background:linear-gradient(180deg,var(--aside-grad1) 0%,var(--aside-grad2) 100%);
      color:#fff; padding:18px 16px; position:sticky; top:0; height:100dvh;
    }
    .brand{font-weight:800; font-size:1.12rem; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.08); display:flex; align-items:center; gap:8px}
    .theme-toggle{margin-top:10px; border:1px solid rgba(255,255,255,.25); color:#fff; background:rgba(255,255,255,.06); border-radius:10px; padding:10px 12px; display:flex; align-items:center; gap:8px; cursor:pointer}
    /* menu menor */
    .navmenu{margin-top:18px; display:flex; flex-direction:column; gap:6px}
    .navmenu a{color:#fff; padding:9px 11px; border-radius:10px; display:flex; align-items:center; gap:10px; font-weight:600; position:relative; font-size:.94rem}
    .navmenu a i{font-size:1rem}
    .navmenu a.active,.navmenu a:hover{background:rgba(255,255,255,.14)}
    .content{padding:24px clamp(14px,3vw,32px)}
    .section-title{color:var(--royal); font-weight:800; font-size:1.25rem; display:flex; gap:10px; align-items:center}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 0 #0000000a}
    .card-soft{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
    .chip{background:var(--chip); color:var(--text); border:1px solid var(--border); border-radius:999px; padding:.2rem .65rem; font-weight:700}
    .table{color:var(--text)} .table td,.table th{border-color:var(--border)} .table thead th{border-color:var(--border)}
    .table-compact th,.table-compact td{padding:.5rem .6rem}
    .btn-royal{background:var(--royal); color:#fff; border:none}
    .btn-royal:hover{background:var(--royal-2); color:#fff}
    .btn-outline-royal{border:1px solid var(--royal); color:var(--royal); background:transparent}
    .btn-outline-royal:hover{background:var(--royal); color:#fff}
    .btn-outline-danger{color:#e74c3c; border-color:#e74c3c}
    .btn-outline-danger:hover{background:#e74c3c; color:#fff}
    /* SPA sections */
    section[data-view]{display:none}
    section.view-active{display:block}
    /* somente Avisos tem bolinha */
    .badge-dot{
      min-width:22px; height:22px; line-height:22px; border-radius:999px; padding:0 6px;
      font-size:.75rem; font-weight:800; display:inline-flex; align-items:center; justify-content:center;
      background:#dc3545; color:#fff; box-shadow:0 0 0 2px rgba(255,255,255,.25) inset; margin-left:auto;
    }
    @media (max-width:920px){ .shell{grid-template-columns:66px 1fr} .brand span{display:none} .navmenu a span{display:none} }
    /* Avisos */
    .aviso-card{border-left:6px solid #3b82f6}
    .aviso-card.lido{border-left-color:#94a3b8; opacity:.98}
    .aviso-card.prioridade{border-left-color:var(--danger)}
    /* Cooperados */
    .cooperado-avatar{width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 0 #0001}
    .cooperado-item{display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer}
    .cooperado-item:hover{background:#f8faff20}
    .cooperado-item.selected{outline:2px solid var(--royal); background:#1d4ed820}
    .selected-header .big{width:180px; height:180px; border-radius:50%; object-fit:cover; border:6px solid var(--royal); box-shadow:0 6px 16px #0002}
    .rating-group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .rating-label{width:160px; font-weight:700}
    .stars{display:inline-flex; gap:3px; font-size:1.4rem; cursor:pointer}
    .star{color:#94a3b8; transition:transform .06s}
    .star.active,.star.hover{color:#fbbf24}
    .rating-group[data-name="av_geral"] .stars{pointer-events:none; opacity:.95}
    .sticky-tools{position:sticky; top:12px}
    .kpi{background:#fafcff10; border:1px solid var(--border); border-radius:12px; padding:10px 12px}
    .kpi .v{font-weight:800; font-size:1.05rem}
    /* Tabelas (cartão) */
    .doc-row{border:1px solid var(--border); border-radius:16px; padding:14px 16px; background:var(--card); box-shadow:0 10px 28px #00000012; transition:transform .08s, box-shadow .12s; cursor:pointer}
    .doc-row:active{transform:scale(.995)} .doc-row:hover{box-shadow:0 12px 32px #00000018}
    .doc-title{font-weight:800; font-size:1.05rem}
    .doc-cat{font-size:.75rem; color:var(--royal); text-transform:uppercase; letter-spacing:.08em; font-weight:800}
    .doc-date{color:var(--muted); font-size:.9rem}
    .doc-desc{font-size:.95rem; color:var(--text); background:var(--soft); border-radius:10px; padding:.6em .9em}
  </style>
</head>
<body>
  <div class="shell">
    <!-- ===== Aside ===== -->
    <aside class="aside">
      <div class="brand"><i class="bi bi-building"></i><span>Portal do Estabelecimento</span></div>
      <button id="btnTheme" class="theme-toggle" type="button"><i class="bi bi-moon"></i><span id="lblTheme">Escuro</span></button>

      <nav class="navmenu" id="sideNav">
        <a data-target="lancar" class="{{ 'active' if (view|default('lancar') not in ['escalas','config','avisos','lancamentos','tabelas']) else '' }}" href="{{ url_for('portal_restaurante', view='lancar') }}">
          <i class="bi bi-person-lines-fill"></i><span>Cooperados</span>
        </a>
        <a data-target="lancamentos" class="{{ 'active' if view=='lancamentos' else '' }}" href="{{ url_for('portal_restaurante', view='lancamentos') }}">
          <i class="bi bi-receipt"></i><span>Lançamentos</span>
        </a>
        <a data-target="escalas" class="{{ 'active' if view=='escalas' else '' }}" href="{{ url_for('portal_restaurante', view='escalas') }}">
          <i class="bi bi-calendar-week"></i><span>Escala</span>
        </a>
        {% if session.get('user_tipo') == 'restaurante' %}
        <a data-target="tabelas" id="linkTabelas" href="{{ url_for('rest_tabelas') }}">
          <i class="bi bi-table"></i><span>Tabelas</span>
        </a>
        {% endif %}
        <a data-target="config" class="{{ 'active' if view=='config' else '' }}" href="{{ url_for('portal_restaurante', view='config') }}">
          <i class="bi bi-gear"></i><span>Configuração</span>
        </a>
        <!-- Avisos = único com badge -->
        <a id="linkAvisos" data-target="avisos" class="{{ 'active' if view=='avisos' else '' }}" href="{{ url_for('portal_restaurante_avisos') }}">
          <i class="bi bi-megaphone"></i><span>Avisos</span>
          {% set _cntAvisos = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
          <span class="badge-dot" id="badgeAvisos" {% if _cntAvisos == 0 %}style="display:none"{% endif %}>{{ _cntAvisos }}</span>
        </a>
        <a href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
      </nav>
    </aside>

    <!-- ===== Main ===== -->
    <main class="content">
      {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
          <div class="mb-3">
            {% for cat, msg in msgs %}
              <div class="alert alert-{{ 'danger' if cat=='error' else cat }} py-2 px-3 mb-2">{{ msg|safe }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% set _cooperados = cooperados if cooperados is defined and cooperados is not none else [] %}
      {% set _lancamentos_periodo = lancamentos_periodo if lancamentos_periodo is defined and lancamentos_periodo is not none else [] %}
      {% set _dias_list = dias_list if dias_list is defined and dias_list is not none else [] %}
      {% set _agenda = agenda if agenda is defined and agenda is not none else {} %}
      {% set _ref_data = ref_data if ref_data is defined and ref_data is not none else None %}
      {% set _modo = modo if modo is defined and modo is not none else 'semana' %}
      {% set _url_lancar_producao = url_lancar_producao if url_lancar_producao is defined else url_for('portal_restaurante') %}

      <!-- ===== CONFIG ===== -->
      <section data-view="config">
        <div class="section-title"><i class="bi bi-shield-lock"></i> Configuração</div>
        <div class="card card-body">
          <form class="row g-3 form-password" method="POST" action="{{ url_for('rest_alterar_senha') }}">
            <div class="col-md-4">
              <label class="form-label">Senha atual</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_atual" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_nova" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
              <div class="form-text">Mínimo de 6 caracteres.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Confirmar nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_conf" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-12 text-end"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
          </form>
        </div>
      </section>

      <!-- ===== ESCALAS ===== -->
      <section data-view="escalas">
        <div class="section-title"><i class="bi bi-calendar-week"></i> Escala semanal</div>
        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
            <input type="hidden" name="view" value="escalas">
            <div class="col-md-3">
              <label class="form-label">Ver</label>
              <select name="modo" class="form-select">
                <option value="semana" {{ 'selected' if (_modo=='semana') }}>Semana completa</option>
                <option value="dia" {{ 'selected' if (_modo=='dia') }}>Somente 1 dia</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Referência</label>
              <input type="date" name="ref" class="form-control" value="{{ _ref_data and _ref_data.strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='escalas') }}"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
            </div>
          </form>

          {% if _modo == 'semana' %}
          <hr class="my-3">
          <div class="row g-3">
            {% for dia in _dias_list %}
            <div class="col-md-6 col-lg-4">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge text-bg-primary fw-semibold">{{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][dia.weekday()] }} — {{ dia.strftime('%d/%m/%Y') }}</span>
                  <i class="bi bi-people"></i>
                </div>
                <div style="max-height:360px; overflow:auto; border-top:1px dashed var(--border);">
                  {% set lista = _agenda.get(dia, []) %}
                  {% if lista %}
                    {% for grupo in (lista | groupby('contrato')) %}
                      {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                      <div class="fw-bold mt-2">{{ contrato_nome }}</div>
                      {% for item in grupo.list %}
                        <div class="py-2 border-bottom">
                          <div class="fw-bold">{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</div>
                          <div class="text-muted small">{{ item.turno or '—' }}{% if item.horario %} • {{ item.horario }}{% endif %}</div>
                        </div>
                      {% endfor %}
                    {% endfor %}
                  {% else %}
                    <div class="text-muted small py-2">Sem escala registrada.</div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <hr class="my-3">
          <div class="card-soft">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge text-bg-primary fw-semibold">{{ _ref_data and ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][_ref_data.weekday()] }} — {{ _ref_data and _ref_data.strftime('%d/%m/%Y') }}</span>
              <i class="bi bi-calendar-day"></i>
            </div>
            <table class="table table-bordered table-hover align-middle table-compact">
              <thead><tr><th>Contrato</th><th>Cooperado</th><th>Turno</th><th>Horário</th></tr></thead>
              <tbody>
                {% set lista = _agenda.get(_ref_data, []) if _ref_data else [] %}
                {% if lista %}
                  {% for grupo in (lista | groupby('contrato')) %}
                    {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                    {% for item in grupo.list %}
                    <tr><td>{{ contrato_nome }}</td><td>{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</td><td>{{ item.turno or '—' }}</td><td>{{ item.horario or '—' }}</td></tr>
                    {% endfor %}
                  {% endfor %}
                {% else %}<tr><td colspan="4" class="text-center text-muted">Sem escala registrada.</td></tr>{% endif %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- ===== AVISOS (carregado localmente ou via fetch da rota) ===== -->
<section data-view="avisos">
  {% set _avisos = avisos if avisos is defined and avisos is not none else [] %}
  {% set _unread_from_list = (_avisos | selectattr('lido','equalto',False) | list | length) %}
  {% set _unread_from_ctx = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
  {% set _badgeN = (_unread_from_list if _unread_from_list>0 else _unread_from_ctx) %}
  <div class="section-title">
    <i class="bi bi-megaphone-fill"></i> Avisos
    <span id="badgeTitulo" class="badge {{ 'text-bg-danger' if _badgeN>0 else 'text-bg-success' }} ms-2">
      {{ _badgeN>0 and (_badgeN ~ ' não lido(s)') or 'Tudo lido' }}
    </span>
  </div>

  <div class="card card-body">
    <div class="d-flex align-items-center gap-2">
      <form method="POST" action="{{ url_for('marcar_todos_avisos_lidos_restaurante') }}" class="m-0">
        <button class="btn btn-royal" type="submit" {% if _badgeN == 0 %}disabled{% endif %}><i class="bi bi-check2-circle me-1"></i> Marcar todos como lidos</button>
      </form>
      <div class="form-check ms-auto">
        <input class="form-check-input" type="checkbox" id="toggleNaoLidos">
        <label class="form-check-label" for="toggleNaoLidos">Mostrar apenas não lidos</label>
      </div>
    </div>
  </div>

  <div id="avisosListContainer">
    {% if _avisos and (_avisos | length) > 0 %}
      {% for a in _avisos %}
      <div id="aviso-{{ a.id }}" class="card card-body my-2 aviso-card {% if a.lido %}lido{% endif %} {% if a.prioridade_alta %}prioridade{% endif %}" data-lido="{{ '1' if a.lido else '0' }}">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-bold">
              {{ a.titulo or 'Aviso' }}
              {% if a.prioridade_alta %}
                <span class="badge text-bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill"></i> Prioridade</span>
              {% endif %}
            </div>
            <div class="text-muted small">
              Publicado em {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em }}
              {% if a.atualizado_em %} · Atualizado {{ a.atualizado_em.strftime('%d/%m/%Y %H:%M') }}{% endif %}
              {% if a.lido %} • <span class="text-success">Lido</span>{% else %} • <span class="text-danger">Não lido</span>{% endif %}
            </div>
          </div>
          <div class="ms-3">
            {% if not a.lido %}
            <button class="btn btn-outline-royal btn-sm"
                    data-acao="marcar-lido"
                    data-url="{{ url_for('marcar_aviso_lido_universal', aviso_id=a.id) }}">
              <i class="bi bi-check2"></i> Marcar como lido
            </button>
            {% endif %}
          </div>
        </div>

        <hr class="my-2">

        <!-- CORPO DO AVISO (robusto) -->
        <div class="aviso-body">
          {% set html = (
            a.corpo_html or a.conteudo_html or a.mensagem_html or a.descricao_html or a.body_html or a.recado_html
            or (a.dados and (a.dados.corpo_html or a.dados.conteudo_html or a.dados.mensagem_html or a.dados.descricao_html or a.dados.body_html or a.dados.recado_html))
          ) %}
          {% if html and html|trim %}
            {{ html|safe }}
          {% else %}
            {% set txt = (
              a.corpo or a.conteudo or a.mensagem or a.texto or a.descricao or a.body or a.message or a.content or a.recado
              or (a.dados and (a.dados.corpo or a.dados.conteudo or a.dados.mensagem or a.dados.texto or a.dados.descricao or a.dados.body or a.dados.message or a.dados.content or a.dados.recado))
            ) %}
            {% if txt and txt|trim %}
              <p class="mb-0">{{ txt|e|replace('\r\n','\n')|replace('\n','<br>')|safe }}</p>
            {% else %}
              <p class="text-muted mb-0"><em>(sem conteúdo)</em></p>
            {% endif %}
          {% endif %}
        </div>
        <!-- /CORPO DO AVISO -->
      </div>
      {% endfor %}
    {% else %}
      <!-- Se não vier avisos no contexto, o JS vai buscar na rota e injetar -->
      <div class="card card-body text-muted">Carregando avisos…</div>
    {% endif %}
  </div>
</section>
<!-- ===== /AVISOS ===== -->

<!-- ===== LANCAMENTOS ===== -->
<section data-view="lancamentos">
  <div class="section-title"><i class="bi bi-receipt"></i> Lançamentos</div>
  <div class="row g-3">
    <div class="col-lg-3">
      <div class="card card-body sticky-tools">
        <form id="formFiltroLanc" method="GET" action="{{ url_for('portal_restaurante') }}" class="row g-2 align-items-end">
          <input type="hidden" name="view" value="lancamentos">

          <div class="col-12">
            <label class="form-label">Início</label>
            <input type="date" class="form-control" name="data_inicio" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
          </div>
          <div class="col-12">
            <label class="form-label">Fim</label>
            <input type="date" class="form-control" name="data_fim" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
          </div>
          <div class="col-12">
            <label class="form-label">Mês (opcional)</label>
            <input type="month" class="form-control" name="mes" value="{{ filtro_mes or '' }}"
                   oninput="if(this.value){ const f=this.form; f.data_inicio.value=''; f.data_fim.value=''; }">
            <div class="form-text">Se escolher um mês, as datas serão ignoradas.</div>
          </div>
          <div class="col-12">
            <label class="form-label">Digite o nome do cooperado (visual)</label>
            <input type="text" class="form-control" name="q" placeholder="Filtrar por nome...">
          </div>

          <div class="col-12 d-grid"><button class="btn btn-royal" type="submit"><i class="bi bi-funnel"></i> Aplicar</button></div>
          <div class="col-12 d-grid"><a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='lancamentos') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a></div>

          <hr class="my-2">
          <div class="kpi mb-2"><div class="small text-muted">Total no período</div><div class="v">R$ <span id="kpiTotalValor">0,00</span></div></div>
          <div class="kpi mb-2"><div class="small text-muted">Entregas no período</div><div class="v"><span id="kpiTotalEntregas">0</span></div></div>

          <!-- Export azul sempre -->
          <div class="d-grid"><button class="btn btn-royal" type="button" id="btnExportCsv"><i class="bi bi-download"></i> Exportar CSV</button></div>
        </form>
      </div>
    </div>

    <div class="col-lg-9">
      <div class="card card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="chip">Período: <span id="txtPeriodo">
            {{ filtro_inicio and filtro_inicio.strftime('%d/%m/%Y') or '' }}
            {% if filtro_inicio and filtro_fim %} a {% endif %}
            {{ filtro_fim and filtro_fim.strftime('%d/%m/%Y') or '' }}
          </span></div>
        </div>

        <table class="table table-bordered table-hover align-middle table-compact" id="tblLanc">
          <thead>
            <tr>
              <th class="text-center" style="width:110px;">Data</th>
              <th>Cooperado</th>
              <th>Contrato</th>
              <th class="text-center" style="width:160px;">Horário</th>
              <th>Descrição</th> <!-- NOVO: visível só aqui -->
              <th class="text-center" style="width:120px;">Entregas</th>
              <th class="text-end" style="width:140px;">Valor (R$)</th>
            </tr>
          </thead>
          <tbody id="tbodyLanc">
            {% for x in _lancamentos_periodo %}
            <tr data-coop="{{ x.cooperado_id or x.coop_id }}"
                data-coopnome="{{ x.cooperado_nome or x.coop_nome }}"
                data-contrato="{{ x.contrato_nome or x.contrato }}">
              <td class="text-center">{{ (x.data.strftime('%d/%m/%Y') if x.data) if x.data is not string else x.data }}</td>
              <td class="fw-semibold coop-name">{{ x.cooperado_nome or x.coop_nome }}</td>
              <td>{{ x.contrato_nome or x.contrato or '—' }}</td>
              <td class="text-center">
                {% if x.hora_inicio or x.hora_fim %}
                  {{ x.hora_inicio or '' }}{% if x.hora_inicio or x.hora_fim %} às {% endif %}{{ x.hora_fim or '' }}
                {% else %}—{% endif %}
              </td>
              <td class="desc">{{ x.descricao or '-' }}</td> <!-- NOVO -->
              <td class="text-center entregas">{{ x.qtd_entregas if x.qtd_entregas is not none else '-' }}</td>
              <td class="text-end valor" data-valor="{{ '%.2f'|format(x.valor or 0) }}">R$ {{ '%.2f'|format(x.valor or 0) }}</td>
            </tr>
            {% else %}{% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-secondary">
              <th colspan="5" class="text-end">Totais</th>
              <th class="text-center" id="ftEntregas">0</th>
              <th class="text-end" id="ftValor">R$ 0,00</th>
            </tr>
          </tfoot>
        </table>

        <hr class="my-3">
        <h6 class="mb-2"><i class="bi bi-people"></i> Totais por cooperado</h6>
        <div id="gridCoop" class="row g-2"></div>
      </div>
    </div>
  </div>
</section>

<!-- ===== LANÇAR ===== -->
<section data-view="lancar">
  <div class="section-title"><i class="bi bi-plus-circle"></i> Lançar Produção Diária</div>

  <div class="card card-body">
    <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
      <input type="hidden" name="view" value="lancar">
      <div class="col-md-3"><label class="form-label">Início</label><input type="date" name="data_inicio" class="form-control" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}"></div>
      <div class="col-md-3"><label class="form-label">Fim</label><input type="date" name="data_fim" class="form-control" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}"></div>
      <div class="col-md-3"><div class="small text-muted mb-1">Período em uso</div><div class="chip">{% if filtro_inicio and filtro_fim %}{{ filtro_inicio.strftime('%d/%m/%Y') }} a {{ filtro_fim.strftime('%d/%m/%Y') }}{% else %} — {% endif %}</div></div>
      <div class="col-md-3 text-end">
        <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='lancar') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
      </div>
    </form>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-4">
      <div class="card card-body">
        <div class="input-group mb-2">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="buscaCoop" type="text" class="form-control" placeholder="Buscar cooperado..." list="cooperadosList">
          <datalist id="cooperadosList">{% for coop in _cooperados %}<option value="{{ coop.nome }}"></option>{% endfor %}</datalist>
          <select id="selectCoop" class="form-select">
            <option value="">Lista...</option>
            {% for coop in _cooperados %}
              <option
                value="{{ coop.id }}"
                data-fone="{{ (coop.telefone or '')|replace('(','')|replace(')','')|replace('-','')|replace(' ','')|replace('+','') }}"
                data-fone-raw="{{ coop.telefone or '' }}"
              >
                {{ coop.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div id="listaCooperados" style="max-height:60vh; overflow:auto;">
          {% for coop in _cooperados %}
          <div class="cooperado-item"
               data-id="{{ coop.id }}"
               data-nome="{{ coop.nome }}"
               data-foto="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
               data-total="{{ '%.2f'|format(coop.total_periodo or 0) }}"
               data-fone="{{ (coop.telefone or '')|replace('(','')|replace(')','')|replace('-','')|replace(' ','')|replace('+','') }}"
               data-fone-raw="{{ coop.telefone or '' }}">
            <img src="{{ url_for('media_coop', coop_id=coop.id) if coop.foto_bytes else url_for('static', filename='img/default.png') }}" class="cooperado-avatar" alt="Foto do cooperado">
            <div class="d-flex flex-column">
              <span class="fw-bold">{{ coop.nome }}</span>
              <small class="text-muted">No período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</small>
              {% if coop.telefone %}
                <small class="text-muted"><i class="bi bi-telephone"></i> {{ coop.telefone }}</small>
              {% endif %}
            </div>
          </div>
          {% else %}
            <div class="text-muted small">Nenhum cooperado encontrado.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card card-body" id="blocoLancamento">
        <div class="selected-header text-center mb-2" id="selectedHeader" style="display:none;">
          <img id="selFoto" src="" class="big" alt="">
          <div class="fw-bold fs-5 mt-2 d-flex justify-content-center align-items-center gap-2 flex-wrap">
            <span id="selNome"></span>
            <!-- 👇 telefone ao lado do nome -->
            <a id="selPhone"
               class="badge bg-light text-dark border text-decoration-none"
               style="font-weight:500;"
               href="javascript:void(0)">
              <span class="text-muted">Sem telefone</span>
            </a>
          </div>
          <div class="text-muted">Total no período: R$ <span id="selTotal">0,00</span></div>
        </div>

        <div class="alert alert-info py-2 px-3 mb-2" id="hintSelecione">Selecione um cooperado para lançar.</div>

        <form id="formLancamento" method="POST" action="{{ _url_lancar_producao }}" class="row g-2 align-items-end mb-1" style="display:none;">
          <input type="hidden" name="cooperado_id" id="inputCooperadoId" value="">
          <div class="col-md-3"><label class="form-label">Valor (R$)</label><input type="number" class="form-control" name="valor" step="0.01" required></div>
          <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" name="data" required></div>
          <div class="col-md-3"><label class="form-label">Hora Início</label><input type="time" class="form-control" name="hora_inicio"></div>
          <div class="col-md-3"><label class="form-label">Hora Fim</label><input type="time" class="form-control" name="hora_fim"></div>
          <div class="col-md-3"><label class="form-label">Entregas</label><input type="number" class="form-control" name="qtd_entregas" min="0" step="1"></div>

          <!-- Descrição (opcional) — exclusiva do Portal do Estabelecimento -->
          <div class="col-12">
            <label class="form-label">Descrição (opcional)</label>
            <textarea class="form-control" name="descricao" rows="2"
                      placeholder="Ex.: motivo do valor, observações, contrato especial…"></textarea>
          </div>

          <div class="col-12"><hr class="my-2"></div>
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkAvaliar"
                onclick="document.getElementById('boxAval').style.display=this.checked?'block':'none'; document.getElementById('inputAvaliar').value=this.checked?'1':'0';">
              <label class="form-check-label" for="chkAvaliar">Registrar avaliação agora</label>
            </div>
            <input type="hidden" name="avaliar" id="inputAvaliar" value="0">
          </div>

          <div id="boxAval" class="row g-2" style="display:none;">
            {% for nm,titulo in [('av_pontualidade','Pontualidade'),('av_educacao','Educação'),('av_eficiencia','Eficiência / Cuidado'),('av_apresentacao','Apresentação')] %}
            <div class="col-md-6">
              <div class="rating-group" data-name="{{ nm }}">
                <div class="rating-label">{{ titulo }}</div>
                <div class="stars">
                  <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                </div>
                <input type="hidden" name="{{ nm }}" value="">
              </div>
            </div>
            {% endfor %}
            <div class="col-md-6">
              <div class="rating-group" data-name="av_geral" data-auto="true">
                <div class="rating-label">Geral (média automática)</div>
                <div class="stars"><i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i></div>
                <input type="hidden" name="av_geral" value="">
              </div>
            </div>
            <div class="col-12"><label class="form-label">Comentário (opcional)</label><textarea class="form-control" name="av_comentario" rows="2" placeholder="Conte rapidamente como foi a experiência..."></textarea></div>
          </div>

          <div class="col-12 text-end mt-2"><button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button></div>
        </form>
      </div>

      <!-- Tabelas por cooperado (mostra/oculta pelo selecionado) -->
      <div id="blocoTabelas" class="mt-2">
        {% for coop in _cooperados %}
        <div id="tabela-{{ coop.id }}" class="card card-body lancamentos-table" style="display:none;">
          <table class="table table-bordered table-hover align-middle table-compact">
            <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th>Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
            <tbody>
              {% for lanc in coop.lancamentos %}
              <tr>
                <td>R$ {{ '%.2f'|format(lanc.valor or 0) }}</td>
                <td>{{ lanc.data.strftime('%d/%m/%Y') if lanc.data }}</td>
                <td>{{ lanc.hora_inicio or '' }}{% if lanc.hora_inicio or lanc.hora_fim %} às {% endif %}{{ lanc.hora_fim or '' }}</td>
                <td>{{ lanc.qtd_entregas if lanc.qtd_entregas is not none else '-' }}</td>
                <td>{% if has_editar_lanc %}<a href="{{ url_for('editar_lancamento', id=lanc.id) }}" class="btn btn-outline-royal btn-sm"><i class="bi bi-pencil"></i></a>{% endif %}</td>
                <td><a href="{{ url_for('excluir_lancamento', id=lanc.id) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a></td>
              </tr>
              {% else %}<tr><td colspan="6" class="text-center text-muted">Nenhum lançamento no período selecionado</td></tr>{% endfor %}
            </tbody>
          </table>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<script>
  // máscara simples BR
  function formatPhoneBR(v) {
    let d = (v || '').replace(/\D/g,'');
    if (d.length > 11 && d.startsWith('55')) d = d.slice(d.length - 11);
    d = d.slice(0, 11);
    if (d.length <= 10) {
      return d.replace(/^(\d{0,2})(\d{0,4})(\d{0,4}).*$/, (_,a,b,c)=>{
        let out=''; if(a) out+='('+a; if(a && a.length===2) out+=') ';
        if(b) out+=b; if(b && b.length===4 && c) out+='-'+c; return out;
      });
    }
    return d.replace(/^(\d{2})(\d{5})(\d{4}).*$/, '($1) $2-$3');
  }

  (function(){
    const header     = document.getElementById('selectedHeader');
    const img        = document.getElementById('selFoto');
    const nomeEl     = document.getElementById('selNome');
    const totalEl    = document.getElementById('selTotal');
    const phoneEl    = document.getElementById('selPhone');
    const form       = document.getElementById('formLancamento');
    const hint       = document.getElementById('hintSelecione');
    const inputId    = document.getElementById('inputCooperadoId');

    function setPhone(digits, raw) {
      const d = (digits || '').replace(/\D/g,'');
      if (d) {
        phoneEl.textContent = formatPhoneBR(d);
        phoneEl.href = 'https://wa.me/55' + d;
        phoneEl.target = '_blank';
        phoneEl.classList.remove('text-muted');
      } else {
        phoneEl.innerHTML = '<span class="text-muted">Sem telefone</span>';
        phoneEl.removeAttribute('href');
        phoneEl.removeAttribute('target');
      }
    }

    function selectCoop({id, nome, foto, total, foneDigits, foneRaw}) {
      header.style.display = '';
      form.style.display = '';
      hint.style.display = 'none';

      img.src = foto || img.src;
      nomeEl.textContent = nome || '—';
      totalEl.textContent = (total || '0,00');

      setPhone(foneDigits, foneRaw);
      inputId.value = id || '';
      // mostra tabela correspondente
      document.querySelectorAll('.lancamentos-table').forEach(t => t.style.display = 'none');
      const table = document.getElementById('tabela-' + id);
      if (table) table.style.display = '';
    }

    // clique na lista
    document.getElementById('listaCooperados')?.addEventListener('click', (e) => {
      const card = e.target.closest('.cooperado-item');
      if (!card) return;
      selectCoop({
        id: card.dataset.id,
        nome: card.dataset.nome,
        foto: card.dataset.foto,
        total: (parseFloat(card.dataset.total || '0') || 0).toFixed(2).replace('.', ','),
        foneDigits: card.dataset.fone || '',
        foneRaw: card.dataset['foneRaw'] || ''
      });
    });

    // mudança no select
    document.getElementById('selectCoop')?.addEventListener('change', (e) => {
      const opt = e.target.selectedOptions[0];
      if (!opt || !opt.value) return;
      // tenta achar o card para pegar foto/total; se não tiver, usa básicos
      const card = document.querySelector('.cooperado-item[data-id="'+opt.value+'"]');
      selectCoop({
        id: opt.value,
        nome: opt.textContent.trim(),
        foto: card ? card.dataset.foto : '',
        total: card ? (parseFloat(card.dataset.total || '0').toFixed(2).replace('.', ',')) : '0,00',
        foneDigits: opt.getAttribute('data-fone') || (card ? card.dataset.fone : ''),
        foneRaw: opt.getAttribute('data-fone-raw') || (card ? card.dataset['foneRaw'] : '')
      });
    });
  })();
</script>

<!-- ===== TABELAS (carregada da rota e exibida aqui) ===== -->
<section data-view="tabelas">
  <div class="section-title"><i class="bi bi-table"></i> Minhas Tabelas</div>
  <div id="tabelasContainer">
    {% if tabela %}
      {% set titulo = tabela.titulo or login_nome %}
      {% set nome_arquivo = tabela.arquivo_nome or '' %}
      {% set ext = nome_arquivo.split('.')[-1]|lower if '.' in nome_arquivo else '' %}
      <article class="doc-row my-2"
               data-view="{{ url_for('rest_tabela_abrir', tabela_id=tabela.id) }}"
               data-download="{{ url_for('rest_tabela_download', tabela_id=tabela.id) }}"
               data-title-full="{{ titulo }}" data-ext="{{ ext }}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="pe-2">
            <div class="doc-cat">TABELA</div>
            <div class="doc-title d-flex align-items-center gap-2"><i class="bi bi-journal-text"></i> {{ titulo }}</div>
            <div class="doc-date">{{ tabela.enviado_em.strftime('%d/%m/%Y %H:%M') if tabela.enviado_em else '' }}</div>
            {% if tabela.descricao %}<div class="doc-desc mt-2">{{ tabela.descricao }}</div>{% endif %}
            <div class="mt-2 d-flex flex-wrap gap-2">
              <span class="chip"><i class="bi bi-file-earmark"></i> {{ nome_arquivo or '—' }}</span>
              {% if ext %}<span class="chip"><i class="bi bi-tag"></i> {{ ext|upper }}</span>{% endif %}
            </div>
          </div>
          <div class="ms-2 d-flex flex-column gap-2">
            <button class="btn btn-royal" data-open title="Visualizar"><i class="bi bi-journal-bookmark-fill"></i></button>
            <a class="btn btn-outline-secondary btn-sm" data-direct-download href="{{ url_for('rest_tabela_download', tabela_id=tabela.id) }}"><i class="bi bi-download"></i></a>
          </div>
        </div>
        <div class="text-muted small mt-2">Clique para visualizar em tela cheia ou baixe o arquivo.</div>
      </article>
    {% else %}
      <div class="card card-body text-muted">Carregando tabelas…</div>
    {% endif %}
  </div>
</section>
<!-- /sections -->
</main>
</div>

<!-- TOAST PERSISTENTE (TOPO DIREITO) -->
{% set _avisos_for_toast = avisos if avisos is defined and avisos is not none else [] %}
{% set _unread_from_list_t = (_avisos_for_toast | selectattr('lido','equalto',False) | list | length) %}
{% set _unread_from_ctx_t = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
{% set _toast_unread = _unread_from_list_t if _unread_from_list_t>0 else _unread_from_ctx_t %}
<div class="position-fixed top-0 end-0 p-3" style="z-index:1060;">
  <div id="toastAvisos" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
    <div class="toast-header">
      <i class="bi bi-megaphone-fill me-2"></i><strong class="me-auto">Novos avisos</strong><small>agora</small>
      <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
    <div class="toast-body">
      Você tem <b id="toastCount">{{ _toast_unread }}</b> aviso(s) não lido(s).
      <a id="toastVerAgora" href="{{ url_for('portal_restaurante_avisos') }}" class="link-primary fw-semibold">Ver agora</a>
    </div>
  </div>
</div>

<!-- TOAST OK -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1056;">
  <div id="toastOK" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="2200">
    <div class="toast-header">
      <i class="bi bi-check2-circle text-success me-2"></i><strong class="me-auto">Pronto</strong><small>agora</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
    <div class="toast-body">Aviso marcado como lido.</div>
  </div>
</div>

<!-- MODAL FULLSCREEN TABELAS -->
<div class="modal fade" id="modalTabela" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <div><div class="doc-cat mb-0">TABELA</div><h5 class="modal-title" id="modalTabelaLabel"></h5></div>
        <div class="d-flex align-items-center gap-2">
          <a id="modalAbrirNovaAba" href="#" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm"><i class="bi bi-box-arrow-up-right"></i> Abrir em nova aba</a>
          <a id="modalBaixar" href="#" class="btn btn-primary btn-sm"><i class="bi bi-download"></i> Baixar</a>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
      </div>
      <div class="modal-body p-2">
        <iframe id="modalFrame" class="w-100" style="height:82vh; border:0" allowfullscreen></iframe>
        <div id="modalAviso" class="small text-muted mt-2 d-none">Se o arquivo não abrir, use “Abrir em nova aba” ou “Baixar”.</div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- MODAL AVALIAR (NOVO) -->
<!-- ======================= -->
<div class="modal fade" id="modalAvaliar" tabindex="-1" aria-labelledby="modalAvaliarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAvaliarLabel"><i class="bi bi-star-half me-2"></i>Deseja avaliar o motoboy agora?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">Você pode registrar a avaliação agora ou <b>pular</b> e lançar apenas os dados.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="btnPularAval"><i class="bi bi-skip-forward"></i> Pular e lançar</button>
        <button type="button" class="btn btn-royal" id="btnAvaliarAgora"><i class="bi bi-star-fill"></i> Avaliar agora</button>
      </div>
    </div>
  </div>
</div>
<!-- /MODAL AVALIAR -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ===== Tema ===== */
  const THEME_KEY='portal_theme';
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
    const lbl=document.getElementById('lblTheme'); const icon=document.querySelector('#btnTheme i');
    if(lbl) lbl.textContent = (t==='dark')?'Claro':'Escuro';
    if(icon){ icon.classList.toggle('bi-moon', t!=='dark'); icon.classList.toggle('bi-sun', t==='dark'); }
    localStorage.setItem(THEME_KEY, t);
  }
  (function initTheme(){
    const saved = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(saved);
    document.getElementById('btnTheme')?.addEventListener('click', ()=>{
      const cur = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(cur==='dark'?'light':'dark');
    });
  })();

  /* ===== Navegação SPA ===== */
  function showSection(view){
    document.querySelectorAll('section[data-view]').forEach(sec=>sec.classList.toggle('view-active', sec.getAttribute('data-view')===view));
    document.querySelectorAll('#sideNav a').forEach(a=>{
      const t=a.getAttribute('data-target'); a.classList.toggle('active', t===view);
    });
    if(view==='avisos') initAvisos();
    if(view==='lancamentos') initLancamentos();
    if(view==='lancar') initLancar();
    if(view==='tabelas') initTabelas();
  }
  function pushView(v){ const u=new URL(location.href); u.searchParams.set('view',v); history.pushState({view:v},'',u.toString()); }
  function startView(){ return new URL(location.href).searchParams.get('view') || 'lancar'; }

  /* ===== Utils ===== */
  function togglePwd(btn){ const i=btn.previousElementSibling; if(!i) return; i.type=i.type==='password'?'text':'password'; btn.querySelector('i').classList.toggle('bi-eye'); btn.querySelector('i').classList.toggle('bi-eye-slash'); }
  const brMoney = (n)=> (n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  const todayStr = ()=>{ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return d.getFullYear()+'-'+mm+'-'+dd; };
  function prefetch(href){ try{ const l=document.createElement('link'); l.rel='prefetch'; l.href=href; document.head.appendChild(l);}catch(e){} }

  /* ===== Toast & badge de Avisos ===== */
  let toastAvisosInst=null;
  function ensureToastInstance(){ const el=document.getElementById('toastAvisos'); if(!el) return null; if(!toastAvisosInst) toastAvisosInst = new bootstrap.Toast(el,{autohide:false}); return toastAvisosInst; }
  function setAvisosBadge(n){
    const b=document.getElementById('badgeAvisos'); if(b){ b.style.display = n>0 ? 'inline-flex':'none'; b.textContent=n; }
    const tCnt=document.getElementById('toastCount'); if(tCnt) tCnt.textContent=n;
    const tit=document.getElementById('badgeTitulo'); if(tit){ tit.className='badge '+(n>0?'text-bg-danger':'text-bg-success'); tit.textContent = n>0 ? (n+' não lido(s)') : 'Tudo lido'; }
    const t=ensureToastInstance(); if(t){ if(n>0) t.show(); else t.hide(); }
  }

  /* ===== Avisos ===== */
  let avisosWired=false;
  function initAvisos(){
    if(avisosWired) return; avisosWired=true;
    const toastOK = new bootstrap.Toast(document.getElementById('toastOK'));
    function getUnread(){ return document.querySelectorAll('.aviso-card[data-lido="0"]').length; }
    function refresh(){ setAvisosBadge(getUnread()); }

    // filtro
    document.getElementById('toggleNaoLidos')?.addEventListener('change', (e)=>{
      const only=e.target.checked;
      document.querySelectorAll('.aviso-card').forEach(card=>{
        const lido=card.getAttribute('data-lido')==='1';
        card.style.display = (only && lido) ? 'none' : '';
      });
    });

    // marcar lido
    (document.getElementById('avisosListContainer')||document).addEventListener('click', async (ev)=>{
      const btn=ev.target.closest('[data-acao="marcar-lido"]'); if(!btn) return;
      const url=btn.getAttribute('data-url'); const card=btn.closest('.aviso-card');
      try{
        const resp=await fetch(url,{method:'POST',credentials:'same-origin'});
        if(resp.ok){
          card.setAttribute('data-lido','1'); card.classList.add('lido');
          const meta=card.querySelector('.text-muted.small'); if(meta && !/Lido/.test(meta.innerHTML)) meta.innerHTML += ' • <span class="text-success">Lido</span>';
          btn.remove(); refresh(); toastOK.show();
        }else{ alert('Falha ao marcar como lido ('+resp.status+').'); }
      }catch(e){ alert('Erro de rede.'); }
    });

    refresh();

    // se não veio lista no contexto, buscar da rota e injetar
    if(!document.querySelector('#avisosListContainer .aviso-card')){
      const href=document.getElementById('linkAvisos')?.href;
      if(href) loadAvisosFromRoute(href);
    }
  }

  async function loadAvisosFromRoute(href){
    try{
      const res=await fetch(href,{credentials:'same-origin'}); if(!res.ok) throw new Error(res.status);
      const html=await res.text(); const dom=new DOMParser().parseFromString(html,'text/html');
      const cards=[...dom.querySelectorAll('.aviso-card,#avisosListContainer .aviso,.aviso')];
      const cont=document.getElementById('avisosListContainer'); if(!cont) return;
      cont.innerHTML='';
      if(cards.length){
        cards.forEach(c=>cont.appendChild(document.importNode(c,true)));
        avisosWired=false; initAvisos(); // religar handlers
        setAvisosBadge(cards.filter(c=>c.getAttribute('data-lido')==='0').length);
      }else{
        cont.innerHTML='<div class="card card-body"><div class="text-muted"><i class="bi bi-inbox me-1"></i> Nenhum aviso disponível.</div></div>';
        setAvisosBadge(0);
      }
    }catch(e){
      const cont=document.getElementById('avisosListContainer');
      if(cont) cont.innerHTML='<div class="card card-body text-muted">Não foi possível carregar os avisos agora.</div>';
    }
  }

  /* ===== Lançar ===== */
  let lancarWired=false;
  function initLancar(){
    if(lancarWired) return; lancarWired=true;
    const busca=document.getElementById('buscaCoop');
    const select=document.getElementById('selectCoop');
    const itens=Array.from(document.querySelectorAll('.cooperado-item'));
    const form=document.getElementById('formLancamento');
    const hint=document.getElementById('hintSelecione');
    const header=document.getElementById('selectedHeader');
    const inputCoopId=document.getElementById('inputCooperadoId');
    const selFoto=document.getElementById('selFoto');
    const selNome=document.getElementById('selNome');
    const selTotal=document.getElementById('selTotal');

    function mostrarCooperado(el){
      if(!el) return;
      itens.forEach(i=>i.classList.remove('selected')); el.classList.add('selected');
      inputCoopId.value=el.dataset.id; selFoto.src=el.dataset.foto; selNome.textContent=el.dataset.nome; selTotal.textContent=el.dataset.total;
      header.style.display='block'; form.style.display='flex'; hint.style.display='none';
      document.querySelectorAll('.lancamentos-table').forEach(t=>t.style.display='none');
      const t=document.getElementById('tabela-'+el.dataset.id); if(t) t.style.display='block';
      document.querySelectorAll('.rating-group').forEach(g=>{ if(g.dataset.name!=='av_geral') wireStars(g); });
      autoGeral();
    }
    itens.forEach(el=>el.addEventListener('click',()=>mostrarCooperado(el)));
    busca?.addEventListener('input',function(){ const q=this.value.trim().toLowerCase(); itens.forEach(el=>el.style.display=(el.dataset.nome||'').toLowerCase().includes(q)?'':'none'); });
    select?.addEventListener('change',function(){ const el=itens.find(x=>x.dataset.id===this.value); if(el) mostrarCooperado(el); });
    if(itens[0]) mostrarCooperado(itens[0]);

    wireAvaliacaoFlow(); // ligar fluxo do modal de avaliação
  }

  function wireStars(group){
    const hidden=group.querySelector('input[type="hidden"]'); const stars=group.querySelectorAll('.star');
    function paint(v,hover=false){ stars.forEach(s=>{ const on=Number(s.dataset.v)<=v; s.classList.toggle('active',on); s.classList.toggle('hover',hover&&on); }); }
    stars.forEach(s=>{
      s.addEventListener('mouseenter',()=>paint(Number(s.dataset.v),true));
      s.addEventListener('mouseleave',()=>paint(Number(hidden.value||0),false));
      s.addEventListener('click',()=>{ hidden.value=Number(s.dataset.v); paint(Number(hidden.value),false); autoGeral(); });
    });
    paint(Number(hidden.value||0),false);
  }

  // autoGeral: média só se houver notas; senão fica vazio e não pinta
  function autoGeral(){
    const g=document.querySelector('.rating-group[data-name="av_geral"]'); if(!g) return;
    const h=g.querySelector('input[type="hidden"]');
    const nomes=['av_pontualidade','av_educacao','av_eficiencia','av_apresentacao']; 
    const vals=[];
    nomes.forEach(n=>{
      const v=Number(document.querySelector(`.rating-group[data-name="${n}"] input[type="hidden"]`)?.value||0);
      if(v>0) vals.push(v);
    });
    const media = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : null;
    h.value = media ?? '';
    g.querySelectorAll('.star').forEach(s=>{
      const v=Number(s.dataset.v);
      s.classList.toggle('active', !!media && v<=media);
      s.classList.remove('hover');
    });
  }

  /* ===== Lancamentos ===== */
  let lancamentosWired=false;
  function initLancamentos(){
    if(lancamentosWired) return; lancamentosWired=true;
    const tbody=document.getElementById('tbodyLanc'); if(!tbody) return;
    const ftValor=document.getElementById('ftValor'); const ftEnt=document.getElementById('ftEntregas');
    const kpiV=document.getElementById('kpiTotalValor'); const kpiE=document.getElementById('kpiTotalEntregas');
    const grid=document.getElementById('gridCoop'); const f=document.getElementById('formFiltroLanc');

    const key='lanc_applied_today';
    if(f && !f.data_inicio.value && !f.data_fim.value && !f.mes.value && !sessionStorage.getItem(key)){
      const t=todayStr(); f.data_inicio.value=t; f.data_fim.value=t;
      sessionStorage.setItem(key,'1'); sessionStorage.setItem('scrollY', String(window.scrollY)); f.submit(); return;
    }
    const savedY=Number(sessionStorage.getItem('scrollY')||0); if(savedY){ window.scrollTo(0,savedY); sessionStorage.removeItem('scrollY'); }

    function rows(){ return Array.from(tbody.querySelectorAll('tr')); }
    function recompute(){
      let totV=0, totE=0; const per={};
      rows().forEach(tr=>{
        if(tr.style.display==='none') return;
        const v=Number(tr.querySelector('.valor')?.dataset.valor||0);
        const eTxt = tr.querySelector('.entregas')?.textContent?.trim() || '0'; // AJUSTE
        const e = eTxt === '-' ? 0 : Number(eTxt.replace(/\D+/g,''));
        totV+=v; totE+=e;
        const id=tr.dataset.coop, nm=tr.dataset.coopnome;
        per[id]=per[id]||{nome:nm,valor:0,ent:0}; per[id].valor+=v; per[id].ent+=e;
      });
      ftValor.textContent='R$ '+brMoney(totV); ftEnt.textContent=String(totE); kpiV.textContent=brMoney(totV); kpiE.textContent=String(totE);
      grid.innerHTML=''; Object.values(per).sort((a,b)=>b.valor-a.valor).forEach(p=>{
        const div=document.createElement('div'); div.className='col-sm-6 col-xl-4';
        div.innerHTML=`<div class="kpi h-100"><div class="fw-bold">${p.nome||'-'}</div><div class="small text-muted">Entregas: <b>${p.ent||0}</b></div><div>Total: <b>R$ ${brMoney(p.valor||0)}</b></div></div>`; grid.appendChild(div);
      });
    }
    f?.q?.addEventListener('input', ()=>{
      const q=(f.q.value||'').toLowerCase().trim(); sessionStorage.setItem('lanc_q',q);
      rows().forEach(tr=>{ const coop=(tr.dataset.coopnome||'').toLowerCase(); const contrato=(tr.dataset.contrato||'').toLowerCase(); tr.style.display = (!q || coop.includes(q) || contrato.includes(q)) ? '' : 'none'; });
      recompute();
    });
    f?.addEventListener('submit', ()=>{ sessionStorage.setItem('scrollY', String(window.scrollY)); });

    // CSV com coluna Descrição
    document.getElementById('btnExportCsv')?.addEventListener('click', ()=>{
      const rowsVis=rows().filter(r=>r.style.display!=='none');
      const header=['Data','Cooperado','Contrato','Horário','Descrição','Entregas','Valor (R$)']; // NOVO
      const linhas=[header]; let totE=0, totV=0;

      function csvEscape(t){ return '"' + String(t||'').replace(/"/g,'""') + '"'; }

      rowsVis.forEach(r=>{
        const c=r.cells;
        const data=c[0]?.textContent.trim()||'';
        const coop=c[1]?.textContent.trim()||'';
        const contrato=c[2]?.textContent.trim()||'';
        const horario=c[3]?.textContent.trim()||'';
        const desc=(r.querySelector('.desc')?.textContent||'').replace(/\s+/g,' ').trim(); // NOVO
        const eTxt=(r.querySelector('.entregas')?.textContent.trim()||'0');
        const entregas=(eTxt==='-')?0:Number(eTxt.replace(/\D+/g,''));
        const valorNum=Number(r.querySelector('.valor')?.dataset.valor||0);

        linhas.push([data,coop,contrato,horario,csvEscape(desc),String(entregas),valorNum.toFixed(2).replace('.',',')]);
        totE+=entregas; totV+=valorNum;
      });
      linhas.push(['Totais','','','', '', String(totE), String(totV.toFixed(2)).replace('.',',')]);
      const csv='\uFEFF'+linhas.map(l=>l.join(';')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lancamentos.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    recompute();
    const savedQ=sessionStorage.getItem('lanc_q')||''; if(savedQ && f?.q){ f.q.value=savedQ; f.q.dispatchEvent(new Event('input')); }

    // Avaliar/editar avaliação sem sair da página
    wireAvalLanc();
  }

  /* ===== Tabelas ===== */
  function initTabelas(){
    if(!document.querySelector('#tabelasContainer .doc-row')){
      const href=document.getElementById('linkTabelas')?.href; if(href) loadTabelasFromRoute(href);
    }
    wireTabelaViewer();
  }
  async function loadTabelasFromRoute(href){
    try{
      const res=await fetch(href,{credentials:'same-origin'}); if(!res.ok) throw new Error(res.status);
      const html=await res.text(); const dom=new DOMParser().parseFromString(html,'text/html');
      const card=dom.querySelector('.doc-row'); if(!card) return;
      const cont=document.getElementById('tabelasContainer'); cont.innerHTML=''; cont.appendChild(document.importNode(card,true));
      wireTabelaViewer();
    }catch(e){ /* falhou: deixa como está */ }
  }
  function wireTabelaViewer(){
    const modalEl=document.getElementById('modalTabela'); const modal=new bootstrap.Modal(modalEl);
    const lbl=document.getElementById('modalTabelaLabel'); const frame=document.getElementById('modalFrame');
    const baixar=document.getElementById('modalBaixar'); const novaAba=document.getElementById('modalAbrirNovaAba');

    document.getElementById('tabelasContainer')?.addEventListener('click', (ev)=>{
      const card=ev.target.closest('.doc-row'); if(!card) return;
      if(ev.target.closest('a[data-direct-download],button[data-direct-download]')) return;
      const viewUrl=card.dataset.view||'#'; const downUrl=card.dataset.download||viewUrl; const title=card.dataset.titleFull||'';
      lbl.textContent=title; baixar.href=downUrl; novaAba.href=viewUrl; frame.src=viewUrl; modal.show();
    });
    modalEl.addEventListener('hidden.bs.modal',()=>{ frame.src=''; });
  }

  /* ===== Helpers para avaliação ===== */
function setAvalInputsEnabled(enabled){
  const boxAval = document.getElementById('boxAval');
  if(!boxAval) return;
  // Não mexe em "name" (para não quebrar). Apenas alterna "disabled".
  boxAval.querySelectorAll('input[name^="av_"], textarea[name="av_comentario"]').forEach(el=>{
    el.disabled = !enabled;
  });
}

/* ===== Fluxo do Modal de Avaliação (Lançar) ===== */
function wireAvaliacaoFlow(){
  const form = document.getElementById('formLancamento');
  if(!form) return;

  const modalEl = document.getElementById('modalAvaliar');
  const modal = new bootstrap.Modal(modalEl);
  const btnAvaliarAgora = document.getElementById('btnAvaliarAgora');
  const btnPularAval = document.getElementById('btnPularAval');
  const chkAvaliar = document.getElementById('chkAvaliar');
  const inputAvaliar = document.getElementById('inputAvaliar');
  const boxAval = document.getElementById('boxAval');

  // ===== NOVO: lock de submissão para não duplicar =====
  let isSubmitting = false;
  const submitBtn = form.querySelector('button.btn-royal[type="submit"]');

  function setSubmitting(on){
    isSubmitting = !!on;
    if(submitBtn){
      submitBtn.disabled = on;
      if(submitBtn.dataset.origText == null) submitBtn.dataset.origText = submitBtn.innerHTML;
      submitBtn.innerHTML = on
        ? '<span class="spinner-border spinner-border-sm me-1"></span> Lançando…'
        : submitBtn.dataset.origText;
    }
    // evita cliques em qualquer campo enquanto envia
    form.style.pointerEvents = on ? 'none' : '';
    form.classList.toggle('opacity-75', on);
  }

  function ensureRequestId(){
    // cria um request_id único para o backend deduplicar
    let inp = form.querySelector('input[name="request_id"]');
    if(!inp){
      inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = 'request_id';
      form.appendChild(inp);
    }
    // Sempre renova ao tentar enviar (dá pra manter o mesmo se preferir)
    inp.value = Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,10);
  }

  function scrollIntoViewSmooth(el){
    try{ el?.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
  }

  // Inicialmente: avaliação desabilitada (não envia nada)
  setAvalInputsEnabled(false);

  // Marcar/Desmarcar "avaliar agora"
  chkAvaliar?.addEventListener('change', ()=>{
    const on = chkAvaliar.checked;
    inputAvaliar.value = on ? '1':'0';
    if(boxAval) boxAval.style.display = on ? 'block':'none';
    setAvalInputsEnabled(on);
    if(on){ autoGeral(); }
  });

  // Intercepta submit pra perguntar se quer avaliar (quando ainda não marcou)
  form.addEventListener('submit', function(ev){
    if(isSubmitting){ ev.preventDefault(); return; } // já está enviando
    if(!form.checkValidity()){
      form.reportValidity?.();
      return;
    }

    const avaliando = chkAvaliar.checked || inputAvaliar.value === '1' || (boxAval && boxAval.style.display === 'block');

    if(avaliando){
      // Vai enviar com avaliação
      setAvalInputsEnabled(true);
      autoGeral();          // garante que a média esteja setada
      ensureRequestId();    // idempotência
      setSubmitting(true);  // trava UI
      // deixa o submit continuar
      return;
    }

    // Não avaliando → abre modal de confirmação
    ev.preventDefault();
    modal.show();
  });

  // Clicou "Avaliar agora"
  btnAvaliarAgora?.addEventListener('click', ()=>{
    chkAvaliar.checked = true;
    inputAvaliar.value = '1';
    if(boxAval) boxAval.style.display = 'block';
    setAvalInputsEnabled(true);
    modal.hide();
    setTimeout(()=>{
      scrollIntoViewSmooth(boxAval);
      boxAval.querySelector('.rating-group .star')?.focus?.();
    }, 150);
  });

  // Clicou "Pular e lançar" (sem avaliação)
  btnPularAval?.addEventListener('click', ()=>{
    chkAvaliar.checked = false;
    inputAvaliar.value = '0';
    if(boxAval) boxAval.style.display = 'none';
    setAvalInputsEnabled(false); // garante que nada de av_ vai no POST
    modal.hide();
    setTimeout(()=>{
      if(isSubmitting) return;
      ensureRequestId();
      setSubmitting(true);
      form.submit();
    }, 80);
  });

  // Se voltar de bfcache, destrava o botão
  window.addEventListener('pageshow', (e)=>{
    if(e.persisted) setSubmitting(false);
  });
}

/* ===== Avaliar/Editar na página de Lançamentos (sem sair) ===== */
function paintStaticStars(el){
  const score = Number(el?.dataset?.score||0);
  if(!el) return;
  el.textContent = '★★★★★'.slice(0, Math.max(0, Math.min(5, score))).padEnd(5, '☆');
}
function wireAvalLanc(){
  const tbody = document.getElementById('tbodyLanc');
  const modalEl = document.getElementById('modalAvalLanc'); // opcional
  if(!tbody || !modalEl) return;

  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('formAvalLanc');
  const info = document.getElementById('avLancInfo');
  const inputLancId = document.getElementById('avLancId');

  function initStarsInModal(){
    modalEl.querySelectorAll('.rating-group').forEach(g=>{
      if(g.dataset.name!=='av_geral') wireStars(g);
    });
    autoGeral();
  }

  tbody.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('[data-open-av]');
    if(!btn) return;
    const tr = btn.closest('tr');
    const lancId = tr.dataset.id;
    const getUrl = tr.dataset.getavurl;
    inputLancId.value = lancId;
    info.textContent = `${tr.cells[0].textContent.trim()} • ${tr.dataset.coopnome}`;

    modalEl.querySelectorAll('input[name^="av_"]').forEach(i=>i.value='');
    modalEl.querySelector('textarea[name="av_comentario"]').value='';

    try{
      const r = await fetch(getUrl, {credentials:'same-origin'});
      if(r.ok){
        const j = await r.json();
        if(j.ok && j.data){
          const d = j.data;
          const map = {
            'av_pontualidade': d.pontualidade,
            'av_educacao': d.educacao,
            'av_eficiencia': d.eficiencia,
            'av_apresentacao': d.apresentacao,
            'av_geral': d.geral
          };
          Object.entries(map).forEach(([k,v])=>{
            const inp = modalEl.querySelector(`input[name="${k}"]`);
            if(inp){ inp.value = v || ''; }
          });
          const ta = modalEl.querySelector('textarea[name="av_comentario"]');
          if(ta) ta.value = d.comentario || '';
        }
      }
    }catch(e){/* silencioso */ }

    initStarsInModal();
    modal.show();
  });

  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const lancId = inputLancId.value;
    const tr = tbody.querySelector(`tr[data-id="${CSS.escape(lancId)}"]`);
    if(!tr) return;
    const postUrl = tr.dataset.avurl;

    const fd = new FormData(form);
    autoGeral();

    try{
      const r = await fetch(postUrl, {method:'POST', body:fd, credentials:'same-origin'});
      if(!r.ok) throw new Error(r.status);
      const j = await r.json();
      if(j.ok){
        const cell = tr.querySelector('[data-avcell]');
        if(cell){
          cell.innerHTML = `<span class="stars-static" data-score="${j.geral||0}">★★★★★</span>
                            <button class="btn btn-outline-royal btn-sm ms-1" data-open-av>Editar</button>`;
          paintStaticStars(cell.querySelector('.stars-static'));
        }
        modal.hide();
      }else{
        alert(j.error || 'Falha ao salvar avaliação.');
      }
    }catch(e){
      alert('Erro de rede ao salvar avaliação.');
    }
  });

  document.querySelectorAll('.stars-static').forEach(paintStaticStars);
}

/* ===== Eventos do menu ===== */
document.getElementById('sideNav')?.addEventListener('click', async (e)=>{
  const a=e.target.closest('a'); if(!a) return;
  const t=a.getAttribute('data-target'); if(!t) return; // logout segue normal
  e.preventDefault();
  document.querySelectorAll('#sideNav a').forEach(x=>x.classList.remove('active')); a.classList.add('active');
  showSection(t); pushView(t);
  if(t==='avisos' || t==='tabelas'){ prefetch(a.href); }
});

document.getElementById('toastVerAgora')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  const href=e.currentTarget.getAttribute('href');
  showSection('avisos'); pushView('avisos');
  await loadAvisosFromRoute(href);
});

/* ===== Inicialização ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const initial=startView(); showSection(initial);
  const unread=Number(document.getElementById('toastCount')?.textContent||'0'); setAvisosBadge(unread);
});
window.addEventListener('popstate',(ev)=>{ const v=(ev.state&&ev.state.view)||startView(); showSection(v); });
</script>
</body>
</html>

