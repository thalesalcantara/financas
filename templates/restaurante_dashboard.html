<!DOCTYPE html>
<html lang="pt-br" data-theme="">
<head>
  <meta charset="UTF-8">
  <title>Portal do Estabelecimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --royal:#2141d9; --royal-2:#3654e6; --royal-3:#eaf0ff;
      --ink:#0b1220; --muted:#6b7280; --soft:#f5f7ff; --danger:#e74c3c; --ok:#16a34a;
      --border:#e6e9f2; --chip:#eef1ff; --bg:#ffffff; --card:#ffffff; --shadow:0 1px 0 #0000000a;
      --badge-danger:#dc3545; --badge-text:#fff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --ink:#e6e6e6; --muted:#a6adc8; --soft:#0f172a; --border:#243045; --chip:#111b33;
        --royal-3:#0f1933; --card:#0e1424; --shadow:0 1px 0 #00000022;
      }
    }
    /* tema forçado por toggle */
    [data-theme="dark"]{
      --bg:#0b1220; --ink:#e6e6e6; --muted:#a6adc8; --soft:#0f172a; --border:#243045; --chip:#111b33;
      --royal-3:#0f1933; --card:#0e1424; --shadow:0 1px 0 #00000022;
    }
    [data-theme="light"]{
      --bg:#ffffff; --ink:#0b1220; --muted:#6b7280; --soft:#f5f7ff; --border:#e6e9f2; --chip:#eef1ff;
      --royal-3:#eaf0ff; --card:#ffffff; --shadow:0 1px 0 #0000000a;
    }

    html,body{ height:100%; }
    body{ background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    a{ text-decoration:none; }
    .shell{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    .aside{
      background:linear-gradient(180deg, var(--royal) 0%, var(--royal-2) 100%);
      color:#fff; padding:18px 16px; position:sticky; top:0; height:100dvh;
    }
    .brand{ font-weight:800; letter-spacing:.5px; font-size:1.15rem; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.10); display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .navmenu{ margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .navmenu a{ color:#fff; padding:10px 12px; border-radius:10px; display:flex; align-items:center; gap:10px; font-weight:600; position:relative; }
    .navmenu a.active, .navmenu a:hover{ background:rgba(255,255,255,.14); }
    .navmenu .badge{ margin-left:auto; }
    .theme-btn{ background:transparent; border:0; color:#fff; font-size:1.1rem; display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .content{ padding:24px clamp(14px,3vw,32px); }
    .section-title{ color:var(--royal); font-weight:800; font-size:1.25rem; display:flex; gap:10px; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); }
    .card-soft{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .chip{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:.2rem .65rem; font-weight:700; color:var(--ink); }
    .table{ color:var(--ink); }
    .table thead{ background:color-mix(in oklab, var(--royal-3) 60%, transparent); }
    .table-compact th,.table-compact td{ padding:.5rem .6rem; }
    .btn-royal{ background:var(--royal); color:#fff; border:none; }
    .btn-royal:hover{ background:var(--royal-2); color:#fff; }
    .btn-outline-royal{ border:1px solid var(--royal); color:var(--royal); }
    .btn-outline-royal:hover{ background:var(--royal); color:#fff; }
    .btn-outline-danger{ color:#e74c3c; border-color:#e74c3c; }
    .btn-outline-danger:hover{ background:#e74c3c; color:#fff; }
    .cooperado-avatar{ width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 0 #0001; }
    .cooperado-item{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer; }
    .cooperado-item:hover{ background:rgba(33,65,217,.06); }
    .cooperado-item.selected{ outline:2px solid var(--royal); background:color-mix(in oklab, var(--royal-3) 60%, transparent); }
    .selected-header .big{ width:180px; height:180px; border-radius:50%; object-fit:cover; border:6px solid var(--royal); box-shadow:0 6px 16px #0003; }
    .rating-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .rating-label{ width:160px; font-weight:700; color:var(--ink); }
    .stars{ display:inline-flex; gap:3px; font-size:1.4rem; cursor:pointer; }
    .star{ color:#cbd5e1; transition:transform .06s; }
    .star.active,.star.hover{ color:#fbbf24; }
    .star:active{ transform:scale(.9); }
    .sticky-tools{ position:sticky; top:12px; }
    .kpi{ background:color-mix(in oklab, var(--royal-3) 55%, transparent); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .kpi .v{ font-weight:800; font-size:1.05rem; }

    /* ===== SPA (mostrar/ocultar abas) ===== */
    section[data-view]{ display:none; }
    section[data-view].is-active{ display:block; }

    /* Toast persistente */
    #toastAvisos[data-persistent="1"]{ opacity:1 !important; }

    /* bolinha de aviso sempre visível no item "Avisos" (e espelhável em outras abas, via JS) */
    .notif-dot{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      min-width:18px; height:18px; border-radius:9px;
      background:var(--badge-danger); color:var(--badge-text); font-weight:700; font-size:.70rem;
      display:flex; align-items:center; justify-content:center; padding:0 6px;
      box-shadow:0 0 0 2px rgba(255,255,255,.35);
    }

    @media (max-width: 920px){
      .shell{ grid-template-columns: 66px 1fr; }
      .brand span{ display:none; }
      .navmenu a span{ display:none; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ============ Aside ============ -->
    <aside class="aside">
      <div class="brand">
        <span><i class="bi bi-building"></i> <strong>Portal do Estabelecimento</strong></span>
        <button id="themeToggle" class="theme-btn" title="Alternar tema"><i class="bi bi-moon-stars"></i></button>
      </div>
      <nav class="navmenu">
        <!-- NENHUM LINK ALTERADO -->
        <a class="{{ 'active' if (view|default('lancar') not in ['escalas','config','avisos','lancamentos']) else '' }}"
           href="{{ url_for('portal_restaurante', view='lancar', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None) }}">
          <i class="bi bi-person-lines-fill"></i><span>Cooperados</span>
        </a>

        <a class="{{ 'active' if view=='lancamentos' else '' }}"
           href="{{ url_for('portal_restaurante', view='lancamentos', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None, mes=filtro_mes if filtro_mes else None) }}">
          <i class="bi bi-receipt"></i><span>Lançamentos</span>
        </a>

        <a class="{{ 'active' if view=='escalas' else '' }}" href="{{ url_for('portal_restaurante', view='escalas') }}">
          <i class="bi bi-calendar-week"></i><span>Escala</span>
        </a>

        {% if session.get('user_tipo') == 'restaurante' %}
        <a class="{{ 'active' if request.endpoint=='rest_tabelas' else '' }}" href="{{ url_for('rest_tabelas') }}">
          <i class="bi bi-table"></i><span>Tabelas</span>
        </a>
        {% endif %}

        <a class="{{ 'active' if view=='config' else '' }}" href="{{ url_for('portal_restaurante', view='config') }}">
          <i class="bi bi-gear"></i><span>Configuração</span>
        </a>

        <a id="linkAvisos" class="{{ 'active' if request.endpoint=='portal_restaurante_avisos' or view=='avisos' else '' }}"
           href="{{ url_for('portal_restaurante_avisos') }}">
          <i class="bi bi-megaphone"></i><span>Avisos</span>
          {% set _cntAvisos = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
          {% if _cntAvisos > 0 %}<span class="badge text-bg-danger">{{ _cntAvisos }}</span>{% endif %}
        </a>

        <a href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
      </nav>
    </aside>

    <!-- ============ Main ============ -->
    <main class="content">

      {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
          <div class="mb-3">
            {% for cat, msg in msgs %}
              <div class="alert alert-{{ 'danger' if cat=='error' else cat }} py-2 px-3 mb-2">{{ msg|safe }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- =================== CONFIG =================== -->
      <section data-view="config">
        <div class="section-title"><i class="bi bi-shield-lock"></i> Configuração</div>
        <div class="card card-body">
          <form class="row g-3 form-password" method="POST" action="{{ url_for('rest_alterar_senha') }}">
            <div class="col-md-4">
              <label class="form-label">Senha atual</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_atual" required>
                <button class="btn btn-outline-secondary" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_nova" minlength="6" required>
                <button class="btn btn-outline-secondary" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
              <div class="form-text">Mínimo de 6 caracteres.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Confirmar nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_conf" minlength="6" required>
                <button class="btn btn-outline-secondary" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-12 text-end"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
          </form>
        </div>
      </section>

      <!-- =================== ESCALAS =================== -->
      <section data-view="escalas">
        <div class="section-title"><i class="bi bi-calendar-week"></i> Escala semanal</div>

        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
            <input type="hidden" name="view" value="escalas">
            <div class="col-md-3">
              <label class="form-label">Ver</label>
              <select name="modo" class="form-select">
                <option value="semana" {{ 'selected' if (modo=='semana') }}>Semana completa</option>
                <option value="dia" {{ 'selected' if (modo=='dia') }}>Somente 1 dia</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Referência</label>
              <input type="date" name="ref" class="form-control" value="{{ ref_data.strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='escalas') }}"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
            </div>
          </form>

          {% if modo == 'semana' %}
            <hr class="my-3">
            <div class="row g-3">
              {% for dia in dias_list %}
              <div class="col-md-6 col-lg-4">
                <div class="card-soft">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge text-bg-primary fw-semibold">{{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][dia.weekday()] }} — {{ dia.strftime('%d/%m/%Y') }}</span>
                    <i class="bi bi-people"></i>
                  </div>
                  <div style="max-height:360px; overflow:auto; border-top:1px dashed var(--border);">
                    {% set lista = agenda.get(dia, []) %}
                    {% if lista %}
                      {% for grupo in (lista | groupby('contrato')) %}
                        {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                        <div class="fw-bold mt-2">{{ contrato_nome }}</div>
                        {% for item in grupo.list %}
                          <div class="py-2 border-bottom">
                            <div class="fw-bold">
                              {{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}
                            </div>
                            <div class="text-muted small">{{ item.turno or '—' }}{% if item.horario %} • {{ item.horario }}{% endif %}</div>
                          </div>
                        {% endfor %}
                      {% endfor %}
                    {% else %}
                      <div class="text-muted small py-2">Sem escala registrada.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <hr class="my-3">
            <div class="card-soft">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge text-bg-primary fw-semibold">{{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][ref_data.weekday()] }} — {{ ref_data.strftime('%d/%m/%Y') }}</span>
                <i class="bi bi-calendar-day"></i>
              </div>
              <table class="table table-bordered table-hover align-middle table-compact">
                <thead><tr><th>Contrato</th><th>Cooperado</th><th>Turno</th><th>Horário</th></tr></thead>
                <tbody>
                  {% set lista = agenda.get(ref_data, []) %}
                  {% if lista %}
                    {% for grupo in (lista | groupby('contrato')) %}
                      {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                      {% for item in grupo.list %}
                      <tr>
                        <td>{{ contrato_nome }}</td>
                        <td>{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</td>
                        <td>{{ item.turno or '—' }}</td>
                        <td>{{ item.horario or '—' }}</td>
                      </tr>
                      {% endfor %}
                    {% endfor %}
                  {% else %}
                  <tr><td colspan="4" class="text-center text-muted">Sem escala registrada.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </section>

      <!-- =================== AVISOS =================== -->
      <section data-view="avisos">
        {% set _avisos = avisos if avisos is defined and avisos is not none else [] %}
        {% set _unread_from_list = (_avisos | selectattr('lido','equalto',False) | list | length) %}
        {% set _unread_from_ctx = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
        <div class="section-title">
          <i class="bi bi-megaphone-fill"></i> Avisos
          {% set _badgeN = (_unread_from_list if _unread_from_list>0 else _unread_from_ctx) %}
          <span id="badgeTitulo" class="badge {{ 'text-bg-danger' if _badgeN>0 else 'text-bg-success' }} ms-2">
            {{ _badgeN>0 and (_badgeN ~ ' não lido(s)') or 'Tudo lido' }}
          </span>
        </div>

        <div class="card card-body">
          <div class="d-flex align-items-center gap-2">
            <form method="POST" action="{{ url_for('marcar_todos_avisos_lidos_restaurante') }}" class="m-0">
              <button class="btn btn-royal" type="submit" {% if _badgeN == 0 %}disabled{% endif %}>
                <i class="bi bi-check2-circle me-1"></i> Marcar todos como lidos
              </button>
            </form>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="toggleNaoLidos">
              <label class="form-check-label" for="toggleNaoLidos">Mostrar apenas não lidos</label>
            </div>
          </div>
        </div>

        {% if _unread_from_ctx > 0 and (_avisos | length) == 0 %}
          <div class="alert alert-warning mt-3">
            Existem {{ _unread_from_ctx }} aviso(s) não lido(s), porém nenhum item foi carregado nesta página.
            Verifique se a rota está preenchendo a variável <code>avisos</code> para este restaurante.
          </div>
        {% endif %}

        {% if _avisos and (_avisos | length) > 0 %}
          {% for a in _avisos %}
          <div id="aviso-{{ a.id }}" class="card card-body my-2 aviso-card {% if a.lido %}lido{% endif %} {% if a.prioridade_alta %}prioridade{% endif %}" data-lido="{{ '1' if a.lido else '0' }}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">
                  {{ a.titulo or 'Aviso' }}
                  {% if a.prioridade_alta %}<span class="badge text-bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill"></i> Prioridade</span>{% endif %}
                </div>
                <div class="text-muted small">
                  Publicado em {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em }}
                  {% if a.lido %} • <span class="text-success">Lido</span>{% else %} • <span class="text-danger">Não lido</span>{% endif %}
                </div>
              </div>
              <div class="ms-3">
                {% if not a.lido %}
                <button class="btn btn-outline-royal btn-sm"
                        data-acao="marcar-lido"
                        data-id="{{ a.id }}"
                        data-url="{{ url_for('marcar_aviso_lido_universal', aviso_id=a.id) }}">
                  <i class="bi bi-check2"></i> Marcar como lido
                </button>
                {% endif %}
              </div>
            </div>
            <hr class="my-2">
            <div class="aviso-body">{{ a.corpo_html | safe if a.corpo_html else (a.conteudo or a.texto or '') }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="card card-body"><div class="text-muted"><i class="bi bi-inbox me-1"></i> Nenhum aviso disponível.</div></div>
        {% endif %}
      </section>

      <!-- =================== LANCAMENTOS (LISTA) =================== -->
      <section data-view="lancamentos">
        <div class="section-title"><i class="bi bi-receipt"></i> Lançamentos</div>

        <div class="row g-3">
          <!-- FORM FILTRO (envia datas/mês para o BACK) -->
          <div class="col-lg-3">
            <div class="card card-body sticky-tools">
              <form id="formFiltroLanc"
                    method="GET"
                    action="{{ url_for('portal_restaurante') }}"
                    class="row g-2 align-items-end">
                <input type="hidden" name="view" value="lancamentos">

                <div class="col-12">
                  <label class="form-label">Início</label>
                  <input type="date" class="form-control"
                         name="data_inicio"
                         value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
                </div>

                <div class="col-12">
                  <label class="form-label">Fim</label>
                  <input type="date" class="form-control"
                         name="data_fim"
                         value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
                </div>

                <div class="col-12">
                  <label class="form-label">Mês (opcional)</label>
                  <input type="month" class="form-control"
                         name="mes"
                         value="{{ filtro_mes or '' }}"
                         oninput="if(this.value){ const f=this.form; f.data_inicio.value=''; f.data_fim.value=''; }">
                  <div class="form-text">Se escolher um mês, as datas serão ignoradas.</div>
                </div>

                <!-- filtro visual (não vai ao back) -->
                <div class="col-12">
                  <label class="form-label">Digite o nome do cooperado (visual)</label>
                  <input type="text" class="form-control" name="q" placeholder="Filtrar por nome...">
                </div>

                <div class="col-12 d-grid">
                  <button class="btn btn-royal" type="submit">
                    <i class="bi bi-funnel"></i> Aplicar
                  </button>
                </div>

                <div class="col-12 d-grid">
                  <a class="btn btn-outline-secondary"
                     href="{{ url_for('portal_restaurante', view='lancamentos') }}">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpar
                  </a>
                </div>

                <hr class="my-2">
                <div class="kpi mb-2"><div class="small text-muted">Total no período</div><div class="v">R$ <span id="kpiTotalValor">0,00</span></div></div>
                <div class="kpi mb-2"><div class="small text-muted">Entregas no período</div><div class="v"><span id="kpiTotalEntregas">0</span></div></div>

                <!-- Exporta TUDO + linha Totais alinhada -->
                <div class="d-grid"><button class="btn btn-outline-royal" type="button" id="btnExportCsv"><i class="bi bi-download"></i> Exportar CSV</button></div>
              </form>
            </div>
          </div>

          <div class="col-lg-9">
            <div class="card card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="chip">
                  Período: <span id="txtPeriodo">
                    {{ filtro_inicio and filtro_inicio.strftime('%d/%m/%Y') or '' }}
                    {% if filtro_inicio and filtro_fim %} a {% endif %}
                    {{ filtro_fim and filtro_fim.strftime('%d/%m/%Y') or '' }}
                  </span>
                </div>
                <div class="small text-muted"></div>
              </div>

              <table class="table table-bordered table-hover align-middle table-compact" id="tblLanc">
                <thead>
                  <tr>
                    <th class="text-center" style="width:110px;">Data</th>
                    <th>Cooperado</th>
                    <th>Contrato</th>
                    <th class="text-center" style="width:160px;">Horário</th>
                    <th class="text-center" style="width:120px;">Entregas</th>
                    <th class="text-end" style="width:140px;">Valor (R$)</th>
                  </tr>
                </thead>
                <tbody id="tbodyLanc">
                  {% for x in lancamentos_periodo or [] %}
                  <tr data-coop="{{ x.cooperado_id or x.coop_id }}"
                      data-coopnome="{{ x.cooperado_nome or x.coop_nome }}"
                      data-contrato="{{ x.contrato_nome or x.contrato }}">
                    <td class="text-center">{{ (x.data.strftime('%d/%m/%Y') if x.data) if x.data is not string else x.data }}</td>
                    <td class="fw-semibold coop-name">{{ x.cooperado_nome or x.coop_nome }}</td>
                    <td>{{ x.contrato_nome or x.contrato or '—' }}</td>
                    <td class="text-center">
                      {% if x.hora_inicio or x.hora_fim %}
                        {{ x.hora_inicio or '' }}{% if x.hora_inicio or x.hora_fim %} às {% endif %}{{ x.hora_fim or '' }}
                      {% else %}—{% endif %}
                    </td>
                    <td class="text-center">{{ x.qtd_entregas if x.qtd_entregas is not none else '-' }}</td>
                    <!-- data-valor = número puro para soma -->
                    <td class="text-end valor" data-valor="{{ '%.2f'|format(x.valor or 0) }}">R$ {{ '%.2f'|format(x.valor or 0) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="table-secondary">
                    <th colspan="4" class="text-end">Totais</th>
                    <th class="text-center" id="ftEntregas">0</th>
                    <th class="text-end" id="ftValor">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>

              <hr class="my-3">
              <h6 class="mb-2"><i class="bi bi-people"></i> Totais por cooperado</h6>
              <div id="gridCoop" class="row g-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- =================== LANÇAR =================== -->
      <section data-view="lancar">
        <div class="section-title"><i class="bi bi-plus-circle"></i> Lançar Produção Diária</div>

        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
            <input type="hidden" name="view" value="lancar">
            <div class="col-md-3">
              <label class="form-label">Início</label>
              <input type="date" name="data_inicio" class="form-control" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fim</label>
              <input type="date" name="data_fim" class="form-control" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
            </div>
            <div class="col-md-3">
              <div class="small text-muted mb-1">Período em uso</div>
              <div class="chip">
                {% if filtro_inicio and filtro_fim %}
                  {{ filtro_inicio.strftime('%d/%m/%Y') }} a {{ filtro_fim.strftime('%d/%m/%Y') }}
                {% else %} — {% endif %}
              </div>
            </div>
            <div class="col-md-3 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='lancar') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
            </div>
          </form>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-4">
            <div class="card card-body">
              <div class="input-group mb-2">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="buscaCoop" type="text" class="form-control" placeholder="Buscar cooperado..." list="cooperadosList">
                <datalist id="cooperadosList">{% for coop in cooperados %}<option value="{{ coop.nome }}"></option>{% endfor %}</datalist>
                <select id="selectCoop" class="form-select"><option value="">Lista...</option>{% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}</select>
              </div>
              <div id="listaCooperados" style="max-height:60vh; overflow:auto;">
                {% for coop in cooperados %}
                <div class="cooperado-item" data-id="{{ coop.id }}" data-nome="{{ coop.nome }}"
                     data-foto="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
                     data-total="{{ '%.2f'|format(coop.total_periodo or 0) }}">
                  <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}" class="cooperado-avatar" alt="">
                  <div class="d-flex flex-column">
                    <span class="fw-bold">{{ coop.nome }}</span>
                    <small class="text-muted">No período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</small>
                  </div>
                </div>
                {% else %}<div class="text-muted small">Nenhum cooperado encontrado.</div>{% endfor %}
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card card-body" id="blocoLancamento">
              <div class="selected-header text-center mb-2" id="selectedHeader" style="display:none;">
                <img id="selFoto" src="" class="big" alt="">
                <div class="fw-bold fs-5 mt-2" id="selNome"></div>
                <div class="text-muted">Total no período: R$ <span id="selTotal">0,00</span></div>
              </div>

              <div class="alert alert-info py-2 px-3 mb-2" id="hintSelecione">
                Selecione um cooperado para lançar.
              </div>

              <!-- FORM -->
              <form id="formLancamento" method="POST" action="{{ url_lancar_producao }}" class="row g-2 align-items-end mb-1" style="display:none;">
                <input type="hidden" name="cooperado_id" id="inputCooperadoId" value="">
                <div class="col-md-3"><label class="form-label">Valor (R$)</label><input type="number" class="form-control" name="valor" step="0.01" required></div>
                <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" name="data" required></div>
                <div class="col-md-3"><label class="form-label">Hora Início</label><input type="time" class="form-control" name="hora_inicio"></div>
                <div class="col-md-3"><label class="form-label">Hora Fim</label><input type="time" class="form-control" name="hora_fim"></div>
                <div class="col-md-3"><label class="form-label">Entregas</label><input type="number" class="form-control" name="qtd_entregas" min="0" step="1"></div>

                <div class="col-12"><hr class="my-2"></div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkAvaliar"
                      onclick="document.getElementById('boxAval').style.display=this.checked?'block':'none'; document.getElementById('inputAvaliar').value=this.checked?'1':'0';">
                    <label class="form-check-label" for="chkAvaliar">Registrar avaliação agora</label>
                  </div>
                  <input type="hidden" name="avaliar" id="inputAvaliar" value="0">
                </div>

                <div id="boxAval" class="row g-2" style="display:none;">
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_geral" data-auto="true">
                      <div class="rating-label">Geral (auto)</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i>
                        <i class="bi bi-star-fill star" data-v="2"></i>
                        <i class="bi bi-star-fill star" data-v="3"></i>
                        <i class="bi bi-star-fill star" data-v="4"></i>
                        <i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_geral" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_pontualidade">
                      <div class="rating-label">Pontualidade</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_pontualidade" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_educacao">
                      <div class="rating-label">Educação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_educacao" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_eficiencia">
                      <div class="rating-label">Eficiência / Cuidado</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_eficiencia" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_apresentacao">
                      <div class="rating-label">Apresentação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_apresentacao" value="">
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Comentário (opcional)</label>
                    <textarea class="form-control" name="av_comentario" rows="2" placeholder="Conte rapidamente como foi a experiência..."></textarea>
                  </div>
                </div>

                <div class="col-12 text-end mt-2"><button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button></div>
              </form>
              <!-- /FORM -->
            </div>

            <div id="blocoTabelas" class="mt-2">
              {% for coop in cooperados %}
              <div id="tabela-{{ coop.id }}" class="card card-body lancamentos-table" style="display:none;">
                <table class="table table-bordered table-hover align-middle table-compact">
                  <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th>Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
                  <tbody>
                    {% for lanc in coop.lancamentos %}
                    <tr>
                      <td>R$ {{ '%.2f'|format(lanc.valor or 0) }}</td>
                      <td>{{ lanc.data.strftime('%d/%m/%Y') if lanc.data }}</td>
                      <td>{{ lanc.hora_inicio or '' }}{% if lanc.hora_inicio or lanc.hora_fim %} às {% endif %}{{ lanc.hora_fim or '' }}</td>
                      <td>{{ lanc.qtd_entregas if lanc.qtd_entregas is not none else '-' }}</td>
                      <td>
                        {% if has_editar_lanc %}
                          <a href="{{ url_for('editar_lancamento', id=lanc.id) }}" class="btn btn-outline-royal btn-sm"><i class="bi bi-pencil"></i></a>
                        {% endif %}
                      </td>
                      <td><a href="{{ url_for('excluir_lancamento', id=lanc.id) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a></td>
                    </tr>
                    {% else %}<tr><td colspan="6" class="text-center text-muted">Nenhum lançamento no período selecionado</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- TOAST novos avisos (persistente até ler) -->
  {% set _avisos_for_toast = avisos if avisos is defined and avisos is not none else [] %}
  {% set _unread_from_list_t = (_avisos_for_toast | selectattr('lido','equalto',False) | list | length) %}
  {% set _unread_from_ctx_t = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
  {% set _toast_unread = _unread_from_list_t if _unread_from_list_t>0 else _unread_from_ctx_t %}
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055;">
    <div id="toastAvisos" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-autohide="false" data-bs-delay="8000" data-persistent="1">
      <div class="toast-header">
        <i class="bi bi-megaphone-fill me-2"></i><strong class="me-auto">Novos avisos</strong><small>agora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
      <div class="toast-body">
        Você tem <b><span id="toastUnreadCount">{{ _toast_unread }}</span></b> aviso(s) não lido(s).
        <a id="toastVerAgora" href="{{ url_for('portal_restaurante_avisos') }}" class="link-primary fw-semibold">Ver agora</a>
      </div>
    </div>
  </div>

  <!-- TOAST OK -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1056;">
    <div id="toastOK" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="2200">
      <div class="toast-header">
        <i class="bi bi-check2-circle text-success me-2"></i><strong class="me-auto">Pronto</strong><small>agora</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
      <div class="toast-body">Aviso marcado como lido.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== Tema (modo escuro/claro) ===== */
    (function themeBoot(){
      const stored = localStorage.getItem('portal-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', stored || (prefersDark ? 'dark' : ''));
      const btn = document.getElementById('themeToggle');
      function syncIcon(){
        const isDark = document.documentElement.getAttribute('data-theme')==='dark';
        btn.innerHTML = isDark ? '<i class="bi bi-brightness-high"></i>' : '<i class="bi bi-moon-stars"></i>';
      }
      btn?.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur==='dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('portal-theme', next);
        syncIcon();
      });
      syncIcon();
    })();

    function togglePwd(btn){
      const i = btn.previousElementSibling; if(!i) return;
      i.type = i.type==='password'?'text':'password';
      btn.querySelector('i').classList.toggle('bi-eye');
      btn.querySelector('i').classList.toggle('bi-eye-slash');
    }

    const brMoney = (n)=> (n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const parseBRDate = (s)=>{ if(!s) return null; if(String(s).includes('/')){ const [d,m,y]=s.split('/'); return new Date(+y, +m-1, +d); } const [y,m,d]=String(s).split('-'); return new Date(+y, +m-1, +d); };

    // ====== Preservar rolagem por ABA (view) ======
    const scrollMem = {
      get(view){ try{ return Number(sessionStorage.getItem('scroll-'+view)||0); }catch{ return 0; } },
      set(view,y){ try{ sessionStorage.setItem('scroll-'+view, String(y||0)); }catch{} }
    };

    // ===== Estrelas =====
    function wireStars(ctx=document){
      ctx.querySelectorAll('.rating-group').forEach(group=>{
        const hidden = group.querySelector('input[type="hidden"]');
        const stars  = group.querySelectorAll('.star');
        function paint(v, hover=false){
          stars.forEach(s=>{
            const on = Number(s.dataset.v) <= v;
            s.classList.toggle('active', on);
            s.classList.toggle('hover', hover && on);
          });
        }
        stars.forEach(s=>{
          s.addEventListener('mouseenter',()=>paint(Number(s.dataset.v), true));
          s.addEventListener('mouseleave',()=>paint(Number(hidden.value||0), false));
          s.addEventListener('click',()=>{ hidden.value = Number(s.dataset.v); paint(Number(hidden.value||0), false); group.dataset.userSet='1'; autoGeral(ctx); });
        });
        paint(Number(hidden.value||0), false);
      });
    }
    function autoGeral(ctx=document){
      const g = ctx.querySelector('.rating-group[data-name="av_geral"]');
      if(!g) return;
      const geralHidden = g.querySelector('input[type="hidden"]');
      const userSet = g.dataset.userSet === '1';
      if (userSet) return;
      const nomes = ['av_pontualidade','av_educacao','av_eficiencia','av_apresentacao'];
      const vals = [];
      nomes.forEach(n=>{
        const grp = ctx.querySelector(`.rating-group[data-name="${n}"]`);
        const v = Number(grp?.querySelector('input[type="hidden"]')?.value||0);
        if (v>0) vals.push(v);
      });
      if (vals.length){
        const media = Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
        geralHidden.value = media;
        const stars = g.querySelectorAll('.star');
        stars.forEach(s=>{
          const on = Number(s.dataset.v) <= media;
          s.classList.toggle('active', on);
          s.classList.toggle('hover', false);
        });
      }
    }

    // ===== Inits por view =====
    function initLancar(ctx=document){
      const sec = ctx.querySelector('section[data-view="lancar"].is-active'); if(!sec) return;
      const busca = document.getElementById('buscaCoop');
      const select = document.getElementById('selectCoop');
      const itens = Array.from(document.querySelectorAll('.cooperado-item'));
      const form = document.getElementById('formLancamento');
      const hint = document.getElementById('hintSelecione');
      const header = document.getElementById('selectedHeader');
      const inputCoopId = document.getElementById('inputCooperadoId');
      const selFoto = document.getElementById('selFoto');
      const selNome = document.getElementById('selNome');
      const selTotal = document.getElementById('selTotal');

      function mostrarCooperado(el){
        if (!el) return;
        itens.forEach(i => i.classList.remove('selected')); el.classList.add('selected');
        inputCoopId.value = el.dataset.id;
        selFoto.src = el.dataset.foto; selNome.textContent = el.dataset.nome; selTotal.textContent = el.dataset.total;
        header.style.display = 'block'; form.style.display = 'flex'; hint.style.display = 'none';
        document.querySelectorAll('.lancamentos-table').forEach(t => t.style.display = 'none');
        const tabela = document.getElementById('tabela-' + el.dataset.id); if (tabela) tabela.style.display = 'block';
        wireStars(); autoGeral();
      }
      itens.forEach(el => el.addEventListener('click', () => mostrarCooperado(el)));
      busca?.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        itens.forEach(el => { el.style.display = (el.dataset.nome||'').toLowerCase().includes(q) ? '' : 'none'; });
      });
      select?.addEventListener('change', function(){ const el = itens.find(x=>x.dataset.id===this.value); if (el) mostrarCooperado(el); });
      const primeiro = itens[0]; if (primeiro) mostrarCooperado(primeiro);

      // modal de avaliação
      const boxAval = document.getElementById('boxAval');
      const inputAvaliar = document.getElementById('inputAvaliar');
      const chkAvaliar = document.getElementById('chkAvaliar');
      const modalAvalEl = document.getElementById('modalAval');
      const modalAval = modalAvalEl ? new bootstrap.Modal(modalAvalEl) : null;
      function algumCampoDeAvaliacaoPreenchido() {
        return ['av_geral','av_pontualidade','av_educacao','av_eficiencia','av_apresentacao','av_comentario']
          .some(n => { const el = form.querySelector(`[name="${n}"]`); return el && String(el.value||'').trim()!==''; });
      }
      if (form && modalAval) {
        let allowSubmit = false;
        form.addEventListener('submit', async function(e) {
          if (allowSubmit) return; // já confirmado
          const jaMarcouAvaliar = inputAvaliar?.value === '1';
          const temAlgoPreenchido = algumCampoDeAvaliacaoPreenchido();
          if (!jaMarcouAvaliar && !temAlgoPreenchido) { e.preventDefault(); modalAval.show(); return; }

          // ======= SUBMIT AJAX sem piscar =======
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn?.setAttribute('disabled','disabled');
          const formData = new FormData(form);
          try{
            const resp = await fetch(form.action, { method:'POST', body: formData });
            if (resp.redirected || resp.ok){
              // Recarrega somente a section atual via softLoad para atualizar listas sem perder rolagem
              await softLoad(new URL(window.location.href));
            } else {
              alert('Falha ao lançar ('+resp.status+').');
            }
          }catch(_){ alert('Falha de rede ao lançar.'); }
          finally{ submitBtn?.removeAttribute('disabled'); }
        });
      }

      document.addEventListener('click', (e)=>{ if (e.target.closest('.rating-group')) autoGeral(); });
    }

    function initAvisos(ctx=document){
      const sec = ctx.querySelector('section[data-view="avisos"].is-active'); if(!sec) return;
      const toastOKEl = document.getElementById('toastOK');
      const toastOK = toastOKEl ? new bootstrap.Toast(toastOKEl) : null;
      const badgeTitulo = document.getElementById('badgeTitulo');
      const badgeSidebar = document.querySelector('#linkAvisos .badge');
      function getUnreadCountLocal(){ return document.querySelectorAll('.aviso-card[data-lido="0"]').length; }
      function refreshBadgesLocal(){
        const n = getUnreadCountLocal();
        if (badgeTitulo){
          badgeTitulo.className = 'badge ' + (n > 0 ? 'text-bg-danger' : 'text-bg-success');
          badgeTitulo.textContent = n > 0 ? (n + ' não lido(s)') : 'Tudo lido';
        }
        if (badgeSidebar){ badgeSidebar.style.display = n>0 ? '' : 'none'; if (n>0) badgeSidebar.textContent = n; }
        setToastUnread(n);
      }
      const toggleNaoLidos = document.getElementById('toggleNaoLidos');
      toggleNaoLidos?.addEventListener('change', () => {
        const onlyUnread = toggleNaoLidos.checked;
        document.querySelectorAll('.aviso-card').forEach(card => {
          const lido = card.getAttribute('data-lido') === '1';
          card.style.display = (onlyUnread && lido) ? 'none' : '';
        });
      });
      document.querySelectorAll('[data-acao="marcar-lido"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const url = btn.getAttribute('data-url'); const card = btn.closest('.aviso-card');
          try{
            const resp = await fetch(url, { method: 'POST' });
            if (resp.ok){
              card.setAttribute('data-lido','1'); card.classList.add('lido');
              const meta = card.querySelector('.text-muted.small'); if (meta) meta.innerHTML += ' • <span class="text-success">Lido</span>';
              btn.remove(); refreshBadgesLocal(); toastOK?.show();
            } else { alert('Não foi possível marcar como lido ('+resp.status+').'); }
          } catch(e){ alert('Falha de rede.'); }
        });
      });
      refreshBadgesLocal();
    }

    function initLancamentos(ctx=document){
      const sec = ctx.querySelector('section[data-view="lancamentos"].is-active'); if(!sec) return;
      const tbody  = document.getElementById('tbodyLanc');
      const ftValor= document.getElementById('ftValor');
      const ftEnt  = document.getElementById('ftEntregas');
      const kpiV   = document.getElementById('kpiTotalValor');
      const kpiE   = document.getElementById('kpiTotalEntregas');
      const grid   = document.getElementById('gridCoop');
      const f      = document.getElementById('formFiltroLanc');
      if(!tbody || !ftValor || !ftEnt || !kpiV || !kpiE || !grid || !f) return;

      function getRows(){ return Array.from(tbody.querySelectorAll('tr')); }

      function recomputeTotals(){
        let totV=0, totE=0;
        const perCoop = {};
        getRows().forEach(tr=>{
          if (tr.style.display==='none') return;
          const v = Number(tr.querySelector('.valor')?.dataset.valor || 0);
          const eTxt = tr.cells[4].textContent.trim();
          const e = eTxt==='-' ? 0 : Number(eTxt.replace(/\D+/g,''));
          totV += v; totE += e;
          const id = tr.dataset.coop, nm = tr.dataset.coopnome;
          perCoop[id] = perCoop[id] || {nome:nm, valor:0, ent:0};
          perCoop[id].valor += v; perCoop[id].ent += e;
        });
        ftValor.textContent = 'R$ ' + brMoney(totV);
        ftEnt.textContent   = String(totE);
        kpiV.textContent    = brMoney(totV);
        kpiE.textContent    = String(totE);

        grid.innerHTML = '';
        Object.values(perCoop).sort((a,b)=>b.valor-a.valor).forEach(p=>{
          const div = document.createElement('div'); div.className='col-sm-6 col-xl-4';
          div.innerHTML = `<div class="kpi h-100"><div class="fw-bold">${p.nome}</div>
            <div class="small text-muted">Entregas: <b>${p.ent||0}</b></div>
            <div>Total: <b>R$ ${brMoney(p.valor)}</b></div></div>`;
          grid.appendChild(div);
        });
        return {totV, totE};
      }

      // filtro de texto local (não vai ao back)
      f.q?.addEventListener('input', ()=>{
        const q = (f.q.value||'').toLowerCase().trim();
        getRows().forEach(tr=>{
          const coop = (tr.dataset.coopnome||'').toLowerCase();
          const contrato = (tr.dataset.contrato||'').toLowerCase();
          tr.style.display = (!q || coop.includes(q) || contrato.includes(q)) ? '' : 'none';
        });
        recomputeTotals();
      });

      // destaca cooperado
      tbody.addEventListener('click', (e)=>{
        const td = e.target.closest('.coop-name'); if(!td) return;
        const nome = td.textContent.trim();
        getRows().forEach(r=>{
          r.classList.toggle('table-warning', r.querySelector('.coop-name')?.textContent.trim()===nome);
        });
      });

      // EXPORTA CSV
      document.getElementById('btnExportCsv')?.addEventListener('click', ()=>{
        const rows = getRows().filter(r=>r.style.display!=='none');
        const header = ['Data','Cooperado','Contrato','Horário','Entregas','Valor (R$)'];
        const linhas = [header];
        let totE = 0, totV = 0;
        rows.forEach(r=>{
          const data      = r.cells[0].textContent.trim();
          const coop      = r.cells[1].textContent.trim();
          const contrato  = r.cells[2].textContent.trim();
          const horario   = r.cells[3].textContent.trim();
          const entTxt    = r.cells[4].textContent.trim();
          const entregas  = entTxt==='-' ? 0 : Number(entTxt.replace(/\D+/g,''));
          const valorNum  = Number(r.querySelector('.valor')?.dataset.valor || 0);
          const valorStr  = valorNum.toFixed(2).replace('.',',');
          totE += entregas; totV += valorNum;
          linhas.push([data, coop, contrato, horario, String(entregas), valorStr]);
        });
        const totalStr = totV.toFixed(2).replace('.',',');
        linhas.push(['Totais','','','', String(totE), totalStr]);
        const csv = '\uFEFF' + linhas.map(l=>l.join(';')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'lancamentos.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      recomputeTotals();
    }

    function initEscalas(){ /* nada especial */ }
    function initConfig(){ /* nada especial */ }

    // ===== Helpers SPA =====
    function getViewFromURL(u){
      const url = u ? new URL(u, window.location.origin) : window.location;
      const usp = new URLSearchParams(url.search);
      return usp.get('view') || 'lancar';
    }
    function setActiveLink(view){
      document.querySelectorAll('.navmenu a').forEach(a=>{
        a.classList.remove('active');
        const href = a.getAttribute('href')||'';
        let v = null;
        if (href.includes('view=')) {
          try{ v = (new URL(href, location.origin)).searchParams.get('view'); }catch{}
        } else if (a.id==='linkAvisos'){ v = 'avisos'; }
        if (v === view) a.classList.add('active');
        if (!v && view==='lancar' && href.includes('portal_restaurante')) a.classList.add('active');
      });
    }
    function showView(view){
      document.querySelectorAll('section[data-view]').forEach(sec=>{
        sec.classList.toggle('is-active', sec.getAttribute('data-view')===view);
      });
      setActiveLink(view);
      if(view==='lancar'){ initLancar(); }
      else if(view==='lancamentos'){ initLancamentos(); }
      else if(view==='avisos'){ initAvisos(); }
      else if(view==='escalas'){ initEscalas(); }
      else if(view==='config'){ initConfig(); }

      // restaurar rolagem da view
      const y = scrollMem.get(view);
      if (y) window.scrollTo({top:y, left:0, behavior:'instant'});
    }

    // intercepta rolagem para memorizar por view
    document.addEventListener('scroll', ()=>{
      const v = getViewFromURL();
      scrollMem.set(v, window.scrollY||0);
    }, {passive:true});

    function canSoftNavigate(href){
      if (!href) return false;
      const abs = new URL(href, location.origin);
      if (abs.pathname.includes('/logout')) return false;
      if (abs.pathname.includes('rest_tabelas')) return false; // deixa abrir página própria de Tabelas
      if (abs.pathname.includes('portal_restaurante')) return true;
      if (abs.pathname.includes('portal_restaurante_avisos')) return true;
      return false;
    }

    async function softLoad(href){
      try{
        const targetView = getViewFromURL(href);
        const yBefore = window.scrollY||0;
        const resp = await fetch(href, {credentials:'same-origin'});
        if(!resp.ok) return false;
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');

        let newSection = doc.querySelector(`section[data-view="${targetView}"]`);
        const curMain = document.querySelector('main.content');

        if (newSection){
          const curSection = document.querySelector(`section[data-view="${targetView}"]`);
          if (!curSection) return false;
          curSection.innerHTML = newSection.innerHTML;
          history.pushState({view: targetView}, '', (new URL(href, location.origin)).toString());
          showView(targetView);
          window.scrollTo({top:yBefore, left:0, behavior:'instant'});
          return true;
        } else {
          const newMain = doc.querySelector('main.content');
          if (!newMain || !curMain) return false;
          const vNow = getViewFromURL();
          curMain.innerHTML = newMain.innerHTML;
          history.pushState({}, '', (new URL(href, location.origin)).toString());
          showView(vNow);
          window.scrollTo({top:yBefore, left:0, behavior:'instant'});
          return true;
        }
      }catch(e){ return false; }
    }

    // Intercepta cliques no menu para SPA
    function handleMenuClicks(){
      const nav = document.querySelector('.navmenu');
      if(!nav) return;
      nav.addEventListener('click', async (e)=>{
        const a = e.target.closest('a'); if(!a) return;
        const href = a.getAttribute('href'); if(!href) return;
        if (!canSoftNavigate(href)) {
          // clique em Tabelas: checagem rápida de /rest/tabelas/*/abrir (caso tenha botões dentro da page)
          return;
        }
        e.preventDefault();
        const ok = await softLoad(href);
        if (!ok) window.location.href = href; // fallback
      });
    }

    // Intercepta formulários GET das abas SPA para carregar apenas a section
    function handleSectionForms(){
      document.addEventListener('submit', async (e)=>{
        const form = e.target.closest('form'); if(!form) return;
        if (form.method?.toUpperCase() !== 'GET') return;
        const action = form.getAttribute('action')||'';
        if (!action.includes('portal_restaurante')) return;
        const before = window.scrollY||0;
        const formData = new FormData(form);
        const usp = new URLSearchParams(formData);
        const href = action + (action.includes('?')?'&':'?') + usp.toString();
        e.preventDefault();
        const ok = await softLoad(href);
        if (!ok) window.location.href = href;
        else window.scrollTo({top:before, left:0, behavior:'instant'});
      });
    }

    // ===== Avisos: toast persistente + polling =====
    let toastAvisos = null;
    function getToastEl(){ return document.getElementById('toastAvisos'); }
    function setToastUnread(n){
      const el = document.getElementById('toastUnreadCount');
      if (el) el.textContent = String(n);
      // badge no menu
      const link = document.getElementById('linkAvisos');
      let dot = link?.querySelector('.notif-dot');
      if (!dot && link){
        dot = document.createElement('span');
        dot.className = 'notif-dot';
        link.appendChild(dot);
      }
      if (dot){
        if (n>0){ dot.style.display='flex'; dot.textContent = n>99?'99+':String(n); }
        else { dot.style.display='none'; }
      }
      // mostra/oculta toast
      if (!toastAvisos){
        const te = getToastEl();
        if (te) toastAvisos = new bootstrap.Toast(te, { autohide: false });
      }
      if (toastAvisos){
        if (n>0){
          const te = getToastEl();
          if (te){
            te.addEventListener('hidden.bs.toast', ()=>{ if (Number(document.getElementById('toastUnreadCount')?.textContent||'0')>0) setTimeout(()=>toastAvisos.show(), 800); }, { once:true });
          }
          toastAvisos.show();
        } else {
          toastAvisos.hide();
        }
      }
    }

    async function pollUnreadLoop(){
      try{
        const linkAvisos = document.getElementById('linkAvisos');
        const href = linkAvisos?.getAttribute('href');
        if (href){
          const resp = await fetch(href, {credentials:'same-origin'});
          if (resp.ok){
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            let n = doc.querySelectorAll('.aviso-card[data-lido="0"]').length;
            if (!n){
              const b = doc.querySelector('#badgeTitulo');
              if (b){
                const m = b.textContent.match(/\d+/);
                if (m) n = Number(m[0]);
              }
            }
            setToastUnread(n||0);
          }
        }
      }catch(_){}
      setTimeout(pollUnreadLoop, 25000);
    }

    // Clique “Ver agora” do toast usa SPA
    function wireToastVerAgora(){
      const a = document.getElementById('toastVerAgora');
      if (!a) return;
      a.addEventListener('click', async (e)=>{
        const href = a.getAttribute('href'); if(!href) return;
        if (!canSoftNavigate(href)) return;
        e.preventDefault();
        const ok = await softLoad(href);
        if (!ok) window.location.href = href;
      });
    }

    // ===== Tabelas: tratar abertura/404 com feedback suave (sem quebrar)
    document.addEventListener('click', async (e)=>{
      const a = e.target.closest('a'); if(!a) return;
      const href = a.getAttribute('href')||'';
      if (!href.includes('/rest/tabelas/') || !href.endsWith('/abrir')) return; // só botões "abrir"
      // TENTA HEAD/GET rápido para evitar aba vazia 404
      try{
        const resp = await fetch(href, {method:'GET', credentials:'same-origin'});
        if (resp.status === 404){
          e.preventDefault();
          showToastInfo('Arquivo de Tabela não encontrado neste servidor. Peça para reenviar o PDF.', true);
        } else if (resp.ok){
          // deixa seguir (nada a fazer)
        } else {
          e.preventDefault();
          showToastInfo('Não foi possível abrir a Tabela ('+resp.status+').', true);
        }
      }catch(_){
        e.preventDefault();
        showToastInfo('Falha de rede ao abrir a Tabela.', true);
      }
    });

    function showToastInfo(msg, danger=false){
      const id = 'toastInfo';
      let wrap = document.getElementById(id);
      if (!wrap){
        wrap = document.createElement('div');
        wrap.id = id; wrap.className = 'position-fixed bottom-0 end-0 p-3'; wrap.style.zIndex = 1060;
        wrap.innerHTML = `<div class="toast" data-bs-autohide="true" data-bs-delay="3500">
          <div class="toast-header">
            <i class="bi ${danger?'bi-exclamation-triangle-fill text-danger':'bi-info-circle'} me-2"></i>
            <strong class="me-auto">Aviso</strong><small>agora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
          </div>
          <div class="toast-body"></div>
        </div>`;
        document.body.appendChild(wrap);
      }
      const toastEl = wrap.querySelector('.toast');
      wrap.querySelector('.toast-body').textContent = msg;
      const t = new bootstrap.Toast(toastEl);
      t.show();
    }

    // Back/forward
    window.addEventListener('popstate', (ev)=>{
      const v = ev.state?.view || getViewFromURL();
      showView(v);
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Abre a view da URL (ou 'lancar')
      const view = getViewFromURL();
      showView(view);
      handleMenuClicks();
      handleSectionForms();
      wireToastVerAgora();

      // Toast inicial (persistente)
      const unreadServer = Number(`{{ _toast_unread }}`) || 0;
      setToastUnread(unreadServer);

      // Badge sempre ativo, com polling
      pollUnreadLoop();
    });
  </script>
</body>
</html>
