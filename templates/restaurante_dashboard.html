<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Portal do Estabelecimento — Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Somente ícones (leve) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <style>
    /* ================== DESIGN SYSTEM (leve, sem Bootstrap) ================== */
    :root{
      --royal:#2041db; --royal-2:#3654e6; --royal-3:#eaf0ff;
      --bg:#fbfcff; --card:#ffffff; --ink:#0d1324; --muted:#6b7385;
      --soft:#f3f6ff; --chip:#eef3ff; --border:#e7eaf3; --ring:#2141d922;
      --ok:#16a34a; --danger:#e74c3c; --warn:#f59e0b;
      --shadow:0 10px 30px rgba(12,18,46,.06);
      --r-lg:16px; --r-md:12px; --r-sm:10px;
    }
    [data-theme="dark"]{
      --bg:#0b0f17; --card:#0f1521; --ink:#e7edf9; --muted:#97a3b6;
      --soft:#0e1729; --chip:#101c33; --border:#1a2234; --royal-3:#0f1a36; --ring:#2f53ff44;
      --shadow:0 12px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit; text-decoration:none}
    button{font:inherit; cursor:pointer}
    .hidden{display:none!important}

    /* Layout */
    .shell{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
    @media (max-width: 980px){ .shell{grid-template-columns:70px 1fr} }

    /* Sidebar */
    .aside{
      background:linear-gradient(180deg,var(--royal) 0%, var(--royal-2) 100%);
      color:#fff; padding:16px 12px; position:sticky; top:0; height:100dvh;
      box-shadow: inset 0 -1px 0 #ffffff22;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800}
    .brand .title{padding:8px 10px; border-radius:12px; background:rgba(255,255,255,.12)}
    @media (max-width:980px){ .brand .title span{display:none} }
    .toolbar{margin-top:10px; display:flex; gap:8px}
    .btn-ghost{
      display:inline-flex; align-items:center; gap:8px; background:transparent; color:#fff;
      border:1px solid #ffffff33; padding:8px 10px; border-radius:10px;
    }
    .navmenu{margin-top:12px; display:flex; flex-direction:column; gap:6px}
    .navmenu a{display:flex; align-items:center; gap:10px; color:#fff; padding:10px 12px; border-radius:12px}
    .navmenu a:hover{background:rgba(255,255,255,.16)}
    .navmenu a.active{background:rgba(255,255,255,.25)}
    .navmenu .badge{margin-left:auto; min-width:22px; text-align:center; background:#ff4d4f; color:#fff; border-radius:999px; padding:2px 7px; font-weight:700}

    /* Content */
    .content{padding:22px clamp(12px,3vw,32px)}
    .section-title{display:flex; align-items:center; gap:10px; color:var(--royal); font-weight:800; font-size:1.2rem}
    [data-theme="dark"] .section-title{color:#cfe0ff}

    /* Cards */
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--r-lg); box-shadow:var(--shadow); padding:16px}
    .card-s{background:var(--card); border:1px solid var(--border); border-radius:var(--r-md); box-shadow:var(--shadow); padding:12px}

    /* Grid simplificado */
    .row{display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:12px}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-5{grid-column:span 5}
    .col-6{grid-column:span 6} .col-7{grid-column:span 7} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    @media (max-width:980px){ .col-3,.col-4,.col-5,.col-6,.col-7,.col-8{grid-column:span 12} }

    /* Forms */
    label{display:block; margin:0 0 6px 2px; font-size:.95rem}
    .input,.select,.textarea{
      width:100%; padding:10px 12px; border-radius:12px; background:var(--card); color:var(--ink); border:1px solid var(--border);
    }
    .input:focus,.select:focus,.textarea:focus{outline:none; border-color:var(--royal); box-shadow:0 0 0 6px var(--ring)}
    .textarea{min-height:120px; resize:vertical}
    .hint{color:var(--muted); font-size:.85rem; margin-top:4px}

    /* Buttons */
    .btn{display:inline-flex; align-items:center; gap:8px; border:0; border-radius:12px; padding:10px 14px; font-weight:700}
    .btn-royal{background:var(--royal); color:#fff}
    .btn-royal:hover{background:var(--royal-2)}
    .btn-outline{background:transparent; color:var(--royal); border:1px solid var(--royal)}
    .btn-outline:hover{background:var(--royal); color:#fff}
    .btn-danger{background:var(--danger); color:#fff}
    .btn-chip{border-radius:999px; background:var(--chip); border:1px solid var(--border); padding:6px 10px; font-weight:800}

    /* Tabelas */
    .table{width:100%; border-collapse:collapse; font-size:.95rem}
    .table th,.table td{padding:10px; border:1px solid var(--border)}
    .table thead th{background:var(--royal-3); color:#1a2450}
    [data-theme="dark"] .table thead th{color:#dfe8ff}
    .text-end{text-align:right}
    .text-muted{color:var(--muted)}
    .small{font-size:.9rem}
    .mt-2{margin-top:10px} .mt-3{margin-top:14px} .mb-1{margin-bottom:6px}
    .divider{height:1px; background:var(--border); margin:10px 0}

    /* Cooperados (lista) */
    .coop-list{max-height:60vh; overflow:auto; display:flex; flex-direction:column; gap:6px}
    .coop-item{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--card)}
    .coop-item:hover{background:var(--soft)}
    .avatar{width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 0 #0001}
    .avatar-big{width:180px; height:180px; border-radius:50%; object-fit:cover; border:6px solid var(--royal); box-shadow:0 8px 22px #0004}

    /* Ratings (5 estrelas lado a lado) */
    .stars{display:inline-flex; gap:6px; font-size:1.6rem; cursor:pointer; vertical-align:middle}
    .star{color:#cbd5e1; transition:transform .06s}
    .star.active,.star.hover{color:#fbbf24}
    .star:active{transform:scale(.92)}

    /* Toasts simples */
    .toast{position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px 14px; display:none}
    .toast.show{display:block}

    /* Lançamentos (lista agrupada) */
    .lan-shell{display:grid; grid-template-columns:320px 1fr; gap:16px}
    .lan-aside{position:sticky; top:16px; height:fit-content}
    .lan-kpis{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .lan-kpi{background:var(--soft); border:1px solid var(--border); border-radius:12px; padding:10px}
    [data-theme="dark"] .lan-kpi{background:#0f182b}
    .lan-kpi .t{color:var(--muted); font-size:.85rem}
    .lan-kpi .v{font-weight:900}
    .lan-list{display:flex; flex-direction:column; gap:10px}
    .lan-item{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow)}
    .lan-head{display:flex; align-items:center; gap:10px; padding:12px 14px; cursor:pointer}
    .lan-head:hover{background:var(--soft)}
    [data-theme="dark"] .lan-head:hover{background:#0f182b}
    .lan-name{font-weight:900}
    .lan-pills{display:flex; gap:8px; margin-left:auto; flex-wrap:wrap}
    .pill{border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-weight:800; background:var(--chip)}
    .lan-body{display:none; padding:0 14px 14px 14px}
    .lan-body.open{display:block}
    .lan-table{width:100%; border-collapse:collapse; font-size:.95rem}
    .lan-table th,.lan-table td{border:1px solid var(--border); padding:8px 10px}
    .lan-table thead th{background:var(--royal-3); color:#10224f}
    [data-theme="dark"] .lan-table thead th{color:#e6ecff}
    .lan-day{margin:10px 0 6px; font-weight:800; color:var(--royal)}
    .lan-empty{padding:10px; color:var(--muted)}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="shell">
    <!-- ===================== Sidebar ===================== -->
    <aside class="aside">
      <div class="brand">
        <div class="title"><i class="bi bi-building"></i> <span>Portal do Estabelecimento</span></div>
      </div>
      <div class="toolbar">
        <button id="btnTheme" class="btn-ghost" type="button" title="Alternar tema">
          <i id="iconTheme" class="bi bi-moon-stars"></i><span id="txtTheme">Escuro</span>
        </button>
      </div>
      <nav class="navmenu" aria-label="Menu">
        <a class="{{ 'active' if (view|default('lancar') not in ['escalas','config','avisos','lancamentos']) else '' }}"
           href="{{ url_for('portal_restaurante', view='lancar', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None) }}">
          <i class="bi bi-person-lines-fill"></i><span>Cooperados</span>
        </a>
        <a class="{{ 'active' if view=='lancamentos' else '' }}"
           href="{{ url_for('portal_restaurante', view='lancamentos', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None) }}">
          <i class="bi bi-receipt"></i><span>Lançamentos</span>
        </a>
        <a class="{{ 'active' if view=='escalas' else '' }}" href="{{ url_for('portal_restaurante', view='escalas') }}">
          <i class="bi bi-calendar-week"></i><span>Escala</span>
        </a>
        {% if session.get('user_tipo') == 'restaurante' %}
        <a class="{{ 'active' if request.endpoint=='rest_tabelas' else '' }}" href="{{ url_for('rest_tabelas') }}">
          <i class="bi bi-table"></i><span>Tabelas</span>
        </a>
        {% endif %}
        <a class="{{ 'active' if view=='config' else '' }}" href="{{ url_for('portal_restaurante', view='config') }}">
          <i class="bi bi-gear"></i><span>Configuração</span>
        </a>
        <a id="linkAvisos" class="{{ 'active' if request.endpoint=='portal_restaurante_avisos' or view=='avisos' else '' }}"
           href="{{ url_for('portal_restaurante_avisos') }}">
          <i class="bi bi-megaphone"></i><span>Avisos</span>
          {% set _cntAvisos = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
          {% if _cntAvisos > 0 %}<span class="badge">{{ _cntAvisos }}</span>{% endif %}
        </a>
        <a href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
      </nav>
    </aside>

    <!-- ===================== Conteúdo ===================== -->
    <main class="content">

      <!-- Flashes -->
      {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
          <div class="mb-1">
            {% for cat, msg in msgs %}
              <div class="card" style="border-left:6px solid {{ '#dc3545' if cat=='error' else '#2041db' }};"><div>{{ msg|safe }}</div></div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% if view == 'config' %}
      <!-- ===================== CONFIG ===================== -->
      <div class="section-title"><i class="bi bi-shield-lock"></i> Configuração</div>
      <div class="card">
        <form class="row" method="POST" action="{{ url_for('rest_alterar_senha') }}">
          <div class="col-4">
            <label>Senha atual</label>
            <div style="display:flex; gap:8px">
              <input type="password" class="input" name="senha_atual" required />
              <button class="btn btn-outline" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
            </div>
          </div>
          <div class="col-4">
            <label>Nova senha</label>
            <div style="display:flex; gap:8px">
              <input type="password" class="input" name="senha_nova" minlength="6" required />
              <button class="btn btn-outline" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
            </div>
            <div class="hint">Mínimo de 6 caracteres.</div>
          </div>
          <div class="col-4">
            <label>Confirmar nova senha</label>
            <div style="display:flex; gap:8px">
              <input type="password" class="input" name="senha_conf" minlength="6" required />
              <button class="btn btn-outline" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
            </div>
          </div>
          <div class="col-12" style="text-align:right"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
        </form>
      </div>

      {% elif view == 'escalas' %}
      <!-- ===================== ESCALA (dia/semana + filtro de turno) ===================== -->
      <div class="section-title"><i class="bi bi-calendar-week"></i> Escala</div>
      <div class="card">
        <form class="row" method="GET" action="{{ url_for('portal_restaurante') }}">
          <input type="hidden" name="view" value="escalas" />
          <input type="hidden" name="modo" id="inputModo" value="{{ modo or 'dia' }}" />
          <div class="col-6">
            <label>Visualização</label>
            <div style="display:flex; gap:8px">
              <button type="button" id="btnModoDia" class="btn {{ 'btn-royal' if (modo=='dia') else 'btn-outline' }}"><i class="bi bi-calendar-day"></i> Dia (hoje)</button>
              <button type="button" id="btnModoSemana" class="btn {{ 'btn-royal' if (modo=='semana') else 'btn-outline' }}"><i class="bi bi-calendar-week"></i> Semana completa</button>
            </div>
            <div class="hint">Padrão abre o dia atual; troque para ver a semana.</div>
          </div>
          <div class="col-3">
            <label>Data de referência</label>
            <input type="date" name="ref" class="input" value="{{ ref_data.strftime('%Y-%m-%d') }}" />
            <div class="hint">Dia exibido (modo dia) • Semana base (modo semana).</div>
          </div>
          <div class="col-3" style="text-align:right">
            <div style="height:10px"></div>
            <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
            <a class="btn btn-outline" href="{{ url_for('portal_restaurante', view='escalas') }}"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
          </div>
        </form>

        <!-- Filtro de Turno (front-end) -->
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <span class="btn-chip"><i class="bi bi-filter-circle"></i> Turno</span>
          <button type="button" class="btn btn-royal" id="turnoTodos">Todos</button>
          <button type="button" class="btn btn-outline" id="turnoDia">Dia</button>
          <button type="button" class="btn btn-outline" id="turnoNoite">Noite</button>
          <span class="text-muted small right">Funciona sem alterar o backend.</span>
        </div>

        {% if modo == 'semana' %}
        <div class="divider"></div>
        <div class="row">
          {% for dia in dias_list %}
          <div class="col-4">
            <div class="card-s">
              <div style="display:flex; justify-content:space-between; align-items:center">
                <span class="btn-chip"><i class="bi bi-calendar-event"></i> {{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][dia.weekday()] }} — {{ dia.strftime('%d/%m/%Y') }}</span>
                <i class="bi bi-people"></i>
              </div>
              <div class="divider"></div>
              <div style="max-height:360px; overflow:auto">
                {% set lista = agenda.get(dia, []) %}
                {% if lista %}
                  {% for grupo in (lista | groupby('contrato')) %}
                    {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                    <div class="mb-1" style="font-weight:800">{{ contrato_nome }}</div>
                    {% for item in grupo.list %}
                      {% set _t = (item.turno or '')|lower %}
                      {% set _tag = 'noite' if 'noit' in _t else ('dia' if ('dia' in _t or 'manh' in _t or 'tard' in _t) else 'outro') %}
                      <div class="esc-item" data-turno="{{ _tag }}" style="padding:8px 0; border-bottom:1px dashed var(--border)">
                        <div style="font-weight:700">
                          {{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}
                        </div>
                        <div class="text-muted small">
                          {{ item.turno or '—' }}{% if item.horario %} • {{ item.horario }}{% endif %}
                        </div>
                      </div>
                    {% endfor %}
                  {% endfor %}
                {% else %}
                  <div class="text-muted">Sem escala registrada.</div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="divider"></div>
        <div class="card-s">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <span class="btn-chip"><i class="bi bi-calendar-day"></i> {{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][ref_data.weekday()] }} — {{ ref_data.strftime('%d/%m/%Y') }}</span>
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="divider"></div>
          <table class="table" id="tblEscDia">
            <thead><tr><th>Contrato</th><th>Cooperado</th><th>Turno</th><th>Horário</th></tr></thead>
            <tbody>
              {% set lista = agenda.get(ref_data, []) %}
              {% if lista %}
                {% for grupo in (lista | groupby('contrato')) %}
                  {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                  {% for item in grupo.list %}
                  {% set _t = (item.turno or '')|lower %}
                  {% set _tag = 'noite' if 'noit' in _t else ('dia' if ('dia' in _t or 'manh' in _t or 'tard' in _t) else 'outro') %}
                  <tr class="esc-item" data-turno="{{ _tag }}">
                    <td>{{ contrato_nome }}</td>
                    <td>{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</td>
                    <td>{{ item.turno or '—' }}</td>
                    <td>{{ item.horario or '—' }}</td>
                  </tr>
                  {% endfor %}
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="text-muted">Sem escala registrada.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>

      {% elif view == 'avisos' %}
      <!-- ===================== AVISOS ===================== -->
      {% set _avisos = avisos if avisos is defined and avisos is not none else [] %}
      {% set _unread_from_list = (_avisos | selectattr('lido','equalto',False) | list | length) %}
      {% set _unread_from_ctx = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
      <div class="section-title"><i class="bi bi-megaphone-fill"></i> Avisos</div>

      <div class="card">
        <div style="display:flex; gap:8px; align-items:center">
          <form method="POST" action="{{ url_for('marcar_todos_avisos_lidos_restaurante') }}">
            <button class="btn btn-royal" type="submit" {% if (_unread_from_list or _unread_from_ctx) == 0 %}disabled{% endif %}><i class="bi bi-check2-circle"></i> Marcar todos como lidos</button>
          </form>
          <label class="right" style="display:flex; gap:8px; align-items:center"><input type="checkbox" id="toggleNaoLidos" /> Mostrar apenas não lidos</label>
          <span id="badgeTitulo" class="btn-chip">{{ (_unread_from_list or _unread_from_ctx) > 0 and ((_unread_from_list or _unread_from_ctx) ~ ' não lido(s)') or 'Tudo lido' }}</span>
        </div>
      </div>

      {% if _unread_from_ctx > 0 and (_avisos | length) == 0 %}
      <div class="card mt-2" style="border-left:6px solid var(--warn)">Existem {{ _unread_from_ctx }} aviso(s) não lido(s), porém nenhum item foi carregado nesta página. Confirme se a rota está preenchendo <code>avisos</code>.</div>
      {% endif %}

      {% if _avisos and (_avisos | length) > 0 %}
        {% for a in _avisos %}
        <div id="aviso-{{ a.id }}" class="card mt-2 aviso-card {% if a.lido %}lido{% endif %}" data-lido="{{ '1' if a.lido else '0' }}">
          <div style="display:flex; justify-content:space-between; align-items:flex-start">
            <div>
              <div style="font-weight:800">
                {{ a.titulo or 'Aviso' }}
                {% if a.prioridade_alta %}<span class="btn-chip" style="background:#ffe4e4; border-color:#ffd1d1; color:#b42318"><i class="bi bi-exclamation-triangle"></i> Prioridade</span>{% endif %}
              </div>
              <div class="text-muted small">
                Publicado em {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em }} •
                {% if a.lido %}<span style="color:var(--ok)">Lido</span>{% else %}<span style="color:var(--danger)">Não lido</span>{% endif %}
              </div>
            </div>
            <div>
              {% if not a.lido %}
              <button class="btn btn-outline" data-acao="marcar-lido" data-url="{{ url_for('marcar_aviso_lido_universal', aviso_id=a.id) }}"><i class="bi bi-check2"></i> Marcar como lido</button>
              {% endif %}
            </div>
          </div>
          <div class="divider"></div>
          <div class="aviso-body">{{ a.corpo_html | safe if a.corpo_html else (a.conteudo or a.texto or '') }}</div>
        </div>
        {% endfor %}
      {% else %}
        <div class="card mt-2 text-muted"><i class="bi bi-inbox"></i> Nenhum aviso disponível.</div>
      {% endif %}

      {% elif view == 'lancamentos' %}
      <!-- ===================== LANÇAMENTOS (novo, agrupado) ===================== -->
      <div class="section-title"><i class="bi bi-receipt"></i> Lançamentos</div>
      <div class="lan-shell">
        <!-- Filtros e KPIs -->
        <aside class="lan-aside card">
          <form id="lanFiltro" class="row">
            <div class="col-12">
              <label>Início</label>
              <input type="date" class="input" name="data_inicio" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}" />
            </div>
            <div class="col-12">
              <label>Fim</label>
              <input type="date" class="input" name="data_fim" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}" />
            </div>
            <div class="col-12">
              <label>Cooperado / Contrato</label>
              <input type="text" class="input" name="q" placeholder="Filtrar por nome/contrato..." />
            </div>
            <div class="col-12" style="display:flex; gap:8px; margin-top:6px">
              <button class="btn btn-royal" type="button" id="btnLanAplicar"><i class="bi bi-funnel"></i> Aplicar</button>
              <button class="btn btn-outline" type="button" id="btnLanLimpar"><i class="bi bi-arrow-counterclockwise"></i> Limpar</button>
            </div>
            <div class="divider" style="grid-column:1/-1"></div>
            <div class="lan-kpis col-12">
              <div class="lan-kpi"><div class="t">Valor total</div><div class="v">R$ <span id="kpiGeralValor">0,00</span></div></div>
              <div class="lan-kpi"><div class="t">Entregas totais</div><div class="v"><span id="kpiGeralEntregas">0</span></div></div>
              <div class="lan-kpi"><div class="t">Cooperados</div><div class="v"><span id="kpiGeralCoops">0</span></div></div>
              <div class="lan-kpi"><div class="t">Média por dia</div><div class="v">R$ <span id="kpiGeralMediaDia">0,00</span></div></div>
            </div>
            <div class="divider" style="grid-column:1/-1"></div>
            <div class="col-12" style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn btn-outline" type="button" id="btnLanExpandAll"><i class="bi bi-arrows-expand"></i> Expandir todos</button>
              <button class="btn btn-outline" type="button" id="btnLanCollapseAll"><i class="bi bi-arrows-collapse"></i> Recolher todos</button>
              <button class="btn btn-outline" type="button" id="btnLanCsv"><i class="bi bi-download"></i> Exportar CSV</button>
            </div>
          </form>
        </aside>

        <!-- Conteúdo -->
        <section>
          <div class="card" style="margin-bottom:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div class="btn-chip">Período:
                <span id="txtLanPeriodo">
                  {{ filtro_inicio.strftime('%d/%m/%Y') if filtro_inicio }}{% if filtro_inicio and filtro_fim %} a {% endif %}{{ filtro_fim.strftime('%d/%m/%Y') if filtro_fim }}
                </span>
              </div>
              <div class="text-muted small">Clique no cooperado para abrir/fechar os lançamentos.</div>
            </div>
          </div>
          <div id="lanLista" class="lan-list"></div>
        </section>
      </div>

      {% else %}
      <!-- ===================== LANÇAR (lista → clique → foto e form ao lado) ===================== -->
      <div class="section-title"><i class="bi bi-plus-circle"></i> Lançar Produção Diária</div>
      <!-- Filtro de período (mantido) -->
      <div class="card">
        <form class="row" method="GET" action="{{ url_for('portal_restaurante') }}">
          <input type="hidden" name="view" value="lancar" />
          <div class="col-3">
            <label>Início</label>
            <input type="date" name="data_inicio" class="input" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}" />
          </div>
          <div class="col-3">
            <label>Fim</label>
            <input type="date" name="data_fim" class="input" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}" />
          </div>
          <div class="col-3">
            <label>Período em uso</label>
            <div class="btn-chip">{% if filtro_inicio and filtro_fim %}{{ filtro_inicio.strftime('%d/%m/%Y') }} a {{ filtro_fim.strftime('%d/%m/%Y') }}{% else %}—{% endif %}</div>
          </div>
          <div class="col-3" style="text-align:right">
            <div style="height:10px"></div>
            <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
            <a class="btn btn-outline" href="{{ url_for('portal_restaurante', view='lancar') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
          </div>
        </form>
      </div>

      <div class="row mt-2">
        <!-- Coluna esquerda: lista com busca -->
        <div class="col-4">
          <div class="card">
            <label>Buscar cooperado</label>
            <div style="display:flex; gap:8px; align-items:center">
              <i class="bi bi-search"></i>
              <input id="buscaCoop" type="text" class="input" placeholder="Digite para listar..." list="cooperadosList" />
            </div>
            <datalist id="cooperadosList">{% for coop in cooperados %}<option value="{{ coop.nome }}"></option>{% endfor %}</datalist>
            <div id="listaCooperados" class="coop-list mt-2">
              {% for coop in cooperados %}
              <div class="coop-item" data-id="{{ coop.id }}" data-nome="{{ coop.nome }}"
                   data-foto="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
                   data-total="{{ '%.2f'|format(coop.total_periodo or 0) }}">
                <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}" class="avatar" alt="" />
                <div>
                  <strong>{{ coop.nome }}</strong><br>
                  <span class="text-muted small">No período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</span>
                </div>
              </div>
              {% else %}<div class="text-muted">Nenhum cooperado encontrado.</div>{% endfor %}
            </div>
          </div>
        </div>

        <!-- Coluna direita: foto grande + formulário -->
        <div class="col-8">
          <div class="card" id="blocoLancamento">
            <div id="headerSel" class="hidden" style="text-align:center">
              <img id="selFoto" class="avatar-big" src="" alt="" />
              <div id="selNome" style="font-weight:800; font-size:1.15rem; margin-top:8px"></div>
              <div class="text-muted">Total no período: R$ <span id="selTotal">0,00</span></div>
              <div class="divider"></div>
            </div>

            <div id="hintSelecione" class="text-muted">Digite para listar e clique em um cooperado para lançar.</div>

            <form id="formLancamento" method="POST" action="{{ url_for('lancar_producao') }}" class="row hidden">
              <input type="hidden" name="cooperado_id" id="inputCooperadoId" value="" />
              <div class="col-3"><label>Valor (R$)</label><input type="number" class="input" name="valor" step="0.01" required /></div>
              <div class="col-3"><label>Data</label><input type="date" class="input" name="data" required /></div>
              <div class="col-3"><label>Hora Início</label><input type="time" class="input" name="hora_inicio" /></div>
              <div class="col-3"><label>Hora Fim</label><input type="time" class="input" name="hora_fim" /></div>
              <div class="col-3"><label>Entregas</label><input type="number" class="input" name="qtd_entregas" min="0" step="1" /></div>

              <div class="col-12"><div class="divider"></div></div>
              <div class="col-12">
                <label class="small"><input type="checkbox" id="chkAvaliar" /> Registrar avaliação agora</label>
                <input type="hidden" name="avaliar" id="inputAvaliar" value="0" />
              </div>

              <!-- Avaliação profissional (estrelas lado a lado) -->
              <div id="boxAval" class="row hidden">
                <div class="col-6">
                  <label style="font-weight:800">Geral (auto)</label>
                  <div class="stars" data-name="av_geral" data-auto="true">
                    <i class="bi bi-star-fill star" data-v="1"></i>
                    <i class="bi bi-star-fill star" data-v="2"></i>
                    <i class="bi bi-star-fill star" data-v="3"></i>
                    <i class="bi bi-star-fill star" data-v="4"></i>
                    <i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_geral" value="" />
                </div>
                <div class="col-6">
                  <label style="font-weight:800">Pontualidade</label>
                  <div class="stars" data-name="av_pontualidade">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_pontualidade" value="" />
                </div>
                <div class="col-6">
                  <label style="font-weight:800">Educação</label>
                  <div class="stars" data-name="av_educacao">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_educacao" value="" />
                </div>
                <div class="col-6">
                  <label style="font-weight:800">Eficiência / Cuidado</label>
                  <div class="stars" data-name="av_eficiencia">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_eficiencia" value="" />
                </div>
                <div class="col-12">
                  <label>Comentário (opcional)</label>
                  <textarea class="textarea" name="av_comentario" rows="6" placeholder="Conte com detalhes como foi a experiência... (sem limite de caracteres)"></textarea>
                </div>
              </div>

              <div class="col-12" style="text-align:right; margin-top:6px">
                <button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button>
              </div>
            </form>
          </div>

          <!-- Tabelas do cooperado selecionado -->
          <div id="blocoTabelas" class="mt-2">
            {% for coop in cooperados %}
            <div id="tabela-{{ coop.id }}" class="card hidden">
              <table class="table">
                <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th class="text-end">Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
                <tbody>
                  {% for lanc in coop.lancamentos %}
                  <tr>
                    <td>R$ {{ '%.2f'|format(lanc.valor or 0) }}</td>
                    <td>{{ lanc.data.strftime('%d/%m/%Y') if lanc.data }}</td>
                    <td>{{ lanc.hora_inicio or '' }}{% if lanc.hora_inicio or lanc.hora_fim %} às {% endif %}{{ lanc.hora_fim or '' }}</td>
                    <td class="text-end">{{ lanc.qtd_entregas if lanc.qtd_entregas is not none else '-' }}</td>
                    <td><a href="{{ url_for('editar_lancamento', id=lanc.id) }}" class="btn btn-outline"><i class="bi bi-pencil"></i></a></td>
                    <td><a href="{{ url_for('excluir_lancamento', id=lanc.id) }}" class="btn btn-danger"><i class="bi bi-trash"></i></a></td>
                  </tr>
                  {% else %}<tr><td colspan="6" class="text-muted">Nenhum lançamento no período selecionado</td></tr>{% endfor %}
                </tbody>
              </table>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </main>
  </div>

  <!-- ===== TOASTS ===== -->
  {% set _avisos_for_toast = avisos if avisos is defined and avisos is not none else [] %}
  {% set _unread_from_list_t = (_avisos_for_toast | selectattr('lido','equalto',False) | list | length) %}
  {% set _unread_from_ctx_t = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
  {% set _toast_unread = _unread_from_list_t if _unread_from_list_t>0 else _unread_from_ctx_t %}
  <div id="toastAvisos" class="toast">
    <div style="display:flex; gap:8px"><i class="bi bi-megaphone-fill"></i><strong>Novos avisos</strong><span class="right text-muted">agora</span></div>
    <div style="height:8px"></div>
    Você tem {{ _toast_unread }} aviso(s) não lido(s).
    <a href="{{ url_for('portal_restaurante_avisos') }}" class="btn btn-outline mt-2"><i class="bi bi-arrow-right"></i> Ver agora</a>
  </div>
  <div id="toastOK" class="toast">
    <div style="display:flex; gap:8px"><i class="bi bi-check2-circle" style="color:var(--ok)"></i><strong>Pronto</strong><span class="right text-muted">agora</span></div>
    <div style="height:8px"></div>
    <div>Aviso marcado como lido.</div>
  </div>

  <!-- ===================== JS (vanilla, leve) ===================== -->
  <script>
    /* Tema */
    (function(){
      const key='coopex.theme', root=document.documentElement;
      const saved=localStorage.getItem(key); if(saved) root.setAttribute('data-theme', saved);
      const btn=document.getElementById('btnTheme'), icon=document.getElementById('iconTheme'), txt=document.getElementById('txtTheme');
      function sync(){ const dark=root.getAttribute('data-theme')==='dark'; icon.className=dark?'bi bi-sun':'bi bi-moon-stars'; txt.textContent=dark?'Claro':'Escuro'; }
      btn?.addEventListener('click', ()=>{ const next=root.getAttribute('data-theme')==='dark'?'light':'dark'; root.setAttribute('data-theme', next); localStorage.setItem(key,next); sync(); });
      sync();
    })();

    /* Helpers */
    function togglePwd(btn){ const i=btn.previousElementSibling; if(!i) return; i.type = i.type==='password'?'text':'password'; const ic=btn.querySelector('i'); ic.classList.toggle('bi-eye'); ic.classList.toggle('bi-eye-slash'); }
    const brMoney = n => (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const parseISO = s => { if(!s) return null; const [y,m,d]=String(s).split('-'); return new Date(+y,+m-1,+d); };
    const fmtDia = s => { const d=parseISO(s); return d? d.toLocaleDateString('pt-BR') : s; };

    document.addEventListener('DOMContentLoaded', () => {
      const viewNow = "{{ view|default('lancar') }}";

      /* ================= Escala: alternar modo + filtro de turno ================= */
      if(viewNow==='escalas'){
        const input=document.getElementById('inputModo');
        const btnDia=document.getElementById('btnModoDia');
        const btnSem=document.getElementById('btnModoSemana');
        function mark(active){
          btnDia.className='btn '+(active==='dia'?'btn-royal':'btn-outline');
          btnSem.className='btn '+(active==='semana'?'btn-royal':'btn-outline');
        }
        btnDia?.addEventListener('click', ()=>{ input.value='dia'; mark('dia'); });
        btnSem?.addEventListener('click', ()=>{ input.value='semana'; mark('semana'); });
        mark(input?.value || 'dia');

        // Filtro de turno (front)
        function filtraTurno(tag){
          document.querySelectorAll('.esc-item').forEach(el=>{
            const t=el.getAttribute('data-turno');
            el.style.display = (tag==='todos' || tag===t) ? '' : 'none';
          });
        }
        document.getElementById('turnoTodos')?.addEventListener('click', (e)=>{ filtraTurno('todos'); e.target.className='btn btn-royal'; document.getElementById('turnoDia').className='btn btn-outline'; document.getElementById('turnoNoite').className='btn btn-outline'; });
        document.getElementById('turnoDia')?.addEventListener('click', (e)=>{ filtraTurno('dia'); e.target.className='btn btn-royal'; document.getElementById('turnoTodos').className='btn btn-outline'; document.getElementById('turnoNoite').className='btn btn-outline'; });
        document.getElementById('turnoNoite')?.addEventListener('click', (e)=>{ filtraTurno('noite'); e.target.className='btn btn-royal'; document.getElementById('turnoTodos').className='btn btn-outline'; document.getElementById('turnoDia').className='btn btn-outline'; });
      }

      /* ================= Avisos ================= */
      if(viewNow==='avisos'){
        const toastOK=document.getElementById('toastOK');
        const badgeTitulo=document.getElementById('badgeTitulo');
        const badgeSidebar=document.querySelector('#linkAvisos .badge');
        function getUnread(){return document.querySelectorAll('.aviso-card[data-lido="0"]').length;}
        function refresh(){
          const n=getUnread();
          if(badgeTitulo) badgeTitulo.textContent = n>0 ? (n+' não lido(s)') : 'Tudo lido';
          if(badgeSidebar){ badgeSidebar.style.display = n>0 ? '' : 'none'; if(n>0) badgeSidebar.textContent=n; }
        }
        document.getElementById('toggleNaoLidos')?.addEventListener('change', (e)=>{
          const only=e.target.checked;
          document.querySelectorAll('.aviso-card').forEach(card=>{
            const lido=card.getAttribute('data-lido')==='1';
            card.style.display = (only && lido)?'none':'';
          });
        });
        document.querySelectorAll('[data-acao="marcar-lido"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const url=btn.getAttribute('data-url'); const card=btn.closest('.aviso-card');
            try{
              const resp=await fetch(url,{method:'POST'});
              if(resp.ok){
                card.setAttribute('data-lido','1'); btn.remove(); refresh();
                toastOK.classList.add('show'); setTimeout(()=>toastOK.classList.remove('show'), 2000);
              }else{ alert('Falha ao marcar como lido ('+resp.status+').'); }
            }catch(e){ alert('Erro de rede.'); }
          });
        });
        refresh();
      }

      /* ================= Lançamentos (agrupado) ================= */
      if(viewNow==='lancamentos'){
        // Dataset vindo do Jinja
        window.LANC_DATA = [];
        {% for x in lancamentos_periodo or [] %}
        window.LANC_DATA.push({
          dataStr: `{{ (x.data.strftime('%Y-%m-%d') if x.data) if x.data is not string else (x.data|replace('/','-')) }}`,
          dataBr: `{{ (x.data.strftime('%d/%m/%Y') if x.data) if x.data is not string else x.data }}`,
          coopId: `{{ x.cooperado_id or x.coop_id }}`,
          coopNome: `{{ (x.cooperado_nome or x.coop_nome or '—')|replace('"','\\"') }}`,
          contrato: `{{ (x.contrato_nome or x.contrato or '')|replace('"','\\"') }}`,
          horaIni: `{{ x.hora_inicio or '' }}`,
          horaFim: `{{ x.hora_fim or '' }}`,
          entregas: {{ x.qtd_entregas if x.qtd_entregas is not none else 0 }},
          valorNum: {{ '%.2f'|format(x.valor or 0) }}
        });
        {% endfor %}

        const $ = s=>document.querySelector(s);
        const lista = $('#lanLista');
        const filtroForm = $('#lanFiltro');
        const kpiValor = $('#kpiGeralValor'), kpiEnt = $('#kpiGeralEntregas'), kpiCoops = $('#kpiGeralCoops'), kpiMediaDia = $('#kpiGeralMediaDia');

        function aplicar(){
          const di = filtroForm.data_inicio.value;
          const df = filtroForm.data_fim.value;
          const q  = (filtroForm.q.value||'').toLowerCase().trim();

          $('#txtLanPeriodo').textContent = (di?new Date(di).toLocaleDateString('pt-BR'):'') + (di&&df?' a ':'') + (df?new Date(df).toLocaleDateString('pt-BR'):'');

          let data = window.LANC_DATA.filter(r=>{
            const dOk = (!di || r.dataStr>=di) && (!df || r.dataStr<=df);
            const t = (r.coopNome+' '+r.contrato).toLowerCase();
            return dOk && (!q || t.includes(q));
          });

          const groups = {};
          data.forEach(r=>{ (groups[r.coopNome] = groups[r.coopNome] || []).push(r); });

          const totV = data.reduce((a,b)=>a+Number(b.valorNum||0),0);
          const totE = data.reduce((a,b)=>a+Number(b.entregas||0),0);
          const diasSet = new Set(data.map(r=>r.dataStr));
          kpiValor.textContent = brMoney(totV);
          kpiEnt.textContent = String(totE);
          kpiCoops.textContent = String(Object.keys(groups).length);
          kpiMediaDia.textContent = brMoney(diasSet.size? totV/diasSet.size : 0);

          lista.innerHTML = '';
          if(data.length===0){ lista.innerHTML = `<div class="lan-empty card">Sem lançamentos no período/filtro.</div>`; return; }

          Object.entries(groups).map(([nome, arr])=>{
            return {nome, arr, val:arr.reduce((a,b)=>a+Number(b.valorNum||0),0), ent:arr.reduce((a,b)=>a+Number(b.entregas||0),0)}
          }).sort((a,b)=>b.val-a.val).forEach(g=>{
            const byDay={}; g.arr.forEach(r=>{ (byDay[r.dataStr]=byDay[r.dataStr]||[]).push(r); });
            const days = Object.keys(byDay).sort();
            const id='acc_'+Math.random().toString(36).slice(2);
            const div=document.createElement('div'); div.className='lan-item';
            div.innerHTML=`
              <div class="lan-head" data-target="${id}" aria-expanded="false">
                <i class="bi bi-caret-down-square"></i>
                <div class="lan-name">${g.nome}</div>
                <div class="lan-pills">
                  <span class="pill"><i class="bi bi-box-seam"></i> Entregas: <b>${g.ent}</b></span>
                  <span class="pill">Total: <b>R$ ${brMoney(g.val)}</b></span>
                  <span class="pill"><i class="bi bi-calendar-event"></i> ${days.length} dia(s)</span>
                </div>
              </div>
              <div id="${id}" class="lan-body">
                ${days.map(d=>{
                  const itens=byDay[d].sort((a,b)=> (a.horaIni||'').localeCompare(b.horaIni||''));
                  const subV=itens.reduce((a,b)=>a+Number(b.valorNum||0),0);
                  const subE=itens.reduce((a,b)=>a+Number(b.entregas||0),0);
                  return `
                    <div class="lan-day">${fmtDia(d)}</div>
                    <table class="lan-table">
                      <thead><tr><th>Contrato</th><th>Horário</th><th class="text-end">Entregas</th><th class="text-end">Valor (R$)</th></tr></thead>
                      <tbody>
                        ${itens.map(r=>{
                          const h=(r.horaIni||r.horaFim)? `${r.horaIni||''} ${ (r.horaIni||r.horaFim)?'às':'' } ${r.horaFim||''}` : '—';
                          return `<tr><td>${r.contrato||'—'}</td><td>${h}</td><td class="text-end">${r.entregas||0}</td><td class="text-end">R$ ${brMoney(r.valorNum)}</td></tr>`;
                        }).join('')}
                      </tbody>
                      <tfoot><tr><th colspan="2" class="text-end">Subtotal do dia</th><th class="text-end">${subE}</th><th class="text-end">R$ ${brMoney(subV)}</th></tr></tfoot>
                    </table>`;
                }).join('')}
              </div>`;
            lista.appendChild(div);
          });

          document.querySelectorAll('.lan-head').forEach(h=>{
            h.addEventListener('click', ()=>{
              const t=document.getElementById(h.dataset.target);
              const open=t.classList.toggle('open');
              h.setAttribute('aria-expanded', open?'true':'false');
              h.querySelector('.bi').className = open ? 'bi bi-caret-up-square' : 'bi bi-caret-down-square';
            });
          });
        }

        document.getElementById('btnLanAplicar').addEventListener('click', aplicar);
        document.getElementById('btnLanLimpar').addEventListener('click', ()=>{
          filtroForm.data_inicio.value=''; filtroForm.data_fim.value=''; filtroForm.q.value='';
          document.getElementById('txtLanPeriodo').textContent='—'; aplicar();
        });
        document.getElementById('btnLanExpandAll').addEventListener('click', ()=>{
          document.querySelectorAll('.lan-body').forEach(b=>b.classList.add('open'));
          document.querySelectorAll('.lan-head .bi').forEach(i=>i.className='bi bi-caret-up-square');
        });
        document.getElementById('btnLanCollapseAll').addEventListener('click', ()=>{
          document.querySelectorAll('.lan-body').forEach(b=>b.classList.remove('open'));
          document.querySelectorAll('.lan-head .bi').forEach(i=>i.className='bi bi-caret-down-square');
        });
        document.getElementById('btnLanCsv').addEventListener('click', ()=>{
          const di=filtroForm.data_inicio.value, df=filtroForm.data_fim.value, q=(filtroForm.q.value||'').toLowerCase().trim();
          const data = window.LANC_DATA.filter(r=>{
            const dOk=(!di || r.dataStr>=di) && (!df || r.dataStr<=df);
            const t=(r.coopNome+' '+r.contrato).toLowerCase();
            return dOk && (!q || t.includes(q));
          });
          const linhas=[['Data','Cooperado','Contrato','Horário','Entregas','Valor (R$)']];
          data.forEach(r=>{
            const h=(r.horaIni||r.horaFim)? `${r.horaIni||''} ${ (r.horaIni||r.horaFim)?'às':'' } ${r.horaFim||''}` : '—';
            linhas.push([r.dataBr, r.coopNome, r.contrato||'—', h, String(r.entregas||0), brMoney(r.valorNum)]);
          });
          const csv='\uFEFF'+linhas.map(l=>l.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');
          const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
          a.href=URL.createObjectURL(blob); a.download='lancamentos.csv'; a.click(); URL.revokeObjectURL(a.href);
        });

        aplicar();
      }

      /* ================= Lançar (seleção mostra foto ao lado + avaliação) ================= */
      if(!['escalas','config','avisos','lancamentos'].includes(viewNow)){
        const busca=document.getElementById('buscaCoop');
        const itens=[...document.querySelectorAll('.coop-item')];
        const header=document.getElementById('headerSel');
        const hint=document.getElementById('hintSelecione');
        const form=document.getElementById('formLancamento');
        const inputCoopId=document.getElementById('inputCooperadoId');
        const selFoto=document.getElementById('selFoto');
        const selNome=document.getElementById('selNome');
        const selTotal=document.getElementById('selTotal');

        function mostrarCoop(el){
          inputCoopId.value=el.dataset.id;
          selFoto.src=el.dataset.foto; selNome.textContent=el.dataset.nome; selTotal.textContent=el.dataset.total;
          header.classList.remove('hidden'); form.classList.remove('hidden'); hint.classList.add('hidden');
          document.querySelectorAll('#blocoTabelas > .card').forEach(t=>t.classList.add('hidden'));
          const tb=document.getElementById('tabela-'+el.dataset.id); if(tb) tb.classList.remove('hidden');
          wireStars(); autoGeral();
        }
        itens.forEach(el=> el.addEventListener('click', ()=>mostrarCoop(el)));
        busca?.addEventListener('input', function(){ const q=this.value.toLowerCase().trim(); itens.forEach(el=>{ el.style.display=(el.dataset.nome||'').toLowerCase().includes(q)?'':'none'; }); });

        // Avaliação
        const chk=document.getElementById('chkAvaliar');
        const box=document.getElementById('boxAval');
        const inputAval=document.getElementById('inputAvaliar');
        chk?.addEventListener('change', ()=>{ const on=chk.checked; box.classList.toggle('hidden', !on); inputAval.value = on?'1':'0'; });

        function paintStars(stars, v){ stars.forEach(s=>{ const on=Number(s.dataset.v)<=v; s.classList.toggle('active',on); }); }
        function wireStars(){
          document.querySelectorAll('.stars').forEach(st=>{
            const name=st.getAttribute('data-name');
            let hidden = document.querySelector(`input[name="${name}"]`);
            if(!hidden){ hidden=document.createElement('input'); hidden.type='hidden'; hidden.name=name; st.parentElement.appendChild(hidden); }
            const stars=st.querySelectorAll('.star');
            stars.forEach(s=>{
              s.addEventListener('mouseenter',()=>paintStars(stars, Number(s.dataset.v)));
              s.addEventListener('mouseleave',()=>paintStars(stars, Number(hidden.value||0)));
              s.addEventListener('click',()=>{ hidden.value=Number(s.dataset.v); paintStars(stars, hidden.value); st.dataset.userSet='1'; autoGeral(); });
            });
            paintStars(stars, Number(hidden.value||0));
          });
        }
        function autoGeral(){
          const g=document.querySelector('.stars[data-name="av_geral"]'); if(!g) return;
          if(g.dataset.userSet==='1') return;
          const names=['av_pontualidade','av_educacao','av_eficiencia'];
          const vals=[];
          names.forEach(n=>{
            const v = Number((document.querySelector(`input[name="${n}"]`)||{}).value||0);
            if(v>0) vals.push(v);
          });
          if(vals.length){
            const media=Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
            const hidden=document.querySelector('input[name="av_geral"]'); hidden.value=media;
            paintStars(g.querySelectorAll('.star'), media);
          }
        }
      }

      // Toast novos avisos
      const unread = Number(`{{ _toast_unread }}`);
      if(unread>0){ const t=document.getElementById('toastAvisos'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 8000); }
    });
  </script>
</body>
</html>
