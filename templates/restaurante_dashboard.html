<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Portal do Estabelecimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --royal:#2141d9; --royal-2:#3654e6; --royal-3:#eaf0ff;
      --ink:#0b1220; --muted:#6b7280; --soft:#f5f7ff; --danger:#e74c3c; --ok:#16a34a;
      --border:#e6e9f2; --chip:#eef1ff; --card:#fff; --bg:#fff; --text:#111827;
      --aside-grad1: var(--royal); --aside-grad2: var(--royal-2);
    }
    /* Dark theme */
    :root[data-theme="dark"]{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a;
      --border:#1f2a44; --chip:#132040; --royal:#3b82f6; --royal-2:#2563eb; --royal-3:#0b2447;
      --aside-grad1:#0b2a6b; --aside-grad2:#143d86;
    }

    html,body{ height:100%; }
    body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; }
    a{ text-decoration:none; }
    .shell{ display:grid; grid-template-columns: 260px 1fr; min-height:100vh; }
    .aside{
      background:linear-gradient(180deg, var(--aside-grad1) 0%, var(--aside-grad2) 100%);
      color:#fff; padding:18px 16px; position:sticky; top:0; height:100dvh;
    }
    .brand{ font-weight:800; letter-spacing:.5px; font-size:1.15rem; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.08); display:flex; align-items:center; gap:8px; }
    .theme-toggle{ margin-top:10px; border:1px solid rgba(255,255,255,.25); color:#fff; background:rgba(255,255,255,.06); border-radius:10px; padding:10px 12px; display:flex; align-items:center; gap:8px; cursor:pointer; }
    .navmenu{ margin-top:18px; display:flex; flex-direction:column; gap:6px; }
    .navmenu a{ color:#fff; padding:10px 12px; border-radius:10px; display:flex; align-items:center; gap:10px; font-weight:600; position:relative; }
    .navmenu a.active, .navmenu a:hover{ background:rgba(255,255,255,.14); }
    .content{ padding:24px clamp(14px,3vw,32px); }
    .section-title{ color:var(--royal); font-weight:800; font-size:1.25rem; display:flex; gap:10px; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 0 #0000000a; }
    .card-soft{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .chip{ background:var(--chip); color:var(--text); border:1px solid var(--border); border-radius:999px; padding:.2rem .65rem; font-weight:700; }
    .table{ color:var(--text); }
    .table thead th{ border-color:var(--border); }
    .table td,.table th{ border-color:var(--border); }
    .table-secondary{ background:rgba(0,0,0,.04); }
    :root[data-theme="dark"] .table-secondary{ background:#111827; color:#e5e7eb; }

    .table-compact th,.table-compact td{ padding:.5rem .6rem; }
    .btn-royal{ background:var(--royal); color:#fff; border:none; }
    .btn-royal:hover{ background:var(--royal-2); color:#fff; }
    .btn-outline-royal{ border:1px solid var(--royal); color:#fff; background:transparent; }
    .btn-outline-royal:hover{ background:var(--royal); color:#fff; }
    .btn-outline-danger{ color:#e74c3c; border-color:#e74c3c; }
    .btn-outline-danger:hover{ background:#e74c3c; color:#fff; }

    .cooperado-avatar{ width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 0 #0001; }
    .cooperado-item{ display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer; }
    .cooperado-item:hover{ background:#f8faff20; }
    .cooperado-item.selected{ outline:2px solid var(--royal); background:#1d4ed820; }
    .selected-header .big{ width:180px; height:180px; border-radius:50%; object-fit:cover; border:6px solid var(--royal); box-shadow:0 6px 16px #0002; }
    .rating-group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .rating-label{ width:160px; font-weight:700; color:var(--text); }
    .stars{ display:inline-flex; gap:3px; font-size:1.4rem; cursor:pointer; }
    .star{ color:#94a3b8; transition:transform .06s; }
    .star.active,.star.hover{ color:#fbbf24; }
    .star:active{ transform:scale(.9); }
    .rating-group[data-name="av_geral"] .stars{ pointer-events:none; opacity:.95; }

    .sticky-tools{ position:sticky; top:12px; }
    .kpi{ background:#fafcff10; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .kpi .v{ font-weight:800; font-size:1.05rem; }

    /* SPA sections */
    section[data-view]{ display:none; }
    section.view-active{ display:block; }

    /* Badge avisos (bolinha) */
    .badge-dot{
      min-width:22px; height:22px; line-height:22px; border-radius:999px; padding:0 6px;
      font-size:.75rem; font-weight:800; display:inline-flex; align-items:center; justify-content:center;
      background:#dc3545; color:#fff; box-shadow:0 0 0 2px rgba(255,255,255,.25) inset; margin-left:auto;
    }

    @media (max-width: 920px){
      .shell{ grid-template-columns: 66px 1fr; }
      .brand span{ display:none; }
      .navmenu a span{ display:none; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ============ Aside ============ -->
    <aside class="aside">
      <div class="brand"><i class="bi bi-building"></i><span>Portal do Estabelecimento</span></div>
      <!-- Toggle tema -->
      <button id="btnTheme" class="theme-toggle" type="button"><i class="bi bi-moon"></i><span id="lblTheme">Escuro</span></button>

      <nav class="navmenu" id="sideNav">
        <!-- Cooperados (SPA) -->
        <a data-target="lancar"
           class="{{ 'active' if (view|default('lancar') not in ['escalas','config','avisos','lancamentos']) else '' }}"
           href="{{ url_for('portal_restaurante', view='lancar', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None) }}">
          <i class="bi bi-person-lines-fill"></i><span>Cooperados</span>
        </a>

        <!-- Lançamentos (SPA) -->
        <a data-target="lancamentos"
           class="{{ 'active' if view=='lancamentos' else '' }}"
           href="{{ url_for('portal_restaurante', view='lancamentos', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None, mes=filtro_mes if filtro_mes else None) }}">
          <i class="bi bi-receipt"></i><span>Lançamentos</span>
        </a>

        <!-- Escala (SPA) -->
        <a data-target="escalas"
           class="{{ 'active' if view=='escalas' else '' }}"
           href="{{ url_for('portal_restaurante', view='escalas') }}">
          <i class="bi bi-calendar-week"></i><span>Escala</span>
        </a>

        {% if session.get('user_tipo') == 'restaurante' %}
        <!-- Tabelas (NAVEGA PELO LINK — não interceptar) -->
        <a id="linkTabelas"
           class="{{ 'active' if request.endpoint=='rest_tabelas' else '' }}"
           href="{{ url_for('rest_tabelas') }}">
          <i class="bi bi-table"></i><span>Tabelas</span>
        </a>
        {% endif %}

        <!-- Configuração (SPA) -->
        <a data-target="config"
           class="{{ 'active' if view=='config' else '' }}"
           href="{{ url_for('portal_restaurante', view='config') }}">
          <i class="bi bi-gear"></i><span>Configuração</span>
        </a>

        <!-- Avisos (NAVEGA PELO LINK — não interceptar) -->
        <a id="linkAvisos"
           class="{{ 'active' if request.endpoint=='portal_restaurante_avisos' or view=='avisos' else '' }}"
           href="{{ url_for('portal_restaurante_avisos') }}">
          <i class="bi bi-megaphone"></i><span>Avisos</span>
          {% set _cntAvisos = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
          {% if _cntAvisos > 0 %}<span class="badge-dot">{{ _cntAvisos }}</span>{% endif %}
        </a>

        <!-- Sair (link normal) -->
        <a href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
      </nav>
    </aside>

    <!-- ============ Main ============ -->
    <main class="content">

      {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
          <div class="mb-3">
            {% for cat, msg in msgs %}
              <div class="alert alert-{{ 'danger' if cat=='error' else cat }} py-2 px-3 mb-2">{{ msg|safe }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {# cópias seguras (SPA) #}
      {% set _dias_list = dias_list if dias_list is defined and dias_list is not none else [] %}
      {% set _agenda = agenda if agenda is defined and agenda is not none else {} %}
      {% set _ref_data = ref_data if ref_data is defined and ref_data is not none else (now() if false else None) %}
      {% set _modo = modo if modo is defined and modo is not none else 'semana' %}
      {% set _cooperados = cooperados if cooperados is defined and cooperados is not none else [] %}
      {% set _lancamentos_periodo = lancamentos_periodo if lancamentos_periodo is defined and lancamentos_periodo is not none else [] %}
      {% set _url_lancar_producao = url_lancar_producao if url_lancar_producao is defined else url_for('portal_restaurante') %}

      <!-- CONFIG (SPA) -->
      <section data-view="config">
        <div class="section-title"><i class="bi bi-shield-lock"></i> Configuração</div>
        <div class="card card-body">
          <form class="row g-3 form-password" method="POST" action="{{ url_for('rest_alterar_senha') }}">
            <div class="col-md-4">
              <label class="form-label">Senha atual</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_atual" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_nova" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
              <div class="form-text">Mínimo de 6 caracteres.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Confirmar nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_conf" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-12 text-end"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
          </form>
        </div>
      </section>

      <!-- ESCALAS (SPA) -->
      <section data-view="escalas">
        <div class="section-title"><i class="bi bi-calendar-week"></i> Escala semanal</div>
        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
            <input type="hidden" name="view" value="escalas">
            <div class="col-md-3">
              <label class="form-label">Ver</label>
              <select name="modo" class="form-select">
                <option value="semana" {{ 'selected' if (_modo=='semana') }}>Semana completa</option>
                <option value="dia" {{ 'selected' if (_modo=='dia') }}>Somente 1 dia</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Referência</label>
              <input type="date" name="ref" class="form-control" value="{{ _ref_data and _ref_data.strftime('%Y-%m-%d') }}">
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='escalas') }}"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
            </div>
          </form>

          {% if _modo == 'semana' %}
          <hr class="my-3">
          <div class="row g-3">
            {% for dia in _dias_list %}
            <div class="col-md-6 col-lg-4">
              <div class="card-soft">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge text-bg-primary fw-semibold">{{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][dia.weekday()] }} — {{ dia.strftime('%d/%m/%Y') }}</span>
                  <i class="bi bi-people"></i>
                </div>
                <div style="max-height:360px; overflow:auto; border-top:1px dashed var(--border);">
                  {% set lista = _agenda.get(dia, []) %}
                  {% if lista %}
                    {% for grupo in (lista | groupby('contrato')) %}
                      {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                      <div class="fw-bold mt-2">{{ contrato_nome }}</div>
                      {% for item in grupo.list %}
                        <div class="py-2 border-bottom">
                          <div class="fw-bold">{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</div>
                          <div class="text-muted small">{{ item.turno or '—' }}{% if item.horario %} • {{ item.horario }}{% endif %}</div>
                        </div>
                      {% endfor %}
                    {% endfor %}
                  {% else %}
                    <div class="text-muted small py-2">Sem escala registrada.</div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <hr class="my-3">
          <div class="card-soft">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge text-bg-primary fw-semibold">{{ _ref_data and ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][_ref_data.weekday()] }} — {{ _ref_data and _ref_data.strftime('%d/%m/%Y') }}</span>
              <i class="bi bi-calendar-day"></i>
            </div>
            <table class="table table-bordered table-hover align-middle table-compact">
              <thead><tr><th>Contrato</th><th>Cooperado</th><th>Turno</th><th>Horário</th></tr></thead>
              <tbody>
                {% set lista = _agenda.get(_ref_data, []) if _ref_data else [] %}
                {% if lista %}
                  {% for grupo in (lista | groupby('contrato')) %}
                    {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                    {% for item in grupo.list %}
                    <tr>
                      <td>{{ contrato_nome }}</td>
                      <td>{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</td>
                      <td>{{ item.turno or '—' }}</td>
                      <td>{{ item.horario or '—' }}</td>
                    </tr>
                    {% endfor %}
                  {% endfor %}
                {% else %}
                <tr><td colspan="4" class="text-center text-muted">Sem escala registrada.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- AVISOS (render local para SPA quando vier do backend; link do menu navega) -->
      <section data-view="avisos">
        {% set _avisos = avisos if avisos is defined and avisos is not none else [] %}
        {% set _unread_from_list = (_avisos | selectattr('lido','equalto',False) | list | length) %}
        {% set _unread_from_ctx = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
        <div class="section-title">
          <i class="bi bi-megaphone-fill"></i> Avisos
          {% set _badgeN = (_unread_from_list if _unread_from_list>0 else _unread_from_ctx) %}
          <span id="badgeTitulo" class="badge {{ 'text-bg-danger' if _badgeN>0 else 'text-bg-success' }} ms-2">
            {{ _badgeN>0 and (_badgeN ~ ' não lido(s)') or 'Tudo lido' }}
          </span>
        </div>

        <div class="card card-body">
          <div class="d-flex align-items-center gap-2">
            <form method="POST" action="{{ url_for('marcar_todos_avisos_lidos_restaurante') }}" class="m-0">
              <button class="btn btn-royal" type="submit" {% if _badgeN == 0 %}disabled{% endif %}>
                <i class="bi bi-check2-circle me-1"></i> Marcar todos como lidos
              </button>
            </form>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="toggleNaoLidos">
              <label class="form-check-label" for="toggleNaoLidos">Mostrar apenas não lidos</label>
            </div>
          </div>
        </div>

        {% if _unread_from_ctx > 0 and (_avisos | length) == 0 %}
          <div class="alert alert-warning mt-3">
            Existem {{ _unread_from_ctx }} aviso(s) não lido(s), porém nenhum item foi carregado nesta página.
            Verifique se a rota está preenchendo a variável <code>avisos</code> para este restaurante.
          </div>
        {% endif %}

        {% if _avisos and (_avisos | length) > 0 %}
          {% for a in _avisos %}
          <div id="aviso-{{ a.id }}" class="card card-body my-2 aviso-card {% if a.lido %}lido{% endif %} {% if a.prioridade_alta %}prioridade{% endif %}" data-lido="{{ '1' if a.lido else '0' }}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">
                  {{ a.titulo or 'Aviso' }}
                  {% if a.prioridade_alta %}<span class="badge text-bg-danger ms-2"><i class="bi bi-exclamation-triangle-fill"></i> Prioridade</span>{% endif %}
                </div>
                <div class="text-muted small">
                  Publicado em {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em }}
                  {% if a.lido %} • <span class="text-success">Lido</span>{% else %} • <span class="text-danger">Não lido</span>{% endif %}
                </div>
              </div>
              <div class="ms-3">
                {% if not a.lido %}
                <button class="btn btn-outline-royal btn-sm"
                        data-acao="marcar-lido"
                        data-id="{{ a.id }}"
                        data-url="{{ url_for('marcar_aviso_lido_universal', aviso_id=a.id) }}">
                  <i class="bi bi-check2"></i> Marcar como lido
                </button>
                {% endif %}
              </div>
            </div>
            <hr class="my-2">
            <div class="aviso-body">{{ a.corpo_html | safe if a.corpo_html else (a.conteudo or a.texto or '') }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="card card-body"><div class="text-muted"><i class="bi bi-inbox me-1"></i> Nenhum aviso disponível.</div></div>
        {% endif %}
      </section>

      <!-- LANCAMENTOS (SPA) -->
      <section data-view="lancamentos">
        <div class="section-title"><i class="bi bi-receipt"></i> Lançamentos</div>

        <div class="row g-3">
          <div class="col-lg-3">
            <div class="card card-body sticky-tools">
              <form id="formFiltroLanc"
                    method="GET"
                    action="{{ url_for('portal_restaurante') }}"
                    class="row g-2 align-items-end">
                <input type="hidden" name="view" value="lancamentos">

                <div class="col-12">
                  <label class="form-label">Início</label>
                  <input type="date" class="form-control" name="data_inicio"
                         value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
                </div>

                <div class="col-12">
                  <label class="form-label">Fim</label>
                  <input type="date" class="form-control" name="data_fim"
                         value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
                </div>

                <div class="col-12">
                  <label class="form-label">Mês (opcional)</label>
                  <input type="month" class="form-control" name="mes"
                         value="{{ filtro_mes or '' }}"
                         oninput="if(this.value){ const f=this.form; f.data_inicio.value=''; f.data_fim.value=''; }">
                  <div class="form-text">Se escolher um mês, as datas serão ignoradas.</div>
                </div>

                <div class="col-12">
                  <label class="form-label">Digite o nome do cooperado (visual)</label>
                  <input type="text" class="form-control" name="q" placeholder="Filtrar por nome...">
                </div>

                <div class="col-12 d-grid">
                  <button class="btn btn-royal" type="submit">
                    <i class="bi bi-funnel"></i> Aplicar
                  </button>
                </div>

                <div class="col-12 d-grid">
                  <a class="btn btn-outline-secondary"
                     href="{{ url_for('portal_restaurante', view='lancamentos') }}">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpar
                  </a>
                </div>

                <hr class="my-2">
                <div class="kpi mb-2"><div class="small text-muted">Total no período</div><div class="v">R$ <span id="kpiTotalValor">0,00</span></div></div>
                <div class="kpi mb-2"><div class="small text-muted">Entregas no período</div><div class="v"><span id="kpiTotalEntregas">0</span></div></div>

                <div class="d-grid"><button class="btn btn-outline-royal" type="button" id="btnExportCsv"><i class="bi bi-download"></i> Exportar CSV</button></div>
              </form>
            </div>
          </div>

          <div class="col-lg-9">
            <div class="card card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="chip">
                  Período: <span id="txtPeriodo">
                    {{ filtro_inicio and filtro_inicio.strftime('%d/%m/%Y') or '' }}
                    {% if filtro_inicio and filtro_fim %} a {% endif %}
                    {{ filtro_fim and filtro_fim.strftime('%d/%m/%Y') or '' }}
                  </span>
                </div>
                <div class="small text-muted"></div>
              </div>

              <table class="table table-bordered table-hover align-middle table-compact" id="tblLanc">
                <thead>
                  <tr>
                    <th class="text-center" style="width:110px;">Data</th>
                    <th>Cooperado</th>
                    <th>Contrato</th>
                    <th class="text-center" style="width:160px;">Horário</th>
                    <th class="text-center" style="width:120px;">Entregas</th>
                    <th class="text-end" style="width:140px;">Valor (R$)</th>
                  </tr>
                </thead>
                <tbody id="tbodyLanc">
                  {% for x in _lancamentos_periodo %}
                  <tr data-coop="{{ x.cooperado_id or x.coop_id }}"
                      data-coopnome="{{ x.cooperado_nome or x.coop_nome }}"
                      data-contrato="{{ x.contrato_nome or x.contrato }}">
                    <td class="text-center">{{ (x.data.strftime('%d/%m/%Y') if x.data) if x.data is not string else x.data }}</td>
                    <td class="fw-semibold coop-name">{{ x.cooperado_nome or x.coop_nome }}</td>
                    <td>{{ x.contrato_nome or x.contrato or '—' }}</td>
                    <td class="text-center">
                      {% if x.hora_inicio or x.hora_fim %}
                        {{ x.hora_inicio or '' }}{% if x.hora_inicio or x.hora_fim %} às {% endif %}{{ x.hora_fim or '' }}
                      {% else %}—{% endif %}
                    </td>
                    <td class="text-center">{{ x.qtd_entregas if x.qtd_entregas is not none else '-' }}</td>
                    <td class="text-end valor" data-valor="{{ '%.2f'|format(x.valor or 0) }}">R$ {{ '%.2f'|format(x.valor or 0) }}</td>
                  </tr>
                  {% else %}{% endfor %}
                </tbody>
                <tfoot>
                  <tr class="table-secondary">
                    <th colspan="4" class="text-end">Totais</th>
                    <th class="text-center" id="ftEntregas">0</th>
                    <th class="text-end" id="ftValor">R$ 0,00</th>
                  </tr>
                </tfoot>
              </table>

              <hr class="my-3">
              <h6 class="mb-2"><i class="bi bi-people"></i> Totais por cooperado</h6>
              <div id="gridCoop" class="row g-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- LANÇAR (SPA) -->
      <section data-view="lancar">
        <div class="section-title"><i class="bi bi-plus-circle"></i> Lançar Produção Diária</div>

        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
            <input type="hidden" name="view" value="lancar">
            <div class="col-md-3">
              <label class="form-label">Início</label>
              <input type="date" name="data_inicio" class="form-control" value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fim</label>
              <input type="date" name="data_fim" class="form-control" value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
            </div>
            <div class="col-md-3">
              <div class="small text-muted mb-1">Período em uso</div>
              <div class="chip">
                {% if filtro_inicio and filtro_fim %}
                  {{ filtro_inicio.strftime('%d/%m/%Y') }} a {{ filtro_fim.strftime('%d/%m/%Y') }}
                {% else %} — {% endif %}
              </div>
            </div>
            <div class="col-md-3 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='lancar') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
            </div>
          </form>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-4">
            <div class="card card-body">
              <div class="input-group mb-2">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="buscaCoop" type="text" class="form-control" placeholder="Buscar cooperado..." list="cooperadosList">
                <datalist id="cooperadosList">{% for coop in _cooperados %}<option value="{{ coop.nome }}"></option>{% endfor %}</datalist>
                <select id="selectCoop" class="form-select"><option value="">Lista...</option>{% for coop in _cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}</select>
              </div>
              <div id="listaCooperados" style="max-height:60vh; overflow:auto;">
                {% for coop in _cooperados %}
                <div class="cooperado-item" data-id="{{ coop.id }}" data-nome="{{ coop.nome }}"
                     data-foto="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
                     data-total="{{ '%.2f'|format(coop.total_periodo or 0) }}">
                  <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}" class="cooperado-avatar" alt="">
                  <div class="d-flex flex-column">
                    <span class="fw-bold">{{ coop.nome }}</span>
                    <small class="text-muted">No período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</small>
                  </div>
                </div>
                {% else %}<div class="text-muted small">Nenhum cooperado encontrado.</div>{% endfor %}
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card card-body" id="blocoLancamento">
              <div class="selected-header text-center mb-2" id="selectedHeader" style="display:none;">
                <img id="selFoto" src="" class="big" alt="">
                <div class="fw-bold fs-5 mt-2" id="selNome"></div>
                <div class="text-muted">Total no período: R$ <span id="selTotal">0,00</span></div>
              </div>

              <div class="alert alert-info py-2 px-3 mb-2" id="hintSelecione">
                Selecione um cooperado para lançar.
              </div>

              <!-- FORM -->
              <form id="formLancamento" method="POST" action="{{ _url_lancar_producao }}" class="row g-2 align-items-end mb-1" style="display:none;">
                <input type="hidden" name="cooperado_id" id="inputCooperadoId" value="">
                <div class="col-md-3"><label class="form-label">Valor (R$)</label><input type="number" class="form-control" name="valor" step="0.01" required></div>
                <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" name="data" required></div>
                <div class="col-md-3"><label class="form-label">Hora Início</label><input type="time" class="form-control" name="hora_inicio"></div>
                <div class="col-md-3"><label class="form-label">Hora Fim</label><input type="time" class="form-control" name="hora_fim"></div>
                <div class="col-md-3"><label class="form-label">Entregas</label><input type="number" class="form-control" name="qtd_entregas" min="0" step="1"></div>

                <div class="col-12"><hr class="my-2"></div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkAvaliar"
                      onclick="document.getElementById('boxAval').style.display=this.checked?'block':'none'; document.getElementById('inputAvaliar').value=this.checked?'1':'0';">
                    <label class="form-check-label" for="chkAvaliar">Registrar avaliação agora</label>
                  </div>
                  <input type="hidden" name="avaliar" id="inputAvaliar" value="0">
                </div>

                <div id="boxAval" class="row g-2" style="display:none;">
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_geral" data-auto="true">
                      <div class="rating-label">Geral (média automática)</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i>
                        <i class="bi bi-star-fill star" data-v="2"></i>
                        <i class="bi bi-star-fill star" data-v="3"></i>
                        <i class="bi bi-star-fill star" data-v="4"></i>
                        <i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_geral" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_pontualidade">
                      <div class="rating-label">Pontualidade</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_pontualidade" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_educacao">
                      <div class="rating-label">Educação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_educacao" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_eficiencia">
                      <div class="rating-label">Eficiência / Cuidado</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_eficiencia" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_apresentacao">
                      <div class="rating-label">Apresentação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_apresentacao" value="">
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Comentário (opcional)</label>
                    <textarea class="form-control" name="av_comentario" rows="2" placeholder="Conte rapidamente como foi a experiência..."></textarea>
                  </div>
                </div>

                <div class="col-12 text-end mt-2"><button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button></div>
              </form>
              <!-- /FORM -->
            </div>

            <div id="blocoTabelas" class="mt-2">
              {% for coop in _cooperados %}
              <div id="tabela-{{ coop.id }}" class="card card-body lancamentos-table" style="display:none;">
                <table class="table table-bordered table-hover align-middle table-compact">
                  <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th>Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
                  <tbody>
                    {% for lanc in coop.lancamentos %}
                    <tr>
                      <td>R$ {{ '%.2f'|format(lanc.valor or 0) }}</td>
                      <td>{{ lanc.data.strftime('%d/%m/%Y') if lanc.data }}</td>
                      <td>{{ lanc.hora_inicio or '' }}{% if lanc.hora_inicio or lanc.hora_fim %} às {% endif %}{{ lanc.hora_fim or '' }}</td>
                      <td>{{ lanc.qtd_entregas if lanc.qtd_entregas is not none else '-' }}</td>
                      <td>{% if has_editar_lanc %}<a href="{{ url_for('editar_lancamento', id=lanc.id) }}" class="btn btn-outline-royal btn-sm"><i class="bi bi-pencil"></i></a>{% endif %}</td>
                      <td><a href="{{ url_for('excluir_lancamento', id=lanc.id) }}" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a></td>
                    </tr>
                    {% else %}<tr><td colspan="6" class="text-center text-muted">Nenhum lançamento no período selecionado</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </section>
      <!-- /sections -->
    </main>
  </div>

  <!-- TOAST novos avisos -->
  {% set _avisos_for_toast = avisos if avisos is defined and avisos is not none else [] %}
  {% set _unread_from_list_t = (_avisos_for_toast | selectattr('lido','equalto',False) | list | length) %}
  {% set _unread_from_ctx_t = (avisos_nao_lidos_count if avisos_nao_lidos_count is defined else avisos_unread_count) or 0 %}
  {% set _toast_unread = _unread_from_list_t if _unread_from_list_t>0 else _unread_from_ctx_t %}
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055;">
    <div id="toastAvisos" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="8000">
      <div class="toast-header">
        <i class="bi bi-megaphone-fill me-2"></i><strong class="me-auto">Novos avisos</strong><small>agora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
      <div class="toast-body">
        Você tem {{ _toast_unread }} aviso(s) não lido(s). <a href="{{ url_for('portal_restaurante_avisos') }}" class="link-primary fw-semibold">Ver agora</a>
      </div>
    </div>
  </div>

  <!-- TOAST OK -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1056;">
    <div id="toastOK" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="2200">
      <div class="toast-header">
        <i class="bi bi-check2-circle text-success me-2"></i><strong class="me-auto">Pronto</strong><small>agora</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
      <div class="toast-body">Aviso marcado como lido.</div>
    </div>
  </div>

  <!-- Modal Avaliação -->
  <div class="modal fade" id="modalAval" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-stars me-1"></i> Deseja avaliar agora?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button></div>
        <div class="modal-body">Você pode registrar a avaliação do cooperado agora ou enviar o lançamento sem avaliação.</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="btnPularAval">Pular e enviar</button>
          <button type="button" class="btn btn-royal" id="btnAvaliarAgora">Avaliar agora</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== Tema (Claro/Escuro) ===== */
    const THEME_KEY='portal_theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
      const lbl=document.getElementById('lblTheme'); const icon=document.querySelector('#btnTheme i');
      if(lbl) lbl.textContent = (t==='dark')?'Claro':'Escuro';
      if(icon){ icon.classList.toggle('bi-moon', t!=='dark'); icon.classList.toggle('bi-sun', t==='dark'); }
      localStorage.setItem(THEME_KEY, t);
    }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(saved);
      document.getElementById('btnTheme')?.addEventListener('click', ()=>{
        const cur = localStorage.getItem(THEME_KEY) || 'light';
        applyTheme(cur==='dark'?'light':'dark');
      });
    })();

    /* ===== Utils ===== */
    function togglePwd(btn){
      const i = btn.previousElementSibling; if(!i) return;
      i.type = i.type==='password'?'text':'password';
      btn.querySelector('i').classList.toggle('bi-eye');
      btn.querySelector('i').classList.toggle('bi-eye-slash');
    }
    const brMoney = (n)=> (n||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const todayStr = ()=>{ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return d.getFullYear()+'-'+mm+'-'+dd; };

    /* ===== SPA Core (não intercepta Tabelas e Avisos) ===== */
    function showSection(view){
      document.querySelectorAll('section[data-view]').forEach(sec=>{
        sec.classList.toggle('view-active', sec.getAttribute('data-view')===view);
      });
      document.querySelectorAll('#sideNav a[data-target]').forEach(a=>{
        a.classList.toggle('active', a.getAttribute('data-target')===view);
      });
      if (view==='avisos') initAvisos();
      if (view==='lancamentos') initLancamentos();
      if (view==='lancar') initLancar();
      if (view==='escalas'){} if(view==='config'){}
    }
    function pushView(view){
      const u = new URL(window.location.href);
      u.searchParams.set('view', view);
      history.pushState({view}, '', u.toString());
    }
    function startView(){
      const u = new URL(window.location.href);
      return u.searchParams.get('view') || 'lancar';
    }

    /* ===== Avaliação (Geral = média automática) ===== */
    function paintStars(stars, v, hover=false){
      stars.forEach(s=>{
        const on = Number(s.dataset.v) <= v;
        s.classList.toggle('active', on);
        s.classList.toggle('hover', hover && on);
      });
    }
    function wireStarsClickable(group){
      const hidden = group.querySelector('input[type="hidden"]');
      const stars  = group.querySelectorAll('.star');
      stars.forEach(s=>{
        s.addEventListener('mouseenter',()=>paintStars(stars, Number(s.dataset.v), true));
        s.addEventListener('mouseleave',()=>paintStars(stars, Number(hidden.value||0), false));
        s.addEventListener('click',()=>{ hidden.value = Number(s.dataset.v); paintStars(stars, hidden.value, false); autoGeral(); });
      });
      paintStars(stars, Number(hidden.value||0), false);
    }
    function autoGeral(){
      const g = document.querySelector('.rating-group[data-name="av_geral"]');
      if(!g) return;
      const geralHidden = g.querySelector('input[type="hidden"]');
      const nomes = ['av_pontualidade','av_educacao','av_eficiencia','av_apresentacao'];
      const vals = [];
      nomes.forEach(n=>{
        const grp = document.querySelector(`.rating-group[data-name="${n}"]`);
        const v = Number(grp?.querySelector('input[type="hidden"]')?.value||0);
        if (v>0) vals.push(v);
      });
      const media = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
      geralHidden.value = media;
      paintStars(g.querySelectorAll('.star'), media, false);
    }

    /* ===== Lançar ===== */
    let lancarWired = false;
    function initLancar(){
      if (lancarWired) return; lancarWired = true;

      const busca = document.getElementById('buscaCoop');
      const select = document.getElementById('selectCoop');
      const itens = Array.from(document.querySelectorAll('.cooperado-item'));
      const form = document.getElementById('formLancamento');
      const hint = document.getElementById('hintSelecione');
      const header = document.getElementById('selectedHeader');
      const inputCoopId = document.getElementById('inputCooperadoId');
      const selFoto = document.getElementById('selFoto');
      const selNome = document.getElementById('selNome');
      const selTotal = document.getElementById('selTotal');

      function mostrarCooperado(el){
        if (!el) return;
        itens.forEach(i => i.classList.remove('selected')); el.classList.add('selected');
        inputCoopId.value = el.dataset.id;
        selFoto.src = el.dataset.foto; selNome.textContent = el.dataset.nome; selTotal.textContent = el.dataset.total;
        header.style.display = 'block'; form.style.display = 'flex'; hint.style.display = 'none';
        document.querySelectorAll('.lancamentos-table').forEach(t => t.style.display = 'none');
        const tabela = document.getElementById('tabela-' + el.dataset.id); if (tabela) tabela.style.display = 'block';
        document.querySelectorAll('.rating-group').forEach(g=>{
          if (g.dataset.name !== 'av_geral') wireStarsClickable(g);
        });
        autoGeral();
      }

      itens.forEach(el => el.addEventListener('click', () => mostrarCooperado(el)));
      busca?.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        itens.forEach(el => { el.style.display = (el.dataset.nome||'').toLowerCase().includes(q) ? '' : 'none'; });
      });
      select?.addEventListener('change', function(){ const el = itens.find(x=>x.dataset.id===this.value); if (el) mostrarCooperado(el); });
      const primeiro = itens[0]; if (primeiro) mostrarCooperado(primeiro);
    }

    /* ===== Avisos ===== */
    let avisosWired = false;
    function initAvisos(){
      if (avisosWired) return; avisosWired = true;
      const toastOKEl = document.getElementById('toastOK');
      const toastOK = toastOKEl ? new bootstrap.Toast(toastOKEl) : null;
      const badgeTitulo = document.getElementById('badgeTitulo');
      const badgeSidebar = document.querySelector('#linkAvisos .badge-dot');

      function getUnreadCount(){ return document.querySelectorAll('.aviso-card[data-lido="0"]').length; }
      function refreshBadges(){
        const n = getUnreadCount();
        if (badgeTitulo){
          badgeTitulo.className = 'badge ' + (n > 0 ? 'text-bg-danger' : 'text-bg-success');
          badgeTitulo.textContent = n > 0 ? (n + ' não lido(s)') : 'Tudo lido';
        }
        if (badgeSidebar){
          if (n>0){ badgeSidebar.style.display=''; badgeSidebar.textContent=n; }
          else { badgeSidebar.style.display='none'; }
        }
      }

      const toggleNaoLidos = document.getElementById('toggleNaoLidos');
      toggleNaoLidos?.addEventListener('change', () => {
        const onlyUnread = toggleNaoLidos.checked;
        document.querySelectorAll('.aviso-card').forEach(card => {
          const lido = card.getAttribute('data-lido') === '1';
          card.style.display = (onlyUnread && lido) ? 'none' : '';
        });
      });
      document.querySelectorAll('[data-acao="marcar-lido"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const url = btn.getAttribute('data-url'); const card = btn.closest('.aviso-card');
          try{
            const resp = await fetch(url, { method: 'POST' });
            if (resp.ok){
              card.setAttribute('data-lido','1'); card.classList.add('lido');
              const meta = card.querySelector('.text-muted.small'); if (meta) meta.innerHTML += ' • <span class="text-success">Lido</span>';
              btn.remove(); refreshBadges(); toastOK?.show();
            } else { alert('Não foi possível marcar como lido ('+resp.status+').'); }
          } catch(e){ alert('Falha de rede.'); }
        });
      });
      refreshBadges();

      const unread = Number(`{{ _toast_unread }}`);
      if (unread > 0) {
        const toastEl = document.getElementById('toastAvisos');
        if (toastEl) { const t = new bootstrap.Toast(toastEl); setTimeout(()=>t.show(), 600); }
      }
    }

    /* ===== Lançamentos ===== */
    let lancamentosWired = false;
    function initLancamentos(){
      if (lancamentosWired) return; lancamentosWired = true;
      const tbody  = document.getElementById('tbodyLanc'); if(!tbody) return;
      const ftValor= document.getElementById('ftValor');
      const ftEnt  = document.getElementById('ftEntregas');
      const kpiV   = document.getElementById('kpiTotalValor');
      const kpiE   = document.getElementById('kpiTotalEntregas');
      const grid   = document.getElementById('gridCoop');
      const f      = document.getElementById('formFiltroLanc');

      // se não houver período, seta hoje e envia (uma vez)
      const appliedKey='lanc_applied_today';
      if (f && !f.data_inicio.value && !f.data_fim.value && !f.mes.value && !sessionStorage.getItem(appliedKey)){
        const t=todayStr(); f.data_inicio.value=t; f.data_fim.value=t;
        sessionStorage.setItem(appliedKey,'1'); sessionStorage.setItem('scrollY', String(window.scrollY));
        f.submit(); return;
      }

      const savedY = Number(sessionStorage.getItem('scrollY')||0);
      if (savedY) { window.scrollTo(0, savedY); sessionStorage.removeItem('scrollY'); }
      const savedQ = sessionStorage.getItem('lanc_q')||'';
      if (savedQ && f?.q){ f.q.value=savedQ; }

      function getRows(){ return Array.from(tbody.querySelectorAll('tr')); }
      function recomputeTotals(){
        let totV=0, totE=0;
        const perCoop = {};
        getRows().forEach(tr=>{
          if (tr.style.display==='none') return;
          const v = Number(tr.querySelector('.valor')?.dataset.valor || 0);
          const eTxt = tr.cells[4]?.textContent?.trim() || '0';
          const e = eTxt==='-' ? 0 : Number(eTxt.replace(/\D+/g,''));
          totV += v; totE += e;
          const id = tr.dataset.coop, nm = tr.dataset.coopnome;
          perCoop[id] = perCoop[id] || {nome:nm, valor:0, ent:0};
          perCoop[id].valor += v; perCoop[id].ent += e;
        });
        ftValor.textContent = 'R$ ' + brMoney(totV);
        ftEnt.textContent   = String(totE);
        kpiV.textContent    = brMoney(totV);
        kpiE.textContent    = String(totE);

        grid.innerHTML = '';
        Object.values(perCoop).sort((a,b)=>b.valor-a.valor).forEach(p=>{
          const div = document.createElement('div'); div.className='col-sm-6 col-xl-4';
          div.innerHTML = `<div class="kpi h-100"><div class="fw-bold">${p.nome||'-'}</div>
            <div class="small text-muted">Entregas: <b>${p.ent||0}</b></div>
            <div>Total: <b>R$ ${brMoney(p.valor||0)}</b></div></div>`;
          grid.appendChild(div);
        });
      }

      f?.q?.addEventListener('input', ()=>{
        const q = (f.q.value||'').toLowerCase().trim();
        sessionStorage.setItem('lanc_q', q);
        getRows().forEach(tr=>{
          const coop = (tr.dataset.coopnome||'').toLowerCase();
          const contrato = (tr.dataset.contrato||'').toLowerCase();
          tr.style.display = (!q || coop.includes(q) || contrato.includes(q)) ? '' : 'none';
        });
        recomputeTotals();
      });

      f?.addEventListener('submit', ()=>{ sessionStorage.setItem('scrollY', String(window.scrollY)); });

      tbody.addEventListener('click', (e)=>{
        const td = e.target.closest('.coop-name'); if(!td) return;
        const nome = td.textContent.trim();
        getRows().forEach(r=>{
          r.classList.toggle('table-warning', r.querySelector('.coop-name')?.textContent.trim()===nome);
        });
      });

      document.getElementById('btnExportCsv')?.addEventListener('click', ()=>{
        const rows = getRows().filter(r=>r.style.display!=='none');
        const header = ['Data','Cooperado','Contrato','Horário','Entregas','Valor (R$)'];
        const linhas = [header];
        let totE = 0, totV = 0;
        rows.forEach(r=>{
          const c = r.cells;
          const entregas = (c[4].textContent.trim()==='-')?0:Number(c[4].textContent.replace(/\D+/g,''));
          const valorNum = Number(r.querySelector('.valor')?.dataset.valor || 0);
          linhas.push([c[0].textContent.trim(), c[1].textContent.trim(), c[2].textContent.trim(), c[3].textContent.trim(), String(entregas), valorNum.toFixed(2).replace('.',',')]);
          totE += entregas; totV += valorNum;
        });
        linhas.push(['Totais','','','', String(totE), totV.toFixed(2).replace('.',',')]);
        const csv = '\uFEFF' + linhas.map(l=>l.join(';')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='lancamentos.csv'; a.click(); URL.revokeObjectURL(a.href);
      });

      recomputeTotals();
      if (f?.q?.value) f.q.dispatchEvent(new Event('input'));
    }

    /* ===== Navegação SPA + Prefetch para Tabelas/Avisos ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // Intercepta apenas itens com data-target (não intercepta TABELAS nem AVISOS)
      document.getElementById('sideNav')?.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if (!a) return;
        const target = a.getAttribute('data-target');
        if (!target) return; // deixa links sem data-target navegarem normalmente
        if (target==='sair') return;
        e.preventDefault();
        showSection(target);
        pushView(target);
      });

      // Prefetch rápido para Tabelas e Avisos
      function prefetch(href){
        try{
          const l=document.createElement('link');
          l.rel='prefetch'; l.href=href; document.head.appendChild(l);
        }catch(e){}
      }
      document.getElementById('linkTabelas')?.addEventListener('mouseenter', e=>prefetch(e.currentTarget.href));
      document.getElementById('linkAvisos')?.addEventListener('mouseenter', e=>prefetch(e.currentTarget.href));

      const initial = startView();
      showSection(initial);

      window.addEventListener('popstate', (ev)=>{
        const v = (ev.state && ev.state.view) || startView();
        showSection(v);
      });

      // Toast de avisos se houver
      const unread = Number(`{{ _toast_unread }}`);
      if (unread > 0) {
        const toastEl = document.getElementById('toastAvisos');
        if (toastEl) { const t = new bootstrap.Toast(toastEl); setTimeout(()=>t.show(), 600); }
      }
    });
  </script>
</body>
</html>
