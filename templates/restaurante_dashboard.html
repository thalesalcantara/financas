<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Portal do Estabelecimento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --royal:#2141d9; --royal-2:#3654e6; --royal-3:#eaf0ff;
      --ink:#0b1220; --muted:#6b7280; --soft:#f5f7ff; --danger:#e74c3c; --ok:#16a34a;
      --border:#e6e9f2; --chip:#eef1ff; --card:#fff; --bg:#fff; --text:#111827;
      --aside-grad1: var(--royal); --aside-grad2: var(--royal-2);
    }
    :root[data-theme="dark"]{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4b2; --card:#0f172a;
      --border:#1f2a44; --chip:#132040; --royal:#3b82f6; --royal-2:#2563eb; --royal-3:#0b2447;
      --aside-grad1:#0b2a6b; --aside-grad2:#143d86;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    a{text-decoration:none}
    .shell{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
    .aside{
      background:linear-gradient(180deg,var(--aside-grad1) 0%,var(--aside-grad2) 100%);
      color:#fff; padding:18px 16px; position:sticky; top:0; height:100dvh;
    }
    .brand{font-weight:800; font-size:1.12rem; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.08); display:flex; align-items:center; gap:8px}
    .theme-toggle{margin-top:10px; border:1px solid rgba(255,255,255,.25); color:#fff; background:rgba(255,255,255,.06); border-radius:10px; padding:10px 12px; display:flex; align-items:center; gap:8px; cursor:pointer}
    .navmenu{margin-top:18px; display:flex; flex-direction:column; gap:6px}
    .navmenu a{color:#fff; padding:9px 11px; border-radius:10px; display:flex; align-items:center; gap:10px; font-weight:600; position:relative; font-size:.94rem}
    .navmenu a i{font-size:1rem}
    .navmenu a.active,.navmenu a:hover{background:rgba(255,255,255,.14)}
    .content{padding:24px clamp(14px,3vw,32px)}
    .section-title{color:var(--royal); font-weight:800; font-size:1.25rem; display:flex; gap:10px; align-items:center}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 0 #0000000a}
    .card-soft{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
    .chip{background:var(--chip); color:var(--text); border:1px solid var(--border); border-radius:999px; padding:.2rem .65rem; font-weight:700}
    .table{color:var(--text)} .table td,.table th{border-color:var(--border)} .table thead th{border-color:var(--border)}
    .table-compact th,.table-compact td{padding:.5rem .6rem}
    .btn-royal{background:var(--royal); color:#fff; border:none}
    .btn-royal:hover{background:var(--royal-2); color:#fff}
    .btn-outline-royal{border:1px solid var(--royal); color:var(--royal); background:transparent}
    .btn-outline-royal:hover{background:var(--royal); color:#fff}
    .btn-outline-danger{color:#e74c3c; border-color:#e74c3c}
    .btn-outline-danger:hover{background:#e74c3c; color:#fff}
    section[data-view]{display:none}
    section.view-active{display:block}
    .badge-dot{
      min-width:22px; height:22px; line-height:22px; border-radius:999px; padding:0 6px;
      font-size:.75rem; font-weight:800; display:inline-flex; align-items:center; justify-content:center;
      background:#dc3545; color:#fff; box-shadow:0 0 0 2px rgba(255,255,255,.25) inset; margin-left:auto;
    }
    @media (max-width:920px){ .shell{grid-template-columns:66px 1fr} .brand span{display:none} .navmenu a span{display:none} }
    .aviso-card{border-left:6px solid #3b82f6}
    .aviso-card.lido{border-left-color:#94a3b8; opacity:.98}
    .aviso-card.prioridade{border-left-color:var(--danger)}
    .cooperado-avatar{width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 1px 0 #0001}
    .cooperado-item{display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; cursor:pointer}
    .cooperado-item:hover{background:#f8faff20}
    .cooperado-item.selected{outline:2px solid var(--royal); background:#1d4ed820}
    .selected-header .big{width:180px; height:180px; border-radius:50%; object-fit:cover; border:6px solid var(--royal); box-shadow:0 6px 16px #0002}
    .rating-group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .rating-label{width:160px; font-weight:700}
    .stars{display:inline-flex; gap:3px; font-size:1.4rem; cursor:pointer}
    .star{color:#94a3b8; transition:transform .06s}
    .star.active,.star.hover{color:#fbbf24}
    .rating-group[data-name="av_geral"] .stars{pointer-events:none; opacity:.95}
    .sticky-tools{position:sticky; top:12px}
    .kpi{background:#fafcff10; border:1px solid var(--border); border-radius:12px; padding:10px 12px}
    .kpi .v{font-weight:800; font-size:1.05rem}
    .doc-row{border:1px solid var(--border); border-radius:16px; padding:14px 16px; background:var(--card); box-shadow:0 10px 28px #00000012; transition:transform .08s, box-shadow .12s; cursor:pointer}
    .doc-row:active{transform:scale(.995)} .doc-row:hover{box-shadow:0 12px 32px #00000018}
    .doc-title{font-weight:800; font-size:1.05rem}
    .doc-cat{font-size:.75rem; color:var(--royal); text-transform:uppercase; letter-spacing:.08em; font-weight:800}
    .doc-date{color:var(--muted); font-size:.9rem}
    .doc-desc{font-size:.95rem; color:var(--text); background:var(--soft); border-radius:10px; padding:.6em .9em}
    .stars-static{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;}
  </style>
</head>
<body>
  <div class="shell">
    <!-- ===== Aside ===== -->
    <aside class="aside">
      <div class="brand"><i class="bi bi-building"></i><span>Portal do Estabelecimento</span></div>
      <button id="btnTheme" class="theme-toggle" type="button"><i class="bi bi-moon"></i><span id="lblTheme">Escuro</span></button>

      <nav class="navmenu" id="sideNav">
        <a data-target="lancar" class="active" href="#"><i class="bi bi-person-lines-fill"></i><span>Cooperados</span></a>
        <a data-target="lancamentos" href="#"><i class="bi bi-receipt"></i><span>Lançamentos</span></a>
        <a data-target="escalas" href="#"><i class="bi bi-calendar-week"></i><span>Escala</span></a>
        <a data-target="tabelas" id="linkTabelas" href="#"><i class="bi bi-table"></i><span>Tabelas</span></a>
        <a data-target="config" href="#"><i class="bi bi-gear"></i><span>Configuração</span></a>
        <a href="#"><i class="bi bi-box-arrow-right"></i><span>Sair</span></a>
      </nav>
    </aside>

    <!-- ===== Main ===== -->
    <main class="content">
      <!-- ===== CONFIG ===== -->
      <section data-view="config">
        <div class="section-title"><i class="bi bi-shield-lock"></i> Configuração</div>
        <div class="card card-body">
          <form class="row g-3 form-password" method="POST" action="/alterar-senha">
            <div class="col-md-4">
              <label class="form-label">Senha atual</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_atual" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_nova" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
              <div class="form-text">Mínimo de 6 caracteres.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Confirmar nova senha</label>
              <div class="input-group">
                <input type="password" class="form-control" name="senha_conf" minlength="6" required>
                <button class="btn btn-outline-royal" type="button" onclick="togglePwd(this)"><i class="bi bi-eye"></i></button>
              </div>
            </div>
            <div class="col-12 text-end"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
          </form>
        </div>
      </section>

      <!-- ===== ESCALAS ===== -->
      <section data-view="escalas">
        <div class="section-title"><i class="bi bi-calendar-week"></i> Escala semanal</div>
        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="#">
            <input type="hidden" name="view" value="escalas">
            <div class="col-md-3">
              <label class="form-label">Ver</label>
              <select name="modo" class="form-select">
                <option value="semana" selected>Semana completa</option>
                <option value="dia">Somente 1 dia</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Referência</label>
              <input type="date" name="ref" class="form-control">
            </div>
            <div class="col-md-6 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="#"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
            </div>
          </form>
          <hr class="my-3">
          <div class="card-soft"><div class="text-muted">Exemplo de escala…</div></div>
        </div>
      </section>

      <!-- ===== AVISOS ===== -->
      <section data-view="avisos">
        <div class="section-title">
          <i class="bi bi-megaphone-fill"></i> Avisos
          <span id="badgeTitulo" class="badge text-bg-success ms-2">Tudo lido</span>
        </div>
        <div class="card card-body">
          <div class="d-flex align-items-center gap-2">
            <form method="POST" action="#" class="m-0">
              <button class="btn btn-royal" type="submit" disabled><i class="bi bi-check2-circle me-1"></i> Marcar todos como lidos</button>
            </form>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="toggleNaoLidos">
              <label class="form-check-label" for="toggleNaoLidos">Mostrar apenas não lidos</label>
            </div>
          </div>
        </div>
        <div id="avisosListContainer">
          <div class="card card-body text-muted">Nenhum aviso disponível.</div>
        </div>
      </section>

      <!-- ===== LANCAMENTOS ===== -->
      <section data-view="lancamentos">
        <div class="section-title"><i class="bi bi-receipt"></i> Lançamentos</div>
        <div class="row g-3">
          <div class="col-lg-3">
            <div class="card card-body sticky-tools">
              <form id="formFiltroLanc" method="GET" action="#" class="row g-2 align-items-end">
                <input type="hidden" name="view" value="lancamentos">
                <div class="col-12">
                  <label class="form-label">Início</label>
                  <input type="date" class="form-control" name="data_inicio">
                </div>
                <div class="col-12">
                  <label class="form-label">Fim</label>
                  <input type="date" class="form-control" name="data_fim">
                </div>
                <div class="col-12">
                  <label class="form-label">Mês (opcional)</label>
                  <input type="month" class="form-control" name="mes" oninput="if(this.value){ const f=this.form; f.data_inicio.value=''; f.data_fim.value=''; }">
                  <div class="form-text">Se escolher um mês, as datas serão ignoradas.</div>
                </div>
                <div class="col-12">
                  <label class="form-label">Digite o nome do cooperado (visual)</label>
                  <input type="text" class="form-control" name="q" placeholder="Filtrar por nome...">
                </div>
                <div class="col-12 d-grid"><button class="btn btn-royal" type="submit"><i class="bi bi-funnel"></i> Aplicar</button></div>
                <div class="col-12 d-grid"><a class="btn btn-outline-secondary" href="#"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a></div>
                <hr class="my-2">
                <div class="kpi mb-2"><div class="small text-muted">Total no período</div><div class="v">R$ <span id="kpiTotalValor">0,00</span></div></div>
                <div class="kpi mb-2"><div class="small text-muted">Entregas no período</div><div class="v"><span id="kpiTotalEntregas">0</span></div></div>
                <div class="d-grid"><button class="btn btn-royal" type="button" id="btnExportCsv"><i class="bi bi-download"></i> Exportar CSV</button></div>
                <div class="d-grid mt-2"><button class="btn btn-outline-royal" type="button" id="btnExportXlsx"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar XLSX (editável)</button></div>
              </form>
            </div>
          </div>

          <div class="col-lg-9">
            <div class="card card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="chip">Período: <span id="txtPeriodo"></span></div>
              </div>

              <table class="table table-bordered table-hover align-middle table-compact" id="tblLanc">
                <thead>
                  <tr>
                    <th class="text-center" style="width:110px;">Data</th>
                    <th>Cooperado</th>
                    <th>Contrato</th>
                    <th class="text-center" style="width:160px;">Horário</th>
                    <th class="text-center" style="width:120px;">Entregas</th>
                    <th class="text-end" style="width:140px;">Valor (R$)</th>
                    <th class="text-center" style="width:160px;">Avaliação</th>
                  </tr>
                </thead>
                <tbody id="tbodyLanc">
                  <tr data-id="101" data-coop="1" data-coopnome="João Silva" data-contrato="Contrato A"
                      data-avurl="/avaliar/101" data-getavurl="/avaliar/101/get">
                    <td class="text-center">03/10/2025</td>
                    <td class="fw-semibold coop-name">João Silva</td>
                    <td>Contrato A</td>
                    <td class="text-center">18:00 às 22:00</td>
                    <td class="text-center">12</td>
                    <td class="text-end valor" data-valor="120.00">R$ 120,00</td>
                    <td class="text-center" data-avcell>
                      <button class="btn btn-outline-royal btn-sm" data-open-av><i class="bi bi-star"></i> Avaliar</button>
                    </td>
                  </tr>
                  <tr data-id="102" data-coop="2" data-coopnome="Maria Souza" data-contrato="Contrato B"
                      data-avurl="/avaliar/102" data-getavurl="/avaliar/102/get">
                    <td class="text-center">03/10/2025</td>
                    <td class="fw-semibold coop-name">Maria Souza</td>
                    <td>Contrato B</td>
                    <td class="text-center">12:00 às 16:00</td>
                    <td class="text-center">8</td>
                    <td class="text-end valor" data-valor="80.00">R$ 80,00</td>
                    <td class="text-center" data-avcell>
                      <span class="stars-static" data-score="4">★★★★★</span>
                      <button class="btn btn-outline-royal btn-sm ms-1" data-open-av>Editar</button>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-secondary">
                    <th colspan="4" class="text-end">Totais</th>
                    <th class="text-center" id="ftEntregas">0</th>
                    <th class="text-end" id="ftValor">R$ 0,00</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>

              <hr class="my-3">
              <h6 class="mb-2"><i class="bi bi-people"></i> Totais por cooperado</h6>
              <div id="gridCoop" class="row g-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== LANÇAR ===== -->
      <section data-view="lancar" class="view-active">
        <div class="section-title"><i class="bi bi-plus-circle"></i> Lançar Produção Diária</div>

        <div class="card card-body">
          <form class="row g-2 align-items-end" method="GET" action="#">
            <input type="hidden" name="view" value="lancar">
            <div class="col-md-3"><label class="form-label">Início</label><input type="date" name="data_inicio" class="form-control"></div>
            <div class="col-md-3"><label class="form-label">Fim</label><input type="date" name="data_fim" class="form-control"></div>
            <div class="col-md-3"><div class="small text-muted mb-1">Período em uso</div><div class="chip">—</div></div>
            <div class="col-md-3 text-end">
              <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
              <a class="btn btn-outline-secondary" href="#"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
            </div>
          </form>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-lg-4">
            <div class="card card-body">
              <div class="input-group mb-2">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="buscaCoop" type="text" class="form-control" placeholder="Buscar cooperado..." list="cooperadosList">
                <datalist id="cooperadosList"><option value="João Silva"></option><option value="Maria Souza"></option></datalist>
                <select id="selectCoop" class="form-select">
                  <option value="">Lista...</option>
                  <option value="1">João Silva</option>
                  <option value="2">Maria Souza</option>
                </select>
              </div>
              <div id="listaCooperados" style="max-height:60vh; overflow:auto;">
                <div class="cooperado-item" data-id="1" data-nome="João Silva" data-foto="https://via.placeholder.com/96x96.png?text=JS" data-total="200.00">
                  <img src="https://via.placeholder.com/96x96.png?text=JS" class="cooperado-avatar" alt="Foto do cooperado">
                  <div class="d-flex flex-column"><span class="fw-bold">João Silva</span><small class="text-muted">No período: R$ 200,00</small></div>
                </div>
                <div class="cooperado-item" data-id="2" data-nome="Maria Souza" data-foto="https://via.placeholder.com/96x96.png?text=MS" data-total="300.00">
                  <img src="https://via.placeholder.com/96x96.png?text=MS" class="cooperado-avatar" alt="Foto do cooperado">
                  <div class="d-flex flex-column"><span class="fw-bold">Maria Souza</span><small class="text-muted">No período: R$ 300,00</small></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card card-body" id="blocoLancamento">
              <div class="selected-header text-center mb-2" id="selectedHeader" style="display:none;">
                <img id="selFoto" src="" class="big" alt="">
                <div class="fw-bold fs-5 mt-2" id="selNome"></div>
                <div class="text-muted">Total no período: R$ <span id="selTotal">0,00</span></div>
              </div>

              <div class="alert alert-info py-2 px-3 mb-2" id="hintSelecione">Selecione um cooperado para lançar.</div>

              <form id="formLancamento" method="POST" action="/lancar" class="row g-2 align-items-end mb-1" style="display:none;">
                <input type="hidden" name="cooperado_id" id="inputCooperadoId" value="">
                <div class="col-md-3"><label class="form-label">Valor (R$)</label><input type="number" class="form-control" name="valor" step="0.01" required></div>
                <div class="col-md-3"><label class="form-label">Data</label><input type="date" class="form-control" name="data" required></div>
                <div class="col-md-3"><label class="form-label">Hora Início</label><input type="time" class="form-control" name="hora_inicio"></div>
                <div class="col-md-3"><label class="form-label">Hora Fim</label><input type="time" class="form-control" name="hora_fim"></div>
                <div class="col-md-3"><label class="form-label">Entregas</label><input type="number" class="form-control" name="qtd_entregas" min="0" step="1"></div>

                <div class="col-12"><hr class="my-2"></div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="chkAvaliar">
                    <label class="form-check-label" for="chkAvaliar">Registrar avaliação agora</label>
                  </div>
                  <input type="hidden" name="avaliar" id="inputAvaliar" value="0">
                </div>

                <div id="boxAval" class="row g-2" style="display:none;">
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_pontualidade">
                      <div class="rating-label">Pontualidade</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_pontualidade" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_educacao">
                      <div class="rating-label">Educação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_educacao" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_eficiencia">
                      <div class="rating-label">Eficiência / Cuidado</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_eficiencia" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_apresentacao">
                      <div class="rating-label">Apresentação</div>
                      <div class="stars">
                        <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                      </div>
                      <input type="hidden" name="av_apresentacao" value="">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="rating-group" data-name="av_geral" data-auto="true">
                      <div class="rating-label">Geral (média automática)</div>
                      <div class="stars"><i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i></div>
                      <input type="hidden" name="av_geral" value="">
                    </div>
                  </div>
                  <div class="col-12"><label class="form-label">Comentário (opcional)</label><textarea class="form-control" name="av_comentario" rows="2" placeholder="Conte rapidamente como foi a experiência..."></textarea></div>
                </div>

                <div class="col-12 text-end mt-2"><button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button></div>
              </form>
            </div>

            <!-- Tabelas por cooperado (mock) -->
            <div id="blocoTabelas" class="mt-2">
              <div id="tabela-1" class="card card-body lancamentos-table" style="display:none;">
                <table class="table table-bordered table-hover align-middle table-compact">
                  <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th>Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
                  <tbody>
                    <tr>
                      <td>R$ 120,00</td><td>03/10/2025</td><td>18:00 às 22:00</td><td>12</td>
                      <td><a href="#" class="btn btn-outline-royal btn-sm"><i class="bi bi-pencil"></i></a></td>
                      <td><a href="#" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div id="tabela-2" class="card card-body lancamentos-table" style="display:none;">
                <table class="table table-bordered table-hover align-middle table-compact">
                  <thead><tr><th>Valor</th><th>Data</th><th>Horário</th><th>Entregas</th><th>Editar</th><th>Excluir</th></tr></thead>
                  <tbody>
                    <tr>
                      <td>R$ 80,00</td><td>03/10/2025</td><td>12:00 às 16:00</td><td>8</td>
                      <td><a href="#" class="btn btn-outline-royal btn-sm"><i class="bi bi-pencil"></i></a></td>
                      <td><a href="#" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></a></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== TABELAS ===== -->
      <section data-view="tabelas">
        <div class="section-title"><i class="bi bi-table"></i> Minhas Tabelas</div>
        <div id="tabelasContainer">
          <div class="card card-body text-muted">Carregando tabelas…</div>
        </div>
      </section>
      <!-- /sections -->
    </main>
  </div>

  <!-- MODAL AVALIAR DEPOIS (em Lançamentos) -->
  <div class="modal fade" id="modalAvalLanc" tabindex="-1" aria-labelledby="modalAvalLancLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="formAvalLanc" method="POST">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAvalLancLabel"><i class="bi bi-star-half me-2"></i> Avaliar lançamento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="lanc_id" id="avLancId" value="">
            <div class="mb-2 small text-muted" id="avLancInfo"></div>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="rating-group" data-name="av_pontualidade">
                  <div class="rating-label">Pontualidade</div>
                  <div class="stars">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_pontualidade" value="">
                </div>
              </div>
              <div class="col-md-6">
                <div class="rating-group" data-name="av_educacao">
                  <div class="rating-label">Educação</div>
                  <div class="stars">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_educacao" value="">
                </div>
              </div>
              <div class="col-md-6">
                <div class="rating-group" data-name="av_eficiencia">
                  <div class="rating-label">Eficiência / Cuidado</div>
                  <div class="stars">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_eficiencia" value="">
                </div>
              </div>
              <div class="col-md-6">
                <div class="rating-group" data-name="av_apresentacao">
                  <div class="rating-label">Apresentação</div>
                  <div class="stars">
                    <i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i>
                  </div>
                  <input type="hidden" name="av_apresentacao" value="">
                </div>
              </div>
              <div class="col-md-6">
                <div class="rating-group" data-name="av_geral" data-auto="true">
                  <div class="rating-label">Geral (média automática)</div>
                  <div class="stars"><i class="bi bi-star-fill star" data-v="1"></i><i class="bi bi-star-fill star" data-v="2"></i><i class="bi bi-star-fill star" data-v="3"></i><i class="bi bi-star-fill star" data-v="4"></i><i class="bi bi-star-fill star" data-v="5"></i></div>
                  <input type="hidden" name="av_geral" value="">
                </div>
              </div>
              <div class="col-12"><label class="form-label">Comentário (opcional)</label><textarea class="form-control" name="av_comentario" rows="2" placeholder="Conte rapidamente como foi a experiência..."></textarea></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-royal"><i class="bi bi-save"></i> Salvar avaliação</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL pergunta Avaliar Agora (ao lançar) -->
  <div class="modal fade" id="modalAvaliar" tabindex="-1" aria-labelledby="modalAvaliarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAvaliarLabel"><i class="bi bi-star-half me-2"></i>Deseja avaliar o motoboy agora?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Você pode registrar a avaliação agora ou <b>pular</b> e lançar apenas os dados.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="btnPularAval"><i class="bi bi-skip-forward"></i> Pular e lançar</button>
          <button type="button" class="btn btn-royal" id="btnAvaliarAgora"><i class="bi bi-star-fill"></i> Avaliar agora</button>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    /* ===== Polyfills/guards ===== */
    if(typeof window.CSS === 'undefined'){ window.CSS = {}; }
    if(typeof window.CSS.escape !== 'function'){
      window.CSS.escape = function(v){ return String(v).replace(/[^a-zA-Z0-9_\-]/g, m => '\\\\' + m); };
    }

    /* ===== Tema ===== */
    const THEME_KEY='portal_theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
      const lbl=document.getElementById('lblTheme'); const icon=document.querySelector('#btnTheme i');
      if(lbl) lbl.textContent = (t==='dark')?'Claro':'Escuro';
      if(icon){ icon.classList.toggle('bi-moon', t!=='dark'); icon.classList.toggle('bi-sun', t==='dark'); }
      localStorage.setItem(THEME_KEY, t);
    }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(saved);
      document.getElementById('btnTheme')?.addEventListener('click', ()=>{
        const cur = localStorage.getItem(THEME_KEY) || 'light';
        applyTheme(cur==='dark'?'light':'dark');
      });
    })();

    /* ===== Navegação SPA ===== */
    function showSection(view){
      document.querySelectorAll('section[data-view]').forEach(sec=>sec.classList.toggle('view-active', sec.getAttribute('data-view')===view));
      document.querySelectorAll('#sideNav a').forEach(a=>{
        const t=a.getAttribute('data-target'); a.classList.toggle('active', t===view);
      });
      if(view==='avisos') initAvisos();
      if(view==='lancamentos') initLancamentos();
      if(view==='lancar') initLancar();
      if(view==='tabelas') initTabelas();
    }
    function pushView(v){
      try{
        const u=new URL(location.href); u.searchParams.set('view',v); history.pushState({view:v},'',u.toString());
      }catch(_e){}
    }
    function startView(){ return new URL(location.href).searchParams.get('view') || 'lancar'; }

    /* ===== Utils ===== */
    function togglePwd(btn){ const i=btn.previousElementSibling; if(!i) return; i.type=i.type==='password'?'text':'password'; btn.querySelector('i').classList.toggle('bi-eye'); btn.querySelector('i').classList.toggle('bi-eye-slash'); }
    const brMoney = (n)=> (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
    const todayStr = ()=>{ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return d.getFullYear()+'-'+mm+'-'+dd; };
    function prefetch(href){ try{ const l=document.createElement('link'); l.rel='prefetch'; l.href=href; document.head.appendChild(l);}catch(e){} }

    /* ===== Avisos (placeholder) ===== */
    function initAvisos(){}

    /* ===== Lançar ===== */
    let lancarWired=false;
    function initLancar(){
      if(lancarWired) return; lancarWired=true;
      const busca=document.getElementById('buscaCoop');
      const select=document.getElementById('selectCoop');
      const itens=Array.from(document.querySelectorAll('.cooperado-item'));
      const form=document.getElementById('formLancamento');
      const hint=document.getElementById('hintSelecione');
      const header=document.getElementById('selectedHeader');
      const inputCoopId=document.getElementById('inputCooperadoId');
      const selFoto=document.getElementById('selFoto');
      const selNome=document.getElementById('selNome');
      const selTotal=document.getElementById('selTotal');

      function mostrarCooperado(el){
        if(!el) return;
        itens.forEach(i=>i.classList.remove('selected')); el.classList.add('selected');
        inputCoopId.value=el.dataset.id; selFoto.src=el.dataset.foto; selNome.textContent=el.dataset.nome; selTotal.textContent=Number(el.dataset.total||0).toLocaleString('pt-BR',{minimumFractionDigits:2});
        header.style.display='block'; form.style.display='flex'; hint.style.display='none';
        document.querySelectorAll('.lancamentos-table').forEach(t=>t.style.display='none');
        const t=document.getElementById('tabela-'+el.dataset.id); if(t) t.style.display='block';
        document.querySelectorAll('.rating-group').forEach(g=>{ if(g.dataset.name!=='av_geral') wireStars(g); });
        autoGeral();
      }
      itens.forEach(el=>el.addEventListener('click',()=>mostrarCooperado(el)));
      busca?.addEventListener('input',function(){ const q=this.value.trim().toLowerCase(); itens.forEach(el=>el.style.display=(el.dataset.nome||'').toLowerCase().includes(q)?'':'none'); });
      select?.addEventListener('change',function(){ const el=itens.find(x=>x.dataset.id===this.value); if(el) mostrarCooperado(el); });
      if(itens[0]) mostrarCooperado(itens[0]);

      wireAvaliacaoFlow();
    }

    function wireStars(group){
      const hidden=group.querySelector('input[type="hidden"]'); const stars=group.querySelectorAll('.star');
      function paint(v,hover=false){ stars.forEach(s=>{ const on=Number(s.dataset.v)<=v; s.classList.toggle('active',on); s.classList.toggle('hover',hover&&on); }); }
      stars.forEach(s=>{
        s.addEventListener('mouseenter',()=>paint(Number(s.dataset.v),true));
        s.addEventListener('mouseleave',()=>paint(Number(hidden.value||0),false));
        s.addEventListener('click',()=>{ hidden.value=Number(s.dataset.v); paint(Number(hidden.value),false); autoGeral(); });
      });
      paint(Number(hidden.value||0),false);
    }

    // autoGeral: média só se houver notas; senão fica vazio e não pinta
    function autoGeral(){
      const g=document.querySelector('.rating-group[data-name="av_geral"]'); if(!g) return;
      const h=g.querySelector('input[type="hidden"]');
      const nomes=['av_pontualidade','av_educacao','av_eficiencia','av_apresentacao']; 
      const vals=[];
      nomes.forEach(n=>{
        const v=Number(document.querySelector(`.rating-group[data-name="${n}"] input[type="hidden"]`)?.value||0);
        if(v>0) vals.push(v);
      });
      const media = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : null;
      h.value = media ?? '';
      g.querySelectorAll('.star').forEach(s=>{
        const v=Number(s.dataset.v);
        s.classList.toggle('active', !!media && v<=media);
        s.classList.remove('hover');
      });
    }

    /* ===== Lancamentos ===== */
    let lancamentosWired=false;
    function initLancamentos(){
      if(lancamentosWired) return; lancamentosWired=true;
      const tbody=document.getElementById('tbodyLanc'); if(!tbody) return;
      const ftValor=document.getElementById('ftValor'); const ftEnt=document.getElementById('ftEntregas');
      const kpiV=document.getElementById('kpiTotalValor'); const kpiE=document.getElementById('kpiTotalEntregas');
      const grid=document.getElementById('gridCoop'); const f=document.getElementById('formFiltroLanc');
      const periodo=document.getElementById('txtPeriodo');

      const t=todayStr(); if(periodo) periodo.textContent = t+' a '+t;

      function rows(){ return Array.from(tbody.querySelectorAll('tr')); }
      function recompute(){
        let totV=0, totE=0; const per={};
        rows().forEach(tr=>{
          if(tr.style.display==='none') return;
          const v=Number(tr.querySelector('.valor')?.dataset.valor||0);
          const eTxt=tr.cells[4]?.textContent?.trim()||'0'; const e=eTxt==='-'?0:Number(eTxt.replace(/\D+/g,''));
          totV+=v; totE+=e;
          const id=tr.dataset.coop, nm=tr.dataset.coopnome;
          per[id]=per[id]||{nome:nm,valor:0,ent:0}; per[id].valor+=v; per[id].ent+=e;
        });
        if(ftValor) ftValor.textContent='R$ '+brMoney(totV);
        if(ftEnt) ftEnt.textContent=String(totE);
        if(kpiV) kpiV.textContent=brMoney(totV);
        if(kpiE) kpiE.textContent=String(totE);
        if(grid){
          grid.innerHTML='';
          Object.values(per).sort((a,b)=>b.valor-a.valor).forEach(p=>{
            const div=document.createElement('div'); div.className='col-sm-6 col-xl-4';
            div.innerHTML=`<div class="kpi h-100"><div class="fw-bold">${p.nome||'-'}</div><div class="small text-muted">Entregas: <b>${p.ent||0}</b></div><div>Total: <b>R$ ${brMoney(p.valor||0)}</b></div></div>`;
            grid.appendChild(div);
          });
        }
      }
      f?.q?.addEventListener('input', ()=>{
        const q=(f.q.value||'').toLowerCase().trim();
        rows().forEach(tr=>{ const coop=(tr.dataset.coopnome||'').toLowerCase(); const contrato=(tr.dataset.contrato||'').toLowerCase(); tr.style.display = (!q || coop.includes(q) || contrato.includes(q)) ? '' : 'none'; });
        recompute();
      });

      document.getElementById('btnExportCsv')?.addEventListener('click', ()=>{
        const rowsVis=rows().filter(r=>r.style.display!=='none');
        const header=['Data','Cooperado','Contrato','Horário','Entregas','Valor (R$)','Avaliação'];
        const linhas=[header]; let totE=0, totV=0;
        rowsVis.forEach(r=>{
          const c=r.cells; const entregas=(c[4].textContent.trim()==='-')?0:Number(c[4].textContent.replace(/\D+/g,'')); const valorNum=Number(r.querySelector('.valor')?.dataset.valor||0);
          const avCell = c[6]?.querySelector('.stars-static')?.dataset.score || '';
          linhas.push([c[0].textContent.trim(),c[1].textContent.trim(),c[2].textContent.trim(),c[3].textContent.trim(),String(entregas),valorNum.toFixed(2).replace('.',','), avCell]);
          totE+=entregas; totV+=valorNum;
        });
        linhas.push(['Totais','','','',String(totE),totV.toFixed(2).replace('.',','), '']);
        const csv='\uFEFF'+linhas.map(l=>l.join(';')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lancamentos.csv'; a.click(); URL.revokeObjectURL(a.href);
      });

      document.getElementById('btnExportXlsx')?.addEventListener('click', ()=>{
        const rowsVis=rows().filter(r=>r.style.display!=='none');
        const data=[['Data','Cooperado','Contrato','Horário','Entregas','Valor (R$)','Avaliação']];
        let totE=0, totV=0;
        rowsVis.forEach(r=>{
          const c=r.cells;
          const entregas=(c[4].textContent.trim()==='-')?0:Number(c[4].textContent.replace(/\D+/g,''));
          const valorNum=Number(r.querySelector('.valor')?.dataset.valor||0);
          const avCell = c[6]?.querySelector('.stars-static')?.dataset.score || '';
          data.push([c[0].textContent.trim(), c[1].textContent.trim(), c[2].textContent.trim(), c[3].textContent.trim(), entregas, valorNum, avCell]);
          totE+=entregas; totV+=valorNum;
        });
        data.push(['Totais','','','', totE, totV, '']);
        const ws = XLSX.utils.aoa_to_sheet(data);
        const range = XLSX.utils.decode_range(ws['!ref']);
        for(let R=1; R<=range.e.r; R++){
          const vCell = XLSX.utils.encode_cell({r:R, c:5});
          if(ws[vCell]) ws[vCell].t='n';
        }
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Lancamentos');
        XLSX.writeFile(wb, 'lancamentos.xlsx');
      });

      recompute();
      document.querySelectorAll('.stars-static').forEach(paintStaticStars);
      wireAvalLanc();
    }

    /* ===== Tabelas ===== */
    function initTabelas(){}

    /* ===== Helpers avaliação listagem ===== */
    function paintStaticStars(el){
      const score = Number(el?.dataset?.score||0);
      if(!el) return;
      el.textContent = '★★★★★'.slice(0, Math.max(0, Math.min(5, score))).padEnd(5, '☆');
    }

    function setAvalInputsEnabled(enabled){
      const boxAval = document.getElementById('boxAval');
      if(!boxAval) return;
      boxAval.querySelectorAll('input[name^="av_"], textarea[name="av_comentario"]').forEach(el=>{
        if(enabled){
          if(el.dataset.origName){ el.name = el.dataset.origName; delete el.dataset.origName; }
        }else{
          if(!el.dataset.origName) el.dataset.origName = el.name;
          el.name = '';
        }
      });
    }

    /* ===== Fluxo Modal de Avaliação (ao lançar) ===== */
    function wireAvaliacaoFlow(){
      const form = document.getElementById('formLancamento');
      if(!form) return;

      const modalEl = document.getElementById('modalAvaliar');
      const modal = new bootstrap.Modal(modalEl);
      const btnAvaliarAgora = document.getElementById('btnAvaliarAgora');
      const btnPularAval = document.getElementById('btnPularAval');
      const chkAvaliar = document.getElementById('chkAvaliar');
      const inputAvaliar = document.getElementById('inputAvaliar');
      const boxAval = document.getElementById('boxAval');

      function scrollIntoViewSmooth(el){
        try{ el?.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
      }

      setAvalInputsEnabled(false);

      chkAvaliar?.addEventListener('change', ()=>{
        const on = chkAvaliar.checked;
        inputAvaliar.value = on ? '1':'0';
        if(boxAval) boxAval.style.display = on ? 'block':'none';
        setAvalInputsEnabled(on);
        if(on){ autoGeral(); }
      });

      form.addEventListener('submit', function(ev){
        if(!form.checkValidity()){
          form.reportValidity?.();
          return;
        }
        if(chkAvaliar.checked || inputAvaliar.value === '1' || (boxAval && boxAval.style.display === 'block')){
          setAvalInputsEnabled(true);
          autoGeral();
          return;
        }
        ev.preventDefault();
        modal.show();
      });

      btnAvaliarAgora?.addEventListener('click', ()=>{
        chkAvaliar.checked = true;
        inputAvaliar.value = '1';
        if(boxAval) boxAval.style.display = 'block';
        setAvalInputsEnabled(true);
        modal.hide();
        setTimeout(()=>{
          scrollIntoViewSmooth(boxAval);
          const firstStar = boxAval.querySelector('.rating-group .star');
          firstStar?.focus?.();
        }, 150);
      });

      btnPularAval?.addEventListener('click', ()=>{
        chkAvaliar.checked = false;
        inputAvaliar.value = '0';
        if(boxAval) boxAval.style.display = 'none';
        setAvalInputsEnabled(false);
        modal.hide();
        setTimeout(()=>form.submit(), 80);
      });
    }

    /* ===== Avaliar/Editar na página de Lançamentos ===== */
    function wireAvalLanc(){
      const tbody = document.getElementById('tbodyLanc');
      const modalEl = document.getElementById('modalAvalLanc');
      if(!tbody || !modalEl) return;

      const modal = new bootstrap.Modal(modalEl);
      const form = document.getElementById('formAvalLanc');
      const info = document.getElementById('avLancInfo');
      const inputLancId = document.getElementById('avLancId');

      function initStarsInModal(){
        modalEl.querySelectorAll('.rating-group').forEach(g=>{
          if(g.dataset.name!=='av_geral') wireStars(g);
        });
        autoGeral();
      }

      tbody.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('[data-open-av]');
        if(!btn) return;
        const tr = btn.closest('tr');
        const lancId = tr.dataset.id;
        const getUrl = tr.dataset.getavurl;
        inputLancId.value = lancId;
        info.textContent = `${tr.cells[0].textContent.trim()} • ${tr.dataset.coopnome}`;

        modalEl.querySelectorAll('input[name^="av_"]').forEach(i=>i.value='');
        modalEl.querySelector('textarea[name="av_comentario"]').value='';

        try{
          if(getUrl){ await fetch(getUrl, {credentials:'same-origin'}); }
          if(lancId==='102'){ // mock
            const map = {'av_pontualidade':4,'av_educacao':4,'av_eficiencia':4,'av_apresentacao':4,'av_geral':4};
            Object.entries(map).forEach(([k,v])=>{
              const inp = modalEl.querySelector(`input[name="${k}"]`); if(inp){ inp.value = v; }
            });
          }
        }catch(e){}

        initStarsInModal();
        modal.show();
      });

      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const lancId = inputLancId.value;
        const tr = tbody.querySelector(`tr[data-id="${CSS.escape(lancId)}"]`);
        if(!tr) return;
        const postUrl = tr.dataset.avurl;

        const fd = new FormData(form);
        autoGeral();

        try{
          if(postUrl){ await fetch(postUrl, {method:'POST', body:fd, credentials:'same-origin'}); }
          const geral = Number(fd.get('av_geral')||0)||0;
          const cell = tr.querySelector('[data-avcell]');
          if(cell){
            if(geral>0){
              cell.innerHTML = `<span class="stars-static" data-score="${geral}">★★★★★</span>
                                <button class="btn btn-outline-royal btn-sm ms-1" data-open-av>Editar</button>`;
              paintStaticStars(cell.querySelector('.stars-static'));
            }else{
              cell.innerHTML = `<button class="btn btn-outline-royal btn-sm" data-open-av><i class="bi bi-star"></i> Avaliar</button>`;
            }
          }
          modal.hide();
        }catch(e){
          alert('Erro de rede ao salvar avaliação.');
        }
      });
    }

    /* ===== Eventos do menu ===== */
    document.getElementById('sideNav')?.addEventListener('click', async (e)=>{
      const a=e.target.closest('a'); if(!a) return;
      const t=a.getAttribute('data-target'); if(!t) return;
      e.preventDefault();
      document.querySelectorAll('#sideNav a').forEach(x=>x.classList.remove('active')); a.classList.add('active');
      showSection(t); pushView(t);
    });

    /* ===== Inicialização ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const initial=startView(); showSection(initial);
      document.querySelectorAll('.stars-static').forEach(paintStaticStars);
    });
    window.addEventListener('popstate',(ev)=>{ const v=(ev.state&&ev.state.view)||startView(); showSection(v); });
  </script>
</body>
</html>
