<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Restaurante - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{ --royal-blue:#2747d9; --white:#fff; --danger:#e74c3c; --edit:#f1c40f; --sidebar-dark:#101218; --hover-blue:#3b61e3; }
    body{ background:#191c20; font-family:'Roboto',Arial,sans-serif; min-height:100vh; }
    .sidebar{ width:200px; height:100vh; position:fixed; top:0; left:0;
      background:linear-gradient(160deg, var(--royal-blue) 80%, var(--sidebar-dark) 100%); color:var(--white); z-index:10; }
    .logo-area{ display:flex; flex-direction:column; align-items:center; padding:18px 0 10px; }
    .logo-img{ width:68px; height:68px; object-fit:contain; margin-bottom:6px; }
    .logo-title{ font-family:'Orbitron',Arial,sans-serif; font-size:1.2rem; text-align:center; letter-spacing:1.5px; }
    .sidebar .nav-link{ color:var(--white); font-size:1.06rem; margin-bottom:7px; border-radius:7px; transition:background .2s; cursor:pointer; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover{ background:var(--hover-blue); color:#fff; }
    .main-content{ margin-left:210px; padding:25px 3vw 30px; min-height:100vh; }
    .section-title{ font-family:'Orbitron',Arial,sans-serif; color:var(--royal-blue); font-size:1.4rem; margin-bottom:15px; }
    .card-white{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 2px 8px 0 #0002; margin-bottom:30px; }
    .cooperado-item{ display:flex; align-items:center; padding:9px 0; border-bottom:1px solid #eee; cursor:pointer; transition:background .2s; }
    .cooperado-item:hover{ background:#f1f6ff; } .cooperado-item.selected{ background:#e6edfc; }
    .cooperado-item:last-child{ border-bottom:none; }
    .cooperado-avatar{ width:45px; height:45px; border-radius:50%; object-fit:cover; margin-right:13px; border:2.5px solid var(--royal-blue); }
    .cooperado-nome{ font-size:1.1rem; font-weight:600; color:#222; }
    .btn-royal{ background:var(--royal-blue); color:#fff; }
    .btn-royal:hover{ background:var(--hover-blue); color:#fff; }
    .btn-edit{ background:var(--edit); color:#191c20; } .btn-edit:hover{ background:#ffe566; color:#191c20; }
    .btn-delete{ background:var(--danger); color:#fff; } .btn-delete:hover{ background:#b93222; color:#fff; }
    .table thead{ background:var(--royal-blue); color:#fff; }
    .stat{ border-radius:12px; padding:14px; background:#fff; box-shadow:0 2px 8px 0 #0002; }
    .stat .label{ color:#6b7280; font-size:.9rem; }
    .stat .val{ font-weight:700; font-size:1.25rem; }
    .contrato-header{ font-weight:700; color:#2747d9; margin-top:.5rem; margin-bottom:.25rem; }
    @media (max-width:800px){
      .sidebar{ width:60px; }
      .logo-title, .sidebar .nav-link span{ display:none; }
      .main-content{ margin-left:70px; padding:15px 1vw; }
      .cooperado-nome{ font-size:.9em; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar d-flex flex-column">
    <div class="logo-area">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo-img">
      <span class="logo-title">COOPEX</span>
    </div>
    <nav class="nav flex-column mt-4">
      <!-- Link Cooperados (lançamentos) -->
      <a class="nav-link {{ 'active' if (view|default('lancar') != 'escalas') else '' }}"
         href="{{ url_for('portal_restaurante', view='lancar', data_inicio=filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio else None, data_fim=filtro_fim.strftime('%Y-%m-%d') if filtro_fim else None) }}">
        <i class="bi bi-person-lines-fill me-2"></i> <span>Cooperados</span>
      </a>
      <!-- Link Escala Semanal -->
      <a class="nav-link {{ 'active' if view=='escalas' else '' }}"
         href="{{ url_for('portal_restaurante', view='escalas') }}">
        <i class="bi bi-calendar-week me-2"></i> <span>Escala semanal</span>
      </a>
      <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> <span>Sair</span></a>
    </nav>
  </div>

  <!-- Main -->
  <div class="main-content">

    {% if view|default('lancar') != 'escalas' %}
      <!-- ============= PÁGINA COOPERADOS (LANÇAMENTOS) ============= -->
      <div class="section-title">Lançar Produção Diária</div>

      <!-- Filtros & Totais -->
      <div class="card-white">
        <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
          <input type="hidden" name="view" value="lancar">
          <div class="col-md-3">
            <label class="form-label">Início</label>
            <input type="date" name="data_inicio" class="form-control"
                   value="{{ filtro_inicio.strftime('%Y-%m-%d') if filtro_inicio }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Fim</label>
            <input type="date" name="data_fim" class="form-control"
                   value="{{ filtro_fim.strftime('%Y-%m-%d') if filtro_fim }}">
          </div>
          <div class="col-md-3">
            <div class="small text-muted mb-1">Período em uso</div>
            <div class="badge text-bg-primary p-2">
              {{ filtro_inicio.strftime('%d/%m/%Y') }} a {{ filtro_fim.strftime('%d/%m/%Y') }}
            </div>
          </div>
          <div class="col-md-3 text-end">
            <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='lancar') }}"><i class="bi bi-arrow-counterclockwise"></i> Limpar</a>
          </div>
        </form>

        <hr class="my-3">

        <div class="row g-3">
          <div class="col-md-3">
            <div class="stat">
              <div class="label">Total a pagar (R$)</div>
              <div class="val">{{ '%.2f'|format(total_bruto or 0) }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat">
              <div class="label">Qtd. de Lançamentos</div>
              <div class="val">{{ total_qtd or 0 }}</div>
            </div>
          </div>
          <!-- Entregas no período -->
          <div class="col-md-3">
            <div class="stat">
              <div class="label">Entregas no período</div>
              <div class="val">{{ total_entregas or 0 }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de Cooperados -->
      <div class="card-white">
        {% for coop in cooperados %}
        <div class="cooperado-item" data-target="form-{{ coop.id }}">
          <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}" class="cooperado-avatar" alt="">
          <div class="d-flex flex-column">
            <span class="cooperado-nome">{{ coop.nome }}</span>
            <small class="text-muted">Total no período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</small>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Formulários de Lançamento -->
      {% for coop in cooperados %}
      <div id="form-{{ coop.id }}" class="card-white" style="display:none;">
        <div class="text-center mb-2">
          <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}" class="cooperado-avatar" style="width:90px; height:90px; border:4px solid var(--royal-blue);" alt="">
          <div class="fw-bold fs-5 mt-1">{{ coop.nome }}</div>
          <div class="text-muted">Total no período: R$ {{ '%.2f'|format(coop.total_periodo or 0) }}</div>
        </div>

        <form method="POST" action="{{ url_for('lancar_producao') }}" class="row g-2 align-items-end mb-3">
          <input type="hidden" name="cooperado_id" value="{{ coop.id }}">
          <div class="col-md-3">
            <label class="form-label">Valor (R$)</label>
            <input type="number" class="form-control" name="valor" step="0.01" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" name="data" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Hora Início</label>
            <input type="time" class="form-control" name="hora_inicio">
          </div>
          <div class="col-md-3">
            <label class="form-label">Hora Fim</label>
            <input type="time" class="form-control" name="hora_fim">
          </div>
          <!-- Entregas (opcional) -->
          <div class="col-md-3">
            <label class="form-label">Entregas</label>
            <input type="number" class="form-control" name="qtd_entregas" min="0" step="1" placeholder="">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-royal"><i class="bi bi-plus-circle"></i> Lançar</button>
          </div>
        </form>

        <!-- Tabela dos lançamentos -->
        <table class="table table-bordered table-hover table-light align-middle">
          <thead>
            <tr>
              <th>Valor</th>
              <th>Data</th>
              <th>Horário</th>
              <th>Entregas</th>
              <th>Editar</th>
              <th>Excluir</th>
            </tr>
          </thead>
          <tbody>
            {% for lanc in coop.lancamentos %}
            <tr>
              <td>R$ {{ '%.2f'|format(lanc.valor or 0) }}</td>
              <td>{{ lanc.data.strftime('%d/%m/%Y') if lanc.data }}</td>
              <td>{{ lanc.hora_inicio or '' }} às {{ lanc.hora_fim or '' }}</td>
              <td>{{ lanc.qtd_entregas if lanc.qtd_entregas is not none else '-' }}</td>
              <td><a href="{{ url_for('editar_lancamento', id=lanc.id) }}" class="btn btn-edit btn-sm"><i class="bi bi-pencil"></i></a></td>
              <td><a href="{{ url_for('excluir_lancamento', id=lanc.id) }}" class="btn btn-delete btn-sm"><i class="bi bi-trash"></i></a></td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center text-muted">Nenhum lançamento no período selecionado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endfor %}

    {% else %}
      <!-- ============= PÁGINA ESCALA (SEMANA ou DIA) ============= -->
      <div class="section-title">Escala semanal</div>

      <div class="card-white">
        <form class="row g-2 align-items-end" method="GET" action="{{ url_for('portal_restaurante') }}">
          <input type="hidden" name="view" value="escalas">
          <div class="col-md-3">
            <label class="form-label">Ver</label>
            <select name="modo" class="form-select">
              <option value="semana" {{ 'selected' if (modo=='semana') }}>Semana completa</option>
              <option value="dia" {{ 'selected' if (modo=='dia') }}>Somente 1 dia</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Referência</label>
            <input type="date" name="ref" class="form-control" value="{{ ref_data.strftime('%Y-%m-%d') }}">
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-royal"><i class="bi bi-funnel"></i> Aplicar</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('portal_restaurante', view='escalas') }}"><i class="bi bi-arrow-counterclockwise"></i> Hoje</a>
          </div>
        </form>

        {% if modo == 'semana' %}
          <hr class="my-3">
          <div class="row g-3">
            {% for dia in dias_list %}
              <div class="col-md-6 col-lg-4">
                <div class="p-3" style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #0002;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge text-bg-primary fw-semibold">
                      {{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][dia.weekday()] }} — {{ dia.strftime('%d/%m/%Y') }}
                    </span>
                    <i class="bi bi-people"></i>
                  </div>
                  <div style="max-height:360px; overflow:auto; border-top:1px dashed #e5e7eb;">
                    {% set lista = agenda.get(dia, []) %}
                    {% if lista %}
                      {# agrupa por contrato (a rota já ordena por contrato->nome, então o groupby funciona) #}
                      {% for grupo in (lista | groupby('contrato')) %}
                        {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                        <div class="contrato-header">{{ contrato_nome }}</div>
                        {% for item in grupo.list %}
                          <div class="py-2 border-bottom">
                            <div class="fw-bold">
                              {{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}
                            </div>
                            <div class="text-muted small">
                              {{ item.turno or '—' }}{% if item.horario %} • {{ item.horario }}{% endif %}
                            </div>
                          </div>
                        {% endfor %}
                      {% endfor %}
                    {% else %}
                      <div class="text-muted small py-2">Sem escala registrada.</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <hr class="my-3">
          <div class="p-3" style="background:#fff;border-radius:12px;box-shadow:0 2px 8px #0002;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="badge text-bg-primary fw-semibold">
                {{ ['SEG','TER','QUA','QUI','SEX','SÁB','DOM'][ref_data.weekday()] }} — {{ ref_data.strftime('%d/%m/%Y') }}
              </span>
              <i class="bi bi-calendar-day"></i>
            </div>

            <table class="table table-bordered table-hover table-light align-middle">
              <thead>
                <tr>
                  <th>Contrato</th>
                  <th>Cooperado</th>
                  <th>Turno</th>
                  <th>Horário</th>
                </tr>
              </thead>
              <tbody>
                {% set lista = agenda.get(ref_data, []) %}
                {% if lista %}
                  {% for grupo in (lista | groupby('contrato')) %}
                    {% set contrato_nome = grupo.grouper or 'Sem contrato' %}
                    {% for item in grupo.list %}
                      <tr>
                        <td>{{ contrato_nome }}</td>
                        <td>{{ item.coop.nome if item.coop else (item.nome_planilha or item.cooperado_nome or '—') }}</td>
                        <td>{{ item.turno or '—' }}</td>
                        <td>{{ item.horario or '—' }}</td>
                      </tr>
                    {% endfor %}
                  {% endfor %}
                {% else %}
                  <tr><td colspan="4" class="text-center text-muted">Sem escala registrada.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // JS só para a página de lançamentos
      var isLanc = "{{ view|default('lancar') }}" !== "escalas";
      if (!isLanc) return;

      let items = document.querySelectorAll('.cooperado-item');
      let forms = document.querySelectorAll('.card-white[id^="form-"]');
      items.forEach(item => {
        item.addEventListener('click', function () {
          items.forEach(i => i.classList.remove('selected'));
          forms.forEach(f => f.style.display = 'none');
          item.classList.add('selected');
          let target = this.getAttribute('data-target');
          document.getElementById(target).style.display = 'block';
          window.scrollTo({top: 0, behavior: 'smooth'});
        });
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
