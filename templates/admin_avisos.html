<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Admin · Avisos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --royal-blue:#2747d9; --hover-blue:#3b61e3;
      --danger:#e74c3c; --success:#2ecc71; --warning:#f1c40f;
      --sidebar-w:260px;
    }
    html,body{height:100%}
    body{font-family:'Roboto',sans-serif;background:#f5f7fa;overflow-x:hidden;color:#1a1f2b}

    /* ===== Sidebar (igual ao dashboard) ===== */
    .sidebar{width:var(--sidebar-w);height:100vh;position:fixed;left:0;top:0;background:var(--royal-blue);color:#fff;overflow-y:auto}
    .brand{display:flex;flex-direction:column;align-items:center;gap:.3rem;padding:20px 10px 12px}
    .brand img{width:100%;max-width:180px;max-height:180px;height:auto;display:block;margin:0 auto 8px;border-radius:16px}
    .brand h3{font-family:'Orbitron',sans-serif;font-size:1.6rem;margin:0;letter-spacing:2px;text-align:center;color:#fff}
    .sidebar .nav-link{color:#fff;border-radius:10px;margin:6px 10px;padding:.6rem .8rem;display:flex;align-items:center;gap:.5rem}
    .sidebar .nav-link:hover,.sidebar .nav-link.active{background:var(--hover-blue)}
    .sidebar .nav-link i{width:18px}

    /* ===== Main ===== */
    .main{margin-left:var(--sidebar-w);max-width:calc(100vw - var(--sidebar-w));padding:18px}
    .card{border:0;border-radius:14px;box-shadow:0 2px 10px #0001}
    .btn-royal{background:var(--royal-blue);color:#fff}
    .btn-royal:hover{background:var(--hover-blue);color:#fff}
    .badge-soft{background:#eef2ff;color:#223;border-radius:999px;padding:.15rem .55rem}
    .chip{display:inline-block;padding:.2rem .55rem;border-radius:999px;background:#eef2ff;font-size:.75rem}
    .aviso-card .title{font-weight:700}
    .aviso-card .meta{color:#6c757d;font-size:.9rem}
    .empty{color:#6c757d}
    .search-wrap{max-width:520px}
    .form-help{color:#6c757d;font-size:.85rem}
    .listbox{max-height:260px;overflow:auto;border:1px solid #0001;border-radius:12px;padding:.25rem;background:#fff}
    .listbox .item{display:flex;align-items:center;gap:.5rem;padding:.35rem .5rem;border-radius:10px}
    .listbox .item:hover{background:#f4f6ff}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #0001}
    .section-title{font-weight:700}
    .muted{color:#6c757d}
    .count{font-variant-numeric:tabular-nums}

    @media(max-width:900px){
      :root{--sidebar-w:64px}
      .brand h3,.brand img{display:none}
      .main{margin-left:var(--sidebar-w);max-width:calc(100vw - var(--sidebar-w))}
      .sidebar .nav-link span{display:none}
    }
  </style>
</head>
<body>

<!-- Sidebar (igual ao dashboard) -->
<aside class="sidebar">
  <div class="brand">
  <h5>Painel Central Coopex</h5>
  </div>

  <nav class="nav flex-column pb-3">
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=resumo">
      <i class="bi bi-graph-up"></i> <span>Resumo</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=lancamentos">
      <i class="bi bi-journal-text"></i> <span>Lançamentos</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=receitas">
      <i class="bi bi-cash"></i> <span>Receitas Coop</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=despesas">
      <i class="bi bi-cart-dash"></i> <span>Despesas Coop</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=coop_receitas">
      <i class="bi bi-cash-coin"></i> <span>Receitas Cooperados</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=coop_despesas">
      <i class="bi bi-people"></i> <span>Despesas Cooperados</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=folha">
      <i class="bi bi-receipt"></i> <span>Folha de Pagamento</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=beneficios">
      <i class="bi bi-heart-pulse"></i> <span>Benefícios</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=cooperados">
      <i class="bi bi-person-badge"></i> <span>Cooperados</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=restaurantes">
      <i class="bi bi-shop"></i> <span>Estabelecimentos</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_dashboard') }}?tab=escalas">
      <i class="bi bi-calendar2-week"></i> <span>Escalas</span>
    </a>

    <!-- Páginas dedicadas -->
    <a class="nav-link" href="{{ url_for('admin_documentos') }}">
      <i class="bi bi-folder2"></i> <span>Documentos</span>
    </a>
    <a class="nav-link" href="{{ url_for('admin_tabelas') }}">
      <i class="bi bi-table"></i> <span>Tabelas</span>
    </a>
    <a class="nav-link {% if request.endpoint == 'admin_avisos' %}active{% endif %}" href="{{ url_for('admin_avisos') }}">
      <i class="bi bi-megaphone"></i> <span>Avisos</span>
    </a>

    <a class="nav-link {% if request.endpoint == 'admin_dashboard' and request.args.get('tab') == 'config' %}active{% endif %}"
   href="{{ url_for('admin_dashboard') }}?tab=config">
  <i class="bi bi-gear"></i> <span>Configurações</span>
</a>

    <a class="nav-link" href="{{ url_for('logout') }}">
      <i class="bi bi-box-arrow-right"></i> <span>Sair</span>
    </a>
  </nav>
</aside>

<!-- Main -->
<main class="main">
  <div class="container py-3">

    <!-- ====== PUBLICAR NOVO AVISO ====== -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <h4 class="m-0"><i class="bi bi-megaphone-fill"></i> Avisos</h4>
      <span class="chip">Escolha destino: cooperados, restaurantes ou ambos</span>
    </div>

    <div class="card p-3 mb-3">
      <form id="formNovoAviso" method="POST" action="{{ url_for('admin_avisos') }}">
        <!-- Conteúdo do aviso -->
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Título</label>
            <input id="novoTitulo" name="titulo" type="text" class="form-control" maxlength="120" placeholder="Ex.: Manutenção no sistema na sexta-feira" required>
            <div class="form-help">Máx. 120 caracteres</div>
          </div>
          <div class="col-12">
            <label class="form-label">Mensagem</label>
            <textarea id="novoMensagem" name="mensagem" class="form-control" rows="4" placeholder="Escreva o conteúdo do aviso..." required></textarea>
            <div class="form-help">Quebra de linha é preservada na leitura.</div>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Prioridade</label>
            <select id="novoPrioridade" name="prioridade" class="form-select">
              <option value="">Normal</option>
              <option value="baixa">Baixa</option>
              <option value="media">Média</option>
              <option value="alta">Alta</option>
            </select>
          </div>
          <div class="col-6 col-md-4">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" type="checkbox" role="switch" id="novoAtivo" name="ativo" checked>
              <label class="form-check-label" for="novoAtivo">Publicar imediatamente</label>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" type="checkbox" role="switch" id="novoConfirmacao" name="exigir_confirmacao" checked>
              <label class="form-check-label" for="novoConfirmacao"><i class="bi bi-check2-square"></i> Exigir confirmação de leitura</label>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <!-- Destino do aviso -->
        <div class="row g-3">
          <div class="col-12">
            <div class="section-title mb-1">Destino do aviso</div>
            <div class="text-muted small mb-2">Escolha para quem este aviso será enviado.</div>

            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="destino_tipo" id="destCoops" value="cooperados" checked>
                <label class="form-check-label" for="destCoops">Cooperados</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="destino_tipo" id="destRests" value="restaurantes">
                <label class="form-check-label" for="destRests">Restaurantes</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="destino_tipo" id="destAmbos" value="ambos">
                <label class="form-check-label" for="destAmbos">Ambos</label>
              </div>
            </div>
          </div>

          <!-- BLOCO COOPERADOS -->
          <div class="col-12" id="blocoCoops">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="section-title"><i class="bi bi-people"></i> Cooperados</div>
                <span class="chip"><span class="count" id="coopSelCount">0</span> selecionado(s)</span>
              </div>
              <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
                <div class="form-check">
                  <input class="form-check-input alcance-coop" type="radio" name="coop_alcance" id="coopTodos" value="todos">
                  <label class="form-check-label" for="coopTodos">Todos os cooperados</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input alcance-coop" type="radio" name="coop_alcance" id="coopSelecionar" value="selecionados" checked>
                  <label class="form-check-label" for="coopSelecionar">Selecionar cooperados</label>
                </div>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnCoopMarcarTodos">Marcar todos desta lista</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnCoopLimpar">Limpar seleção</button>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-12 col-md-6">
                  <input type="text" id="buscaCoop" class="form-control form-control-sm" placeholder="Buscar cooperado por nome...">
                </div>
              </div>

              <div class="listbox mt-2" id="listaCoops">
                {% for c in cooperados %}
                <label class="item">
                  <input class="form-check-input chk-coop" type="checkbox" name="dest_cooperados[]" value="{{ c.id }}">
                  <img class="avatar" src="{{ c.foto_url or url_for('static', filename='img/default.png') }}" alt="">
                  <span class="flex-fill">{{ c.nome }}</span>
                </label>
                {% else %}
                <div class="text-muted p-2">Nenhum cooperado cadastrado.</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- BLOCO RESTAURANTES -->
          <div class="col-12 d-none" id="blocoRests">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="section-title"><i class="bi bi-shop"></i> Restaurantes</div>
                <span class="chip"><span class="count" id="restSelCount">0</span> selecionado(s)</span>
              </div>
              <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
                <div class="form-check">
                  <input class="form-check-input alcance-rest" type="radio" name="rest_alcance" id="restTodos" value="todos">
                  <label class="form-check-label" for="restTodos">Todos os restaurantes</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input alcance-rest" type="radio" name="rest_alcance" id="restSelecionar" value="selecionados" checked>
                  <label class="form-check-label" for="restSelecionar">Selecionar restaurantes</label>
                </div>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnRestMarcarTodos">Marcar todos desta lista</button>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnRestLimpar">Limpar seleção</button>
              </div>

              <div class="row g-2 mt-2">
                <div class="col-12 col-md-6">
                  <input type="text" id="buscaRest" class="form-control form-control-sm" placeholder="Buscar restaurante por nome...">
                </div>
              </div>

              <div class="listbox mt-2" id="listaRests">
                {% for r in restaurantes %}
                <label class="item">
                  <input class="form-check-input chk-rest" type="checkbox" name="dest_restaurantes[]" value="{{ r.id }}">
                  <i class="bi bi-shop"></i>
                  <span class="flex-fill">{{ r.nome }}</span>
                </label>
                {% else %}
                <div class="text-muted p-2">Nenhum restaurante cadastrado.</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- BLOCO AMBOS -->
          <div class="col-12 d-none" id="blocoAmbos">
            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="section-title"><i class="bi bi-people"></i> Cooperados</div>
                    <span class="chip"><span class="count" id="ambCoopSelCount">0</span> selecionado(s)</span>
                  </div>
                  <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
                    <div class="form-check">
                      <input class="form-check-input alcance-coop ambos" type="radio" name="coop_alcance_ambos" id="ambCoopTodos" value="todos">
                      <label class="form-check-label" for="ambCoopTodos">Todos os cooperados</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input alcance-coop ambos" type="radio" name="coop_alcance_ambos" id="ambCoopSel" value="selecionados" checked>
                      <label class="form-check-label" for="ambCoopSel">Selecionar cooperados</label>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnAmbCoopMarcarTodos">Marcar todos</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnAmbCoopLimpar">Limpar</button>
                  </div>
                  <div class="row g-2 mt-2">
                    <div class="col-12">
                      <input type="text" id="buscaAmbCoop" class="form-control form-control-sm" placeholder="Buscar cooperado...">
                    </div>
                  </div>
                  <div class="listbox mt-2" id="listaAmbCoops">
                    {% for c in cooperados %}
                    <label class="item">
                      <input class="form-check-input chk-amb-coop" type="checkbox" name="dest_cooperados_ambos[]" value="{{ c.id }}">
                      <img class="avatar" src="{{ c.foto_url or url_for('static', filename='img/default.png') }}" alt="">
                      <span class="flex-fill">{{ c.nome }}</span>
                    </label>
                    {% else %}
                    <div class="text-muted p-2">Nenhum cooperado cadastrado.</div>
                    {% endfor %}
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-6">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="section-title"><i class="bi bi-shop"></i> Restaurantes</div>
                    <span class="chip"><span class="count" id="ambRestSelCount">0</span> selecionado(s)</span>
                  </div>
                  <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
                    <div class="form-check">
                      <input class="form-check-input alcance-rest ambos" type="radio" name="rest_alcance_ambos" id="ambRestTodos" value="todos">
                      <label class="form-check-label" for="ambRestTodos">Todos os restaurantes</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input alcance-rest ambos" type="radio" name="rest_alcance_ambos" id="ambRestSel" value="selecionados" checked>
                      <label class="form-check-label" for="ambRestSel">Selecionar restaurantes</label>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnAmbRestMarcarTodos">Marcar todos</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnAmbRestLimpar">Limpar</button>
                  </div>
                  <div class="row g-2 mt-2">
                    <div class="col-12">
                      <input type="text" id="buscaAmbRest" class="form-control form-control-sm" placeholder="Buscar restaurante...">
                    </div>
                  </div>
                  <div class="listbox mt-2" id="listaAmbRests">
                    {% for r in restaurantes %}
                    <label class="item">
                      <input class="form-check-input chk-amb-rest" type="checkbox" name="dest_restaurantes_ambos[]" value="{{ r.id }}">
                      <i class="bi bi-shop"></i>
                      <span class="flex-fill">{{ r.nome }}</span>
                    </label>
                    {% else %}
                    <div class="text-muted p-2">Nenhum restaurante cadastrado.</div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div><!-- /row destino -->

        <div class="mt-3 d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" id="btnPreviewNovo" data-bs-toggle="modal" data-bs-target="#novoPreviewModal">
            <i class="bi bi-search"></i> Visualizar
          </button>
          <button type="submit" class="btn btn-royal">
            <i class="bi bi-send"></i> Publicar
          </button>
          <button type="reset" class="btn btn-light">Limpar</button>
        </div>
      </form>
    </div>

    <!-- Modal de pré-visualização do NOVO aviso -->
    <div class="modal fade" id="novoPreviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title"><i class="bi bi-megaphone-fill"></i> Pré-visualização</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body pt-0">
            <div class="mb-1 text-muted small" id="prevNovoMeta">—</div>
            <div class="fw-bold fs-5" id="prevNovoTitulo">Sem título</div>
            <div class="mt-2" id="prevNovoMensagem" style="white-space:pre-line">—</div>
            <div class="mt-3 d-flex gap-2 flex-wrap" id="prevNovoBadges"></div>
            <div class="mt-2 small">
              <span class="text-muted">Destino: </span><span id="prevDestinoTexto">—</span>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
            <button class="btn btn-royal" id="btnConfirmarPublicacao">
              <i class="bi bi-send"></i> Publicar agora
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== LISTA DE AVISOS EXISTENTES ====== -->
    {% set total = avisos|length %}
    {% set ativos_list = avisos|selectattr('ativo')|list %}
    {% set qtd_ativos = ativos_list|length %}
    {% set qtd_inativos = total - qtd_ativos %}

    <div class="row g-3 align-items-stretch mt-2">
      <div class="col-12 col-md-4">
        <div class="card p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">Total</div>
              <div class="display-6">{{ total }}</div>
            </div>
            <i class="bi bi-megaphone" style="font-size:2rem;color:#6c8bff"></i>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card p-3 h-100">
          <div class="fw-bold text-success mb-1">Ativos</div>
          <div class="display-6 text-success">{{ qtd_ativos }}</div>
        </div>
      </div>
      <div class="col-6 col-md-4">
        <div class="card p-3 h-100">
          <div class="fw-bold text-secondary mb-1">Inativos</div>
          <div class="display-6 text-secondary">{{ qtd_inativos }}</div>
        </div>
      </div>
    </div>

    <div class="search-wrap mx-auto mt-3">
      <input id="busca" type="text" class="form-control" placeholder="Filtrar avisos por título ou conteúdo...">
    </div>

    <div id="listaAvisos" class="mt-3">
      {% for a in avisos %}
      {% set titulo = a.titulo or a.title or 'Sem título' %}
      {% set conteudo = a.mensagem or a.texto or a.corpo or '' %}
      <div class="card p-3 mb-2 aviso-card" data-titulo="{{ titulo }}" data-conteudo="{{ conteudo }}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="me-2">
            <div class="title">{{ titulo }}</div>
            <div class="meta">
              <i class="bi bi-calendar-event"></i>
              {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em else '—' }}
              {% if a.atualizado_em %} · <i class="bi bi-pencil-square"></i> Atualizado {{ a.atualizado_em.strftime('%d/%m/%Y %H:%M') }}{% endif %}
            </div>
            <div class="mt-2 text-muted" style="white-space:pre-line">
              {{ conteudo[:280] }}{% if conteudo|length > 280 %}…{% endif %}
            </div>
            <div class="mt-2 d-flex flex-wrap gap-2">
              <span class="badge {{ 'bg-success-subtle text-success' if a.ativo else 'bg-secondary-subtle text-secondary' }}">
                {{ 'Ativo' if a.ativo else 'Inativo' }}
              </span>
              {% if a.prioridade %}
                <span class="badge-soft">Prioridade: {{ a.prioridade|capitalize }}</span>
              {% else %}
                <span class="badge-soft">Prioridade: Normal</span>
              {% endif %}
              {% if a.exigir_confirmacao %}
                <span class="badge-soft"><i class="bi bi-check2-square"></i> Confirmação</span>
              {% endif %}
            </div>
          </div>

          <div class="text-end">
            <form method="POST" action="{{ url_for('admin_avisos_toggle', aviso_id=a.id) }}" class="d-inline">
              <button class="btn btn-sm btn-outline-secondary">
                {% if a.ativo %}
                  <i class="bi bi-eye-slash"></i> Ocultar
                {% else %}
                  <i class="bi bi-eye"></i> Exibir
                {% endif %}
              </button>
            </form>

            <button class="btn btn-sm btn-royal mt-1" data-bs-toggle="modal" data-bs-target="#previewModal{{ a.id }}">
              <i class="bi bi-search"></i> Visualizar
            </button>

            <form method="POST"
                  action="{{ url_for('admin_avisos_excluir', aviso_id=a.id) }}"
                  class="d-inline"
                  onsubmit="return confirm('Tem certeza que deseja excluir este aviso? Esta ação não pode ser desfeita.');">
              <button class="btn btn-sm btn-outline-danger mt-1">
                <i class="bi bi-trash"></i> Excluir
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Modal de pré-visualização do AVISO existente -->
      <div class="modal fade" id="previewModal{{ a.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header border-0">
              <h5 class="modal-title"><i class="bi bi-megaphone-fill"></i> {{ titulo }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body pt-0">
              <div class="small text-muted mb-2">
                {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em else '' }}
                {% if a.prioridade %} · Prioridade: {{ a.prioridade|capitalize }}{% endif %}
                {% if a.exigir_confirmacao %} · <i class="bi bi-check2-square"></i> Exige confirmação{% endif %}
              </div>
              <div style="white-space:pre-line">{{ conteudo }}</div>
            </div>
            <div class="modal-footer border-0">
              <button class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card p-4 text-center empty">
        <i class="bi bi-info-circle"></i> Nenhum aviso cadastrado.
      </div>
      {% endfor %}
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ====== Filtro local ======
  const busca = document.getElementById('busca');
  const lista = document.getElementById('listaAvisos');
  busca?.addEventListener('input', () => {
    const q = (busca.value || '').toLowerCase();
    [...lista.querySelectorAll('.aviso-card')].forEach(card => {
      const titulo = (card.dataset.titulo || '').toLowerCase();
      const conteudo = (card.dataset.conteudo || '').toLowerCase();
      card.style.display = (!q || titulo.includes(q) || conteudo.includes(q)) ? '' : 'none';
    });
  });

  // ====== Alterna blocos de destino ======
  const destCoops = document.getElementById('destCoops');
  const destRests = document.getElementById('destRests');
  const destAmbos = document.getElementById('destAmbos');
  const blocoCoops = document.getElementById('blocoCoops');
  const blocoRests = document.getElementById('blocoRests');
  const blocoAmbos = document.getElementById('blocoAmbos');
  function aplicarModoDestino(){
    const modo = document.querySelector('input[name="destino_tipo"]:checked')?.value;
    blocoCoops.classList.toggle('d-none', modo !== 'cooperados');
    blocoRests.classList.toggle('d-none', modo !== 'restaurantes');
    blocoAmbos.classList.toggle('d-none', modo !== 'ambos');
  }
  [destCoops, destRests, destAmbos].forEach(el => el.addEventListener('change', aplicarModoDestino));
  aplicarModoDestino();

  // ====== util contadores/busca ======
  const coopSelCount = document.getElementById('coopSelCount');
  const listaCoops = document.getElementById('listaCoops');
  const buscaCoop = document.getElementById('buscaCoop');
  const btnCoopMarcarTodos = document.getElementById('btnCoopMarcarTodos');
  const btnCoopLimpar = document.getElementById('btnCoopLimpar');
  function atualizarContadorCoop(){
    coopSelCount.textContent = listaCoops.querySelectorAll('.chk-coop:checked').length;
  }
  listaCoops?.addEventListener('change', e => { if(e.target.classList.contains('chk-coop')) atualizarContadorCoop(); });
  btnCoopMarcarTodos?.addEventListener('click', ()=>{ listaCoops.querySelectorAll('.chk-coop:not(:disabled)').forEach(ch=> ch.checked=true); atualizarContadorCoop(); });
  btnCoopLimpar?.addEventListener('click', ()=>{ listaCoops.querySelectorAll('.chk-coop').forEach(ch=> ch.checked=false); atualizarContadorCoop(); });
  buscaCoop?.addEventListener('input', ()=>{ const q=(buscaCoop.value||'').toLowerCase(); listaCoops.querySelectorAll('.item').forEach(it=>{ it.style.display = (!q || it.textContent.toLowerCase().includes(q)) ? '' : 'none'; }); });

  const restSelCount = document.getElementById('restSelCount');
  const listaRests = document.getElementById('listaRests');
  const buscaRest = document.getElementById('buscaRest');
  const btnRestMarcarTodos = document.getElementById('btnRestMarcarTodos');
  const btnRestLimpar = document.getElementById('btnRestLimpar');
  function atualizarContadorRest(){
    restSelCount.textContent = listaRests.querySelectorAll('.chk-rest:checked').length;
  }
  listaRests?.addEventListener('change', e => { if(e.target.classList.contains('chk-rest')) atualizarContadorRest(); });
  btnRestMarcarTodos?.addEventListener('click', ()=>{ listaRests.querySelectorAll('.chk-rest:not(:disabled)').forEach(ch=> ch.checked=true); atualizarContadorRest(); });
  btnRestLimpar?.addEventListener('click', ()=>{ listaRests.querySelectorAll('.chk-rest').forEach(ch=> ch.checked=false); atualizarContadorRest(); });
  buscaRest?.addEventListener('input', ()=>{ const q=(buscaRest.value||'').toLowerCase(); listaRests.querySelectorAll('.item').forEach(it=>{ it.style.display = (!q || it.textContent.toLowerCase().includes(q)) ? '' : 'none'; }); });

  const ambCoopSelCount = document.getElementById('ambCoopSelCount');
  const ambRestSelCount = document.getElementById('ambRestSelCount');
  const listaAmbCoops = document.getElementById('listaAmbCoops');
  const listaAmbRests = document.getElementById('listaAmbRests');
  const buscaAmbCoop = document.getElementById('buscaAmbCoop');
  const buscaAmbRest = document.getElementById('buscaAmbRest');
  const btnAmbCoopMarcarTodos = document.getElementById('btnAmbCoopMarcarTodos');
  const btnAmbCoopLimpar = document.getElementById('btnAmbCoopLimpar');
  const btnAmbRestMarcarTodos = document.getElementById('btnAmbRestMarcarTodos');
  const btnAmbRestLimpar = document.getElementById('btnAmbRestLimpar');

  function atualizarContadorAmbCoop(){ ambCoopSelCount.textContent = listaAmbCoops.querySelectorAll('.chk-amb-coop:checked').length; }
  function atualizarContadorAmbRest(){ ambRestSelCount.textContent = listaAmbRests.querySelectorAll('.chk-amb-rest:checked').length; }
  listaAmbCoops?.addEventListener('change', e => { if(e.target.classList.contains('chk-amb-coop')) atualizarContadorAmbCoop(); });
  listaAmbRests?.addEventListener('change', e => { if(e.target.classList.contains('chk-amb-rest')) atualizarContadorAmbRest(); });
  btnAmbCoopMarcarTodos?.addEventListener('click', ()=>{ listaAmbCoops.querySelectorAll('.chk-amb-coop:not(:disabled)').forEach(ch=> ch.checked=true); atualizarContadorAmbCoop(); });
  btnAmbCoopLimpar?.addEventListener('click', ()=>{ listaAmbCoops.querySelectorAll('.chk-amb-coop').forEach(ch=> ch.checked=false); atualizarContadorAmbCoop(); });
  btnAmbRestMarcarTodos?.addEventListener('click', ()=>{ listaAmbRests.querySelectorAll('.chk-amb-rest:not(:disabled)').forEach(ch=> ch.checked=true); atualizarContadorAmbRest(); });
  btnAmbRestLimpar?.addEventListener('click', ()=>{ listaAmbRests.querySelectorAll('.chk-amb-rest').forEach(ch=> ch.checked=false); atualizarContadorAmbRest(); });
  buscaAmbCoop?.addEventListener('input', ()=>{ const q=(buscaAmbCoop.value||'').toLowerCase(); listaAmbCoops.querySelectorAll('.item').forEach(it=>{ it.style.display = (!q || it.textContent.toLowerCase().includes(q)) ? '' : 'none'; }); });
  buscaAmbRest?.addEventListener('input', ()=>{ const q=(buscaAmbRest.value||'').toLowerCase(); listaAmbRests.querySelectorAll('.item').forEach(it=>{ it.style.display = (!q || it.textContent.toLowerCase().includes(q)) ? '' : 'none'; }); });

  // ====== Pré-visualização do NOVO aviso ======
  const novoTitulo = document.getElementById('novoTitulo');
  const novoMensagem = document.getElementById('novoMensagem');
  const novoPrioridade = document.getElementById('novoPrioridade');
  const novoAtivo = document.getElementById('novoAtivo');
  const novoConfirmacao = document.getElementById('novoConfirmacao');
  const prevNovoTitulo = document.getElementById('prevNovoTitulo');
  const prevNovoMensagem = document.getElementById('prevNovoMensagem');
  const prevNovoBadges = document.getElementById('prevNovoBadges');
  const prevNovoMeta = document.getElementById('prevNovoMeta');
  const prevDestinoTexto = document.getElementById('prevDestinoTexto');

  function resumoDestinoTexto(){
    const modo = document.querySelector('input[name="destino_tipo"]:checked')?.value;
    if(modo === 'cooperados'){
      const alcance = document.querySelector('input[name="coop_alcance"]:checked')?.value;
      if(alcance === 'todos') return 'Todos os cooperados';
      const n = document.querySelectorAll('#listaCoops .chk-coop:checked').length;
      return n ? `${n} cooperado(s) selecionado(s)` : 'Nenhum cooperado selecionado';
    }
    if(modo === 'restaurantes'){
      const alcance = document.querySelector('input[name="rest_alcance"]:checked')?.value;
      if(alcance === 'todos') return 'Todos os restaurantes';
      const n = document.querySelectorAll('#listaRests .chk-rest:checked').length;
      return n ? `${n} restaurante(s) selecionado(s)` : 'Nenhum restaurante selecionado';
    }
    const alcCoop = document.querySelector('input[name="coop_alcance_ambos"]:checked')?.value;
    const alcRest = document.querySelector('input[name="rest_alcance_ambos"]:checked')?.value;
    const nC = document.querySelectorAll('#listaAmbCoops .chk-amb-coop:checked').length;
    const nR = document.querySelectorAll('#listaAmbRests .chk-amb-rest:checked').length;
    const txtC = (alcCoop === 'todos') ? 'todos os cooperados' : (nC ? `${nC} cooperado(s)` : 'nenhum cooperado');
    const txtR = (alcRest === 'todos') ? 'todos os restaurantes' : (nR ? `${nR} restaurante(s)` : 'nenhum restaurante');
    return `Cooperados: ${txtC} · Restaurantes: ${txtR}`;
  }

  function atualizarPreviewNovo() {
    prevNovoTitulo.textContent = (novoTitulo.value || 'Sem título');
    prevNovoMensagem.textContent = (novoMensagem.value || '—');

    prevNovoBadges.innerHTML = '';
    const frag = document.createDocumentFragment();
    const b1 = document.createElement('span');
    b1.className = 'badge ' + (novoAtivo.checked ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary');
    b1.textContent = novoAtivo.checked ? 'Ativo' : 'Inativo';
    frag.appendChild(b1);

    const pr = (novoPrioridade.value || 'normal');
    const b2 = document.createElement('span');
    b2.className = 'badge-soft';
    const pMap = {baixa:'Baixa', media:'Média', alta:'Alta', normal:'Normal'};
    b2.textContent = 'Prioridade: ' + (pMap[pr] || 'Normal');
    b2.style.marginLeft = '8px';
    frag.appendChild(b2);

    if (novoConfirmacao.checked){
      const b3 = document.createElement('span');
      b3.className = 'badge-soft';
      b3.style.marginLeft = '8px';
      b3.innerHTML = '<i class="bi bi-check2-square"></i> Confirmação';
      frag.appendChild(b3);
    }
    prevNovoBadges.appendChild(frag);

    const agora = new Date();
    const pad = n => String(n).padStart(2,'0');
    prevNovoMeta.textContent = `${pad(agora.getDate())}/${pad(agora.getMonth()+1)}/${agora.getFullYear()} ${pad(agora.getHours())}:${pad(agora.getMinutes())}`;

    prevDestinoTexto.textContent = resumoDestinoTexto();
  }

  document.getElementById('btnPreviewNovo')?.addEventListener('click', atualizarPreviewNovo);
  [novoTitulo, novoMensagem, novoPrioridade, novoAtivo, novoConfirmacao,
   destCoops, destRests, destAmbos].forEach(el => {
    el?.addEventListener('input', atualizarPreviewNovo);
    el?.addEventListener('change', atualizarPreviewNovo);
  });

  atualizarPreviewNovo();
  // contadores iniciais
  function bootCounts(){
    const ev = new Event('change');
    document.getElementById('listaCoops')?.dispatchEvent(ev);
    document.getElementById('listaRests')?.dispatchEvent(ev);
    document.getElementById('listaAmbCoops')?.dispatchEvent(ev);
    document.getElementById('listaAmbRests')?.dispatchEvent(ev);
  }
  bootCounts();

  // Publicar direto pelo botão dentro do modal
  document.getElementById('btnConfirmarPublicacao')?.addEventListener('click', () => {
    document.getElementById('formNovoAviso')?.submit();
  });
</script>
</body>
</html>
