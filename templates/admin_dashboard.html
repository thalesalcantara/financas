{# ===================== CONTEÚDO DA ABA "Avaliações" ===================== #}
<section id="avaliacoes" class="tab-pane fade {{ 'show active' if _tab=='avaliacoes' else '' }}" role="tabpanel">

  {% set page_title = "Avaliações" %}
  <div class="container py-3">

    <!-- Título + Toggle de Tipo -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="m-0 d-flex align-items-center gap-2">
        <i class="bi bi-stars"></i> Avaliações
        <small class="text-muted">| {{ 'Cooperado → Restaurante' if tipo=='restaurante' else 'Restaurante → Cooperado' }}</small>
      </h4>

      <div class="btn-group" role="group" aria-label="Tipo de avaliação">
        <a class="btn btn-sm {{ 'btn-primary' if tipo=='restaurante' else 'btn-outline-primary' }}"
           href="{{ url_for('admin_avaliacoes',
                            tipo='restaurante',
                            restaurante_id=_flt.restaurante_id,
                            cooperado_id=_flt.cooperado_id,
                            data_inicio=_flt.data_inicio,
                            data_fim=_flt.data_fim) }}">
          Cooperado → Restaurante
        </a>
        <a class="btn btn-sm {{ 'btn-primary' if tipo=='cooperado' else 'btn-outline-primary' }}"
           href="{{ url_for('admin_avaliacoes',
                            tipo='cooperado',
                            restaurante_id=_flt.restaurante_id,
                            cooperado_id=_flt.cooperado_id,
                            data_inicio=_flt.data_inicio,
                            data_fim=_flt.data_fim) }}">
          Restaurante → Cooperado
        </a>
      </div>
    </div>

    <!-- Barra de ações -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <a class="btn btn-outline-secondary btn-sm"
         href="{{ url_for('admin_export_avaliacoes_csv',
                          tipo=tipo,
                          restaurante_id=_flt.restaurante_id,
                          cooperado_id=_flt.cooperado_id,
                          data_inicio=_flt.data_inicio,
                          data_fim=_flt.data_fim) }}">
        <i class="bi bi-download"></i> Exportar CSV
      </a>
    </div>

    <!-- Filtros -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <form method="GET" action="{{ url_for('admin_avaliacoes') }}" class="row g-2 align-items-end">
          <input type="hidden" name="tipo" value="{{ tipo }}">

          <div class="col-md-4">
            <label class="form-label">Restaurante</label>
            <select class="form-select form-select-sm" name="restaurante_id">
              <option value="">Todos</option>
              {% for r in restaurantes %}
                <option value="{{ r.id }}" {{ 'selected' if (_flt.restaurante_id or 0)==r.id else '' }}>{{ r.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Cooperado</label>
            <select class="form-select form-select-sm" name="cooperado_id">
              <option value="">Todos</option>
              {% for c in cooperados %}
                <option value="{{ c.id }}" {{ 'selected' if (_flt.cooperado_id or 0)==c.id else '' }}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">De</label>
            <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ _flt.data_inicio }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Até</label>
            <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ _flt.data_fim }}">
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-royal btn-sm"><i class="bi bi-funnel"></i> Filtrar</button>
            <button type="button" id="btnMesAtual" class="btn btn-light btn-sm">Este mês (1–último)</button>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_avaliacoes', tipo=tipo) }}">Limpar</a>
          </div>
        </form>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-2 mb-3">
      <div class="col-6 col-lg-2">
        <div class="card p-3 text-center h-100">
          <div class="small text-muted">Avaliações</div>
          <div class="fs-5 fw-bold">{{ kpis.qtd|default(0) }}</div>
        </div>
      </div>
      <div class="col-6 col-lg-2">
        <div class="card p-3 text-center h-100">
          <div class="small text-muted">Média Geral</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.geral|default(0)) }}</div>
        </div>
      </div>

      {% if tipo=='restaurante' %}
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Tratamento</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.trat|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Ambiente</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.amb|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Suporte</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.sup|default(0)) }}</div>
          </div>
        </div>
      {% else %}
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Pontualidade</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.pont|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Educação</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.educ|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Eficiência</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.efic|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Apresentação</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(kpis.apres|default(0)) }}</div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Ranking + Gráfico -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0">
            <i class="bi bi-trophy"></i>
            Ranking por {{ 'restaurante' if tipo=='restaurante' else 'cooperado' }} (mín. 3 avaliações)
          </h6>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                {% if tipo=='restaurante' %}
                  <th>Restaurante</th>
                  <th class="text-center">Avaliações</th>
                  <th class="text-center">Média Geral</th>
                  <th class="text-center">Trat.</th>
                  <th class="text-center">Amb.</th>
                  <th class="text-center">Sup.</th>
                {% else %}
                  <th>Cooperado</th>
                  <th class="text-center">Avaliações</th>
                  <th class="text-center">Média Geral</th>
                  <th class="text-center">Pont.</th>
                  <th class="text-center">Educ.</th>
                  <th class="text-center">Efic.</th>
                  <th class="text-center">Apres.</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% if tipo=='restaurante' %}
                {% for r in ranking if r.qtd >= 3 %}
                  <tr>
                    <td>{{ r.rest_nome }}</td>
                    <td class="text-center">{{ r.qtd }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_geral) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_trat) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_amb) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_sup) }}</td>
                  </tr>
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted">Sem dados suficientes</td></tr>
                {% endfor %}
              {% else %}
                {% for r in ranking if r.qtd >= 3 %}
                  <tr>
                    <td>{{ r.coop_nome }}</td>
                    <td class="text-center">{{ r.qtd }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_geral) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_pont) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_educ) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_efic) }}</td>
                    <td class="text-center">{{ '%.2f'|format(r.m_apres) }}</td>
                  </tr>
                {% else %}
                  <tr><td colspan="7" class="text-center text-muted">Sem dados suficientes</td></tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="mt-3">
          <canvas id="chartTop"></canvas>
        </div>
      </div>
    </div>

    <!-- Compatibilidade Cooperado × Restaurante -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <h6 class="m-0 d-flex align-items-center gap-2">
            <i class="bi bi-heart-fill"></i> Compatibilidade Cooperado × Restaurante
          </h6>
          <span class="text-muted small">
            Ordenado por <b>média geral</b> (desempate por nº de avaliações).
          </span>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                <th style="width:260px">Cooperado</th>
                <th style="width:260px">Restaurante</th>
                <th class="text-center" style="width:140px">Média ★</th>
                <th class="text-center" style="width:140px">Avaliações</th>
              </tr>
            </thead>
            <tbody>
              {% if compat and compat|length %}
                {% set shown = 0 %}
                {% for row in compat if row.count >= 3 %}
                  {% if shown < 10 %}
                    <tr>
                      <td class="text-break">{{ row.coop }}</td>
                      <td class="text-break">{{ row.rest }}</td>
                      <td class="text-center fw-bold">{{ '%.2f'|format(row.avg) }}</td>
                      <td class="text-center">{{ row.count }}</td>
                    </tr>
                    {% set shown = shown + 1 %}
                  {% endif %}
                {% endfor %}
                {% if shown < 10 %}
                  {% for row in compat if row.count < 3 %}
                    {% if shown < 10 %}
                      <tr class="text-muted">
                        <td class="text-break">{{ row.coop }}</td>
                        <td class="text-break">{{ row.rest }}</td>
                        <td class="text-center fw-bold">{{ '%.2f'|format(row.avg) }}</td>
                        <td class="text-center">{{ row.count }}</td>
                      </tr>
                      {% set shown = shown + 1 %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% else %}
                <tr><td colspan="4" class="text-center text-muted">Sem dados suficientes.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Lista detalhada -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body">
        <h6 class="m-0 mb-2"><i class="bi bi-list-stars"></i> Avaliações (detalhe)</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                <th>Data</th>
                <th>Restaurante</th>
                <th>Cooperado</th>
                <th>Geral</th>
                {% if tipo=='restaurante' %}
                  <th>Trat.</th><th>Amb.</th><th>Sup.</th>
                {% else %}
                  <th>Pont.</th><th>Educ.</th><th>Efic.</th><th>Apres.</th>
                {% endif %}
                <th>Comentário</th>
                <th>Média</th>
                <th>Sentimento</th>
                <th>Temas</th>
                <th>Crítico?</th>
              </tr>
            </thead>
            <tbody>
              {% for a in avaliacoes %}
                <tr>
                  <td class="text-nowrap">{{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em else '-' }}</td>
                  <td class="text-break">{{ a.rest_nome }}</td>
                  <td class="text-break">{{ a.coop_nome }}</td>
                  <td class="text-center">{{ a.geral }}</td>

                  {% if tipo=='restaurante' %}
                    <td class="text-center">{{ a.trat }}</td>
                    <td class="text-center">{{ a.amb }}</td>
                    <td class="text-center">{{ a.sup }}</td>
                  {% else %}
                    <td class="text-center">{{ a.pont }}</td>
                    <td class="text-center">{{ a.educ }}</td>
                    <td class="text-center">{{ a.efic }}</td>
                    <td class="text-center">{{ a.apres }}</td>
                  {% endif %}

                  <td class="text-break">{{ a.comentario }}</td>
                  <td class="text-center">{{ a.media if a.media is not none else '' }}</td>
                  <td class="text-center">{{ a.sentimento or '' }}</td>
                  <td class="text-break">{{ a.temas or '' }}</td>
                  <td class="text-center">{{ 'SIM' if a.alerta else 'NÃO' }}</td>
                </tr>
              {% else %}
                <tr><td colspan="{{ 12 if tipo=='restaurante' else 13 }}" class="text-center text-muted">Nenhuma avaliação</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- /container -->
</section>

<!-- Chart.js (fallback via CDN se não estiver na base) -->
<script>
  window.addEventListener('load', function(){
    // Botão "Este mês (1–último)"
    (function(){
      const btn = document.getElementById('btnMesAtual');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth();
        const first = new Date(y, m, 1);
        const last  = new Date(y, m+1, 0);
        const pad = n => String(n).padStart(2,'0');
        const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        document.querySelector('input[name="data_inicio"]').value = toISO(first);
        document.querySelector('input[name="data_fim"]').value    = toISO(last);
      });
    })();

    (function initChart(){
      const ensureChartJS = () => new Promise((resolve)=>{
        if (window.Chart) return resolve();
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/chart.js";
        s.onload = () => resolve();
        document.head.appendChild(s);
      });

      const dataTop = {{ chart_top|tojson }};
      const el = document.getElementById('chartTop');
      if (!el || !dataTop || !dataTop.labels || !dataTop.labels.length) return;

      ensureChartJS().then(()=>{
        new Chart(el, {
          type: 'bar',
          data: { labels: dataTop.labels, datasets: [{ label: 'Média Geral', data: dataTop.values }] },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 5 } },
            plugins: { legend: { display: false } }
          }
        });
      });
    })();
  });
</script>
