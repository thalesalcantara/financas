<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel Admin - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --royal-blue:#2747d9;
      --hover-blue:#3b61e3;
      --danger:#e74c3c;
      --success:#2ecc71;
      --warning:#f1c40f;
      --sidebar-w:260px;
    }

    body{
      font-family:'Roboto',sans-serif;
      background:#f5f7fa;
      overflow-x:hidden;
    }

    .sidebar{
      width:var(--sidebar-w);
      height:100vh;
      position:fixed;
      left:0;
      top:0;
      background:var(--royal-blue);
      color:#fff;
      overflow-y:auto;
    }

    .brand{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:.3rem;
      padding:20px 10px 12px;
    }
    .brand img{
      width:100%;
      max-width:180px;
      max-height:180px;
      height:auto;
      display:block;
      margin:0 auto 8px auto;
      background:none !important;
      border-radius:16px;
      box-shadow:none !important;
    }
    .brand h3,
    .brand h5{
      font-family:'Orbitron',sans-serif;
      font-size:1.6rem;
      margin:0;
      letter-spacing:2px;
      text-align:center;
      color:#fff;
    }

    /* ===== Grupos do menu lateral ===== */
    .sidebar-group{
      margin:4px 0;
    }
    .sidebar-group-toggle{
      width:100%;
      border:0;
      background:transparent;
      color:#fff;
      padding:.45rem .9rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:.9rem;
      text-align:left;
    }
    .sidebar-group-toggle:hover{
      background:rgba(0,0,0,.12);
    }
    .sidebar-group-toggle .label{
      display:flex;
      align-items:center;
      gap:.4rem;
    }
    .sidebar-group-toggle .label i{
      width:18px;
    }
    .sidebar-group-toggle .chevron{
      transition:transform .2s ease;
      font-size:.9rem;
    }
    .sidebar-group-toggle.open .chevron{
      transform:rotate(180deg);
    }

    .sidebar .nav-link{
      color:#fff;
      border-radius:8px;
      margin:3px 10px;
      padding:.55rem .8rem;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active{
      background:var(--hover-blue);
    }
    .sidebar .nav-link i{
      width:18px;
      margin-right:.4rem;
    }

    .main{
      margin-left:var(--sidebar-w);
      max-width:calc(100vw - var(--sidebar-w));
      padding:18px;
    }

    .card{
      border-radius:12px;
      box-shadow:0 2px 6px #0002;
    }

    .btn-royal{
      background:var(--royal-blue);
      color:#fff;
    }
    .btn-royal:hover{
      background:var(--hover-blue);
    }
    .btn-danger{background:var(--danger)}
    .btn-success{background:var(--success)}
    .btn-warning{background:var(--warning);color:#222}

    .muted{color:#6c757d}
    .table thead{background:#eef2ff}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
    .pill{display:inline-block;font-size:.8rem;background:#eef2ff;border-radius:999px;padding:.15rem .55rem;margin:.1rem}
    .chart-card{padding:14px;height:360px}
    .chart-card canvas{width:100% !important;height:300px !important;display:block}
    .tab-content,.card,.table-responsive{max-width:100%}
    .badge-soft{background:#eef2ff;color:#223;border-radius:999px;padding:.15rem .55rem}
    .text-tight{line-height:1.15}

    .kpi-icon{
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,.18);
      font-size:1.25rem;
    }

    @media(max-width:900px){
      :root{--sidebar-w:64px}
      .brand h3,
      .brand h5,
      .brand img{display:none}
      .main{
        margin-left:var(--sidebar-w);
        max-width:calc(100vw - var(--sidebar-w));
      }
      .sidebar .nav-link span{display:none}
      .sidebar-group-toggle .label span{display:none}
    }
  </style>

  {# Se quiser voltar a usar o CSS externo, remova o comentário abaixo #}
  {# <link rel="stylesheet"
         href="{{ url_for('static', filename='css/corporate-coopex.css', v=1) }}"> #}
</head>
<body>

{# -----------------------------------------
   Fallbacks e aba ativa
   ----------------------------------------- #}
{% set kpis       = kpis if kpis is defined else {'qtd':0,'geral':0,'trat':0,'amb':0,'sup':0,'pont':0,'educ':0,'efic':0,'apres':0} %}
{% set chart_top  = chart_top if chart_top is defined else {'labels':[],'values':[]} %}
{% set ranking    = ranking if ranking is defined else [] %}
{% set compat     = compat if compat is defined else [] %}
{% set avaliacoes = avaliacoes if avaliacoes is defined else [] %}
{% set _flt       = _flt if _flt is defined else namespace(restaurante_id=None, cooperado_id=None, data_inicio='', data_fim='') %}
{% set _tab       = (tab if tab is defined else request.args.get('tab','resumo')) %}

{# _tab define qual aba está ativa: vem da view ou da querystring #}

<!-- Sidebar -->
<aside class="sidebar">
  <div class="brand">
    <h3>Painel Central Coopex</h3>
  </div>

  <nav class="nav flex-column pb-3">

    <!-- GRUPO: Financeiro -->
    <div class="sidebar-group">
      <button class="sidebar-group-toggle" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#grpFinanceiro"
              aria-expanded="false">
        <span class="label">
          <i class="bi bi-wallet2"></i>
          <span>Financeiro</span>
        </span>
        <i class="bi bi-chevron-down chevron"></i>
      </button>

      <div class="collapse" id="grpFinanceiro">
        <!-- Resumo (tab) -->
        <a class="nav-link {{ 'active' if _tab=='resumo' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#resumo"
           href="#resumo"
           role="tab"
           aria-controls="resumo"
           aria-selected="{{ 'true' if _tab=='resumo' else 'false' }}">
          <i class="bi bi-graph-up"></i> <span>Resumo</span>
        </a>

        <!-- Avaliações (tab) -->
        <a class="nav-link {{ 'active' if _tab=='avaliacoes' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#avaliacoes"
           href="#avaliacoes"
           role="tab"
           aria-controls="avaliacoes"
           aria-selected="{{ 'true' if _tab=='avaliacoes' else 'false' }}">
          <i class="bi bi-stars"></i> <span>Avaliações</span>
        </a>

        <!-- Lançamentos (tab) -->
        <a class="nav-link {{ 'active' if _tab=='lancamentos' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#lancamentos"
           href="#lancamentos"
           role="tab"
           aria-controls="lancamentos"
           aria-selected="{{ 'true' if _tab=='lancamentos' else 'false' }}">
          <i class="bi bi-journal-text"></i> <span>Lançamentos</span>
        </a>

        <!-- Receitas Coop (tab) -->
        <a class="nav-link {{ 'active' if _tab=='receitas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#receitas"
           href="#receitas"
           role="tab"
           aria-controls="receitas"
           aria-selected="{{ 'true' if _tab=='receitas' else 'false' }}">
          <i class="bi bi-cash"></i> <span>Receitas Coop</span>
        </a>

        <!-- Despesas Coop (tab) -->
        <a class="nav-link {{ 'active' if _tab=='despesas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#despesas"
           href="#despesas"
           role="tab"
           aria-controls="despesas"
           aria-selected="{{ 'true' if _tab=='despesas' else 'false' }}">
          <i class="bi bi-cart-dash"></i> <span>Despesas Coop</span>
        </a>

        <!-- Receitas Cooperados (tab) -->
        <a class="nav-link {{ 'active' if _tab=='coop_receitas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#coop_receitas"
           href="#coop_receitas"
           role="tab"
           aria-controls="coop_receitas"
           aria-selected="{{ 'true' if _tab=='coop_receitas' else 'false' }}">
          <i class="bi bi-cash-coin"></i> <span>Receitas Cooperados</span>
        </a>

        <!-- Despesas Cooperados (tab) -->
        <a class="nav-link {{ 'active' if _tab=='coop_despesas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#coop_despesas"
           href="#coop_despesas"
           role="tab"
           aria-controls="coop_despesas"
           aria-selected="{{ 'true' if _tab=='coop_despesas' else 'false' }}">
          <i class="bi bi-people"></i> <span>Despesas Cooperados</span>
        </a>

        <!-- Folha (tab) -->
        <a class="nav-link {{ 'active' if _tab=='folha' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#folha"
           href="#folha"
           role="tab"
           aria-controls="folha"
           aria-selected="{{ 'true' if _tab=='folha' else 'false' }}">
          <i class="bi bi-receipt"></i> <span>Folha de Pagamento</span>
        </a>

        <!-- Benefícios (tab) -->
        <a class="nav-link {{ 'active' if _tab=='beneficios' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#beneficios"
           href="#beneficios"
           role="tab"
           aria-controls="beneficios"
           aria-selected="{{ 'true' if _tab=='beneficios' else 'false' }}">
          <i class="bi bi-heart-pulse"></i> <span>Benefícios</span>
        </a>
      </div>
    </div>

    <!-- GRUPO: Cadastros -->
    <div class="sidebar-group">
      <button class="sidebar-group-toggle" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#grpCadastros"
              aria-expanded="false">
        <span class="label">
          <i class="bi bi-people"></i>
          <span>Cadastros</span>
        </span>
        <i class="bi bi-chevron-down chevron"></i>
      </button>

      <div class="collapse" id="grpCadastros">
        <!-- Cooperados (tab) -->
        <a class="nav-link {{ 'active' if _tab=='cooperados' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#cooperados"
           href="#cooperados"
           role="tab"
           aria-controls="cooperados"
           aria-selected="{{ 'true' if _tab=='cooperados' else 'false' }}">
          <i class="bi bi-person-badge"></i> <span>Cooperados</span>
        </a>

        <!-- Estabelecimentos (tab) -->
        <a class="nav-link {{ 'active' if _tab=='restaurantes' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#restaurantes"
           href="#restaurantes"
           role="tab"
           aria-controls="restaurantes"
           aria-selected="{{ 'true' if _tab=='restaurantes' else 'false' }}">
          <i class="bi bi-shop"></i> <span>Estabelecimentos</span>
        </a>

        <!-- Escalas (tab) -->
        <a class="nav-link {{ 'active' if _tab=='escalas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#escalas"
           href="#escalas"
           role="tab"
           aria-controls="escalas"
           aria-selected="{{ 'true' if _tab=='escalas' else 'false' }}">
          <i class="bi bi-calendar2-week"></i> <span>Escalas</span>
        </a>
      </div>
    </div>

    <!-- GRUPO: Conteúdo -->
    <div class="sidebar-group">
      <button class="sidebar-group-toggle" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#grpConteudo"
              aria-expanded="false">
        <span class="label">
          <i class="bi bi-folder2"></i>
          <span>Conteúdo</span>
        </span>
        <i class="bi bi-chevron-down chevron"></i>
      </button>

      <div class="collapse" id="grpConteudo">
        <!-- Páginas dedicadas (rotas próprias, não tabs) -->
        <a class="nav-link {% if request.endpoint == 'admin_documentos' %}active{% endif %}"
           href="{{ url_for('admin_documentos') }}">
          <i class="bi bi-folder2"></i> <span>Documentos</span>
        </a>

        <a class="nav-link {% if request.endpoint == 'admin_tabelas' %}active{% endif %}"
           href="{{ url_for('admin_tabelas') }}">
          <i class="bi bi-table"></i> <span>Tabelas</span>
        </a>

        <a class="nav-link {% if request.endpoint == 'admin_avisos' %}active{% endif %}"
           href="{{ url_for('admin_avisos') }}">
          <i class="bi bi-megaphone"></i> <span>Avisos</span>
        </a>
      </div>
    </div>

    <!-- GRUPO: Sistema -->
    <div class="sidebar-group">
      <button class="sidebar-group-toggle" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#grpSistema"
              aria-expanded="false">
        <span class="label">
          <i class="bi bi-gear"></i>
          <span>Sistema</span>
        </span>
        <i class="bi bi-chevron-down chevron"></i>
      </button>

      <div class="collapse" id="grpSistema">
        <!-- Config (tab) -->
        <a class="nav-link {{ 'active' if _tab=='config' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#config"
           href="#config"
           role="tab"
           aria-controls="config"
           aria-selected="{{ 'true' if _tab=='config' else 'false' }}">
          <i class="bi bi-gear"></i> <span>Configurações</span>
        </a>

        <!-- Logout -->
        <a class="nav-link" href="{{ url_for('logout') }}">
          <i class="bi bi-box-arrow-right"></i> <span>Sair</span>
        </a>
      </div>
    </div>

  </nav>
</aside>

<!-- Main -->
<main class="main">
  <div class="tab-content">

         <!-- === RESUMO (Dashboard Financeiro Completo) === -->
<section class="tab-pane fade {{ 'show active' if _tab=='resumo' else '' }}" id="resumo" role="tabpanel">
  {# ---------- Helpers de data ---------- #}
  {% macro ymd(x) -%}
    {%- if x and x.strftime is defined -%}
      {{ x.strftime('%Y-%m-%d') }}
    {%- elif x -%}
      {{ x }}
    {%- else -%}
      {{ '' }}
    {%- endif -%}
  {%- endmacro %}

  {# ---------- Filtros atuais (querystring) ---------- #}
  {% set ri  = request.args.get('resumo_inicio','') %}
  {% set rf  = request.args.get('resumo_fim','') %}
  {% set rs  = request.args.get('resumo_restaurante_id','') %}
  {% set cs  = request.args.get('resumo_cooperado_id','') %}
  {% set rid = rs|int if rs else None %}
  {% set cid = cs|int if cs else None %}

  {# ---------- Bases com fallback (NÃO sobrescrever 'receitas'/'despesas' originais) ---------- #}
  {% set _producoes = (producoes | default([]) | list) %}
  {% if _producoes|length == 0 %}
    {% set _producoes = (lancamentos | default([]) | list) %}
  {% endif %}

  {# Cooperados (por pessoa) #}
  {% set receitas_coop = (receitas_coop | default([]) | list) %}
  {% set despesas_coop = (despesas_coop | default([]) | list) %}

  {# Cooperativa (geral) — usar exatamente a MESMA fonte da aba de receitas da coop #}
  {% set _rec_coop_corp =
       (receitas if receitas is defined else
        (receitas_cooperativa if receitas_cooperativa is defined else
         (receitas_corp if receitas_corp is defined else
          []))) %}
  {% set _desp_coop_corp =
       (despesas if despesas is defined else
        (despesas_cooperativa if despesas_cooperativa is defined else
         (despesas_corp if despesas_corp is defined else
          []))) %}

  {# ---------- Totais (lado servidor, para primeiro paint) ---------- #}
  {% set ns_prod = namespace(total=0) %}
  {% for p in _producoes %}
    {% set d   = ymd(p.data) %}
    {% set okd = (not ri or d >= ri) and (not rf or d <= rf) %}
    {% set okc = (not cid or (p.cooperado and p.cooperado.id==cid)) %}
    {% set okr = (not rid or (p.restaurante and p.restaurante.id==rid)) %}
    {% if okd and okc and okr %}
      {% set ns_prod.total = ns_prod.total + (p.valor or 0) %}
    {% endif %}
  {% endfor %}
  {% set total_producoes_f = ns_prod.total %}
  {% set total_inss_f      = total_producoes_f * 0.045 %}

  {% set ns_rec_corp = namespace(total=0) %}
  {% for r in _rec_coop_corp %}
    {% set d = ymd(r.data or r.data_lancamento) %}
    {% if (not ri or d >= ri) and (not rf or d <= rf) %}
      {% set v = r.valor|default(r.valor_total, true)|default(0, true) %}
      {% set ns_rec_corp.total = ns_rec_corp.total + (v or 0) %}
    {% endif %}
  {% endfor %}
  {% set total_receitas_corp_f = ns_rec_corp.total %}

  {% set ns_desp_corp = namespace(total=0) %}
  {% for d in _desp_coop_corp %}
    {% set dt = ymd(d.data or d.data_lancamento) %}
    {% if (not ri or dt >= ri) and (not rf or dt <= rf) %}
      {% set v = d.valor|default(d.valor_total, true)|default(0, true) %}
      {% set ns_desp_corp.total = ns_desp_corp.total + (v or 0) %}
    {% endif %}
  {% endfor %}
  {% set total_despesas_corp_f = ns_desp_corp.total %}

  {# Cooperados (por pessoa) #}
  {% set ns_rec_coop = namespace(total=0) %}
  {% for r in receitas_coop %}
    {% set d = ymd(r.data) %}
    {% set okd = (not ri or d >= ri) and (not rf or d <= rf) %}
    {% set okc = (not cid or (r.cooperado and r.cooperado.id==cid)) %}
    {% if okd and okc %}
      {% set ns_rec_coop.total = ns_rec_coop.total + (r.valor or 0) %}
    {% endif %}
  {% endfor %}
  {% set total_receitas_coop_f = ns_rec_coop.total %}

  {% set ns_desp_coop = namespace(total=0) %}
  {% for d in despesas_coop %}
    {% set dt  = ymd(d.data) %}
    {% set okd = (not ri or dt >= ri) and (not rf or dt <= rf) %}
    {% set okc = (not cid or (d.cooperado and d.cooperado.id==cid)) %}
    {% if okd and okc %}
      {% set ns_desp_coop.total = ns_desp_coop.total + (d.valor or 0) %}
    {% endif %}
  {% endfor %}
  {% set total_despesas_coop_f = ns_desp_coop.total %}

  {# Ajuste: Receitas dos cooperados = Produções + Receitas individuais #}
  {% set total_receitas_coop_full_f = (total_producoes_f|default(0)) + (total_receitas_coop_f|default(0)) %}

  {# Resultado coop e Total de Receitas (Geral) #}
  {% set _resultado_corp = (total_receitas_corp_f|default(0)) - (total_despesas_corp_f|default(0)) %}
  {% set _total_receitas_geral = (total_receitas_corp_f|default(0)) + (total_receitas_coop_full_f|default(0)) %}

  <!-- Filtros -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="resumo">
        <div class="col-md-2">
          <label class="form-label">De</label>
          <input type="date" class="form-control form-control-sm" name="resumo_inicio" value="{{ ri }}">
        </div>
        <div class="col-md-2">
          <label class="form-label">Até</label>
          <input type="date" class="form-control form-control-sm" name="resumo_fim" value="{{ rf }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Estabelecimento</label>
          <select class="form-select form-select-sm" name="resumo_restaurante_id">
            <option value="">Todos</option>
            {% for r in restaurantes %}
              <option value="{{ r.id }}" {{ 'selected' if rid and rid==r.id else '' }}>{{ r.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cooperado</label>
          <select class="form-select form-select-sm" name="resumo_cooperado_id">
            <option value="">Todos</option>
            {% for c in cooperados %}
              <option value="{{ c.id }}" {{ 'selected' if cid and cid==c.id else '' }}>{{ c.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 d-flex flex-wrap gap-2">
          <button class="btn btn-royal btn-sm"><i class="bi bi-funnel"></i> Filtrar</button>
          {% if ri or rf or rid or cid %}
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_dashboard', tab='resumo') }}">Limpar</a>
          {% endif %}
          <button id="btnExportXLSX" type="button" class="btn btn-outline-success btn-sm">
            <i class="bi bi-file-earmark-excel"></i> Exportar XLSX (com filtros)
          </button>
          {% if ri or rf or rid or cid %}
            <span class="small text-muted ms-1">
              Período: <b>{{ ri if ri else 'início' }}</b> a <b>{{ rf if rf else 'hoje' }}</b>
              {% if rid %} · Estab: <b>{{ (restaurantes|selectattr('id','equalto',rid)|list)[0].nome }}</b>{% endif %}
              {% if cid %} · Cooperado: <b>{{ (cooperados|selectattr('id','equalto',cid)|list)[0].nome }}</b>{% endif %}
            </span>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-2">
    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Total Produções</div>
            <div id="kpiTotalProds" class="fw-bold fs-5">R$ {{ '%.2f'|format(total_producoes_f) }}</div>
            <div class="small text-muted">Bruto no período</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-graph-up"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Total INSS</div>
            <div id="kpiINSS" class="fw-bold fs-5">R$ {{ '%.2f'|format(total_inss_f) }}</div>
            <div class="small text-muted">4,5% s/ produções</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-shield-check"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Receitas Cooperativa</div>
            <div id="kpiRecCoopCorp" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(total_receitas_corp_f) }}</div>
            <div class="small text-muted">Entradas da coop</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-cash-coin"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Despesas Cooperativa</div>
            <div id="kpiDespCoopCorp" class="fw-bold fs-5 text-danger">R$ {{ '%.2f'|format(total_despesas_corp_f) }}</div>
            <div class="small text-muted">Saídas da coop</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-cart-dash"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Receitas Cooperados (Prod + Rec)</div>
            <div id="kpiRecCooperadosFull" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(total_receitas_coop_full_f) }}</div>
            <div class="small text-muted">Produções + Receitas</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-currency-exchange"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Despesas Cooperados</div>
            <div id="kpiDespCooperados" class="fw-bold fs-5 text-danger">R$ {{ '%.2f'|format(total_despesas_coop_f) }}</div>
            <div class="small text-muted">Débitos/benefícios</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-bank"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Resultado Cooperativa</div>
            <div class="fw-bold fs-5">
              <span id="kpiResultadoCoop" class="{{ 'text-success' if _resultado_corp >= 0 else 'text-danger' }}">
                R$ {{ '%.2f'|format(_resultado_corp) }}
              </span>
            </div>
            <div class="small text-muted">Receitas − Despesas (coop)</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-pie-chart"></i></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
      <div class="card border-0 shadow-sm rounded-3 h-100 p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase text-muted small">Total de Receitas (Geral)</div>
            <div id="kpiTotalReceitasGeral" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(_total_receitas_geral) }}</div>
            <div class="small text-muted">Coop + (Prod + Rec Cooperados)</div>
          </div>
          <div class="kpi-icon"><i class="bi bi-cash-stack"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumo por Cooperado -->
  <div class="card border-0 shadow-sm rounded-3 mt-2">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
        <h6 class="m-0 d-flex align-items-center gap-2">
          <i class="bi bi-people"></i> Resumo por Cooperado (filtro aplicado)
        </h6>
        <small class="text-muted">Líquido = Produções + <span class="text-success">Receitas</span> − INSS − <span class="text-danger">Despesas</span> − <span class="text-primary">Adiant.</span></small>
      </div>
      <div class="table-responsive">
        <table id="tblResumoCoop" class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th>Cooperado</th>
              <th class="text-end">Produções</th>
              <th class="text-end">INSS (4,5%)</th>
              <th class="text-end">Receitas</th>
              <th class="text-end">Despesas</th>
              <th class="text-end">Adiant.</th>
              <th class="text-end">Líquido</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" class="text-center text-muted">Carregando…</td></tr>
          </tbody>
          <tfoot>
            <tr class="table-light fw-bold">
              <td>Total</td>
              <td class="text-end" id="tProd">R$ 0,00</td>
              <td class="text-end" id="tINSS">R$ 0,00</td>
              <td class="text-end text-success" id="tRec">R$ 0,00</td>
              <td class="text-end text-danger" id="tDes">R$ 0,00</td>
              <td class="text-end text-primary" id="tAd">R$ 0,00</td>
              <td class="text-end fw-bold" id="tLiq">R$ 0,00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-2 mt-2">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm rounded-3 p-3">
        <h6 class="mb-2"><i class="bi bi-graph-up-arrow"></i> Evolução Mensal — Cooperativa</h6>
        <canvas id="chartCoop"></canvas>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm rounded-3 p-3">
        <h6 class="mb-2"><i class="bi bi-graph-up-arrow"></i> Evolução Mensal — Cooperados</h6>
        <canvas id="chartCooperados"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-2 mt-2">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-3 p-3">
        <h6 class="mb-2"><i class="bi bi-shop"></i> Top Estabelecimentos (Produções no período)</h6>
        <canvas id="chartEstabs"></canvas>
      </div>
    </div>
  </div>

  {% set _has_av = (avaliacoes is defined) and (avaliacoes|length > 0) %}
  <div class="row g-2 mt-2" {% if not _has_av %}style="display:none"{% endif %}>
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-sm rounded-3 p-3">
        <h6 class="mb-2"><i class="bi bi-stars"></i> Avaliações — Média por mês</h6>
        <canvas id="chartAvaliacao"></canvas>
      </div>
    </div>
  </div>

  <style>
    .kpi-icon{
      width:42px;height:42px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(39,71,217,.10);color:var(--royal-blue)
    }
  </style>
</section>

{# ===================== CONTEÚDO DA ABA "Avaliações" ===================== #}
<section id="avaliacoes" class="tab-pane fade {{ 'show active' if _tab=='avaliacoes' else '' }}" role="tabpanel">

  {% set page_title = "Avaliações" %}
  <div class="container py-3">

    <!-- Título + Toggle de Tipo -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="m-0 d-flex align-items-center gap-2">
        <i class="bi bi-stars"></i> Avaliações
        <small class="text-muted">
          | {{ 'Cooperado → Restaurante' if (tipo|default('restaurante'))=='restaurante' else 'Restaurante → Cooperado' }}
        </small>
      </h4>

      <div class="btn-group" role="group" aria-label="Tipo de avaliação">
        <a class="btn btn-sm {{ 'btn-primary' if (tipo|default('restaurante'))=='restaurante' else 'btn-outline-primary' }}"
           href="{{ url_for('admin_avaliacoes',
                            tipo='restaurante',
                            restaurante_id=_flt.restaurante_id|default(''),
                            cooperado_id=_flt.cooperado_id|default(''),
                            data_inicio=_flt.data_inicio|default(''),
                            data_fim=_flt.data_fim|default('')) }}">
          Cooperado → Restaurante
        </a>
        <a class="btn btn-sm {{ 'btn-primary' if (tipo|default('restaurante'))=='cooperado' else 'btn-outline-primary' }}"
           href="{{ url_for('admin_avaliacoes',
                            tipo='cooperado',
                            restaurante_id=_flt.restaurante_id|default(''),
                            cooperado_id=_flt.cooperado_id|default(''),
                            data_inicio=_flt.data_inicio|default(''),
                            data_fim=_flt.data_fim|default('')) }}">
          Restaurante → Cooperado
        </a>
      </div>
    </div>

    <!-- Barra de ações -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <a class="btn btn-outline-secondary btn-sm"
         href="{{ url_for('admin_export_avaliacoes_csv',
                          tipo=tipo|default('restaurante'),
                          restaurante_id=_flt.restaurante_id|default(''),
                          cooperado_id=_flt.cooperado_id|default(''),
                          data_inicio=_flt.data_inicio|default(''),
                          data_fim=_flt.data_fim|default('')) }}">
        <i class="bi bi-download"></i> Exportar CSV
      </a>
    </div>

    <!-- Filtros -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <form method="GET" action="{{ url_for('admin_avaliacoes') }}" class="row g-2 align-items-end">
          <input type="hidden" name="tipo" value="{{ tipo|default('restaurante') }}">

          <div class="col-md-4">
            <label class="form-label">Restaurante</label>
            <select class="form-select form-select-sm" name="restaurante_id">
              <option value="">Todos</option>
              {% for r in (restaurantes|default([])) %}
                <option value="{{ r.id }}" {{ 'selected' if ((_flt.restaurante_id|default(0))==r.id) else '' }}>{{ r.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Cooperado</label>
            <select class="form-select form-select-sm" name="cooperado_id">
              <option value="">Todos</option>
              {% for c in (cooperados|default([])) %}
                <option value="{{ c.id }}" {{ 'selected' if ((_flt.cooperado_id|default(0))==c.id) else '' }}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label">De</label>
            <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ _flt.data_inicio|default('') }}">
          </div>
          <div class="col-md-2">
            <label class="form-label">Até</label>
            <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ _flt.data_fim|default('') }}">
          </div>

          <div class="col-12 d-flex gap-2">
            <button class="btn btn-royal btn-sm"><i class="bi bi-funnel"></i> Filtrar</button>
            <button type="button" id="btnMesAtual" class="btn btn-light btn-sm">Este mês (1–último)</button>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_avaliacoes', tipo=tipo|default('restaurante')) }}">Limpar</a>
          </div>
        </form>
      </div>
    </div>

    <!-- KPIs -->
    {% set _k = kpis|default({}) %}
    <div class="row g-2 mb-3">
      <div class="col-6 col-lg-2">
        <div class="card p-3 text-center h-100">
          <div class="small text-muted">Avaliações</div>
          <div class="fs-5 fw-bold">{{ _k.qtd|default(0) }}</div>
        </div>
      </div>
      <div class="col-6 col-lg-2">
        <div class="card p-3 text-center h-100">
          <div class="small text-muted">Média Geral</div>
          <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.geral|default(0)) }}</div>
        </div>
      </div>

      {% if (tipo|default('restaurante'))=='restaurante' %}
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Tratamento</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.trat|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Ambiente</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.amb|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Suporte</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.sup|default(0)) }}</div>
          </div>
        </div>
      {% else %}
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Pontualidade</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.pont|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Educação</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.educ|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Eficiência</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.efic|default(0)) }}</div>
          </div>
        </div>
        <div class="col-6 col-lg-2">
          <div class="card p-3 text-center h-100">
            <div class="small text-muted">Apresentação</div>
            <div class="fs-5 fw-bold">{{ '%.2f'|format(_k.apres|default(0)) }}</div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Ranking + Gráfico -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0">
            <i class="bi bi-trophy"></i>
            Ranking por {{ 'restaurante' if (tipo|default('restaurante'))=='restaurante' else 'cooperado' }} (mín. 3 avaliações)
          </h6>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                {% if (tipo|default('restaurante'))=='restaurante' %}
                  <th>Restaurante</th>
                  <th class="text-center">Avaliações</th>
                  <th class="text-center">Média Geral</th>
                  <th class="text-center">Trat.</th>
                  <th class="text-center">Amb.</th>
                  <th class="text-center">Sup.</th>
                {% else %}
                  <th>Cooperado</th>
                  <th class="text-center">Avaliações</th>
                  <th class="text-center">Média Geral</th>
                  <th class="text-center">Pont.</th>
                  <th class="text-center">Educ.</th>
                  <th class="text-center">Efic.</th>
                  <th class="text-center">Apres.</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% if (tipo|default('restaurante'))=='restaurante' %}
                {% set _rk = ranking|default([]) %}
                {% set _have = false %}
                {% for r in _rk %}
                  {% if (r.qtd|default(0)) >= 3 %}
                    {% set _have = true %}
                    <tr>
                      <td>{{ r.rest_nome }}</td>
                      <td class="text-center">{{ r.qtd }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_geral|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_trat|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_amb|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_sup|default(0)) }}</td>
                    </tr>
                  {% endif %}
                {% endfor %}
                {% if not _have %}
                  <tr><td colspan="6" class="text-center text-muted">Sem dados suficientes</td></tr>
                {% endif %}
              {% else %}
                {% set _rk = ranking|default([]) %}
                {% set _have = false %}
                {% for r in _rk %}
                  {% if (r.qtd|default(0)) >= 3 %}
                    {% set _have = true %}
                    <tr>
                      <td>{{ r.coop_nome }}</td>
                      <td class="text-center">{{ r.qtd }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_geral|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_pont|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_educ|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_efic|default(0)) }}</td>
                      <td class="text-center">{{ '%.2f'|format(r.m_apres|default(0)) }}</td>
                    </tr>
                  {% endif %}
                {% endfor %}
                {% if not _have %}
                  <tr><td colspan="7" class="text-center text-muted">Sem dados suficientes</td></tr>
                {% endif %}
              {% endif %}
            </tbody>
          </table>
        </div>

        <div class="mt-3">
          <canvas id="chartTop" height="120"></canvas>
        </div>
      </div>
    </div>

    <!-- Compatibilidade Cooperado × Restaurante (percentual) -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <h6 class="m-0 d-flex align-items-center gap-2">
            <i class="bi bi-heart-fill"></i> Compatibilidade Cooperado × Restaurante
          </h6>
          <span class="text-muted small">
            Percentual calculado como <b>(média ★ ÷ 5) × 100</b>. Quando disponível, mostramos também o 360° (mão dupla).
          </span>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                <th style="width:260px">Cooperado</th>
                <th style="width:260px">Restaurante</th>
                <th class="text-center" style="width:120px">Média ★</th>
                <th style="min-width:220px">Compatibilidade</th>
                <th class="text-center" style="width:120px">Avaliações</th>
                <th class="text-center" style="width:120px">360°</th>
              </tr>
            </thead>
            <tbody>
              {% set _compat = compat|default([]) %}
              {% if _compat and (_compat|length) > 0 %}
                {% set shown = 0 %}
                {% for row in _compat %}
                  {% if (row.count|default(0)) >= 1 %}
                    {% set shown = shown + 1 %}
                    {% set pct = ((row.avg|default(0) / 5.0) * 100.0) %}
                    <tr>
                      <td class="text-break">{{ row.coop|default('-') }}</td>
                      <td class="text-break">{{ row.rest|default('-') }}</td>
                      <td class="text-center fw-bold">{{ '%.2f'|format(row.avg|default(0)) }}</td>
                      <td>
                        <div class="progress" style="height:10px;">
                          <div class="progress-bar {{ 'bg-success' if pct>=80 else ('bg-warning' if pct>=60 else 'bg-danger') }}"
                               role="progressbar"
                               style="width: {{ '%.0f'|format(pct) }}%;"
                               aria-valuenow="{{ '%.0f'|format(pct) }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="small text-muted mt-1">
                          {{ '%.0f'|format(pct) }}%
                          {% if (tipo|default('restaurante'))=='restaurante' %}
                            (coop → rest)
                          {% else %}
                            (rest → coop)
                          {% endif %}
                        </div>
                      </td>
                      <td class="text-center">{{ row.count|default(0) }}</td>
                      <td class="text-center">
                        {% if compat360 is defined %}
                          {% set k = row.key if row.key is defined else (row.pair_key if row.pair_key is defined else None) %}
                          {% set x = (compat360.get(k) if k else None) %}
                          {% if x %}
                            {% set pct_cr = ((x.avg_cr|default(0) / 5.0)*100.0) %}
                            {% set pct_rc = ((x.avg_rc|default(0) / 5.0)*100.0) %}
                            {% set pct_mix = ((pct_cr + pct_rc)/2.0) %}
                            <span class="badge {{ 'text-bg-success' if pct_mix>=80 else ('text-bg-warning' if pct_mix>=60 else 'text-bg-danger') }}">
                              {{ '%.0f'|format(pct_mix) }}%
                            </span>
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
                {% if shown == 0 %}
                  <tr><td colspan="6" class="text-center text-muted">Sem dados suficientes.</td></tr>
                {% endif %}
              {% else %}
                <tr><td colspan="6" class="text-center text-muted">Sem dados suficientes.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Insights rápidos (diagnóstico inteligente) -->
    <div class="card border-0 shadow-sm rounded-3 mb-3">
      <div class="card-body">
        <h6 class="m-0 mb-2"><i class="bi bi-graph-up-arrow"></i> Insights rápidos</h6>
        <div id="insightsWrap" class="row g-2">
          <!-- preenchido via JS com base nos dados já renderizados -->
        </div>
      </div>
    </div>

    <!-- Lista detalhada -->
    <div class="card border-0 shadow-sm rounded-3">
      <div class="card-body">
        <h6 class="m-0 mb-2"><i class="bi bi-list-stars"></i> Avaliações (detalhe)</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr class="text-nowrap">
                <th>Data</th>
                <th>Restaurante</th>
                <th>Cooperado</th>
                <th>Geral</th>
                {% if (tipo|default('restaurante'))=='restaurante' %}
                  <th>Trat.</th><th>Amb.</th><th>Sup.</th>
                {% else %}
                  <th>Pont.</th><th>Educ.</th><th>Efic.</th><th>Apres.</th>
                {% endif %}
                <th>Comentário</th>
                <th>Média</th>
                <th>Sentimento</th>
                <th>Temas</th>
                <th>Crítico?</th>
              </tr>
            </thead>
            <tbody>
              {% set _avs = avaliacoes|default([]) %}
              {% if _avs and (_avs|length) > 0 %}
                {% for a in _avs %}
                  <tr>
                    <td class="text-nowrap">{{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em else '-' }}</td>
                    <td class="text-break">{{ a.rest_nome|default('-') }}</td>
                    <td class="text-break">{{ a.coop_nome|default('-') }}</td>
                    <td class="text-center">{{ a.geral|default('') }}</td>

                    {% if (tipo|default('restaurante'))=='restaurante' %}
                      <td class="text-center">{{ a.trat|default('') }}</td>
                      <td class="text-center">{{ a.amb|default('') }}</td>
                      <td class="text-center">{{ a.sup|default('') }}</td>
                    {% else %}
                      <td class="text-center">{{ a.pont|default('') }}</td>
                      <td class="text-center">{{ a.educ|default('') }}</td>
                      <td class="text-center">{{ a.efic|default('') }}</td>
                      <td class="text-center">{{ a.apres|default('') }}</td>
                    {% endif %}

                    <td class="text-break">{{ a.comentario|default('') }}</td>
                    <td class="text-center">{{ a.media if a.media is not none else '' }}</td>
                    <td class="text-center">{{ a.sentimento|default('') }}</td>
                    <td class="text-break">{{ a.temas|default('') }}</td>
                    <td class="text-center">{{ 'SIM' if a.alerta else 'NÃO' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{{ 11 if (tipo|default('restaurante'))=='restaurante' else 13 }}"
                      class="text-center text-muted">Nenhuma avaliação</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div> <!-- /container -->
</section>

     <!-- LANÇAMENTOS -->
<section class="tab-pane fade {{ 'show active' if _tab=='lancamentos' else '' }}" id="lancamentos" role="tabpanel">
  {% set soma_valor = (lancamentos|sum(attribute='valor')) if lancamentos else 0 %}
  {% set soma_inss  = (soma_valor * 0.045) %}
  {% set soma_liq   = (soma_valor - soma_inss) %}

  <!-- Header + KPIs -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-journal-text"></i> Lançamentos
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ lancamentos|length if lancamentos else 0 }}</b></span>
      <span class="badge bg-success-subtle text-success border">Bruto: <b>R$ {{ '%.2f'|format(soma_valor) }}</b></span>
      <span class="badge bg-secondary-subtle text-secondary border">INSS 4,5%: <b>R$ {{ '%.2f'|format(soma_inss) }}</b></span>
      <span class="badge {{ 'bg-success-subtle text-success' if soma_liq >=0 else 'bg-danger-subtle text-danger' }} border">
        Líquido: <b>R$ {{ '%.2f'|format(soma_liq) }}</b>
      </span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar Lançamentos</h6>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvancados" aria-expanded="false">
          <i class="bi bi-sliders"></i> Mais filtros
        </button>
      </div>

      <form method="GET" action="{{ url_for('filtrar_lancamentos') }}" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="lancamentos">

        <div class="col-md-3">
          <label class="form-label">Restaurante</label>
          <select class="form-select form-select-sm" name="restaurante_id">
            <option value="">Todos</option>
            {% for r in restaurantes %}
              <option value="{{ r.id }}" {{ 'selected' if (request.args.get('restaurante_id')|int) == r.id else '' }}>{{ r.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Cooperado</label>
          <select class="form-select form-select-sm" name="cooperado_id">
            <option value="">Todos</option>
            {% for c in cooperados %}
              <option value="{{ c.id }}" {{ 'selected' if (request.args.get('cooperado_id')|int) == c.id else '' }}>{{ c.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>

        <div class="col-md-2">
          <div class="form-check form-switch mt-4">
            <input class="form-check-input" type="checkbox" name="considerar_periodo" value="1" id="considerarPeriodo"
                   {{ 'checked' if request.args.get('considerar_periodo') else '' }}>
            <label class="form-check-label small" for="considerarPeriodo" title="Aplica a regra de período do restaurante (Seg-Dom, Sáb-Sex, Sex-Qui)">
              Considerar período do restaurante
            </label>
          </div>
        </div>

        <div class="collapse" id="filtrosAvancados">
          <div class="col-12 mt-2">
            <label class="form-label mb-1">Dias da Semana</label>
            <div class="d-flex flex-wrap">
              {% set dows = request.args.getlist('dow') %}
              {% set dlabels = [('1','Seg'),('2','Ter'),('3','Qua'),('4','Qui'),('5','Sex'),('6','Sáb'),('7','Dom')] %}
              {% for val,label in dlabels %}
                <div class="form-check form-check-inline me-2">
                  <input class="form-check-input" id="dow{{ val }}" type="checkbox" name="dow" value="{{ val }}" {{ 'checked' if val in dows else '' }}>
                  <label class="form-check-label" for="dow{{ val }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-royal btn-sm"><i class="bi bi-funnel"></i> Filtrar</button>
          <a href="{{ url_for('exportar_lancamentos', **request.args) }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
          </a>
          <button type="reset" class="btn btn-light btn-sm">Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lançar Produção -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Lançar Produção</h6>
        <span class="text-muted small">A competência por <b>período do restaurante</b> é aplicada no back-end.</span>
      </div>

      <form method="POST" action="{{ url_for('admin_add_lancamento') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-3">
          <label class="form-label">Restaurante</label>
          <select class="form-select form-select-sm" name="restaurante_id" required>
            {% for r in restaurantes %}<option value="{{ r.id }}">{{ r.nome }} ({{ r.periodo }})</option>{% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Cooperado</label>
          <select class="form-select form-select-sm" name="cooperado_id" required>
            {% for c in cooperados %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Ex.: almoço, jantar" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" required>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Horário</label>
          <div class="input-group input-group-sm">
            <input type="time" class="form-control" name="hora_inicio">
            <span class="input-group-text">às</span>
            <input type="time" class="form-control" name="hora_fim">
          </div>
        </div>

        <div class="col-md-2">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-plus-circle"></i> Lançar</button>
        </div>
      </form>

      <div class="mt-2 text-muted small">
        Nota: o INSS abaixo é o cálculo bruto linha-a-linha (4,5%). <b>Isenções por benefício</b> entram na <u>Folha</u> e nos <u>totais</u> do Resumo.
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th>Restaurante</th>
              <th>Período</th>
              <th>Cooperado</th>
              <th>Descrição</th>
              <th class="text-end">Valor</th>
              <th>Data</th>
              <th>Horário</th>
              <th class="text-end">INSS (4,5%)</th>
              <th class="text-end">Líquido</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for l in lancamentos %}
              {% set inss = (l.valor or 0)*0.045 %}
              {% set liq  = (l.valor or 0) - inss %}
              <tr>
                <td>{{ l.restaurante.nome }}</td>
                <td class="text-nowrap">
                  <span class="badge bg-light text-dark border">{{ l.restaurante.periodo }}</span>
                </td>
                <td>{{ l.cooperado.nome }}</td>
                <td class="text-break">{{ l.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(l.valor) }}</td>
                <td>{{ l.data.strftime('%d/%m/%Y') }}</td>
                <td class="text-nowrap">
                  {{ l.hora_inicio }}{% if l.hora_fim %} às {{ l.hora_fim }}{% endif %}
                </td>
                <td class="text-end">R$ {{ "%.2f"|format(inss) }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(liq) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditLancamento"
                          data-id="{{ l.id }}" data-restaurante="{{ l.restaurante.id }}" data-cooperado="{{ l.cooperado.id }}"
                          data-descricao="{{ l.descricao }}" data-valor="{{ l.valor }}" data-data="{{ l.data.strftime('%Y-%m-%d') }}"
                          data-hora_inicio="{{ l.hora_inicio }}" data-hora_fim="{{ l.hora_fim }}"
                          data-url="{{ url_for('admin_edit_lancamento', id=l.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del" href="{{ url_for('admin_delete_lancamento', id=l.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="10" class="text-center text-muted">Nenhum lançamento encontrado</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="4" class="text-end">Totais do Filtro:</th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_valor) }}</th>
              <th></th><th></th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_inss) }}</th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_liq) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

    <!-- RECEITAS COOP -->
<section class="tab-pane fade {{ 'show active' if _tab=='receitas' else '' }}" id="receitas" role="tabpanel">
  {% set ns_total = namespace(v=0) %}
  {% for r in receitas or [] %}
    {% set v_item = r.valor|default(r.valor_total, true)|default(0, true) %}
    {% set ns_total.v = ns_total.v + (v_item or 0) %}
  {% endfor %}
  {% set total_receitas_coop_table = ns_total.v %}
  {% set qtd_registros = receitas|length if receitas else 0 %}

  <!-- Header + KPIs -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-cash"></i> Receitas da Cooperativa
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ qtd_registros }}</b></span>
      <span class="badge bg-success-subtle text-success border">Total: <b>R$ {{ '%.2f'|format(total_receitas_coop_table) }}</b></span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="receitas">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio"
                 value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim"
                 value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
        <div class="col-md-3 d-none d-md-block"></div>
      </form>
    </div>
  </div>

  <!-- Adicionar Receita -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Receita</h6>
        <span class="text-muted small">Preencha os campos e clique em <b>Adicionar</b>.</span>
      </div>

      <form method="POST" action="{{ url_for('add_receita') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-5">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>
        <div class="col-md-2">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-success btn-sm w-100">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for r in receitas %}
              {% set v_row = r.valor|default(r.valor_total, true)|default(0, true) %}
              <tr>
                <td>{{ r.data.strftime('%d/%m/%Y') if r.data else '-' }}</td>
                <td class="text-break">{{ r.descricao }}</td>
                <td class="text-end">R$ {{ '%.2f'|format(v_row) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditReceita"
                          data-id="{{ r.id }}"
                          data-descricao="{{ r.descricao }}"
                          data-valor="{{ v_row }}"
                          data-data="{{ r.data.strftime('%Y-%m-%d') if r.data else '' }}"
                          data-url="{{ url_for('edit_receita', id=r.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del"
                     href="{{ url_for('delete_receita', id=r.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-center text-muted">Nenhuma receita</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="2" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(total_receitas_coop_table) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

     <!-- DESPESAS COOP -->
<section class="tab-pane fade {{ 'show active' if _tab=='despesas' else '' }}" id="despesas" role="tabpanel">
  {% set total_despesas_coop_table = (despesas|sum(attribute='valor')) if despesas else 0 %}
  {% set qtd_registros = despesas|length if despesas else 0 %}

  <!-- Header + KPIs -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-bag-dash"></i> Despesas da Cooperativa
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ qtd_registros }}</b></span>
      <span class="badge bg-danger-subtle text-danger border">Total: <b>R$ {{ '%.2f'|format(total_despesas_coop_table) }}</b></span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="despesas">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio"
                 value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim"
                 value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
        <div class="col-md-3 d-none d-md-block"></div>
      </form>
    </div>
  </div>

  <!-- Adicionar Despesa -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Despesa</h6>
        <span class="text-muted small">Preencha os campos e clique em <b>Adicionar</b>.</span>
      </div>

      <form method="POST" action="{{ url_for('add_despesa') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-5">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>
        <div class="col-md-2">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-danger btn-sm w-100">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for d in despesas %}
              <tr>
                <td>{{ d.data.strftime('%d/%m/%Y') if d.data else '-' }}</td>
                <td class="text-break">{{ d.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(d.valor) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditDespesa"
                          data-id="{{ d.id }}"
                          data-descricao="{{ d.descricao }}"
                          data-valor="{{ d.valor }}"
                          data-data="{{ d.data.strftime('%Y-%m-%d') if d.data else '' }}"
                          data-url="{{ url_for('edit_despesa', id=d.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del"
                     href="{{ url_for('delete_despesa', id=d.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-center text-muted">Nenhuma despesa</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="2" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(total_despesas_coop_table) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>
<!-- Bootstrap JS (necessário para abas, modais, etc.) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =========================================================
   HELPERS GLOBAIS (Chart.js / XLSX)
   ========================================================= */
window.ensureChart = window.ensureChart || function(){
  return new Promise(function(resolve){
    if (window.Chart) return resolve();
    var s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = function(){ resolve(); };
    document.head.appendChild(s);
  });
};

window.ensureXLSX = window.ensureXLSX || function(){
  return new Promise(function(resolve){
    if (window.XLSX) return resolve();
    var s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
    s.onload = function(){ resolve(); };
    document.head.appendChild(s);
  });
};

/* =========================================================
   RESUMO / DASHBOARD FINANCEIRO + EXPORTAÇÃO XLSX
   ========================================================= */
(function(){
  // Esses valores vêm do Jinja (aba Resumo)
  const FILTER = {
    ri: "{{ ri|default('') }}",
    rf: "{{ rf|default('') }}",
    rid: {{ rid if rid is not none else 'null' }},
    cid: {{ cid if cid is not none else 'null' }}
  };

  // Bases (servidor → JS)
  const PRODUCOES = [
    {% for l in _producoes %}
      {
        id: {{ l.id }},
        data: "{{ ymd(l.data) }}",
        valor: {{ (l.valor or 0)|float }},
        cooperado_id: {{ l.cooperado.id if l.cooperado else 'null' }},
        cooperado_nome: "{{ (l.cooperado.nome if l.cooperado else '')|e }}",
        restaurante_id: {{ l.restaurante.id if l.restaurante else 'null' }},
        restaurante_nome: "{{ (l.restaurante.nome if l.restaurante else '')|e }}"
      }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const REC_COOP = [
    {% for r in receitas_coop %}
      {
        id: {{ r.id }},
        data: "{{ ymd(r.data) }}",
        valor: {{ (r.valor or 0)|float }},
        cooperado_id: {{ r.cooperado.id if r.cooperado else 'null' }},
        cooperado_nome: "{{ (r.cooperado.nome if r.cooperado else '')|e }}",
        descricao: "{{ (r.descricao or '')|e }}"
      }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const DESP_COOP = [
    {% for d in despesas_coop %}
      {
        id: {{ d.id }},
        data: "{{ ymd(d.data) }}",
        valor: {{ (d.valor or 0)|float }},
        cooperado_id: {{ d.cooperado.id if d.cooperado else 'null' }},
        cooperado_nome: "{{ (d.cooperado.nome if d.cooperado else (d.cooperado_nome if d.cooperado_nome is defined else ''))|e }}",
        descricao: "{{ (d.descricao or '')|e }}",
        adiantamento: {{ 1 if d.adiantamento else 0 }}
      }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const REC_COOP_CORP = [
    {% for r in _rec_coop_corp %}
      {
        id: {{ r.id }},
        data: "{{ ymd(r.data or r.data_lancamento) }}",
        valor: {{ (r.valor|default(r.valor_total, true)|default(0, true))|float }},
        descricao: "{{ (r.descricao or '')|e }}"
      }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const DESP_COOP_CORP = [
    {% for d in _desp_coop_corp %}
      {
        id: {{ d.id }},
        data: "{{ ymd(d.data or d.data_lancamento) }}",
        valor: {{ (d.valor|default(d.valor_total, true)|default(0, true))|float }},
        descricao: "{{ (d.descricao or '')|e }}"
      }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const COOPS = [
    {% for c in cooperados %}
      { id: {{ c.id }}, nome: "{{ c.nome|e }}" }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const RESTS = [
    {% for r in restaurantes %}
      { id: {{ r.id }}, nome: "{{ r.nome|e }}" }{{ "," if not loop.last }}
    {% endfor %}
  ];

  const AVALS = [
    {% for a in (avaliacoes or []) %}
      { data: "{{ a.criado_em.strftime('%Y-%m-%d') if a.criado_em else '' }}", geral: {{ (a.geral or 0)|float }} }{{ "," if not loop.last }}
    {% endfor %}
  ];

  // Helpers
  const parseISO = s => (!s)?null:new Date(s+'T00:00:00');
  const fmtBR = v => 'R$ ' + Number(v||0).toLocaleString('pt-BR',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });

  const inRange = d => {
    const di = parseISO(FILTER.ri), df = parseISO(FILTER.rf), x = parseISO(d);
    if(!x) return true;
    if(di && x < di) return false;
    if(df && x > df) return false;
    return true;
  };

  const byMonthKey = d => {
    if(!d) return '';
    const dt = parseISO(d);
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
  };

  const sumBy = (arr, fn) => arr.reduce((acc,cur)=>acc+(+fn(cur)||0), 0);

  // Filtrados
  const filteredPROD = PRODUCOES.filter(p =>
    inRange(p.data) &&
    (FILTER.cid==null || p.cooperado_id===FILTER.cid) &&
    (FILTER.rid==null || p.restaurante_id===FILTER.rid)
  );
  const filteredRECp = REC_COOP.filter(r =>
    inRange(r.data) &&
    (FILTER.cid==null || r.cooperado_id===FILTER.cid)
  );
  const filteredDESp = DESP_COOP.filter(d =>
    inRange(d.data) &&
    (FILTER.cid==null || d.cooperado_id===FILTER.cid)
  );
  const filteredRECc = REC_COOP_CORP.filter(r => inRange(r.data));
  const filteredDESc = DESP_COOP_CORP.filter(d => inRange(d.data));

  // KPIs
  const kpiProd = sumBy(filteredPROD, x=>x.valor);
  const kpiINSS = kpiProd * 0.045;
  const kpiRecCoopCorp = sumBy(filteredRECc, x=>x.valor);
  const kpiDespCoopCorp = sumBy(filteredDESc, x=>x.valor);
  const kpiRecCooperadosFull = kpiProd + sumBy(filteredRECp, x=>x.valor);
  const kpiDespCooperados = sumBy(filteredDESp, x=>x.valor);
  const kpiResultadoCoop = kpiRecCoopCorp - kpiDespCoopCorp;
  const kpiTotalReceitasGeral = kpiRecCoopCorp + kpiRecCooperadosFull;

  const elTotalProds         = document.getElementById('kpiTotalProds');
  const elINSS               = document.getElementById('kpiINSS');
  const elRecCoopCorp        = document.getElementById('kpiRecCoopCorp');
  const elDespCoopCorp       = document.getElementById('kpiDespCoopCorp');
  const elRecCoopFull        = document.getElementById('kpiRecCooperadosFull');
  const elDespCooperados     = document.getElementById('kpiDespCooperados');
  const elTotalReceitasGeral = document.getElementById('kpiTotalReceitasGeral');
  const elResCoop            = document.getElementById('kpiResultadoCoop');

  if (elTotalProds)         elTotalProds.textContent        = fmtBR(kpiProd);
  if (elINSS)               elINSS.textContent              = fmtBR(kpiINSS);
  if (elRecCoopCorp)        elRecCoopCorp.textContent       = fmtBR(kpiRecCoopCorp);
  if (elDespCoopCorp)       elDespCoopCorp.textContent      = fmtBR(kpiDespCoopCorp);
  if (elRecCoopFull)        elRecCoopFull.textContent       = fmtBR(kpiRecCooperadosFull);
  if (elDespCooperados)     elDespCooperados.textContent    = fmtBR(kpiDespCooperados);
  if (elTotalReceitasGeral) elTotalReceitasGeral.textContent= fmtBR(kpiTotalReceitasGeral);

  if (elResCoop){
    elResCoop.textContent = fmtBR(kpiResultadoCoop);
    elResCoop.classList.remove('text-success','text-danger');
    elResCoop.classList.add(kpiResultadoCoop < 0 ? 'text-danger' : 'text-success');
  }

  // Tabela Resumo por Cooperado
  (function buildResumoCoop(){
    const tbody = document.querySelector('#tblResumoCoop tbody');
    if (!tbody) return;

    const map = new Map();
    const ensure = (id, nome) => {
      if(!map.has(id)) map.set(id, {id, nome, prod:0, inss:0, rec:0, des:0, ad:0});
      return map.get(id);
    };

    filteredPROD.forEach(p=>{
      if(p.cooperado_id==null) return;
      const row = ensure(p.cooperado_id, p.cooperado_nome);
      row.prod += p.valor;
      row.inss += p.valor*0.045;
    });
    filteredRECp.forEach(r=>{
      if(r.cooperado_id==null) return;
      const row = ensure(r.cooperado_id, r.cooperado_nome);
      row.rec += r.valor;
    });
    filteredDESp.forEach(d=>{
      if(d.cooperado_id==null) return;
      const row = ensure(d.cooperado_id, d.cooperado_nome || '—');
      if(d.adiantamento) row.ad += d.valor; else row.des += d.valor;
    });

    const rows = Array.from(map.values()).sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
    tbody.innerHTML = rows.length? '' : '<tr><td colspan="7" class="text-center text-muted">Sem dados no filtro.</td></tr>';

    let tProd=0,tINSS=0,tRec=0,tDes=0,tAd=0,tLiq=0;
    rows.forEach(r=>{
      const liq = r.prod + r.rec - r.inss - r.des - r.ad;
      tProd+=r.prod; tINSS+=r.inss; tRec+=r.rec; tDes+=r.des; tAd+=r.ad; tLiq+=liq;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-break">${r.nome||'—'}</td>
        <td class="text-end">${fmtBR(r.prod)}</td>
        <td class="text-end">${fmtBR(r.inss)}</td>
        <td class="text-end text-success">${fmtBR(r.rec)}</td>
        <td class="text-end text-danger">${fmtBR(r.des)}</td>
        <td class="text-end text-primary">${fmtBR(r.ad)}</td>
        <td class="text-end fw-bold ${liq<0?'text-danger':''}">${fmtBR(liq)}</td>`;
      tbody.appendChild(tr);
    });

    const tProdEl = document.getElementById('tProd');
    const tINSSEl = document.getElementById('tINSS');
    const tRecEl  = document.getElementById('tRec');
    const tDesEl  = document.getElementById('tDes');
    const tAdEl   = document.getElementById('tAd');
    const tLiqEl  = document.getElementById('tLiq');

    if (tProdEl) tProdEl.textContent = fmtBR(tProd);
    if (tINSSEl) tINSSEl.textContent = fmtBR(tINSS);
    if (tRecEl)  tRecEl.textContent  = fmtBR(tRec);
    if (tDesEl)  tDesEl.textContent  = fmtBR(tDes);
    if (tAdEl)   tAdEl.textContent   = fmtBR(tAd);
    if (tLiqEl){
      tLiqEl.textContent = fmtBR(tLiq);
      tLiqEl.classList.remove('text-danger','text-success');
      if (tLiq < 0) tLiqEl.classList.add('text-danger');
    }
  })();

  // Gráficos (somente se os canvases existirem)
  window.ensureChart().then(function(){
    // Coop: Receitas vs Despesas
    (function(){
      const el = document.getElementById('chartCoop');
      if(!el) return;
      const byM = {};
      filteredRECc.forEach(r=>{
        const k=byMonthKey(r.data)||'—';
        (byM[k]??={r:0,d:0}).r+=r.valor;
      });
      filteredDESc.forEach(d=>{
        const k=byMonthKey(d.data)||'—';
        (byM[k]??={r:0,d:0}).d+=d.valor;
      });
      const labels = Object.keys(byM).sort();
      const rec = labels.map(k=>byM[k].r);
      const des = labels.map(k=>byM[k].d);
      new Chart(el, {
        type:'bar',
        data:{ labels, datasets:[
          {label:'Receitas', data:rec},
          {label:'Despesas', data:des}
        ]},
        options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}
      });
    })();

    // Cooperados: Produções x INSS
    (function(){
      const el = document.getElementById('chartCooperados');
      if(!el) return;
      const byM = {};
      filteredPROD.forEach(p=>{
        const k=byMonthKey(p.data)||'—';
        (byM[k]??={prod:0,inss:0}).prod+=p.valor;
        byM[k].inss += p.valor*0.045;
      });
      const labels = Object.keys(byM).sort();
      const prod = labels.map(k=>byM[k].prod);
      const inss = labels.map(k=>byM[k].inss);
      new Chart(el, {
        type:'line',
        data:{ labels, datasets:[
          {label:'Produções (bruto)', data:prod, tension:.2},
          {label:'INSS (4,5%)', data:inss, tension:.2}
        ]},
        options:{responsive:true, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}
      });
    })();

    // Estabelecimentos (ranking)
    (function(){
      const el = document.getElementById('chartEstabs');
      if(!el) return;
      const byR = {};
      filteredPROD.forEach(p=>{
        if(p.restaurante_id==null) return;
        byR[p.restaurante_nome] = (byR[p.restaurante_nome]||0)+p.valor;
      });
      const entries = Object.entries(byR).sort((a,b)=>b[1]-a[1]).slice(0,20);
      const labels = entries.map(e=>e[0]);
      const vals   = entries.map(e=>e[1]);
      new Chart(el, {
        type:'bar',
        data:{ labels, datasets:[{label:'Produções por Estabelecimento', data:vals}] },
        options:{responsive:true, indexAxis:'y', scales:{x:{beginAtZero:true}}, plugins:{legend:{display:false}}}
      });
    })();

    // Avaliações média por mês (se houver)
    (function(){
      const el = document.getElementById('chartAvaliacao');
      if(!el || !Array.isArray(AVALS) || !AVALS.length) return;
      const byM = {};
      AVALS.filter(a=>inRange(a.data)).forEach(a=>{
        const k = byMonthKey(a.data)||'—';
        (byM[k]??={s:0,c:0}).s += (a.geral||0);
        byM[k].c += 1;
      });
      const labels = Object.keys(byM).sort();
      if(!labels.length) return;
      const medias = labels.map(k=> byM[k].c ? byM[k].s/byM[k].c : 0 );
      new Chart(el, {
        type:'line',
        data:{ labels, datasets:[{label:'Média ★', data:medias, tension:.2}] },
        options:{responsive:true, scales:{y:{beginAtZero:true, max:5}}, plugins:{legend:{display:false}}}
      });
    })();
  });

  // Exportação XLSX
  function aoaToSheet(title, aoa, wb){
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, title);
  }
  function safeSheetName(s){
    const cleaned = String(s||'').replace(/[:\\/?*\[\]]/g,' ').slice(0,31).trim();
    return cleaned || 'Planilha';
  }

  async function exportXLSX(){
    await window.ensureXLSX();
    const wb = XLSX.utils.book_new();

    const k1 = [
      ['Dashboard Financeiro — Filtro'],
      ['Período', FILTER.ri||'início', '→', FILTER.rf||'hoje'],
      ['Estabelecimento', FILTER.rid==null ? 'Todos' : (RESTS.find(r=>r.id===FILTER.rid)?.nome||FILTER.rid)],
      ['Cooperado', FILTER.cid==null ? 'Todos' : (COOPS.find(c=>c.id===FILTER.cid)?.nome||FILTER.cid)],
      [],
      ['KPIs'],
      ['Total Produções', kpiProd],
      ['INSS (4,5%)',    kpiINSS],
      ['Receitas Coop (período)',  kpiRecCoopCorp],
      ['Despesas Coop (período)',  kpiDespCoopCorp],
      ['Receitas Cooperados (Prod + Rec)', kpiRecCooperadosFull],
      ['Despesas Cooperados (período)', kpiDespCooperados],
      ['Total de Receitas (Geral)', kpiTotalReceitasGeral],
      ['Resultado Cooperativa', kpiResultadoCoop],
    ];
    aoaToSheet('KPIs', k1, wb);

    const prodAOA = [['Data','Cooperado','Estabelecimento','Descrição','Valor','INSS(4,5%)']];
    filteredPROD.forEach(p=>{
      prodAOA.push([p.data, p.cooperado_nome||'', p.restaurante_nome||'', 'Produção', p.valor, p.valor*0.045]);
    });
    aoaToSheet('Producoes', prodAOA, wb);

    const recCAOA = [['Data','Descrição','Valor']];
    filteredRECc.forEach(r=>recCAOA.push([r.data, r.descricao||'', r.valor]));
    aoaToSheet('Receitas_Coop', recCAOA, wb);

    const desCAOA = [['Data','Descrição','Valor']];
    filteredDESc.forEach(d=>desCAOA.push([d.data, d.descricao||'', d.valor]));
    aoaToSheet('Despesas_Coop', desCAOA, wb);

    const byR = {};
    filteredPROD.forEach(p=>{
      if(p.restaurante_nome) byR[p.restaurante_nome]=(byR[p.restaurante_nome]||0)+p.valor;
    });
    const estAOA = [['Estabelecimento','Total Produções (R$)']];
    Object.entries(byR).sort((a,b)=>b[1]-a[1]).forEach(([nome,v])=>estAOA.push([nome,v]));
    aoaToSheet('Estabelecimentos', estAOA, wb);

    const byC_rec = {};
    filteredRECp.forEach(r=>{
      const k = r.cooperado_nome || `ID ${r.cooperado_id}`;
      (byC_rec[k] ||= []).push(r);
    });
    Object.keys(byC_rec).forEach(nome=>{
      const aoa = [['Data','Descrição','Valor']];
      byC_rec[nome].forEach(r=>aoa.push([r.data, r.descricao||'', r.valor]));
      aoaToSheet(safeSheetName('Receita - '+nome), aoa, wb);
    });

    const byC_des = {};
    filteredDESp.forEach(d=>{
      const k = d.cooperado_nome || `ID ${d.cooperado_id}`;
      (byC_des[k] ||= []).push(d);
    });
    Object.keys(byC_des).forEach(nome=>{
      const aoa = [['Data','Descrição','Valor','Adiantamento']];
      byC_des[nome].forEach(d=>aoa.push([d.data, d.descricao||'', d.valor, d.adiantamento? 'SIM':'NÃO']));
      aoaToSheet(safeSheetName('Despesa - '+nome), aoa, wb);
    });

    if (Array.isArray(AVALS) && AVALS.length){
      const avAOA = [['Data','Geral']];
      AVALS.filter(a=>inRange(a.data)).forEach(a=>avAOA.push([a.data, a.geral]));
      aoaToSheet('Avaliacoes', avAOA, wb);
    }

    const now = new Date();
    const ymd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    XLSX.writeFile(wb, `Dashboard_Coopex_${ymd}.xlsx`);
  }

  const btnExport = document.getElementById('btnExportXLSX');
  if (btnExport) {
    btnExport.addEventListener('click', exportXLSX);
  }
})();

/* =========================================================
   AVALIAÇÕES – BOTÃO "ESTE MÊS", GRÁFICO TOP e INSIGHTS
   ========================================================= */
(function(){
  // Botão "Este mês (1–último)"
  const btn = document.getElementById('btnMesAtual');
  if (btn) {
    btn.addEventListener('click', function(){
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth();
      const first = new Date(y, m, 1);
      const last  = new Date(y, m+1, 0);
      const pad = n => String(n).padStart(2,'0');
      const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

      const form = btn.closest('form') || document.querySelector('form[action*="admin_avaliacoes"]');
      if (!form) return;
      const di = form.querySelector('input[name="data_inicio"]');
      const df = form.querySelector('input[name="data_fim"]');
      if (di) di.value = toISO(first);
      if (df) df.value = toISO(last);
      form.submit();
    });
  }

  // Gráfico Top
  const dataTop = {{ chart_top|default({'labels':[], 'values':[]})|tojson }};
  const elTop   = document.getElementById('chartTop');

  if (elTop && dataTop && Array.isArray(dataTop.labels) && dataTop.labels.length){
    window.ensureChart().then(function(){
      new Chart(elTop, {
        type: 'bar',
        data: { labels: dataTop.labels, datasets: [{ label: 'Média Geral', data: dataTop.values }] },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, max: 5 } },
          plugins: { legend: { display: false } }
        }
      });
    });
  }

  // Insights
  const wrap = document.getElementById('insightsWrap');
  if (wrap){
    const tipo = "{{ tipo|default('restaurante') }}";
    const k    = {{ kpis|default({})|tojson }};
    const pct  = v => Math.max(0, Math.min(100, Math.round((Number(v||0)/5)*100)));

    function card(title, value, badgeClass){
      const div = document.createElement('div');
      div.className = 'col-12 col-md-6 col-lg-3';
      const valStr = String(value || '');
      div.innerHTML = `
        <div class="card p-3 h-100">
          <div class="small text-muted">${title}</div>
          <div class="d-flex align-items-center justify-content-between mt-1">
            <div class="fw-bold">${valStr}</div>
            <span class="badge ${badgeClass}">${valStr.includes('%')? valStr : ''}</span>
          </div>
        </div>`;
      return div;
    }

    if (tipo === 'restaurante') {
      const vals = [
        {k:'trat', label:'Tratamento', v:k.trat||0},
        {k:'amb',  label:'Ambiente',   v:k.amb||0},
        {k:'sup',  label:'Suporte',    v:k.sup||0},
      ];
      const sorted = vals.slice().sort((a,b)=>a.v-b.v);
      const worst  = sorted[0];
      const best   = sorted[sorted.length-1];
      const comp   = pct(k.geral||0);

      wrap.appendChild(card('Compatibilidade média (coop → rest)', comp+'%', comp>=80?'text-bg-success':(comp>=60?'text-bg-warning':'text-bg-danger')));
      wrap.appendChild(card('Ponto forte', `${best.label} · ${best.v.toFixed(2)}★`, 'text-bg-success'));
      wrap.appendChild(card('Ponto de atenção', `${worst.label} · ${worst.v.toFixed(2)}★`, 'text-bg-danger'));
      wrap.appendChild(card('Amostra', `${(k.qtd||0)} avaliação(ões)`, 'text-bg-secondary'));
    } else {
      const vals = [
        {k:'pont', label:'Pontualidade',  v:k.pont||0},
        {k:'educ', label:'Educação',      v:k.educ||0},
        {k:'efic', label:'Eficiência',    v:k.efic||0},
        {k:'apres',label:'Apresentação',  v:k.apres||0},
      ];
      const sorted = vals.slice().sort((a,b)=>a.v-b.v);
      const worst  = sorted[0];
      const best   = sorted[sorted.length-1];
      const comp   = pct(k.geral||0);

      wrap.appendChild(card('Compatibilidade média (rest → coop)', comp+'%', comp>=80?'text-bg-success':(comp>=60?'text-bg-warning':'text-bg-danger')));
      wrap.appendChild(card('Ponto forte', `${best.label} · ${best.v.toFixed(2)}★`, 'text-bg-success'));
      wrap.appendChild(card('Ponto de atenção', `${worst.label} · ${worst.v.toFixed(2)}★`, 'text-bg-danger'));
      wrap.appendChild(card('Amostra', `${(k.qtd||0)} avaliação(ões)`, 'text-bg-secondary'));
    }
  }
})();

/* =========================================================
   GENÉRICO – CONFIRMAÇÃO DE EXCLUSÃO
   ========================================================= */
document.querySelectorAll('.btn-del').forEach(function(btn){
  btn.addEventListener('click', function(e){
    if(!confirm('Deseja realmente excluir este registro?')){
      e.preventDefault();
    }
  });
});
</script>
</body>
</html>
