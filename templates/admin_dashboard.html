<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Painel Admin - Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Bootstrap / Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --royal-blue:#2747d9;
      --royal-dark:#16258a;
      --hover-blue:#3b61e3;
      --sidebar-w:260px;
      --text-muted:#8f9bb8;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:'Roboto',sans-serif;
      background:#f3f5fb;
      color:#1f2430;
      overflow-x:hidden;
    }

    .layout{
      display:flex;
      min-height:100vh;
    }

    /* SIDEBAR ----------------------------------------------------------------*/

    .sidebar{
      position:fixed;
      top:0;
      left:0;
      height:100vh;
      width:var(--sidebar-w);
      background:linear-gradient(180deg,var(--royal-blue),var(--royal-dark));
      color:#fff;
      padding:18px 14px;
      display:flex;
      flex-direction:column;
      box-shadow:0 0 22px rgba(0,0,0,.25);
      z-index:1020;
      overflow-y:auto;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:12px;
      padding:0 4px;
    }
    .brand-title{
      font-family:'Orbitron',sans-serif;
      font-size:1.25rem;
      letter-spacing:2px;
      text-transform:uppercase;
      margin:0;
    }
    .brand-sub{
      font-size:.75rem;
      opacity:.8;
    }

    .sidebar-nav{
      margin-top:8px;
      padding:0;
    }

    .nav-section-label{
      font-size:.7rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.60);
      margin:12px 6px 6px;
    }

    .sidebar-divider{
      border-color:rgba(255,255,255,.08);
      margin:10px 0 6px;
    }

    .nav-link-main,
    .nav-link-group-toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
      border:0;
      border-radius:10px;
      padding:8px 10px;
      margin:2px 0;
      background:transparent;
      color:#fff;
      font-size:.9rem;
      text-align:left;
      text-decoration:none;
      cursor:pointer;
      transition:background .15s,transform .05s;
    }
    .nav-link-main:hover,
    .nav-link-group-toggle:hover{
      background:rgba(255,255,255,.08);
    }
    .nav-link-main.active{
      background:rgba(0,0,0,.20);
      box-shadow:0 0 0 1px rgba(255,255,255,.22);
    }
    .nav-link-main:active,
    .nav-link-group-toggle:active{
      transform:scale(.98);
    }

    .nav-link-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .nav-link-icon{
      width:18px;
      display:flex;
      justify-content:center;
    }
    .nav-link-label{
      white-space:nowrap;
    }

    .nav-caret{
      font-size:.8rem;
      opacity:.7;
    }

    .nav-sublinks{
      padding-left:30px;
      margin-bottom:4px;
    }

    .nav-sublink{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      margin:2px 0;
      border-radius:8px;
      font-size:.85rem;
      color:rgba(255,255,255,.85);
      text-decoration:none;
      transition:background .15s,color .15s,transform .05s;
    }
    .nav-sublink:hover{
      background:rgba(255,255,255,.08);
      color:#fff;
    }
    .nav-sublink.active{
      background:rgba(0,0,0,.20);
      color:#fff;
      box-shadow:0 0 0 1px rgba(255,255,255,.22);
    }

    .sidebar-footer{
      margin-top:auto;
      padding-top:10px;
    }

    /* MAIN -------------------------------------------------------------------*/

    .main{
      flex:1;
      margin-left:var(--sidebar-w);
      padding:18px 22px;
    }

    .content-shell{
      max-width:1320px;
      margin:0 auto 32px;
    }

    .page-header{
      margin-bottom:16px;
    }
    .page-header h3{
      margin:0;
      font-size:1.35rem;
      font-weight:600;
    }
    .page-header small{
      color:var(--text-muted);
      font-size:.85rem;
    }

    .card{
      border-radius:12px;
      border:0;
      box-shadow:0 2px 8px rgba(15,23,42,.09);
      background:#fff;
    }

    .btn-royal{
      background:var(--royal-blue);
      color:#fff;
      border-color:var(--royal-blue);
    }
    .btn-royal:hover{
      background:var(--hover-blue);
      border-color:var(--hover-blue);
      color:#fff;
    }

    table thead th{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.03em;
    }

    .form-label{
      font-size:.8rem;
      font-weight:500;
      color:#3c4460;
    }

    .badge-soft{
      background:#eef2ff;
      color:#223;
      border-radius:999px;
      padding:.15rem .55rem;
      font-size:.75rem;
    }

    /* Responsivo -------------------------------------------------------------*/

    @media (max-width: 991.98px){
      :root{ --sidebar-w:72px; }

      .sidebar{
        padding:18px 8px;
      }
      .brand-sub,
      .brand-title,
      .nav-section-label,
      .nav-link-label{
        display:none;
      }
      .nav-sublinks{
        padding-left:12px;
      }
      .main{
        margin-left:var(--sidebar-w);
        padding:16px 10px;
      }
    }
  </style>
</head>
<body>

{# -----------------------------------------
   Fallbacks e aba ativa
   ----------------------------------------- #}
{% set kpis       = kpis if kpis is defined else {'qtd':0,'geral':0,'trat':0,'amb':0,'sup':0,'pont':0,'educ':0,'efic':0,'apres':0} %}
{% set chart_top  = chart_top if chart_top is defined else {'labels':[],'values':[]} %}
{% set ranking    = ranking if ranking is defined else [] %}
{% set compat     = compat if compat is defined else [] %}
{% set avaliacoes = avaliacoes if avaliacoes is defined else [] %}
{% set _flt       = _flt if _flt is defined else namespace(restaurante_id=None, cooperado_id=None, data_inicio='', data_fim='') %}
{% set _tab       = (tab if tab is defined else request.args.get('tab','resumo')) %}

<div class="layout">

  <!-- SIDEBAR -------------------------------------------------------------->
  <aside class="sidebar">

    <div class="brand">
      <h1 class="brand-title">PAINEL COOPEX</h1>
      <span class="brand-sub">Administração Central</span>
    </div>

    <nav class="sidebar-nav nav flex-column">

      <div class="nav-section-label">Visão Geral</div>

      <!-- Resumo (TAB, igual antes) -->
      <a class="nav-link-main {{ 'active' if _tab=='resumo' else '' }}"
         data-bs-toggle="tab"
         data-bs-target="#resumo"
         href="#resumo"
         role="tab"
         aria-controls="resumo"
         aria-selected="{{ 'true' if _tab=='resumo' else 'false' }}">
        <div class="nav-link-left">
          <span class="nav-link-icon"><i class="bi bi-graph-up"></i></span>
          <span class="nav-link-label">Resumo</span>
        </div>
      </a>

      <!-- Avaliações (ROTA /admin/avaliacoes) -->
    <a class="nav-link-main {% if request.endpoint == 'admin_avaliacoes' %}active{% endif %}"
       href="{{ url_for('admin_avaliacoes') }}">
      <div class="nav-link-left">
        <span class="nav-link-icon"><i class="bi bi-stars"></i></span>
        <span class="nav-link-label">Avaliações</span>
      </div>
    </a>

      <hr class="sidebar-divider">

      <!-- FINANCEIRO (TABS, não rotas) ------------------------------------->
      <button class="nav-link-group-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#menuFinanceiro"
              aria-expanded="true">
        <div class="nav-link-left">
          <span class="nav-link-icon"><i class="bi bi-currency-exchange"></i></span>
          <span class="nav-link-label">Financeiro</span>
        </div>
        <span class="nav-caret"><i class="bi bi-chevron-down"></i></span>
      </button>

      <div id="menuFinanceiro" class="collapse show nav-sublinks">
        <!-- Lançamentos (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='lancamentos' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#lancamentos"
           href="#lancamentos"
           role="tab"
           aria-controls="lancamentos"
           aria-selected="{{ 'true' if _tab=='lancamentos' else 'false' }}">
          <i class="bi bi-journal-text"></i>
          <span class="nav-link-label">Lançamentos</span>
        </a>

        <!-- Receitas Coop (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='receitas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#receitas"
           href="#receitas"
           role="tab"
           aria-controls="receitas"
           aria-selected="{{ 'true' if _tab=='receitas' else 'false' }}">
          <i class="bi bi-credit-card"></i>
          <span class="nav-link-label">Receitas Coop</span>
        </a>

        <!-- Despesas Coop (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='despesas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#despesas"
           href="#despesas"
           role="tab"
           aria-controls="despesas"
           aria-selected="{{ 'true' if _tab=='despesas' else 'false' }}">
          <i class="bi bi-cart-dash"></i>
          <span class="nav-link-label">Despesas Coop</span>
        </a>

        <!-- Receitas Cooperados (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='coop_receitas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#coop_receitas"
           href="#coop_receitas"
           role="tab"
           aria-controls="coop_receitas"
           aria-selected="{{ 'true' if _tab=='coop_receitas' else 'false' }}">
          <i class="bi bi-wallet2"></i>
          <span class="nav-link-label">Receitas Cooperados</span>
        </a>

        <!-- Despesas Cooperados (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='coop_despesas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#coop_despesas"
           href="#coop_despesas"
           role="tab"
           aria-controls="coop_despesas"
           aria-selected="{{ 'true' if _tab=='coop_despesas' else 'false' }}">
          <i class="bi bi-bag-dash"></i>
          <span class="nav-link-label">Despesas Cooperados</span>
        </a>

        <!-- Benefícios (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='beneficios' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#beneficios"
           href="#beneficios"
           role="tab"
           aria-controls="beneficios"
           aria-selected="{{ 'true' if _tab=='beneficios' else 'false' }}">
          <i class="bi bi-heart-pulse"></i>
          <span class="nav-link-label">Benefícios</span>
        </a>
      </div>

      <!-- CADASTROS (tabs + rotas) ------------------------------------------>
      <button class="nav-link-group-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#menuCadastros"
              aria-expanded="true">
        <div class="nav-link-left">
          <span class="nav-link-icon"><i class="bi bi-people"></i></span>
          <span class="nav-link-label">Cadastros</span>
        </div>
        <span class="nav-caret"><i class="bi bi-chevron-down"></i></span>
      </button>

      <div id="menuCadastros" class="collapse show nav-sublinks">
        <!-- Cooperados (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='cooperados' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#cooperados"
           href="#cooperados"
           role="tab"
           aria-controls="cooperados"
           aria-selected="{{ 'true' if _tab=='cooperados' else 'false' }}">
          <i class="bi bi-person-badge"></i>
          <span class="nav-link-label">Cooperados</span>
        </a>

        <!-- Estabelecimentos (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='restaurantes' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#restaurantes"
           href="#restaurantes"
           role="tab"
           aria-controls="restaurantes"
           aria-selected="{{ 'true' if _tab=='restaurantes' else 'false' }}">
          <i class="bi bi-shop-window"></i>
          <span class="nav-link-label">Estabelecimentos</span>
        </a>

        <!-- Documentos (rota) -->
        <a class="nav-sublink {% if request.endpoint == 'admin_documentos' %}active{% endif %}"
           href="{{ url_for('admin_documentos') }}">
          <i class="bi bi-folder2"></i>
          <span class="nav-link-label">Documentos</span>
        </a>

        <!-- Tabelas (rota) -->
        <a class="nav-sublink {% if request.endpoint == 'admin_tabelas' %}active{% endif %}"
           href="{{ url_for('admin_tabelas') }}">
          <i class="bi bi-table"></i>
          <span class="nav-link-label">Tabelas</span>
        </a>
      </div>

      <!-- OPERAÇÃO ---------------------------------------------------------->
      <button class="nav-link-group-toggle"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#menuOperacao"
              aria-expanded="true">
        <div class="nav-link-left">
          <span class="nav-link-icon"><i class="bi bi-broadcast-pin"></i></span>
          <span class="nav-link-label">Operação</span>
        </div>
        <span class="nav-caret"><i class="bi bi-chevron-down"></i></span>
      </button>

      <div id="menuOperacao" class="collapse show nav-sublinks">
        <!-- Escalas (tab) -->
        <a class="nav-sublink {{ 'active' if _tab=='escalas' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#escalas"
           href="#escalas"
           role="tab"
           aria-controls="escalas"
           aria-selected="{{ 'true' if _tab=='escalas' else 'false' }}">
          <i class="bi bi-calendar-week"></i>
          <span class="nav-link-label">Escalas</span>
        </a>

        <!-- Avisos (rota, como já era) -->
        <a class="nav-sublink {% if request.endpoint == 'admin_avisos' %}active{% endif %}"
           href="{{ url_for('admin_avisos') }}">
          <i class="bi bi-megaphone"></i>
          <span class="nav-link-label">Avisos</span>
        </a>
      </div>

      <hr class="sidebar-divider">

      <!-- Config (TAB) e Sair (rota) ---------------------------------------->
      <div class="sidebar-footer">
        <a class="nav-link-main {{ 'active' if _tab=='config' else '' }}"
           data-bs-toggle="tab"
           data-bs-target="#config"
           href="#config"
           role="tab"
           aria-controls="config"
           aria-selected="{{ 'true' if _tab=='config' else 'false' }}">
          <div class="nav-link-left">
            <span class="nav-link-icon"><i class="bi bi-gear"></i></span>
            <span class="nav-link-label">Configurações</span>
          </div>
        </a>

        <a class="nav-link-main"
           href="{{ url_for('logout') }}">
          <div class="nav-link-left">
            <span class="nav-link-icon"><i class="bi bi-box-arrow-right"></i></span>
            <span class="nav-link-label">Sair</span>
          </div>
        </a>
      </div>

    </nav>
  </aside>

<!-- Main -->
<main class="main">
  <div class="tab-content">

    <!-- === RESUMO (Dashboard Financeiro Completo) === -->
    <section class="tab-pane fade {{ 'show active' if _tab=='resumo' else '' }}" id="resumo" role="tabpanel">
      <div class="resumo-shell">

        {# ---------- Helpers de data ---------- #}
        {% macro ymd(x) -%}
          {%- if x and x.strftime is defined -%}
            {{ x.strftime('%Y-%m-%d') }}
          {%- elif x -%}
            {{ x }}
          {%- else -%}
            {{ '' }}
          {%- endif -%}
        {%- endmacro %}

        {# ---------- Filtros atuais (querystring) ---------- #}
        {% set ri  = request.args.get('resumo_inicio','') %}
        {% set rf  = request.args.get('resumo_fim','') %}
        {% set rs  = request.args.get('resumo_restaurante_id','') %}
        {% set cs  = request.args.get('resumo_cooperado_id','') %}
        {% set rid = rs|int if rs else None %}
        {% set cid = cs|int if cs else None %}

        {# Nomes seguros para os badges (não quebra se não encontrar) #}
        {% set _rest_sel = (restaurantes|selectattr('id','equalto',rid)|list|first) if rid else None %}
        {% set _coop_sel = (cooperados|selectattr('id','equalto',cid)|list|first) if cid else None %}

        {# ---------- Bases com fallback (NÃO sobrescrever 'receitas'/'despesas' originais) ---------- #}
        {% set _producoes = (producoes | default([]) | list) %}
        {% if _producoes|length == 0 %}
          {% set _producoes = (lancamentos | default([]) | list) %}
        {% endif %}

        {# Cooperados (por pessoa) #}
        {% set receitas_coop = (receitas_coop | default([]) | list) %}
        {% set despesas_coop = (despesas_coop | default([]) | list) %}

        {# Cooperativa (geral) — mesma fonte da aba de RECEITAS/ DESPESAS da coop #}
        {% set _rec_coop_corp =
             (receitas if receitas is defined else
              (receitas_cooperativa if receitas_cooperativa is defined else
               (receitas_corp if receitas_corp is defined else
                []))) %}
        {% set _desp_coop_corp =
             (despesas if despesas is defined else
              (despesas_cooperativa if despesas_cooperativa is defined else
               (despesas_corp if despesas_corp is defined else
                []))) %}

        {# ---------- Totais (lado servidor, para primeiro paint) ---------- #}
        {# Produções (considera restaurante/cooperado) #}
        {% set ns_prod = namespace(total=0) %}
        {% for p in _producoes %}
          {% set d   = ymd(p.data) %}
          {% set okd = (not ri or d >= ri) and (not rf or d <= rf) %}
          {% set okc = (not cid or (p.cooperado and p.cooperado.id==cid)) %}
          {% set okr = (not rid or (p.restaurante and p.restaurante.id==rid)) %}
          {% if okd and okc and okr %}
            {% set ns_prod.total = ns_prod.total + (p.valor or 0) %}
          {% endif %}
        {% endfor %}
        {% set total_producoes_f = ns_prod.total %}
        {% set total_inss_4_f    = total_producoes_f * 0.04 %}
        {% set total_sest_05_f   = total_producoes_f * 0.005 %}
        {% set total_encargos_f  = total_inss_4_f + total_sest_05_f %}

        {# Coop (geral) — mesma lógica da aba RECEITAS: valor|default(valor_total, true)|default(0, true) #}
        {% set ns_rec_corp = namespace(total=0) %}
        {% for r in _rec_coop_corp %}
          {% set d = ymd(r.data or r.data_lancamento) %}
          {% if (not ri or d >= ri) and (not rf or d <= rf) %}
            {% set v = r.valor|default(r.valor_total, true)|default(0, true) %}
            {% set ns_rec_corp.total = ns_rec_corp.total + (v or 0) %}
          {% endif %}
        {% endfor %}
        {% set total_receitas_corp_f = ns_rec_corp.total %}

        {% set ns_desp_corp = namespace(total=0) %}
        {% for d in _desp_coop_corp %}
          {% set dt = ymd(d.data or d.data_lancamento) %}
          {% if (not ri or dt >= ri) and (not rf or dt <= rf) %}
            {% set v = d.valor|default(d.valor_total, true)|default(0, true) %}
            {% set ns_desp_corp.total = ns_desp_corp.total + (v or 0) %}
          {% endif %}
        {% endfor %}
        {% set total_despesas_corp_f = ns_desp_corp.total %}

        {# Cooperados (por pessoa) #}
        {% set ns_rec_coop = namespace(total=0) %}
        {% for r in receitas_coop %}
          {% set d = ymd(r.data) %}
          {% set okd = (not ri or d >= ri) and (not rf or d <= rf) %}
          {% set okc = (not cid or (r.cooperado and r.cooperado.id==cid)) %}
          {% if okd and okc %}
            {% set ns_rec_coop.total = ns_rec_coop.total + (r.valor or 0) %}
          {% endif %}
        {% endfor %}
        {% set total_receitas_coop_f = ns_rec_coop.total %}

        {# Despesas Cooperados (SEM coluna de adiantamento: tudo soma em DESPESAS) #}
        {% set ns_desp_coop = namespace(total=0) %}
        {% for d in despesas_coop %}
          {% set dt  = ymd(d.data) %}
          {% set okd = (not ri or dt >= ri) and (not rf or dt <= rf) %}
          {% set okc = (not cid or (d.cooperado and d.cooperado.id==cid)) %}
          {% if okd and okc %}
            {% set ns_desp_coop.total = ns_desp_coop.total + (d.valor or 0) %}
          {% endif %}
        {% endfor %}
        {% set total_despesas_coop_f = ns_desp_coop.total %}

        {# Ajuste: Receitas dos cooperados = Produções + Receitas individuais #}
        {% set total_receitas_coop_full_f = (total_producoes_f|default(0)) + (total_receitas_coop_f|default(0)) %}

        {# Resultado coop e Total de Receitas (Geral) #}
        {% set _resultado_corp = (total_receitas_corp_f|default(0)) - (total_despesas_corp_f|default(0)) %}
        {% set _total_receitas_geral = (total_receitas_corp_f|default(0)) + (total_receitas_coop_full_f|default(0)) %}

        <!-- Filtros -->
        <div class="card border-0 shadow-sm rounded-4 mb-3 resumo-filter-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
              <div class="d-flex align-items-center gap-2">
                <div class="resumo-pill-label">
                  <i class="bi bi-sliders"></i>
                </div>
                <div>
                  <h5 class="mb-0 resumo-title">Resumo geral financeiro</h5>
                  <small class="text-muted">
                    Use os filtros para enxergar produção, INSS (4,0%), SEST/SENAT (0,5%), receitas e despesas por período, estabelecimento e cooperado.
                  </small>
                </div>
              </div>

              {% if ri or rf or rid or cid %}
                <div class="d-flex flex-wrap gap-1 small justify-content-end">
                  {% if ri or rf %}
                    <span class="badge rounded-pill bg-light text-dark border">
                      <i class="bi bi-calendar-event"></i>
                      {{ ri if ri else 'início' }} — {{ rf if rf else 'hoje' }}
                    </span>
                  {% endif %}
                  {% if rid %}
                    <span class="badge rounded-pill bg-light text-dark border">
                      <i class="bi bi-shop"></i>
                      Estab: {{ _rest_sel.nome if _rest_sel else rid }}
                    </span>
                  {% endif %}
                  {% if cid %}
                    <span class="badge rounded-pill bg-light text-dark border">
                      <i class="bi bi-person"></i>
                      Coop: {{ _coop_sel.nome if _coop_sel else cid }}
                    </span>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            <form method="GET" class="row g-2 align-items-end">
              <input type="hidden" name="tab" value="resumo">
              <div class="col-md-2">
                <label class="form-label">De</label>
                <input type="date" class="form-control form-control-sm" name="resumo_inicio" value="{{ ri }}">
              </div>
              <div class="col-md-2">
                <label class="form-label">Até</label>
                <input type="date" class="form-control form-control-sm" name="resumo_fim" value="{{ rf }}">
              </div>
              <div class="col-md-4">
                <label class="form-label">Estabelecimento</label>
                <select class="form-select form-select-sm" name="resumo_restaurante_id">
                  <option value="">Todos</option>
                  {% for rr in restaurantes %}
                    <option value="{{ rr.id }}" {{ 'selected' if rid and rid==rr.id else '' }}>{{ rr.nome }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Cooperado</label>
                <select class="form-select form-select-sm" name="resumo_cooperado_id">
                  <option value="">Todos</option>
                  {% for cc in cooperados %}
                    <option value="{{ cc.id }}" {{ 'selected' if cid and cid==cc.id else '' }}>{{ cc.nome }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-12 d-flex flex-wrap gap-2 mt-2">
                <button class="btn btn-royal btn-sm">
                  <i class="bi bi-funnel"></i> Filtrar
                </button>
                {% if ri or rf or rid or cid %}
                  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_dashboard', tab='resumo') }}">
                    <i class="bi bi-x-circle"></i> Limpar
                  </a>
                {% endif %}
                <button id="btnExportXLSX" type="button" class="btn btn-outline-success btn-sm">
                  <i class="bi bi-file-earmark-excel"></i> Exportar XLSX (com filtros)
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row g-2 resumo-kpi-row">
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-prod"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Total Produções</div>
                  <div id="kpiTotalProds" class="fw-bold fs-5">R$ {{ '%.2f'|format(total_producoes_f) }}</div>
                  <div class="small text-muted">Bruto no período</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-graph-up"></i></div>
              </div>
            </div>
          </div>

          <!-- INSS 4% -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-inss"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Total INSS</div>
                  <div id="kpiINSS4" class="fw-bold fs-5">R$ {{ '%.2f'|format(total_inss_4_f) }}</div>
                  <div class="small text-muted">4,0% s/ produções</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-shield-check"></i></div>
              </div>
            </div>
          </div>

          <!-- SEST/SENAT 0,5% -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-sest"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Total SEST/SENAT</div>
                  <div id="kpiSEST05" class="fw-bold fs-5">R$ {{ '%.2f'|format(total_sest_05_f) }}</div>
                  <div class="small text-muted">0,5% s/ produções</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-shield"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-rec-coop"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Receitas Cooperativa</div>
                  <div id="kpiRecCoopCorp" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(total_receitas_corp_f) }}</div>
                  <div class="small text-muted">Entradas da coop</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-cash-coin"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-desp-coop"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Despesas Cooperativa</div>
                  <div id="kpiDespCoopCorp" class="fw-bold fs-5 text-danger">R$ {{ '%.2f'|format(total_despesas_corp_f) }}</div>
                  <div class="small text-muted">Saídas da coop</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-cart-dash"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-rec-coop2"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Receitas Cooperados</div>
                  <div id="kpiRecCooperadosFull" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(total_receitas_coop_full_f) }}</div>
                  <div class="small text-muted">Produções + Receitas</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-currency-exchange"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-desp-coop2"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Despesas Cooperados</div>
                  <div id="kpiDespCooperados" class="fw-bold fs-5 text-danger">R$ {{ '%.2f'|format(total_despesas_coop_f) }}</div>
                  <div class="small text-muted">Débitos/benefícios</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-bank"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-res-coop"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Resultado Cooperativa</div>
                  <div class="fw-bold fs-5">
                    <span id="kpiResultadoCoop" class="{{ 'text-success' if _resultado_corp >= 0 else 'text-danger' }}">
                      R$ {{ '%.2f'|format(_resultado_corp) }}
                    </span>
                  </div>
                  <div class="small text-muted">Receitas − Despesas (coop)</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-pie-chart"></i></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm rounded-4 h-100 p-3 kpi-card">
              <div class="kpi-border kpi-total-rec"></div>
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <div class="text-uppercase text-muted small">Total de Receitas (Geral)</div>
                  <div id="kpiTotalReceitasGeral" class="fw-bold fs-5 text-success">R$ {{ '%.2f'|format(_total_receitas_geral) }}</div>
                  <div class="small text-muted">Coop + (Prod + Rec Cooperados)</div>
                </div>
                <div class="kpi-icon"><i class="bi bi-cash-stack"></i></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumo por Cooperado -->
        <div class="card border-0 shadow-sm rounded-4 mt-3">
          <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center gap-2">
                <div class="resumo-pill-label"><i class="bi bi-people"></i></div>
                <div>
                  <h6 class="m-0">Resumo por Cooperado (filtro aplicado)</h6>
                  <small class="text-muted">
                    Líquido = Produções + <span class="text-success">Receitas</span> − INSS (4,0%) − SEST/SENAT (0,5%) −
                    <span class="text-danger">Despesas</span>
                  </small>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table id="tblResumoCoop" class="table table-sm table-bordered table-hover align-middle table-resumo">
                <thead class="table-light">
                  <tr class="text-nowrap">
                    <th>Cooperado</th>
                    <th class="text-end">Produções</th>
                    <th class="text-end">INSS (4,0%)</th>
                    <th class="text-end">SEST/SENAT (0,5%)</th>
                    <th class="text-end text-success">Receitas</th>
                    <th class="text-end text-danger">Despesas</th>
                    <th class="text-end">Líquido</th>
                  </tr>
                </thead>

                <tbody>
                  <tr><td colspan="7" class="text-center text-muted">Carregando…</td></tr>
                </tbody>

                <tfoot>
                  <tr class="table-light fw-bold">
                    <td>Total</td>
                    <td class="text-end" id="tProd">R$ 0,00</td>
                    <td class="text-end" id="tINSS4">R$ 0,00</td>
                    <td class="text-end" id="tSEST05">R$ 0,00</td>
                    <td class="text-end text-success" id="tRec">R$ 0,00</td>
                    <td class="text-end text-danger" id="tDes">R$ 0,00</td>
                    <td class="text-end fw-bold" id="tLiq">R$ 0,00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="row g-2 mt-3">
          <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 p-3">
              <h6 class="mb-2 d-flex align-items-center gap-1">
                <span class="resumo-pill-label"><i class="bi bi-graph-up-arrow"></i></span>
                <span>Evolução Mensal — Cooperativa</span>
              </h6>
              <canvas id="chartCoop"></canvas>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 p-3">
              <h6 class="mb-2 d-flex align-items-center gap-1">
                <span class="resumo-pill-label"><i class="bi bi-graph-up-arrow"></i></span>
                <span>Evolução Mensal — Cooperados</span>
              </h6>
              <canvas id="chartCooperados"></canvas>
            </div>
          </div>
        </div>

        <div class="row g-2 mt-3">
          <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4 p-3">
              <h6 class="mb-2 d-flex align-items-center gap-1">
                <span class="resumo-pill-label"><i class="bi bi-shop"></i></span>
                <span>Top Estabelecimentos (Produções no período)</span>
              </h6>
              <canvas id="chartEstabs"></canvas>
            </div>
          </div>
        </div>

      </div> <!-- /resumo-shell -->

      <style>
        /* CONTAINER GERAL DA ABA RESUMO */
        #resumo .resumo-shell{
          background: radial-gradient(circle at top left, rgba(48,71,214,0.10), transparent 55%),
                      radial-gradient(circle at bottom right, rgba(16,185,129,0.10), transparent 55%);
          border-radius: 1.5rem;
          padding: 0.85rem;
        }

        #resumo .resumo-filter-card {
          background: rgba(255,255,255,0.96);
          border: 1px solid rgba(148,163,184,0.35);
        }

        #resumo .resumo-title{
          font-size: 1.05rem;
          font-weight: 600;
        }

        #resumo .resumo-kpi-row .card.kpi-card {
          position: relative;
          overflow: hidden;
          transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, border-color 0.12s ease-out, background-color 0.12s ease-out;
          border: 1px solid #e2e8f0;
          background: #ffffff;
        }

        #resumo .resumo-kpi-row .card.kpi-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 26px rgba(15, 23, 42, 0.14);
          border-color: rgba(48,71,214,0.55);
          background: linear-gradient(135deg, #ffffff, #f5f7ff);
        }

        #resumo .kpi-border{
          position:absolute;
          inset:0;
          border-radius:inherit;
          border:2px solid transparent;
          pointer-events:none;
          opacity:0.85;
        }
        #resumo .kpi-prod{ border-color: rgba(37,99,235,0.55); }
        #resumo .kpi-inss{ border-color: rgba(56,189,248,0.55); }
        #resumo .kpi-sest{ border-color: rgba(2,132,199,0.55); }
        #resumo .kpi-rec-coop{ border-color: rgba(16,185,129,0.55); }
        #resumo .kpi-desp-coop{ border-color: rgba(239,68,68,0.55); }
        #resumo .kpi-rec-coop2{ border-color: rgba(34,197,94,0.55); }
        #resumo .kpi-desp-coop2{ border-color: rgba(248,113,113,0.65); }
        #resumo .kpi-res-coop{ border-color: rgba(14,116,144,0.6); }
        #resumo .kpi-total-rec{ border-color: rgba(99,102,241,0.7); }

        #resumo .resumo-kpi-row .card.kpi-card .text-muted.small {
          font-size: 0.76rem;
        }

        #resumo .resumo-pill-label {
          width: 32px;
          height: 32px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: rgba(48,71,214,0.08);
          color: #3047d6;
          font-size: 0.9rem;
        }

        #resumo .kpi-icon {
          width: 42px;
          height: 42px;
          border-radius: 14px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(48,71,214,0.08);
          color: #3047d6;
          font-size: 1.1rem;
        }

        #resumo .table-resumo thead th {
          font-size: 0.78rem;
          text-transform: uppercase;
          letter-spacing: 0.04em;
          background: #f5f7fb;
          border-bottom: 1px solid #e4e7f0;
        }

        #resumo .table-resumo tbody td {
          font-size: 0.8rem;
        }

        #resumo .table-resumo tfoot td {
          font-size: 0.82rem;
        }

        #resumo .table-resumo tbody tr:hover {
          background-color: #f8f9ff;
        }

        #resumo .card.p-3 > h6 {
          font-size: 0.9rem;
          font-weight: 600;
        }

        #resumo canvas {
          max-height: 280px;
        }

        @media (max-width: 576px) {
          #resumo .resumo-shell{
            border-radius: 1rem;
            padding: 0.6rem;
          }
          #resumo .resumo-kpi-row .card.kpi-card {
            padding: 0.75rem 0.85rem;
          }

          #resumo .resumo-filter-card .form-label {
            font-size: 0.78rem;
          }
        }
      </style>
    </section>

    <!-- Dados (seguros p/ JS) + Scripts (Chart.js + XLSX) -->
    <script>
    (function(){
      // ---- Filtros atuais (mais seguro com tojson) ----
      const FILTER = {{ {'ri': ri, 'rf': rf, 'rid': rid, 'cid': cid}|tojson }};

      // ---- Bases compactas ----
      const PRODUCOES = [
        {% for l in _producoes %}
          {
            id: {{ l.id }},
            data: "{{ ymd(l.data) }}",
            valor: {{ (l.valor or 0)|float }},
            cooperado_id: {{ l.cooperado.id if l.cooperado else 'null' }},
            cooperado_nome: "{{ (l.cooperado.nome if l.cooperado else '')|e }}",
            restaurante_id: {{ l.restaurante.id if l.restaurante else 'null' }},
            restaurante_nome: "{{ (l.restaurante.nome if l.restaurante else '')|e }}"
          }{{ "," if not loop.last }}
        {% endfor %}
      ];

      const REC_COOP = [
        {% for r in receitas_coop %}
          {
            id: {{ r.id }},
            data: "{{ ymd(r.data) }}",
            valor: {{ (r.valor or 0)|float }},
            cooperado_id: {{ r.cooperado.id if r.cooperado else 'null' }},
            cooperado_nome: "{{ (r.cooperado.nome if r.cooperado else '')|e }}",
            descricao: "{{ (r.descricao or '')|e }}"
          }{{ "," if not loop.last }}
        {% endfor %}
      ];

      // >>> IMPORTANTE: mantemos o campo adiantamento aqui só porque existe no banco,
      // mas ele NÃO será usado para criar coluna nem somar separado.
      const DESP_COOP = [
        {% for d in despesas_coop %}
          {% set _is_ad_js = (d.adiantamento in [True, 1, '1', 'true', 'True', 'on']) %}
          {
            id: {{ d.id }},
            data: "{{ ymd(d.data) }}",
            valor: {{ (d.valor or 0)|float }},
            cooperado_id: {{ d.cooperado.id if d.cooperado else 'null' }},
            cooperado_nome: "{{ (d.cooperado.nome if d.cooperado else (d.cooperado_nome if d.cooperado_nome is defined else ''))|e }}",
            descricao: "{{ (d.descricao or '')|e }}",
            adiantamento: {{ 1 if _is_ad_js else 0 }}
          }{{ "," if not loop.last }}
        {% endfor %}
      ];

      // Receitas e Despesas da COOPERATIVA
      const REC_COOP_CORP = [
        {% for r in _rec_coop_corp %}
          {
            id: {{ r.id }},
            data: "{{ ymd(r.data or r.data_lancamento) }}",
            valor: {{ (r.valor|default(r.valor_total, true)|default(0, true))|float }},
            descricao: "{{ (r.descricao or '')|e }}"
          }{{ "," if not loop.last }}
        {% endfor %}
      ];

      const DESP_COOP_CORP = [
        {% for d in _desp_coop_corp %}
          {
            id: {{ d.id }},
            data: "{{ ymd(d.data or d.data_lancamento) }}",
            valor: {{ (d.valor|default(d.valor_total, true)|default(0, true))|float }},
            descricao: "{{ (d.descricao or '')|e }}"
          }{{ "," if not loop.last }}
        {% endfor %}
      ];

      const COOPS = [
        {% for c in cooperados %}
          { id: {{ c.id }}, nome: "{{ c.nome|e }}" }{{ "," if not loop.last }}
        {% endfor %}
      ];

      const RESTS = [
        {% for r in restaurantes %}
          { id: {{ r.id }}, nome: "{{ r.nome|e }}" }{{ "," if not loop.last }}
        {% endfor %}
      ];

      // ---- Utils ----
      const parseISO = s => (!s) ? null : new Date(s + 'T00:00:00');

      const fmtBR = v => 'R$ ' + Number(v || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      const inRange = (d) => {
        const di = parseISO(FILTER.ri);
        const df = parseISO(FILTER.rf);
        const x  = parseISO(d);
        if (!x) return true;
        if (di && x < di) return false;
        if (df && x > df) return false;
        return true;
      };

      const byMonthKey = d => {
        if (!d) return '';
        const dt = parseISO(d);
        if (!dt || isNaN(dt)) return '';
        return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
      };

      const sumBy = (arr, fn) => arr.reduce((acc, cur) => acc + (+fn(cur) || 0), 0);

      // ---- Filtro ----
      const filteredPROD = PRODUCOES.filter(p =>
        inRange(p.data) &&
        (FILTER.cid == null || p.cooperado_id === FILTER.cid) &&
        (FILTER.rid == null || p.restaurante_id === FILTER.rid)
      );

      const filteredRECp = REC_COOP.filter(r =>
        inRange(r.data) &&
        (FILTER.cid == null || r.cooperado_id === FILTER.cid)
      );

      const filteredDESp = DESP_COOP.filter(d => {
        if (!inRange(d.data)) return false;
        if (FILTER.cid == null) return true;

        if (d.cooperado_id === FILTER.cid) return true;

        const coop = COOPS.find(c => c.id === FILTER.cid);
        if (coop && d.cooperado_nome) {
          return d.cooperado_nome.trim().toUpperCase() === coop.nome.trim().toUpperCase();
        }
        return false;
      });

      const filteredRECc = REC_COOP_CORP.filter(r => inRange(r.data));
      const filteredDESc = DESP_COOP_CORP.filter(d => inRange(d.data));

      // ---- KPIs (front) ----
      const kpiProd         = sumBy(filteredPROD, x => x.valor);
      const kpiINSS4        = kpiProd * 0.04;
      const kpiSEST05       = kpiProd * 0.005;
      const kpiEncargos45   = kpiINSS4 + kpiSEST05;

      const kpiRecCoopCorp  = sumBy(filteredRECc, x => x.valor);
      const kpiDespCoopCorp = sumBy(filteredDESc, x => x.valor);

      const kpiRecCooperadosFull = kpiProd + sumBy(filteredRECp, x => x.valor);

      // >>> SEM ADIANTAMENTO: despesas cooperados soma TUDO
      const kpiDespCooperados = sumBy(filteredDESp, x => x.valor);

      const kpiResultadoCoop      = kpiRecCoopCorp - kpiDespCoopCorp;
      const kpiTotalReceitasGeral = kpiRecCoopCorp + kpiRecCooperadosFull;

      // aplica KPIs na tela
      document.getElementById('kpiTotalProds').textContent         = fmtBR(kpiProd);
      document.getElementById('kpiINSS4').textContent              = fmtBR(kpiINSS4);
      document.getElementById('kpiSEST05').textContent             = fmtBR(kpiSEST05);
      document.getElementById('kpiRecCoopCorp').textContent        = fmtBR(kpiRecCoopCorp);
      document.getElementById('kpiDespCoopCorp').textContent       = fmtBR(kpiDespCoopCorp);
      document.getElementById('kpiRecCooperadosFull').textContent  = fmtBR(kpiRecCooperadosFull);
      document.getElementById('kpiDespCooperados').textContent     = fmtBR(kpiDespCooperados);
      document.getElementById('kpiTotalReceitasGeral').textContent = fmtBR(kpiTotalReceitasGeral);

      const resEl = document.getElementById('kpiResultadoCoop');
      if (resEl) {
        resEl.textContent = fmtBR(kpiResultadoCoop);
        resEl.classList.remove('text-success', 'text-danger');
        resEl.classList.add(kpiResultadoCoop < 0 ? 'text-danger' : 'text-success');
      }

      // ---- chave segura para agrupar cooperado mesmo sem id ----
      const coopKey = (id, nome) => {
        if (id != null) return `id:${id}`;
        if (nome && nome.trim()) return `nome:${nome.trim().toUpperCase()}`;
        return 'nome:—';
      };

      // ---- Função de resumo (usada na tabela e no XLSX) ----
      function computeResumoCoopRows() {
        const map = new Map(); // key -> item agregado

        const ensure = (id, nome) => {
          const key = coopKey(id, nome);
          if (!map.has(key)) {
            // >>> SEM adiantamento
            map.set(key, { key, id, nome, prod: 0, inss4: 0, sest05: 0, rec: 0, des: 0 });
          }
          return map.get(key);
        };

        filteredPROD.forEach(p => {
          const row = ensure(p.cooperado_id, p.cooperado_nome);
          row.prod   += p.valor;
          row.inss4  += p.valor * 0.04;
          row.sest05 += p.valor * 0.005;
        });

        filteredRECp.forEach(r => {
          const row = ensure(r.cooperado_id, r.cooperado_nome);
          row.rec += r.valor;
        });

        filteredDESp.forEach(d => {
          const row = ensure(d.cooperado_id, d.cooperado_nome || '—');
          // >>> tudo entra como DESPESA
          row.des += d.valor;
        });

        return Array.from(map.values()).sort((a, b) =>
          (a.nome || '').localeCompare(b.nome || '', 'pt-BR')
        );
      }

      const RESUMO_COOP_ROWS = computeResumoCoopRows();

      // ---- Tabela Resumo por Cooperado (7 colunas) ----
      (function renderResumoCoopTable() {
        const rows  = RESUMO_COOP_ROWS;
        const tbody = document.querySelector('#tblResumoCoop tbody');
        if (!tbody) return;

        tbody.innerHTML = rows.length
          ? ''
          : '<tr><td colspan="7" class="text-center text-muted">Sem dados no filtro.</td></tr>';

        let tProd = 0, tINSS4 = 0, tSEST05 = 0, tRec = 0, tDes = 0, tLiq = 0;

        rows.forEach(r => {
          const liq = r.prod + r.rec - r.inss4 - r.sest05 - r.des;

          tProd  += r.prod;
          tINSS4 += r.inss4;
          tSEST05 += r.sest05;
          tRec   += r.rec;
          tDes   += r.des;
          tLiq   += liq;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-break">${r.nome || '—'}</td>
            <td class="text-end">${fmtBR(r.prod)}</td>
            <td class="text-end">${fmtBR(r.inss4)}</td>
            <td class="text-end">${fmtBR(r.sest05)}</td>
            <td class="text-end text-success">${fmtBR(r.rec)}</td>
            <td class="text-end text-danger">${fmtBR(r.des)}</td>
            <td class="text-end fw-bold ${liq < 0 ? 'text-danger' : ''}">${fmtBR(liq)}</td>`;
          tbody.appendChild(tr);
        });

        document.getElementById('tProd').textContent   = fmtBR(tProd);
        document.getElementById('tINSS4').textContent  = fmtBR(tINSS4);
        document.getElementById('tSEST05').textContent = fmtBR(tSEST05);

        const tRecEl = document.getElementById('tRec');
        const tDesEl = document.getElementById('tDes');
        const tLiqEl = document.getElementById('tLiq');

        if (tRecEl) tRecEl.textContent = fmtBR(tRec);
        if (tDesEl) tDesEl.textContent = fmtBR(tDes);

        if (tLiqEl) {
          tLiqEl.textContent = fmtBR(tLiq);
          tLiqEl.classList.remove('text-danger', 'text-success');
          if (tLiq < 0) tLiqEl.classList.add('text-danger');
        }
      })();

      // ---- Gráficos (Chart.js via CDN) ----
      const ensureChart = () => new Promise(res => {
        if (window.Chart) return res();
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/chart.js";
        s.onload = () => res();
        document.head.appendChild(s);
      });

      ensureChart().then(() => {
        const moneyTick = (value) => 'R$ ' + Number(value || 0).toLocaleString('pt-BR', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });

        const baseChartOptions = {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { usePointStyle: true, padding: 18, boxWidth: 10, boxHeight: 10 }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (ctx) => {
                  const label = ctx.dataset.label || '';
                  const v = ctx.parsed.y ?? ctx.parsed.x ?? 0;
                  return `${label}: ${moneyTick(v)}`;
                }
              }
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(148,163,184,0.25)' },
              ticks: { callback: (v) => moneyTick(v) }
            }
          }
        };

        // Cooperativa: Receitas vs Despesas por mês
        (function () {
          const byM = {};
          filteredRECc.forEach(r => {
            const k = byMonthKey(r.data) || '—';
            (byM[k] ??= { r: 0, d: 0 }).r += r.valor;
          });
          filteredDESc.forEach(d => {
            const k = byMonthKey(d.data) || '—';
            (byM[k] ??= { r: 0, d: 0 }).d += d.valor;
          });

          const labels = Object.keys(byM).sort();
          const rec    = labels.map(k => byM[k].r);
          const des    = labels.map(k => byM[k].d);

          const ctx = document.getElementById('chartCoop');
          if (!ctx) return;

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Receitas', data: rec, backgroundColor: 'rgba(37, 99, 235, 0.75)', borderRadius: 6 },
                { label: 'Despesas', data: des, backgroundColor: 'rgba(239, 68, 68, 0.75)', borderRadius: 6 }
              ]
            },
            options: baseChartOptions
          });
        })();

        // Cooperados: Produções + INSS 4% + SEST 0,5% por mês
        (function () {
          const byM = {};
          filteredPROD.forEach(p => {
            const k = byMonthKey(p.data) || '—';
            (byM[k] ??= { prod: 0, inss4: 0, sest05: 0 }).prod += p.valor;
            byM[k].inss4  += p.valor * 0.04;
            byM[k].sest05 += p.valor * 0.005;
          });

          const labels = Object.keys(byM).sort();
          const prod   = labels.map(k => byM[k].prod);
          const inss4  = labels.map(k => byM[k].inss4);
          const sest05 = labels.map(k => byM[k].sest05);

          const ctx = document.getElementById('chartCooperados');
          if (!ctx) return;

          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Produções (bruto)',
                  data: prod,
                  borderColor: 'rgba(37, 99, 235, 1)',
                  backgroundColor: 'rgba(37, 99, 235, 0.18)',
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointRadius: 3,
                  pointHoverRadius: 4
                },
                {
                  label: 'INSS (4,0%)',
                  data: inss4,
                  borderColor: 'rgba(56, 189, 248, 1)',
                  backgroundColor: 'rgba(56, 189, 248, 0.12)',
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointRadius: 3,
                  pointHoverRadius: 4
                },
                {
                  label: 'SEST/SENAT (0,5%)',
                  data: sest05,
                  borderColor: 'rgba(2, 132, 199, 1)',
                  backgroundColor: 'rgba(2, 132, 199, 0.10)',
                  borderWidth: 2,
                  tension: 0.3,
                  fill: true,
                  pointRadius: 3,
                  pointHoverRadius: 4
                }
              ]
            },
            options: baseChartOptions
          });
        })();

        // Estabelecimentos — barra horizontal
        (function () {
          const byR = {};
          filteredPROD.forEach(p => {
            if (p.restaurante_id == null) return;
            const k = p.restaurante_nome || '—';
            byR[k] = (byR[k] || 0) + p.valor;
          });

          const entries = Object.entries(byR).sort((a, b) => b[1] - a[1]).slice(0, 20);
          const labels = entries.map(e => e[0]);
          const vals   = entries.map(e => e[1]);

          const ctx = document.getElementById('chartEstabs');
          if (!ctx) return;

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{ label: 'Produções por Estabelecimento', data: vals, backgroundColor: 'rgba(16, 185, 129, 0.8)', borderRadius: 6 }]
            },
            options: { ...baseChartOptions, plugins: { ...baseChartOptions.plugins, legend: { display: false } }, indexAxis: 'y' }
          });
        })();
      });

      // ---- Exportação XLSX ----
      const ensureXLSX = () => new Promise(res => {
        if (window.XLSX) return res();
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        s.onload = () => res();
        document.head.appendChild(s);
      });

      function aoaToSheet(title, aoa, wb) {
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        XLSX.utils.book_append_sheet(wb, ws, title);
      }

      function safeSheetName(s) {
        const cleaned = String(s || '').replace(/[:\\/?*\[\]]/g, ' ').slice(0, 31).trim();
        return cleaned || 'Planilha';
      }

      async function exportXLSX() {
        await ensureXLSX();
        const wb = XLSX.utils.book_new();

        const k1 = [
          ['Dashboard Financeiro — Filtro'],
          ['Período', FILTER.ri || 'início', '→', FILTER.rf || 'hoje'],
          ['Estabelecimento', FILTER.rid == null ? 'Todos' : (RESTS.find(r => r.id === FILTER.rid)?.nome || FILTER.rid)],
          ['Cooperado', FILTER.cid == null ? 'Todos' : (COOPS.find(c => c.id === FILTER.cid)?.nome || FILTER.cid)],
          [],
          ['KPIs'],
          ['Total Produções', kpiProd],
          ['INSS (4,0%)', kpiINSS4],
          ['SEST/SENAT (0,5%)', kpiSEST05],
          ['Encargos (4,5%)', kpiEncargos45],
          ['Receitas Coop (período)', kpiRecCoopCorp],
          ['Despesas Coop (período)', kpiDespCoopCorp],
          ['Receitas Cooperados (Prod + Rec)', kpiRecCooperadosFull],
          ['Despesas Cooperados (período)', kpiDespCooperados],
          ['Total de Receitas (Geral)', kpiTotalReceitasGeral],
          ['Resultado Cooperativa', kpiResultadoCoop],
        ];
        aoaToSheet('KPIs', k1, wb);

        const prodAOA = [['Data', 'Cooperado', 'Estabelecimento', 'Valor', 'INSS(4,0%)', 'SEST/SENAT(0,5%)', 'Encargos(4,5%)', 'Líquido']];
        filteredPROD.forEach(p => {
          const inss4  = p.valor * 0.04;
          const sest05 = p.valor * 0.005;
          const enc    = inss4 + sest05;
          const liq    = p.valor - enc;
          prodAOA.push([p.data, p.cooperado_nome || '', p.restaurante_nome || '', p.valor, inss4, sest05, enc, liq]);
        });
        aoaToSheet('Producoes', prodAOA, wb);

        const recCAOA = [['Data', 'Descrição', 'Valor']];
        filteredRECc.forEach(r => recCAOA.push([r.data, r.descricao || '', r.valor]));
        aoaToSheet('Receitas_Coop', recCAOA, wb);

        const desCAOA = [['Data', 'Descrição', 'Valor']];
        filteredDESc.forEach(d => desCAOA.push([d.data, d.descricao || '', d.valor]));
        aoaToSheet('Despesas_Coop', desCAOA, wb);

        const byR = {};
        filteredPROD.forEach(p => {
          if (p.restaurante_nome)
            byR[p.restaurante_nome] = (byR[p.restaurante_nome] || 0) + p.valor;
        });
        const estAOA = [['Estabelecimento', 'Total Produções (R$)']];
        Object.entries(byR).sort((a, b) => b[1] - a[1]).forEach(([nome, v]) => estAOA.push([nome, v]));
        aoaToSheet('Estabelecimentos', estAOA, wb);

        // >>> SEM ADIANTAMENTOS no XLSX também
        const resumoAOA = [['Cooperado', 'Produções', 'INSS (4,0%)', 'SEST/SENAT (0,5%)', 'Receitas', 'Despesas', 'Líquido']];
        let tProd = 0, tINSS4 = 0, tSEST05 = 0, tRec = 0, tDes = 0, tLiq = 0;

        RESUMO_COOP_ROWS.forEach(r => {
          const liq = r.prod + r.rec - r.inss4 - r.sest05 - r.des;
          tProd  += r.prod;
          tINSS4 += r.inss4;
          tSEST05 += r.sest05;
          tRec   += r.rec;
          tDes   += r.des;
          tLiq   += liq;

          resumoAOA.push([r.nome || '—', r.prod, r.inss4, r.sest05, r.rec, r.des, liq]);
        });

        resumoAOA.push(['TOTAIS', tProd, tINSS4, tSEST05, tRec, tDes, tLiq]);
        aoaToSheet('Resumo_Cooperados', resumoAOA, wb);

        const byC_rec = {};
        filteredRECp.forEach(r => {
          const k = r.cooperado_nome || `ID ${r.cooperado_id}`;
          (byC_rec[k] ||= []).push(r);
        });
        Object.keys(byC_rec).forEach(nome => {
          const aoa = [['Data', 'Descrição', 'Valor']];
          byC_rec[nome].forEach(r => aoa.push([r.data, r.descricao || '', r.valor]));
          aoaToSheet(safeSheetName('Receita - ' + nome), aoa, wb);
        });

        const byC_des = {};
        filteredDESp.forEach(d => {
          const k = d.cooperado_nome || `ID ${d.cooperado_id}`;
          (byC_des[k] ||= []).push(d);
        });
        Object.keys(byC_des).forEach(nome => {
          const aoa = [['Data', 'Descrição', 'Valor']];
          byC_des[nome].forEach(d => {
            aoa.push([d.data, d.descricao || '', d.valor]);
          });
          aoaToSheet(safeSheetName('Despesa - ' + nome), aoa, wb);
        });

        const now = new Date();
        const ymd = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        XLSX.writeFile(wb, `Dashboard_Coopex_${ymd}.xlsx`);
      }

      document.getElementById('btnExportXLSX')?.addEventListener('click', exportXLSX);
    })();
    </script>
</section>

<!-- LANÇAMENTOS (versão moderna/compacta – drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='lancamentos' else '' }}" id="lancamentos" role="tabpanel">
  {# ====== TOTAIS DO FILTRO (já vem filtrado do backend) ====== #}
  {% set soma_valor    = (lancamentos|sum(attribute='valor')) if lancamentos else 0 %}
  {% set soma_inss_4   = (soma_valor * 0.04) %}
  {% set soma_sest_05  = (soma_valor * 0.005) %}
  {% set soma_liq      = (soma_valor - soma_inss_4 - soma_sest_05) %}
  {% set soma_qtd      = (lancamentos | map(attribute='qtd_entregas') | select('number') | sum) if lancamentos else 0 %}

  <!-- Header + KPIs -->
  <div class="card lanc-card-header mb-3">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <h5 class="m-0 d-flex align-items-center gap-2">
          <span class="lanc-icon-circle">
            <i class="bi bi-journal-text"></i>
          </span>
          <span>Lançamentos & Produção</span>
        </h5>
        <small class="text-muted-2">
          Controle de produção por restaurante, cooperado e período, com INSS (4,0%), SEST/SENAT (0,5%) e líquido calculados.
        </small>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
        <div class="kpi-chip kpi-neutral">
          <span class="kpi-label">Registros</span>
          <span class="kpi-value">{{ lancamentos|length if lancamentos else 0 }}</span>
        </div>
        <div class="kpi-chip kpi-info">
          <span class="kpi-label">Bruto</span>
          <span class="kpi-value">R$ {{ '%.2f'|format(soma_valor) }}</span>
        </div>

        <div class="kpi-chip kpi-soft">
          <span class="kpi-label">INSS (4,0%)</span>
          <span class="kpi-value">R$ {{ '%.2f'|format(soma_inss_4) }}</span>
        </div>

        <div class="kpi-chip kpi-soft">
          <span class="kpi-label">SEST/SENAT (0,5%)</span>
          <span class="kpi-value">R$ {{ '%.2f'|format(soma_sest_05) }}</span>
        </div>

        <div class="kpi-chip {{ 'kpi-success' if soma_liq >= 0 else 'kpi-danger' }}">
          <span class="kpi-label">Líquido</span>
          <span class="kpi-value">R$ {{ '%.2f'|format(soma_liq) }}</span>
        </div>

        <div class="kpi-chip kpi-neutral">
          <span class="kpi-label">Entregas</span>
          <span class="kpi-value">{{ soma_qtd }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card lanc-filter-card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div class="d-flex align-items-center gap-2">
          <div class="filter-dot"></div>
          <h6 class="m-0">Filtros de Lançamentos</h6>
        </div>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" type="button"
                data-bs-toggle="collapse" data-bs-target="#filtrosAvancados"
                aria-expanded="false">
          <i class="bi bi-sliders"></i> Mais filtros
        </button>
      </div>

      <form method="GET" action="{{ url_for('filtrar_lancamentos') }}" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="lancamentos">

        <div class="col-md-3">
          <label class="form-label lanc-label">Restaurante</label>
          <select class="form-select form-select-sm" name="restaurante_id">
            <option value="">Todos</option>
            {% for rr in restaurantes %}
              <option value="{{ rr.id }}" {{ 'selected' if (request.args.get('restaurante_id')|int) == rr.id else '' }}>
                {{ rr.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Cooperado</label>
          <select class="form-select form-select-sm" name="cooperado_id">
            <option value="">Todos</option>
            {% for cc in cooperados %}
              <option value="{{ cc.id }}" {{ 'selected' if (request.args.get('cooperado_id')|int) == cc.id else '' }}>
                {{ cc.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label lanc-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>

        <div class="col-md-2">
          <label class="form-label lanc-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>

        <div class="col-md-2">
          <div class="form-check form-switch mt-4">
            <input class="form-check-input" type="checkbox" name="considerar_periodo" value="1" id="considerarPeriodo"
                   {{ 'checked' if request.args.get('considerar_periodo') else '' }}>
            <label class="form-check-label small" for="considerarPeriodo"
                   title="Aplica a regra de período do restaurante (Seg-Dom, Sáb-Sex, Sex-Qui)">
              Considerar período do restaurante
            </label>
          </div>
        </div>

        <div class="collapse" id="filtrosAvancados">
          <div class="col-12 mt-3">
            <label class="form-label lanc-label mb-1">Dias da Semana</label>
            <div class="d-flex flex-wrap gap-1">
              {% set dows = request.args.getlist('dow') %}
              {% set dlabels = [('1','Seg'),('2','Ter'),('3','Qua'),('4','Qui'),('5','Sex'),('6','Sáb'),('7','Dom')] %}
              {% for val,label in dlabels %}
                <div class="form-check form-check-inline me-2">
                  <input class="form-check-input" id="dow{{ val }}" type="checkbox" name="dow" value="{{ val }}"
                         {{ 'checked' if val in dows else '' }}>
                  <label class="form-check-label" for="dow{{ val }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="col-12 d-flex flex-wrap gap-2 mt-3">
          <button class="btn btn-royal btn-sm rounded-pill">
            <i class="bi bi-funnel"></i> Filtrar
          </button>

          <a href="{{ url_for('exportar_lancamentos', **request.args) }}"
             class="btn btn-outline-secondary btn-sm rounded-pill">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
          </a>

          <button type="reset" class="btn btn-light btn-sm rounded-pill">
            Limpar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lançar Produção -->
  <div class="card lanc-launch-card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="launch-icon">
            <i class="bi bi-plus-circle"></i>
          </span>
          <div>
            <h6 class="m-0">Lançar Produção</h6>
            <small class="text-muted-2">
              A competência por <b>período do restaurante</b> é aplicada no back-end.
            </small>
          </div>
        </div>
      </div>

      <form method="POST" action="{{ url_for('admin_add_lancamento') }}" class="row g-2 align-items-end mt-3">
        <div class="col-md-3">
          <label class="form-label lanc-label">Restaurante</label>
          <select class="form-select form-select-sm" name="restaurante_id" required>
            {% for rr in restaurantes %}
              <option value="{{ rr.id }}">{{ rr.nome }} ({{ rr.periodo }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Cooperado</label>
          <select class="form-select form-select-sm" name="cooperado_id" required>
            {% for cc in cooperados %}
              <option value="{{ cc.id }}">{{ cc.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Ex.: almoço, jantar" required>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" required>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Horário</label>
          <div class="input-group input-group-sm">
            <input type="time" class="form-control" name="hora_inicio">
            <span class="input-group-text">às</span>
            <input type="time" class="form-control" name="hora_fim">
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label lanc-label">Qtd. Entregas</label>
          <input type="number" min="0" step="1" class="form-control form-control-sm" name="qtd_entregas" placeholder="Ex.: 25">
        </div>

        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100 rounded-pill mt-2 mt-md-0">
            <i class="bi bi-plus-circle"></i> Lançar
          </button>
        </div>
      </form>

      <div class="mt-2 text-muted small">
        Nota: os descontos abaixo são cálculo bruto linha-a-linha:
        <b>INSS 4,0%</b> + <b>SEST/SENAT 0,5%</b> = <b>4,5%</b>.
        <b>Isenções por benefício</b> entram na <u>Folha</u> e nos <u>totais</u> do Resumo.
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card lanc-table-card">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm align-middle table-hover lanc-table">
          <thead>
            <tr class="text-nowrap">
              <th>Restaurante</th>
              <th>Período</th>
              <th>Cooperado</th>
              <th>Descrição</th>
              <th class="text-end">Valor</th>
              <th class="text-center">Entregas</th>
              <th>Data</th>
              <th>Horário</th>
              <th class="text-end">INSS (4,0%)</th>
              <th class="text-end">SEST/SENAT (0,5%)</th>
              <th class="text-end">Líquido</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for l in lancamentos %}
              {% set inss_4  = (l.valor or 0) * 0.04 %}
              {% set sest_05 = (l.valor or 0) * 0.005 %}
              {% set liq     = (l.valor or 0) - inss_4 - sest_05 %}
              <tr>
                <td class="text-nowrap"><span class="table-main-text">{{ l.restaurante.nome }}</span></td>
                <td class="text-nowrap">
                  <span class="badge bg-light text-dark border">{{ l.restaurante.periodo }}</span>
                </td>
                <td class="text-nowrap">{{ l.cooperado.nome }}</td>
                <td class="text-break">{{ l.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(l.valor) }}</td>
                <td class="text-center">
                  <span class="badge bg-soft-count">{{ l.qtd_entregas if l.qtd_entregas is not none else '—' }}</span>
                </td>
                <td class="text-nowrap">{{ l.data.strftime('%d/%m/%Y') }}</td>
                <td class="text-nowrap">{{ l.hora_inicio }}{% if l.hora_fim %} às {{ l.hora_fim }}{% endif %}</td>
                <td class="text-end">R$ {{ "%.2f"|format(inss_4) }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(sest_05) }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(liq) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm rounded-pill"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditLancamento"
                          data-id="{{ l.id }}"
                          data-restaurante="{{ l.restaurante.id }}"
                          data-cooperado="{{ l.cooperado.id }}"
                          data-descricao="{{ l.descricao }}"
                          data-valor="{{ l.valor }}"
                          data-data="{{ l.data.strftime('%Y-%m-%d') }}"
                          data-hora_inicio="{{ l.hora_inicio }}"
                          data-hora_fim="{{ l.hora_fim }}"
                          data-qtd_entregas="{{ l.qtd_entregas }}"
                          data-url="{{ url_for('admin_edit_lancamento', id=l.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm rounded-pill btn-del"
                     href="{{ url_for('admin_delete_lancamento', id=l.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="12" class="text-center text-muted py-3">Nenhum lançamento encontrado</td>
              </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="lanc-tfoot-row">
              <th colspan="4" class="text-end">Totais do filtro:</th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_valor) }}</th>
              <th class="text-center">{{ soma_qtd }}</th>
              <th></th>
              <th></th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_inss_4) }}</th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_sest_05) }}</th>
              <th class="text-end">R$ {{ "%.2f"|format(soma_liq) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

<style>
  .text-muted-2 { color: #9aa0ac; }

  .lanc-card-header {
    border-radius: 1rem;
    border: 1px solid #e4e7f0;
    background: radial-gradient(circle at top left, #f5f7ff 0, #ffffff 40%);
  }

  .lanc-icon-circle {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    background: #3047d61a;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #3047d6;
    font-size: 1rem;
  }

  .kpi-chip {
    border-radius: 999px;
    padding: 0.3rem 0.9rem;
    font-size: 0.78rem;
    display: inline-flex;
    flex-direction: column;
    min-width: 90px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
  }

  .kpi-label { font-size: 0.7rem; color: #6b7280; }
  .kpi-value { font-weight: 600; }

  .kpi-info {
    background: #eef2ff;
    border-color: #c7d2fe;
    color: #1d4ed8;
  }

  .kpi-soft {
    background: #f1f5f9;
    border-color: #e2e8f0;
  }

  .kpi-success {
    background: #e5fbf0;
    border-color: #bbf7d0;
    color: #166534;
  }

  .kpi-danger {
    background: #fee2e2;
    border-color: #fecaca;
    color: #b91c1c;
  }

  .kpi-neutral {
    background: #f9fafb;
    border-color: #e5e7eb;
  }

  .lanc-filter-card {
    border-radius: 0.9rem;
    border: 1px solid #e4e7f0;
    background: #ffffff;
  }

  .filter-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
  }

  .lanc-label { font-size: 0.78rem; font-weight: 500; }

  .lanc-launch-card {
    border-radius: 0.9rem;
    border: 1px solid #e4e7f0;
    background: linear-gradient(135deg, #f5f7ff 0, #ffffff 60%);
  }

  .launch-icon {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    background: #22c55e1a;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #16a34a;
    font-size: 0.9rem;
  }

  .lanc-table-card {
    border-radius: 0.9rem;
    border: 1px solid #e4e7f0;
    background: #ffffff;
  }

  .lanc-table thead th {
    font-size: 0.76rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background-color: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
  }

  .lanc-table th, .lanc-table td {
    font-size: 0.78rem;
    vertical-align: middle;
    padding: 0.45rem 0.55rem;
  }

  .lanc-table tbody tr:hover { background: #f9fafb; }

  .table-main-text { font-weight: 500; }

  .bg-soft-count { background: #eef2ff; color: #1f2937; }

  .lanc-tfoot-row { background: #f8fafc; font-size: 0.78rem; }

  .btn-del { transition: transform 0.12s ease-out; }
  .btn-del:hover { transform: translateY(-1px); }
</style>


<!-- RECEITAS COOP (versão profissional/compacta – drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='receitas' else '' }}" id="receitas" role="tabpanel">
  {# total defensivo: aceita r.valor OU r.valor_total #}
  {% set ns_total = namespace(v=0) %}
  {% for r in receitas or [] %}
    {% set v_item = r.valor|default(r.valor_total, true)|default(0, true) %}
    {% set ns_total.v = ns_total.v + (v_item or 0) %}
  {% endfor %}
  {% set total_receitas_coop_table = ns_total.v %}
  {% set qtd_registros = receitas|length if receitas else 0 %}

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-cash"></i> Receitas da Cooperativa
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ qtd_registros }}</b></span>
      <span class="badge bg-success-subtle text-success border">Total: <b>R$ {{ '%.2f'|format(total_receitas_coop_table) }}</b></span>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="receitas">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
        <div class="col-md-3 d-none d-md-block"></div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Receita</h6>
        <span class="text-muted small">Preencha os campos e clique em <b>Adicionar</b>.</span>
      </div>

      <form method="POST" action="{{ url_for('add_receita') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-5">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>
        <div class="col-md-2">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-success btn-sm w-100">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for r in receitas %}
              {% set v_row = r.valor|default(r.valor_total, true)|default(0, true) %}
              <tr>
                <td>{{ r.data.strftime('%d/%m/%Y') if r.data else '-' }}</td>
                <td class="text-break">{{ r.descricao }}</td>
                <td class="text-end">R$ {{ '%.2f'|format(v_row) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditReceita"
                          data-id="{{ r.id }}"
                          data-descricao="{{ r.descricao }}"
                          data-valor="{{ v_row }}"
                          data-data="{{ r.data.strftime('%Y-%m-%d') if r.data else '' }}"
                          data-url="{{ url_for('edit_receita', id=r.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del" href="{{ url_for('delete_receita', id=r.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-center text-muted">Nenhuma receita</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="2" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(total_receitas_coop_table) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>


<!-- DESPESAS COOP (versão profissional/compacta – drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='despesas' else '' }}" id="despesas" role="tabpanel">
  {% set total_despesas_coop_table = (despesas|sum(attribute='valor')) if despesas else 0 %}
  {% set qtd_registros = despesas|length if despesas else 0 %}

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-bag-dash"></i> Despesas da Cooperativa
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ qtd_registros }}</b></span>
      <span class="badge bg-danger-subtle text-danger border">Total: <b>R$ {{ '%.2f'|format(total_despesas_coop_table) }}</b></span>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="despesas">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
        <div class="col-md-3 d-none d-md-block"></div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Despesa</h6>
        <span class="text-muted small">Preencha os campos e clique em <b>Adicionar</b>.</span>
      </div>

      <form method="POST" action="{{ url_for('add_despesa') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-5">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>
        <div class="col-md-2">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-danger btn-sm w-100">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for d in despesas %}
              <tr>
                <td>{{ d.data.strftime('%d/%m/%Y') if d.data else '-' }}</td>
                <td class="text-break">{{ d.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(d.valor) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditDespesa"
                          data-id="{{ d.id }}"
                          data-descricao="{{ d.descricao }}"
                          data-valor="{{ d.valor }}"
                          data-data="{{ d.data.strftime('%Y-%m-%d') if d.data else '' }}"
                          data-url="{{ url_for('edit_despesa', id=d.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del" href="{{ url_for('delete_despesa', id=d.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-center text-muted">Nenhuma despesa</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="2" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(total_despesas_coop_table) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>


<!-- RECEITAS COOPERADOS (versão profissional/compacta – drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='coop_receitas' else '' }}" id="coop_receitas" role="tabpanel">
  {% set total_receitas_coop_table = (receitas_coop|sum(attribute='valor')) if receitas_coop else 0 %}
  {% set qtd_registros = receitas_coop|length if receitas_coop else 0 %}

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-cash-coin"></i> Receitas para Cooperados
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">Registros: <b>{{ qtd_registros }}</b></span>
      <span class="badge bg-success-subtle text-success border">Total: <b>R$ {{ '%.2f'|format(total_receitas_coop_table) }}</b></span>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>
      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="coop_receitas">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>
        <div class="col-md-3">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
        <div class="col-md-3 d-none d-md-block"></div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Receita</h6>
        <span class="text-muted small">Selecione o cooperado e informe os dados.</span>
      </div>

      <form method="POST" action="{{ url_for('add_receita_coop') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-3">
          <label class="form-label">Cooperado</label>
          <select class="form-select form-select-sm" name="cooperado_id" required>
            <option disabled selected>Selecione o Cooperado</option>
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>
        <div class="col-md-1">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-success btn-sm w-100">
            <i class="bi bi-plus-circle"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th style="width:260px">Cooperado</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for rc in receitas_coop %}
              <tr>
                <td>{{ rc.data.strftime('%d/%m/%Y') if rc.data else '-' }}</td>
                <td class="text-break">{{ rc.cooperado.nome }}</td>
                <td class="text-break">{{ rc.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(rc.valor) }}</td>
                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditReceitaCoop"
                          data-id="{{ rc.id }}"
                          data-cooperado="{{ rc.cooperado.id }}"
                          data-descricao="{{ rc.descricao }}"
                          data-valor="{{ rc.valor }}"
                          data-data="{{ rc.data.strftime('%Y-%m-%d') if rc.data else '' }}"
                          data-url="{{ url_for('edit_receita_coop', id=rc.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <a class="btn btn-danger btn-sm btn-del" href="{{ url_for('delete_receita_coop', id=rc.id) }}">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="text-center text-muted">Nenhuma receita</td></tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="table-light">
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(total_receitas_coop_table) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>


<!-- DESPESAS COOPERADOS (versão profissional/compacta – SEM ADIANTAMENTO + PESQUISA) -->
<section class="tab-pane fade {{ 'show active' if _tab=='coop_despesas' else '' }}" id="coop_despesas" role="tabpanel">
  {% set _despesas = (despesas_coop | default([]) | list) %}

  {# Totais (tudo entra como despesa) #}
  {% set ns_dc = namespace(qtd_total=0, total=0) %}
  {% for dc in _despesas %}
    {% set ns_dc.qtd_total = ns_dc.qtd_total + 1 %}
    {% set ns_dc.total = ns_dc.total + (dc.valor or 0) %}
  {% endfor %}

  {% set _qtd_total   = ns_dc.qtd_total %}
  {% set _total_geral = ns_dc.total %}

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-bag-dash"></i> Despesas para Cooperados
    </h5>
    <div class="d-flex flex-wrap gap-2">
      <span class="badge bg-light text-dark border">
        Registros: <b>{{ _qtd_total }}</b>
      </span>
      <span class="badge bg-danger-subtle text-danger border">
        Total: <b>R$ {{ '%.2f'|format(_total_geral) }}</b>
      </span>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h6 class="m-0"><i class="bi bi-funnel"></i> Filtrar</h6>
      </div>

      <form method="GET" class="row g-2 align-items-end">
        <input type="hidden" name="tab" value="coop_despesas">

        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" class="form-control form-control-sm" name="data_inicio" value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" class="form-control form-control-sm" name="data_fim" value="{{ request.args.get('data_fim','') }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Pesquisar (Cooperado ou Descrição)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="qDespCoop" placeholder="Ex: João / capacete / manutenção...">
            <button class="btn btn-outline-secondary" type="button" id="btnClearQDesp" title="Limpar">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <small class="text-muted">A pesquisa filtra a tabela abaixo (não altera o banco).</small>
        </div>

        <div class="col-md-2">
          <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Aplicar datas</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Adicionar Despesa -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0"><i class="bi bi-plus-circle"></i> Adicionar Despesa</h6>
        <span class="text-muted small">
          Lançamento de despesa/benefício para cooperado(s).
        </span>
      </div>

      <form method="POST" action="{{ url_for('add_despesa_coop') }}" class="row g-2 align-items-end mt-2">
        <div class="col-md-4">
          <label class="form-label">Cooperados</label>
          <select class="form-select form-select-sm" name="cooperado_ids[]" multiple size="5">
            <option value="all">Todos</option>
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
          <small class="text-muted">Use Ctrl/Cmd para múltiplos.</small>
        </div>

        <div class="col-md-3">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control form-control-sm" name="descricao" placeholder="Descrição" required>
        </div>

        <div class="col-md-2">
          <label class="form-label">Valor (R$)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control" name="valor" placeholder="0,00" required>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Data</label>
          <input type="date" class="form-control form-control-sm" name="data" required>
        </div>

        <div class="col-md-1 d-flex flex-column">
          <label class="form-label d-none d-md-block">&nbsp;</label>
          <button class="btn btn-danger btn-sm w-100" title="Salvar">
            <i class="bi bi-plus-circle"></i>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-2 p-md-3">
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle" id="tblDespesasCoop">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:120px">Data</th>
              <th style="width:260px">Cooperado</th>
              <th>Descrição</th>
              <th class="text-end" style="width:160px">Valor</th>
              <th class="text-center" style="width:140px">Ações</th>
            </tr>
          </thead>

          <tbody>
            {% for dc in despesas_coop %}
              {% set coop_nome = (dc.cooperado.nome if dc.cooperado else 'Todos') %}
              <tr
                data-coop="{{ coop_nome|lower }}"
                data-desc="{{ (dc.descricao or '')|lower }}"
              >
                <td>{{ dc.data.strftime('%d/%m/%Y') if dc.data else '-' }}</td>
                <td class="text-break">{{ coop_nome }}</td>
                <td class="text-break">{{ dc.descricao }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(dc.valor) }}</td>

                <td class="text-center text-nowrap">
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditDespesaCoop"
                          data-id="{{ dc.id }}"
                          data-cooperado="{{ dc.cooperado.id if dc.cooperado else '' }}"
                          data-descricao="{{ dc.descricao }}"
                          data-valor="{{ dc.valor }}"
                          data-data="{{ dc.data.strftime('%Y-%m-%d') if dc.data else '' }}"
                          data-url="{{ url_for('edit_despesa_coop', id=dc.id) }}">
                    <i class="bi bi-pencil"></i>
                  </button>

                  <!-- EXCLUIR via POST (evita 405) -->
                  <form method="POST" action="{{ url_for('delete_despesa_coop', id=dc.id) }}" class="d-inline">
                    {# Se você usa Flask-WTF/CSRF, descomente a linha abaixo #}
                    {# {{ csrf_token() }} #}
                    <button type="submit" class="btn btn-danger btn-sm btn-del" onclick="return confirm('Excluir esta despesa?');">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="text-center text-muted">Nenhuma despesa</td></tr>
            {% endfor %}
          </tbody>

          <tfoot>
            <tr class="table-light">
              <th colspan="3" class="text-end">Total</th>
              <th class="text-end">R$ {{ '%.2f'|format(_total_geral) }}</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Pesquisa na tabela por cooperado OU descrição (front-end)
    (function(){
      const input = document.getElementById('qDespCoop');
      const btnClear = document.getElementById('btnClearQDesp');
      const tbl = document.getElementById('tblDespesasCoop');
      if(!input || !tbl) return;

      function norm(s){
        return (s || '')
          .toString()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g,'')
          .trim();
      }

      function apply(){
        const q = norm(input.value);
        const rows = tbl.querySelectorAll('tbody tr');

        // Se não tem linhas de dados (ex: "Nenhuma despesa"), não faz nada
        rows.forEach(tr=>{
          const coop = norm(tr.getAttribute('data-coop') || '');
          const desc = norm(tr.getAttribute('data-desc') || '');
          const ok = !q || coop.includes(q) || desc.includes(q);
          tr.style.display = ok ? '' : 'none';
        });
      }

      input.addEventListener('input', apply);
      if(btnClear){
        btnClear.addEventListener('click', ()=>{
          input.value = '';
          input.focus();
          apply();
        });
      }
      apply();
    })();
  </script>
</section>

     <!-- BENEFÍCIOS (versão profissional / sem alterar backend) -->
<section class="tab-pane fade {{ 'show active' if _tab=='beneficios' else '' }}" id="beneficios" role="tabpanel">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-heart-pulse"></i> Benefícios
    </h5>
    <span class="text-muted small">Rateio entre quem <u>não</u> recebe (isentos não pagam e não entram no divisor)</span>
  </div>

  <!-- Formulário de rateio -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <p class="mb-3 text-muted">
        Informe o <b>período semanal</b> e, para cada tipo, o <b>valor unitário por beneficiado</b>. Na submissão
        calculamos: <b>Total</b> (= unitário × nº beneficiados) e <b>Rateio por pagante</b>
        (pagantes = <i>todos</i> − <i>beneficiados</i> − <i>isentos</i>).
      </p>

      <form id="form-beneficios" method="POST" action="{{ url_for('ratear_beneficios') }}" class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label">Data inicial</label>
          <input type="date" class="form-control form-control-sm" name="data_inicial" required value="{{ request.args.get('data_inicio','') }}">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Data final</label>
          <input type="date" class="form-control form-control-sm" name="data_final" required value="{{ request.args.get('data_fim','') }}">
          <small class="muted">Ex.: 18/05/2025 a 24/05/2025</small>
        </div>

        <!-- Hospitalar -->
        <div class="col-12"><hr class="my-2"></div>
        <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h6 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-heart-pulse"></i> Benefício Hospitalar
          </h6>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge-soft" id="hosp_badge">Prévia: —</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor por beneficiado (R$)</label>
          <input type="number" step="0.01" class="form-control form-control-sm" name="hosp_valor_unit" id="hosp_valor_unit" placeholder="0,00">
          <input type="hidden" name="hosp_valor" id="hosp_valor_total">
        </div>
        <div class="col-md-5">
          <label class="form-label">Cooperados que <b>recebem</b></label>
          <select class="form-select form-select-sm" name="hosp_beneficiarios[]" id="hosp_beneficiarios" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
          <small class="muted">Os <u>não selecionados</u> (exceto isentos) pagam o rateio.</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cooperados <b>isentos</b></label>
          <select class="form-select form-select-sm" name="hosp_isencoes[]" id="hosp_isencoes" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
          <small class="muted">Isentos não pagam e não entram no divisor.</small>
        </div>

        <!-- Farmacêutico -->
        <div class="col-12"><hr class="my-2"></div>
        <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h6 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-capsule"></i> Benefício Farmacêutico
          </h6>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge-soft" id="farm_badge">Prévia: —</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor por beneficiado (R$)</label>
          <input type="number" step="0.01" class="form-control form-control-sm" name="farm_valor_unit" id="farm_valor_unit" placeholder="0,00">
          <input type="hidden" name="farm_valor" id="farm_valor_total">
        </div>
        <div class="col-md-5">
          <label class="form-label">Cooperados que <b>recebem</b></label>
          <select class="form-select form-select-sm" name="farm_beneficiarios[]" id="farm_beneficiarios" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cooperados <b>isentos</b></label>
          <select class="form-select form-select-sm" name="farm_isencoes[]" id="farm_isencoes" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
        </div>

        <!-- Alimentar -->
        <div class="col-12"><hr class="my-2"></div>
        <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h6 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-basket"></i> Benefício Alimentar
          </h6>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge-soft" id="alim_badge">Prévia: —</span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor por beneficiado (R$)</label>
          <input type="number" step="0.01" class="form-control form-control-sm" name="alim_valor_unit" id="alim_valor_unit" placeholder="0,00">
          <input type="hidden" name="alim_valor" id="alim_valor_total">
        </div>
        <div class="col-md-5">
          <label class="form-label">Cooperados que <b>recebem</b></label>
          <select class="form-select form-select-sm" name="alim_beneficiarios[]" id="alim_beneficiarios" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Cooperados <b>isentos</b></label>
          <select class="form-select form-select-sm" name="alim_isencoes[]" id="alim_isencoes" multiple size="6">
            {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
          </select>
        </div>

        <div class="col-12">
          <button class="btn btn-royal">
            <i class="bi bi-scissors"></i> Aplicar rateios
          </button>
          <small class="muted ms-2">Os lançamentos aparecerão em <b>Despesas para Cooperados</b> como “(rateio ref mm/aaaa)”.</small>
        </div>
      </form>
    </div>
  </div>

  <!-- Registros de benefícios recebidos -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h6 class="m-0 d-flex align-items-center gap-2">
          <i class="bi bi-journal-medical"></i> Registros de Benefícios Recebidos
        </h6>
        <form method="GET" class="row g-2 align-items-end">
          <input type="hidden" name="tab" value="beneficios">
          <div class="col-md-3">
            <label class="form-label">De</label>
            <input type="date" class="form-control form-control-sm" name="b_ini" value="{{ request.args.get('b_ini','') }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Até</label>
            <input type="date" class="form-control form-control-sm" name="b_fim" value="{{ request.args.get('b_fim','') }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">Cooperado</label>
            <select class="form-select form-select-sm" name="coop_benef_id">
              <option value="">Todos</option>
              {% set coop_benef_id = request.args.get('coop_benef_id') %}
              {% for coop in cooperados %}
                                <option value="{{ coop.id }}" {{ 'selected' if coop_benef_id and coop_benef_id|int == coop.id else '' }}>{{ coop.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-royal btn-sm w-100"><i class="bi bi-funnel"></i> Filtrar</button>
          </div>
        </form>
      </div>

     <!-- Ações em massa -->
<form id="form-bulk-beneficios" method="POST" action="{{ url_for('excluir_beneficio_bulk') }}" class="d-flex align-items-center gap-2 mt-2">
  {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
  <input type="hidden" name="tab" value="beneficios">
  <button type="submit" class="btn btn-outline-danger btn-sm" id="btn-bulk-delete" disabled>
    <i class="bi bi-trash"></i> Excluir selecionados
  </button>
  <span class="text-muted small">Selecione vários e exclua de uma vez.</span>
</form>

<div class="table-responsive mt-3">
  <table class="table table-sm table-bordered table-hover align-middle" id="tabela-beneficios">
    <thead class="table-light">
      <tr class="text-nowrap">
        <th class="text-center" style="width:36px;">
          <input type="checkbox" id="check_all">
        </th>
        <th>Referência</th>
        <th>Data Lançamento</th>
        <th>Tipo</th>
        <th>Recebedor</th>
        <th class="text-end">Valor p/ Recebedor</th>
        <th class="text-center">Ações</th>
      </tr>
    </thead>
    <tbody>
      {% set _bini  = request.args.get('b_ini') %}
      {% set _bfim  = request.args.get('b_fim') %}
      {% set _coopf = request.args.get('coop_benef_id') %}

      {% for b in beneficios_view %}
        {% set qtd = b.recebedores|length %}
        {% set vpb = ((b.valor_total or 0) / (qtd if qtd>0 else 1)) %}
        {% for rec in b.recebedores %}
          {% set mostrar = True %}
          {% if _coopf and rec.id and (rec.id|int) != (_coopf|int) %}{% set mostrar = False %}{% endif %}
          {% if _bini %}{% set mostrar = mostrar and (b.data_final.strftime('%Y-%m-%d') >= _bini) %}{% endif %}
          {% if _bfim %}{% set mostrar = mostrar and (b.data_inicial.strftime('%Y-%m-%d') <= _bfim) %}{% endif %}

          {% if mostrar %}
            <tr data-bid="{{ b.id }}">
              <td class="text-center">
                {# Mostra 1 checkbox por benefício (na primeira linha daquele benefício) #}
                {% if loop.first %}
                  <input type="checkbox"
                         class="chk-beneficio"
                         name="ids[]"
                         form="form-bulk-beneficios"
                         value="{{ b.id }}">
                {% endif %}
              </td>
              <td>{{ b.data_inicial.strftime('%d/%m/%Y') }} – {{ b.data_final.strftime('%d/%m/%Y') }}</td>
              <td>{% if b.data_lancamento %}{{ b.data_lancamento.strftime('%d/%m/%Y') }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
              <td class="text-capitalize">{{ b.tipo }}</td>
              <td class="text-break">{{ rec.nome }}</td>
              <td class="text-end">R$ {{ '%.2f'|format(vpb) }}</td>
              <td class="text-center">
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm btn-del-one"
                  data-bs-toggle="modal"
                  data-bs-target="#modalExcluirBeneficio"
                  data-beneficio-id="{{ b.id }}"
                  data-beneficio-label="{{ b.tipo|capitalize }} ({{ b.data_inicial.strftime('%d/%m/%Y') }}–{{ b.data_final.strftime('%d/%m/%Y') }})">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="text-center text-muted">Sem registros</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal: Excluir benefício (único) -->
<div class="modal fade" id="modalExcluirBeneficio" tabindex="-1" aria-labelledby="modalExcluirBeneficioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" class="modal-content" id="form-del-one" action="{{ url_for('excluir_beneficio_one') }}">
      {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
      <input type="hidden" name="beneficio_id" id="beneficio_id_hidden">
      <div class="modal-header">
        <h5 class="modal-title" id="modalExcluirBeneficioLabel">
          <i class="bi bi-exclamation-triangle text-danger"></i> Confirmar exclusão
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          Tem certeza que deseja excluir o benefício: <b id="beneficio_label_preview">—</b>?
        </p>
        <small class="text-muted">Esta ação não pode ser desfeita.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-trash"></i> Excluir
        </button>
      </div>
    </form>
  </div>
</div>
</section> <!-- FECHA A ABA BENEFÍCIOS -->

<!-- ==== BENEFÍCIOS: prévia + total + seleção em massa (escopado) ==== -->
<script>
(function(){
  const sec = document.getElementById('beneficios');
  if (!sec) return;

  // ===== Utils =====
  const TOTAL_COOPS = {{ cooperados|length or 0 }};
  const q = (sel) => sec.querySelector(sel);
  function idsFromSelect(sel){ return Array.from(sel?.selectedOptions || []).map(o => String(o.value)); }
  function valNum(inp){ const n = parseFloat(String(inp?.value ?? '').replace(',','.')); return isFinite(n)?n:0; }
  function money(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // ===== Prévia por tipo =====
  function calcPreview(prefix){
    const unit    = q(`#${prefix}_valor_unit`);
    const bensSel = q(`#${prefix}_beneficiarios`);
    const isenSel = q(`#${prefix}_isencoes`);
    const badge   = q(`#${prefix}_badge`);
    if(!unit || !bensSel || !isenSel || !badge) return;

    const vUnit = Math.max(0, valNum(unit));
    const bens  = idsFromSelect(bensSel);
    const isen  = idsFromSelect(isenSel);
    const unique = new Set([...bens, ...isen]); // não pagam
    const numBens = bens.length;
    const numIsen = isen.length;
    const pagantes = Math.max(0, TOTAL_COOPS - unique.size);
    const total = vUnit * numBens;
    const porPag = pagantes > 0 ? (total / pagantes) : 0;

    badge.textContent =
      `Recebem: ${numBens} · Isentos: ${numIsen} · Pagantes: ${pagantes} · ` +
      `Total a ratear: ${money(total)} · Cobrança por pagante: ${money(porPag)}`;
  }

  ['hosp','farm','alim'].forEach(p=>{
    q(`#${p}_valor_unit`)?.addEventListener('input', ()=>calcPreview(p));
    q(`#${p}_beneficiarios`)?.addEventListener('change', ()=>calcPreview(p));
    q(`#${p}_isencoes`)?.addEventListener('change', ()=>calcPreview(p));
    calcPreview(p); // estado inicial
  });

  // ===== Garantir IDs dos hidden + calcular total no submit =====
  const form = q('#form-beneficios');
  if (form){
    (function ensureHiddenIds(){
      const map = { hosp:'hosp_valor_total', farm:'farm_valor_total', alim:'alim_valor_total' };
      Object.entries(map).forEach(([p, id])=>{
        if (!q('#'+id)) {
          const i = q(`input[name="${p}_valor"]`);
          if (i) i.id = id;
        }
      });
    })();

    function setTotal(prefix){
      const unit = q(`#${prefix}_valor_unit`);
      const bensSel = q(`#${prefix}_beneficiarios`);
      const hidden = q(`#${prefix}_valor_total`) || q(`input[name="${prefix}_valor"]`);
      const count = (bensSel?.selectedOptions?.length) || 0;
      const total = Math.max(0, valNum(unit) * count);
      if (hidden) hidden.value = total.toFixed(2);
    }

    form.addEventListener('submit', function(){
      ['hosp','farm','alim'].forEach(setTotal);
    });
  }

  // ===== Seleção em massa + modal de exclusão =====
  const tbl      = q('#tabela-beneficios');
  const checkAll = q('#check_all');
  const bulkBtn  = document.getElementById('btn-bulk-delete'); // fora da sec
  const modal    = document.getElementById('modalExcluirBeneficio'); // fora da sec

  const allChecks = () => tbl ? tbl.querySelectorAll('tbody .chk-beneficio') : [];
  const checkedCount = () => tbl ? tbl.querySelectorAll('tbody .chk-beneficio:checked').length : 0;

  function toggleBulkBtn(){ if (bulkBtn) bulkBtn.disabled = (checkedCount() === 0); }
  function updateHeaderState(){
    if (!checkAll || !tbl) return;
    const total   = allChecks().length;
    const checked = checkedCount();
    if (checked === 0){ checkAll.checked = false; checkAll.indeterminate = false; }
    else if (checked === total){ checkAll.checked = true; checkAll.indeterminate = false; }
    else { checkAll.checked = false; checkAll.indeterminate = true; }
  }

  checkAll?.addEventListener('change', ()=>{
    allChecks().forEach(ch => { ch.checked = checkAll.checked; });
    toggleBulkBtn(); updateHeaderState();
  });

  tbl?.addEventListener('change', (e)=>{
    if (e.target && e.target.classList?.contains('chk-beneficio')){
      toggleBulkBtn(); updateHeaderState();
    }
  });

  toggleBulkBtn(); updateHeaderState();

  if (modal) {
    modal.addEventListener('show.bs.modal', function (ev) {
      const btn   = ev.relatedTarget;
      const id    = btn ? btn.getAttribute('data-beneficio-id') : '';
      const label = btn ? (btn.getAttribute('data-beneficio-label') || '—') : '—';
      const labelNode = modal.querySelector('#beneficio_label_preview');
      if (labelNode) labelNode.textContent = label;
      const hidden = modal.querySelector('#beneficio_id_hidden');
      if (hidden) hidden.value = id || '';
    });
  }
})();
</script>
      
<!-- COOPERADOS (versão profissional / drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='cooperados' else '' }}" id="cooperados" role="tabpanel">
  {% set qtd_coops = cooperados|length %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-person-badge"></i> Cadastro de Cooperados
    </h5>
    <span class="badge-soft">Total: <b>{{ qtd_coops }}</b></span>
  </div>

  <!-- Novo cooperado -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_cooperado') }}" enctype="multipart/form-data" class="row g-3 align-items-end">
        {% if csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}

        <div class="col-md-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control form-control-sm" name="nome" placeholder="Nome completo" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Usuário</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-at"></i></span>
            <input type="text" class="form-control" name="usuario" placeholder="usuario" required>
          </div>
          <small class="text-muted">Usado no login.</small>
        </div>

        <div class="col-md-3">
          <label class="form-label">Senha</label>
          <div class="input-group input-group-sm">
            <input type="password" class="form-control" name="senha" id="coopSenha" placeholder="********" required>
            <button class="btn btn-outline-secondary" type="button" id="btnToggleSenha" title="Mostrar/ocultar">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>

        <!-- Telefone (WhatsApp) -->
        <div class="col-md-3">
          <label class="form-label">Telefone (WhatsApp)</label>
          <input type="tel"
                 class="form-control form-control-sm"
                 name="telefone"
                 id="coopTelefone"
                 inputmode="numeric"
                 placeholder="(00) 00000-0000">
          <small class="text-muted">Cole/insira só dígitos; formatamos automaticamente.</small>
        </div>

        <div class="col-md-3">
          <label class="form-label">Foto (opcional)</label>
          <input type="file" class="form-control form-control-sm" name="foto" id="coopFoto" accept="image/*">
          <div class="d-flex align-items-center gap-2 mt-2">
            <img id="coopPreview" class="avatar border" src="{{ url_for('static', filename='img/default.png') }}" alt="" style="width:40px;height:40px;object-fit:cover;">
            <small class="text-muted">Prévia</small>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-royal">
            <i class="bi bi-save"></i> Cadastrar
          </button>
          <button type="reset" class="btn btn-light ms-1">Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de cooperados -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <h6 class="m-0 d-flex align-items-center gap-2">
          <i class="bi bi-people"></i> Cooperados cadastrados
        </h6>
        <div class="input-group input-group-sm" style="max-width:340px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" id="buscaCooperados" placeholder="Filtrar por nome, usuário ou telefone...">
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:60px;">Foto</th>
              <th>Nome</th>
              <th>Usuário</th>
              <th style="width:170px;">Telefone</th>
              <th style="width:120px;" class="text-center">Status</th>
              <th class="text-center" style="width:260px;">Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyCooperados">
            {% for coop in cooperados %}
              <tr data-nome="{{ coop.nome|lower }}"
                  data-user="{{ coop.usuario_ref.usuario|lower }}"
                  data-fone="{{ (coop.telefone or '')|replace('(','')|replace(')','')|replace('-','')|replace(' ','')|replace('+','')|lower }}">
                <td class="text-center">
                  <img src="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
                       class="avatar border" alt="{{ coop.nome }}"
                       style="width:40px;height:40px;object-fit:cover;">
                </td>

                <td class="fw-medium">{{ coop.nome }}</td>
                <td class="text-muted">{{ coop.usuario_ref.usuario }}</td>

                <td class="text-monospace">
                  {% if coop.telefone %}
                    <span class="fone" data-raw="{{ coop.telefone }}">{{ coop.telefone }}</span>
                    <a class="ms-1 btn btn-sm btn-outline-success"
                       target="_blank"
                       href="https://wa.me/55{{ (coop.telefone|replace('(','')|replace(')','')|replace('-','')|replace(' ','')|replace('+','')) }}">
                      <i class="bi bi-whatsapp"></i>
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </td>

                <!-- Badge de status -->
                <td class="text-center">
                  <span id="badge-ativo-{{ coop.id }}"
                        class="badge {{ 'bg-success' if coop.usuario_ref.ativo else 'bg-secondary' }}">
                    {{ 'Ativo' if coop.usuario_ref.ativo else 'Inativo' }}
                  </span>
                </td>

                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <!-- Toggle ativo/inativo -->
                    <button class="btn {{ 'btn-outline-danger' if coop.usuario_ref.ativo else 'btn-outline-success' }}"
                            type="button"
                            title="{{ 'Desativar' if coop.usuario_ref.ativo else 'Ativar' }}"
                            data-id="{{ coop.id }}"
                            data-ativo="{{ 1 if coop.usuario_ref.ativo else 0 }}"
                            onclick="toggleAtivoCooperado(this)">
                      <i class="bi {{ 'bi-person-dash' if coop.usuario_ref.ativo else 'bi-person-check' }}"></i>
                      <span class="d-none d-sm-inline">{{ 'Desativar' if coop.usuario_ref.ativo else 'Ativar' }}</span>
                    </button>

                    <!-- Editar (AGORA passa a foto atual também) -->
                    <button class="btn btn-warning"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEditCooperado"
                            data-id="{{ coop.id }}"
                            data-nome="{{ coop.nome }}"
                            data-usuario="{{ coop.usuario_ref.usuario }}"
                            data-telefone="{{ (coop.telefone or '')|replace('(','')|replace(')','')|replace('-','')|replace(' ','')|replace('+','') }}"
                            data-foto="{{ coop.foto_url or url_for('static', filename='img/default.png') }}"
                            data-url="{{ url_for('edit_cooperado', id=coop.id) }}"
                            title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <!-- Resetar senha -->
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalResetSenhaCooperado"
                            data-id="{{ coop.id }}" data-url="{{ url_for('reset_senha_cooperado', id=coop.id) }}" title="Redefinir senha">
                      <i class="bi bi-key"></i>
                    </button>

                    <!-- Excluir -->
                    <form action="{{ url_for('delete_cooperado', id=coop.id) }}"
                          method="POST"
                          class="d-inline"
                          onsubmit="return confirm('Excluir {{ coop.nome }}? Esta ação não pode ser desfeita.');">
                      {% if csrf_token is defined %}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      {% endif %}
                      <button type="submit" class="btn btn-danger btn-del" title="Excluir">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="text-center text-muted">Nenhum cooperado</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

    <!-- UX Helpers -->
  <script>
    // Formata BR: (00) 0000-0000 ou (00) 00000-0000
    function formatPhoneBR(v) {
      let d = (v || '').toString().replace(/\D/g, '');
      if (d.length > 11 && d.startsWith('55')) d = d.slice(d.length - 11);
      d = d.slice(0, 11);
      if (d.length <= 10) {
        return d.replace(/^(\d{0,2})(\d{0,4})(\d{0,4}).*$/, (_, a, b, c) => {
          let out = '';
          if (a) out += '(' + a;
          if (a && a.length === 2) out += ') ';
          if (b) out += b;
          if (b && b.length === 4 && c) out += '-' + c;
          return out;
        });
      }
      return d.replace(/^(\d{2})(\d{5})(\d{4}).*$/, '($1) $2-$3');
    }

    // filtro local por nome/usuário e dígitos do telefone
    (function(){
      const input = document.getElementById('buscaCooperados');
      const tbody = document.getElementById('tbodyCooperados');
      input?.addEventListener('input', () => {
        const qRaw = (input.value || '').trim().toLowerCase();
        const qDigits = qRaw.replace(/\D/g,'');
        [...tbody.querySelectorAll('tr')].forEach(tr => {
          const nome = tr.dataset.nome || '';
          const user = tr.dataset.user || '';
          const fone = tr.dataset.fone || '';
          tr.style.display = (!qRaw || nome.includes(qRaw) || user.includes(qRaw) || (qDigits && fone.includes(qDigits))) ? '' : 'none';
        });
      });
    })();

    // Formata todos os <span class="fone" data-raw="..."> renderizados
    (function(){
      document.querySelectorAll('span.fone[data-raw]').forEach(span => {
        const raw = span.getAttribute('data-raw') || '';
        const formatted = formatPhoneBR(raw);
        if (formatted) span.textContent = formatted;
      });
    })();

    // prévia da foto (form de NOVO cooperado)
    (function(){
      const file = document.getElementById('coopFoto');
      const prev = document.getElementById('coopPreview');
      file?.addEventListener('change', () => {
        const f = file.files?.[0];
        if(!f) { return; }
        const reader = new FileReader();
        reader.onload = e => prev.src = e.target.result;
        reader.readAsDataURL(f);
      });
    })();

    // mostrar/ocultar senha
    (function(){
      const btn = document.getElementById('btnToggleSenha');
      const inp = document.getElementById('coopSenha');
      btn?.addEventListener('click', () => {
        const isPwd = inp.type === 'password';
        inp.type = isPwd ? 'text' : 'password';
        btn.innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
      });
    })();

    // Preenche o modal de edição (agora inclui FOTO atual + prévia) e aplica máscara no campo
    (function(){
      const modal = document.getElementById('modalEditCooperado');
      modal?.addEventListener('show.bs.modal', (ev) => {
        const btn = ev.relatedTarget;
        const form = modal.querySelector('form');
        const nome = form?.querySelector('[name="nome"]');
        const usuario = form?.querySelector('[name="usuario"]');
        const tel = form?.querySelector('[name="telefone"]');
        const file = form?.querySelector('input[type="file"][name="foto"]');
        const prev = form?.querySelector('#editCoopPreview');

        if (form && btn?.dataset?.url) form.setAttribute('action', btn.dataset.url);
        if (nome)    nome.value    = btn?.dataset?.nome    || '';
        if (usuario) usuario.value = btn?.dataset?.usuario || '';
        if (tel)     tel.value     = formatPhoneBR(btn?.dataset?.telefone || '');

        // foto atual (para a prévia do modal)
        const fotoAtual = btn?.dataset?.foto || '{{ url_for("static", filename="img/default.png") }}';
        if (prev) prev.src = fotoAtual;

        // limpar input file ao abrir
        if (file) file.value = '';
      });

      // máscara tel no modal
      const tel = document.getElementById('editTelefone');
      tel?.addEventListener('input', () => {
        const f = formatPhoneBR(tel.value);
        if (tel.value !== f) tel.value = f;
      });
      tel?.addEventListener('blur', () => tel.value = formatPhoneBR(tel.value));

      // prévia da foto no MODAL de edição
      const modalForm = document.querySelector('#modalEditCooperado form');
      const fileIn = modalForm?.querySelector('input[type="file"][name="foto"]');
      const prevImg = modalForm?.querySelector('#editCoopPreview');
      fileIn?.addEventListener('change', ()=>{
        const f = fileIn.files?.[0];
        if(!f) return;
        const rd = new FileReader();
        rd.onload = e => { if(prevImg) prevImg.src = e.target.result; };
        rd.readAsDataURL(f);
      });
    })();

    // alternar ativo/inativo
    async function toggleAtivoCooperado(btn) {
      const id = btn.dataset.id;

      const headers = { 'X-Requested-With': 'fetch' };
      {% if csrf_token is defined %}
        headers['X-CSRFToken'] = '{{ csrf_token() }}';
      {% endif %}

      try {
        const resp = await fetch(`/admin/cooperados/${id}/toggle-status`, {
          method: 'POST',
          headers
        });
        const data = await resp.json();

        if (!data.ok) {
          alert(data.error || 'Falha ao alternar status');
          return;
        }

        const ativo = !!data.ativo;

        // Badge
        const badge = document.getElementById(`badge-ativo-${id}`);
        if (badge) {
          badge.textContent = ativo ? 'Ativo' : 'Inativo';
          badge.classList.toggle('bg-success', ativo);
          badge.classList.toggle('bg-secondary', !ativo);
        }

        // Botão
        btn.dataset.ativo = ativo ? 1 : 0;
        btn.title = ativo ? 'Desativar' : 'Ativar';
        btn.classList.toggle('btn-outline-danger', ativo);
        btn.classList.toggle('btn-outline-success', !ativo);
        btn.innerHTML = ativo
          ? '<i class="bi bi-person-dash"></i> <span class="d-none d-sm-inline">Desativar</span>'
          : '<i class="bi bi-person-check"></i> <span class="d-none d-sm-inline">Ativar</span>';

      } catch (e) {
        console.error(e);
        alert('Erro de rede ao alternar status');
      }
    }
  </script>

  {# Modal de edição do cooperado (agora com enctype e prévia da foto) #}
  <div class="modal fade" id="modalEditCooperado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form method="POST" enctype="multipart/form-data" class="modal-content">
        {% if csrf_token is defined %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <div class="modal-header">
          <h5 class="modal-title">Editar Cooperado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control form-control-sm" name="nome" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Usuário</label>
              <input type="text" class="form-control form-control-sm" name="usuario" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefone (WhatsApp)</label>
              <input type="tel"
                     class="form-control form-control-sm"
                     name="telefone"
                     id="editTelefone"
                     inputmode="numeric"
                     placeholder="(00) 00000-0000">
              <small class="text-muted">Só dígitos; formatamos automaticamente.</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Foto (opcional)</label>
              <input type="file" class="form-control form-control-sm" name="foto" accept="image/*">
              <div class="d-flex align-items-center gap-2 mt-2">
                <img id="editCoopPreview" class="avatar border" src="{{ url_for('static', filename='img/default.png') }}" alt="" style="width:40px;height:40px;object-fit:cover;">
                <small class="text-muted">Prévia</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-royal">
            <i class="bi bi-save"></i> Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

      <!-- RESTAURANTES (versão profissional / drop-in) -->
<section class="tab-pane fade {{ 'show active' if _tab=='restaurantes' else '' }}" id="restaurantes" role="tabpanel">
  {% set qtd_rest = restaurantes|length %}
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <h5 class="m-0 d-flex align-items-center gap-2">
      <i class="bi bi-shop"></i> Cadastro de Estabelecimentos
    </h5>
    <span class="badge-soft">Total: <b>{{ qtd_rest }}</b></span>
  </div>

  <!-- Novo estabelecimento -->
  <div class="card border-0 shadow-sm rounded-3 mb-3">
    <div class="card-body">
      <form method="POST" action="{{ url_for('add_restaurante') }}" enctype="multipart/form-data" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control form-control-sm" name="nome" placeholder="Ex.: Restaurante Centro" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Período</label>
          <select class="form-select form-select-sm" name="periodo" required>
            <option value="seg-dom">Seg a Dom</option>
            <option value="sab-sex">Sáb a Sex</option>
            <option value="sex-qui">Sex a Qui</option>
          </select>
          <small class="text-muted">Usado na competência de lançamentos.</small>
        </div>

        <div class="col-md-2">
          <label class="form-label">Usuário</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-at"></i></span>
            <input type="text" class="form-control" name="usuario" placeholder="usuario" required>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Senha</label>
          <div class="input-group input-group-sm">
            <input type="password" class="form-control" name="senha" id="restSenha" placeholder="********" required>
            <button class="btn btn-outline-secondary" type="button" id="btnToggleRestSenha" title="Mostrar/ocultar">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Logo (opcional)</label>
          <input type="file" class="form-control form-control-sm" name="foto" id="restFoto" accept="image/*">
          <div class="d-flex align-items-center gap-2 mt-2">
            <img id="restPreview" class="avatar border" src="{{ url_for('static', filename='img/default.png') }}" alt=""
                 style="width:40px;height:40px;object-fit:cover;">
            <small class="text-muted">Prévia</small>
          </div>
        </div>

        <div class="col-12">
          <button class="btn btn-royal">
            <i class="bi bi-save"></i> Cadastrar
          </button>
          <button type="reset" class="btn btn-light ms-1">Limpar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de estabelecimentos -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <h6 class="m-0 d-flex align-items-center gap-2">
          <i class="bi bi-list-ul"></i> Estabelecimentos cadastrados
        </h6>
        <div class="input-group input-group-sm" style="max-width:360px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control" id="buscaRestaurantes" placeholder="Filtrar por nome, usuário ou período...">
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr class="text-nowrap">
              <th style="width:60px;">Logo</th>
              <th>Nome</th>
              <th>Usuário</th>
              <th style="width:140px;">Período</th>
              <th class="text-center" style="width:200px;">Ações</th>
            </tr>
          </thead>
          <tbody id="tbodyRestaurantes">
            {% for r in restaurantes %}
              <tr data-nome="{{ r.nome|lower }}" data-user="{{ r.usuario_ref.usuario|lower }}" data-periodo="{{ r.periodo|lower }}">
                <td class="text-center">
                  <img src="{{ r.foto_url or url_for('static', filename='img/default.png') }}"
                       class="avatar border" alt="{{ r.nome }}"
                       style="width:40px;height:40px;object-fit:cover;">
                </td>
                <td class="fw-medium">{{ r.nome }}</td>
                <td class="text-muted">{{ r.usuario_ref.usuario }}</td>
                <td class="text-nowrap">
                  <span class="badge bg-light text-dark">
                    {% if r.periodo == 'seg-dom' %}Seg–Dom
                    {% elif r.periodo == 'sab-sex' %}Sáb–Sex
                    {% elif r.periodo == 'sex-qui' %}Sex–Qui
                    {% else %}{{ r.periodo }}{% endif %}
                  </span>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalEditRestaurante"
                            data-id="{{ r.id }}" data-nome="{{ r.nome }}" data-usuario="{{ r.usuario_ref.usuario }}" data-periodo="{{ r.periodo }}"
                            data-url="{{ url_for('edit_restaurante', id=r.id) }}" title="Editar">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalResetSenhaRestaurante"
                            data-id="{{ r.id }}" data-url="{{ url_for('reset_senha_restaurante', id=r.id) }}" title="Redefinir senha">
                      <i class="bi bi-key"></i>
                    </button>
                    <form action="{{ url_for('delete_restaurante', id=r.id) }}"
      method="POST"
      class="d-inline"
      onsubmit="return confirm('Excluir {{ r.nome }}? Esta ação não pode ser desfeita.');">
  {% if csrf_token is defined %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% endif %}
  <button type="submit" class="btn btn-danger btn-sm" title="Excluir">
    <i class="bi bi-trash"></i>
  </button>
</form>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="text-center text-muted">Nenhum estabelecimento</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- UX Helpers -->
  <script>
    // filtro local por nome/usuário/período
    (function(){
      const input = document.getElementById('buscaRestaurantes');
      const tbody = document.getElementById('tbodyRestaurantes');
      input?.addEventListener('input', () => {
        const q = (input.value || '').trim().toLowerCase();
        [...tbody.querySelectorAll('tr')].forEach(tr => {
          const nome = tr.dataset.nome || '';
          const user = tr.dataset.user || '';
          const per  = tr.dataset.periodo || '';
          tr.style.display = (!q || nome.includes(q) || user.includes(q) || per.includes(q)) ? '' : 'none';
        });
      });
    })();

    // prévia do logo
    (function(){
      const file = document.getElementById('restFoto');
      const prev = document.getElementById('restPreview');
      file?.addEventListener('change', () => {
        const f = file.files?.[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = e => prev.src = e.target.result;
        reader.readAsDataURL(f);
      });
    })();

    // mostrar/ocultar senha
    (function(){
      const btn = document.getElementById('btnToggleRestSenha');
      const inp = document.getElementById('restSenha');
      btn?.addEventListener('click', () => {
        const isPwd = inp.type === 'password';
        inp.type = isPwd ? 'text' : 'password';
        btn.innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
      });
    })();

    // confirmação de exclusão (somente dentro desta aba)
    (function(){
      const section = document.getElementById('restaurantes');
      section?.addEventListener('click', function(e){
        const del = e.target.closest('.btn-del');
        if (!del) return;
        if (!confirm('Tem certeza que deseja excluir?')) {
          e.preventDefault();
          return;
        }
        // evita cliques repetidos após confirmar
        del.classList.add('disabled');
        del.setAttribute('aria-disabled','true');
      });
    })();
  </script>
</section>

       <!-- ESCALAS -->
<section class="tab-pane fade {{ 'show active' if _tab=='escalas' else '' }}" id="escalas" role="tabpanel">
  <!-- Cabeçalho Escalas -->
  <div class="d-flex flex-column flex-lg-row justify-content-between gap-2 align-items-lg-center mb-3">
    <div>
      <h5 class="mb-0 section-title">Gestão de Escalas</h5>
      <small class="section-subtitle">
        Upload da planilha, consulta rápida por cooperado e histórico de trocas em um só lugar.
      </small>
    </div>

    <div class="d-flex flex-column flex-sm-row gap-2 align-items-stretch align-items-sm-center">
      <div class="alert alert-info py-1 px-2 mb-0 small shadow-sm border-0">
        <b>Prazo-limite geral:</b> 31/12/<span id="prazoAno">—</span>
        <span class="mx-1">•</span>
        faltam <b><span id="prazoDias">0</span> dias</b>.
      </div>
    </div>
  </div>

  <!-- Upload + Busca -->
  <div class="card p-3 mb-3 escala-upload-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
      <div class="flex-grow-1">
        <h6 class="mb-1 section-title">Upload da Escala (.xlsx)</h6>
        <small class="section-subtitle">
          Envie a planilha oficial de escalas. A associação do cooperado é feita por login (quando existir) ou por nome,
          ignorando acentos.
        </small>

        <form method="POST"
              action="{{ url_for('upload_escala') }}"
              enctype="multipart/form-data"
              class="row g-2 align-items-end mt-2">

          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}

          <div class="col-md-6">
            <label for="arquivo_escala" class="form-label extra-small text-muted-2 mb-1">
              Planilha de escala (.xlsx)
            </label>
            <input type="file"
                   class="form-control form-control-sm"
                   id="arquivo_escala"
                   name="file"
                   accept=".xlsx"
                   required>
          </div>

          <div class="col-md-3">
            <button type="submit" class="btn btn-royal btn-sm w-100 mt-1">
              <i class="bi bi-upload me-1"></i> Enviar Planilha
            </button>
          </div>
        </form>
      </div>

      <!-- Busca por cooperado / placa / CNH -->
      <div class="escala-search-box">
        <span class="section-subtitle d-block mb-1">Pesquisar cooperado</span>
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-light border-0 pe-1">
            <i class="bi bi-search text-muted-2"></i>
          </span>
          <input type="text"
                 id="filtroCooperado"
                 class="form-control border-0 shadow-none search-input"
                 placeholder="Digite nome, placa ou CNH...">
        </div>
        <div class="d-flex gap-2 mt-2 justify-content-end">
          <span class="badge-soft">
            Cooperados: {{ cooperados|length if cooperados else 0 }}
          </span>
          <span class="badge-soft">
            Com escala: {{ escalas_por_coop|length if escalas_por_coop is defined else 0 }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Cooperados & Escalas -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h6 class="mb-0 section-title">Resumo dos Cooperados</h6>
        <small class="section-subtitle">
          Documentação, quantidade de linhas na escala e acesso rápido ao detalhamento.
        </small>
      </div>
    </div>

    <div class="table-responsive escalas-wrapper">
      <table class="table table-sm align-middle mb-0 table-escalas" id="tabela-escalas">
        <thead>
          <tr>
            <th>Cooperado</th>
            <th>CNH</th>
            <th>Placa</th>
            <th>Situação Docs</th>
            <th>Última atualização</th>
            <th class="text-center">Qtde de linhas</th>
            <th class="text-center">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cooperados %}
            {# ===== SOMENTE ATIVOS (fallback seguro) =====
               - Se existir c.ativo (bool), usa.
               - Se existir c.status, considera "ativo"/"ATIVO".
               - Se não existir nada disso, assume ativo (para não quebrar template).
            #}
            {% set is_ativo = (c.ativo if c.ativo is defined else ( (c.status|string|lower) in ['ativo','active'] if c.status is defined else true )) %}
            {% if is_ativo %}
              {% set lst = (escalas_por_coop[c.id] if (escalas_por_coop is defined and c.id in escalas_por_coop) else []) %}
              {% set sdoc = status_doc_por_coop.get(c.id) if status_doc_por_coop is defined else None %}
              {% set ok_cnh   = sdoc.cnh_ok if sdoc is not none and 'cnh_ok' in sdoc else None %}
              {% set ok_placa = sdoc.placa_ok if sdoc is not none and 'placa_ok' in sdoc else None %}

              <tr data-coop-nome="{{ c.nome|lower }}"
                  data-coop-cnh="{{ (c.cnh_numero if c.cnh_numero is defined and c.cnh_numero else '')|lower }}"
                  data-coop-placa="{{ (c.placa if c.placa is defined and c.placa else '')|lower }}"
                  data-coop-ativo="1">
                <!-- Cooperado -->
                <td>
                  <div class="small fw-semibold text-truncate">
                    {{ c.nome }}
                  </div>
                  <div class="extra-small text-muted-2">
                    ID {{ c.id }}
                  </div>
                </td>

                <!-- CNH -->
                <td>
                  <div class="extra-small text-muted">
                    {{ c.cnh_numero if c.cnh_numero is defined and c.cnh_numero else '—' }}
                  </div>
                  <div class="extra-small text-muted-2">
                    Validade:
                    {% if c.cnh_validade is defined and c.cnh_validade %}
                      {{ c.cnh_validade.strftime('%d/%m') }}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>

                <!-- Placa -->
                <td>
                  <div class="extra-small text-muted">
                    {{ c.placa if c.placa is defined and c.placa else '—' }}
                  </div>
                  <div class="extra-small text-muted-2">
                    Validade:
                    {% if c.placa_validade is defined and c.placa_validade %}
                      {{ c.placa_validade.strftime('%d/%m') }}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>

                <!-- Situação Docs -->
                <td class="text-nowrap">
                  {% if ok_cnh is not none %}
                    <span class="badge badge-doc {{ 'badge-doc-ok' if ok_cnh else 'badge-doc-pend' }} me-1">
                      CNH {{ 'OK' if ok_cnh else 'Pend.' }}
                    </span>
                  {% else %}
                    <span class="badge badge-doc badge-doc-na">CNH —</span>
                  {% endif %}

                  {% if ok_placa is not none %}
                    <span class="badge badge-doc {{ 'badge-doc-ok' if ok_placa else 'badge-doc-pend' }} mt-1 mt-sm-0">
                      Placa {{ 'OK' if ok_placa else 'Pend.' }}
                    </span>
                  {% else %}
                    <span class="badge badge-doc badge-doc-na mt-1 mt-sm-0">Placa —</span>
                  {% endif %}

                  {% if ok_cnh and ok_placa %}
                    <span class="ms-1 text-success">👏</span>
                  {% endif %}
                </td>

                <!-- Última atualização -->
                <td>
                  <div class="extra-small text-muted">
                    {{ c.ultima_atualizacao.strftime('%d/%m/%Y %H:%M') if c.ultima_atualizacao else '—' }}
                  </div>
                </td>

                <!-- Qtde linhas -->
                <td class="text-center">
                  <span class="badge-soft d-inline-flex align-items-center justify-content-center px-2">
                    {{ lst|length }}
                  </span>
                </td>

                <!-- Ações -->
                <td class="text-center">
                  <div class="d-flex flex-column flex-sm-row gap-1 justify-content-center">
                    <button class="btn btn-royal btn-xs"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEscalas"
                            data-coopid="{{ c.id }}">
                      <i class="bi bi-eye me-1"></i> Ver escala
                    </button>
                    <a class="btn btn-outline-secondary btn-xs"
                       href="{{ url_for('editar_documentos', coop_id=c.id) }}">
                      <i class="bi bi-pen me-1"></i> Documentos
                    </a>
                  </div>
                </td>
              </tr>
            {% endif %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                Nenhum cooperado encontrado.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- SOLICITAÇÕES DE TROCA (pendentes) -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0 section-title">
          Trocas de Escala - Pendentes
        </h5>
        <small class="section-subtitle">
          Visualização dos dois contratos e de quem é cada um.
        </small>
      </div>
      <span class="badge-soft">
        Pendentes: {{ trocas_pendentes|length if trocas_pendentes else 0 }}
      </span>
    </div>

    {% if trocas_pendentes %}
      <div class="table-responsive mt-3 troca-pendentes-wrapper">
        <table class="table table-sm align-middle mb-0 table-troca">
          <thead>
            <tr>
              <th style="width: 80px;">#</th>
              <th>Cooperado 1</th>
              <th>Escala 1</th>
              <th>Cooperado 2</th>
              <th>Escala 2</th>
              <th style="width: 220px;">Mensagem</th>
              <th style="width: 130px;" class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for t in trocas_pendentes or [] %}
              {% set solicitante  = t.solicitante  if t.solicitante  else None %}
              {% set destinatario = t.destinatario if t.destinatario else None %}
              {% set origem       = t.origem       if t.origem       else None %}

              {% set solicitante_nome = (solicitante.nome if solicitante else t.solicitante_nome)|default('—', true) %}
              {% set solicitante_id   = (solicitante.id   if solicitante else t.solicitante_id)|default('—', true) %}

              {% set coop2_nome = (destinatario.nome if destinatario else t.destinatario_nome)|default('—', true) %}
              {% set coop2_id   = (destinatario.id   if destinatario else t.destinatario_id)|default('—', true) %}

              {% if origem and origem.data is defined %}
                {% set origem_data = origem.data %}
              {% elif t.origem_data is defined %}
                {% set origem_data = t.origem_data %}
              {% else %}
                {% set origem_data = '—' %}
              {% endif %}

              {% if origem and origem.turno is defined %}
                {% set origem_turno = origem.turno %}
              {% elif t.origem_turno is defined %}
                {% set origem_turno = t.origem_turno %}
              {% else %}
                {% set origem_turno = '—' %}
              {% endif %}

              {% if origem and origem.horario is defined %}
                {% set origem_horario = origem.horario %}
              {% elif t.origem_horario is defined %}
                {% set origem_horario = t.origem_horario %}
              {% else %}
                {% set origem_horario = '—' %}
              {% endif %}

              {% if origem and origem.contrato is defined %}
                {% set origem_contrato = origem.contrato %}
              {% elif t.origem_contrato is defined %}
                {% set origem_contrato = t.origem_contrato %}
              {% else %}
                {% set origem_contrato = '—' %}
              {% endif %}

              {% if t.destino_data is defined and t.destino_data %}
                {% set destino_data = t.destino_data %}
              {% elif t.destino and t.destino.data is defined %}
                {% set destino_data = t.destino.data %}
              {% else %}
                {% set destino_data = '—' %}
              {% endif %}

              {% if t.destino_turno is defined and t.destino_turno %}
                {% set destino_turno = t.destino_turno %}
              {% elif t.destino and t.destino.turno is defined %}
                {% set destino_turno = t.destino.turno %}
              {% else %}
                {% set destino_turno = '—' %}
              {% endif %}

              {% if t.destino_horario is defined and t.destino_horario %}
                {% set destino_horario = t.destino_horario %}
              {% elif t.destino and t.destino.horario is defined %}
                {% set destino_horario = t.destino.horario %}
              {% else %}
                {% set destino_horario = '—' %}
              {% endif %}

              {% if t.destino_contrato is defined and t.destino_contrato %}
                {% set destino_contrato = t.destino_contrato %}
              {% elif t.destino and t.destino.contrato is defined %}
                {% set destino_contrato = t.destino.contrato %}
              {% else %}
                {% set destino_contrato = '—' %}
              {% endif %}

              <tr>
                <td>
                  <div class="small fw-semibold">#{{ t.id|default('—', true) }}</div>
                  <div class="text-muted-2 extra-small">
                    {% if t.criada_em %}
                      {% if t.criada_em.strftime is defined %}
                        {{ t.criada_em.strftime('%d/%m/%Y %H:%M') }}
                      {% else %}
                        {{ t.criada_em }}
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>

                <td>
                  <div class="small fw-semibold text-truncate">
                    {{ solicitante_nome }}
                  </div>
                  <div class="text-muted-2 extra-small">
                    ID {{ solicitante_id }}
                  </div>
                </td>

                <td>
                  <div class="extra-small text-muted">
                    {{ origem_contrato }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_data }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_turno }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_horario }}
                  </div>
                </td>

                <td>
                  <div class="small fw-semibold text-truncate text-success">
                    {{ coop2_nome }}
                  </div>
                  <div class="text-muted-2 extra-small">
                    ID {{ coop2_id }}
                  </div>
                </td>

                <td>
                  <div class="extra-small text-muted">
                    {{ destino_contrato }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_data }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_turno }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_horario }}
                  </div>
                </td>

                <td class="mensagem-col">
                  {% set raw_msg = t.mensagem or '' %}
                  {% if 'AFETACAO_JSON' in raw_msg %}
                    <div class="extra-small text-muted">
                      Sem mensagem adicional.
                    </div>
                  {% elif raw_msg %}
                    <div class="extra-small text-muted">
                      {{ raw_msg }}
                    </div>
                  {% else %}
                    <div class="extra-small text-muted">
                      Sem mensagem adicional.
                    </div>
                  {% endif %}
                </td>

                <td class="text-end">
                  <div class="d-flex flex-column gap-1 align-items-end">
                    <form method="POST"
                          action="{{ url_for('admin_aprovar_troca', id=t.id if t.id is defined else none) }}"
                          onsubmit="return confirm('Confirmar aprovação desta troca?');">
                      <button type="submit" class="btn btn-success btn-xs w-100">
                        Aprovar
                      </button>
                    </form>

                    <form method="POST"
                          action="{{ url_for('admin_recusar_troca', id=t.id if t.id is defined else none) }}"
                          onsubmit="return confirm('Recusar esta solicitação?');">
                      <button type="submit" class="btn btn-outline-danger btn-xs w-100">
                        Recusar
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center text-muted mt-3">
        Nenhuma solicitação pendente.
      </div>
    {% endif %}
  </div>

  <!-- HISTÓRICO DE TROCAS (aplicadas) -->
  <div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0 section-title">
          Trocas de Escala - Aplicadas
        </h5>
        <small class="section-subtitle">
          Registro das trocas já aprovadas.
        </small>
      </div>
      <span class="badge-soft">
        {{ trocas_historico|length if trocas_historico else 0 }} registro(s)
      </span>
    </div>

    {% if trocas_historico %}
      <div class="table-responsive mt-3 troca-historico-wrapper">
        <table class="table table-sm align-middle mb-0 table-troca">
          <thead>
            <tr>
              <th style="width: 80px;">#</th>
              <th>Cooperado 1</th>
              <th>Escala 1</th>
              <th>Cooperado 2</th>
              <th>Escala 2</th>
              <th style="width: 220px;">Mensagem</th>
              <th style="width: 150px;">Aplicada em</th>
            </tr>
          </thead>
          <tbody>
            {% for t in trocas_historico or [] %}
              {% set solicitante  = t.solicitante  if t.solicitante  else None %}
              {% set destinatario = t.destinatario if t.destinatario else None %}
              {% set origem       = t.origem       if t.origem       else None %}

              {% set solicitante_nome = (solicitante.nome if solicitante else t.solicitante_nome)|default('—', true) %}
              {% set solicitante_id   = (solicitante.id   if solicitante else t.solicitante_id)|default('—', true) %}

              {% set coop2_nome = (destinatario.nome if destinatario else t.destinatario_nome)|default('—', true) %}
              {% set coop2_id   = (destinatario.id   if destinatario else t.destinatario_id)|default('—', true) %}

              {% if origem and origem.data is defined %}
                {% set origem_data = origem.data %}
              {% elif t.origem_data is defined %}
                {% set origem_data = t.origem_data %}
              {% else %}
                {% set origem_data = '—' %}
              {% endif %}

              {% if origem and origem.turno is defined %}
                {% set origem_turno = origem.turno %}
              {% elif t.origem_turno is defined %}
                {% set origem_turno = t.origem_turno %}
              {% else %}
                {% set origem_turno = '—' %}
              {% endif %}

              {% if origem and origem.horario is defined %}
                {% set origem_horario = origem.horario %}
              {% elif t.origem_horario is defined %}
                {% set origem_horario = t.origem_horario %}
              {% else %}
                {% set origem_horario = '—' %}
              {% endif %}

              {% if origem and origem.contrato is defined %}
                {% set origem_contrato = origem.contrato %}
              {% elif t.origem_contrato is defined %}
                {% set origem_contrato = t.origem_contrato %}
              {% else %}
                {% set origem_contrato = '—' %}
              {% endif %}

              {% if t.destino_data is defined and t.destino_data %}
                {% set destino_data = t.destino_data %}
              {% else %}
                {% set destino_data = '—' %}
              {% endif %}

              {% if t.destino_turno is defined and t.destino_turno %}
                {% set destino_turno = t.destino_turno %}
              {% else %}
                {% set destino_turno = '—' %}
              {% endif %}

              {% if t.destino_horario is defined and t.destino_horario %}
                {% set destino_horario = t.destino_horario %}
              {% else %}
                {% set destino_horario = '—' %}
              {% endif %}

              {% if t.destino_contrato is defined and t.destino_contrato %}
                {% set destino_contrato = t.destino_contrato %}
              {% else %}
                {% set destino_contrato = '—' %}
              {% endif %}

              <tr>
                <td>
                  <div class="small fw-semibold">#{{ t.id|default('—', true) }}</div>
                  <div class="text-muted-2 extra-small">
                    {% if t.criada_em %}
                      {% if t.criada_em.strftime is defined %}
                        {{ t.criada_em.strftime('%d/%m/%Y %H:%M') }}
                      {% else %}
                        {{ t.criada_em }}
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>

                <td>
                  <div class="small fw-semibold text-truncate">
                    {{ solicitante_nome }}
                  </div>
                  <div class="text-muted-2 extra-small">
                    ID {{ solicitante_id }}
                  </div>
                </td>

                <td>
                  <div class="extra-small text-muted">
                    {{ origem_contrato }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_data }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_turno }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ origem_horario }}
                  </div>
                </td>

                <td>
                  <div class="small fw-semibold text-truncate text-success">
                    {{ coop2_nome }}
                  </div>
                  <div class="text-muted-2 extra-small">
                    ID {{ coop2_id }}
                  </div>
                </td>

                <td>
                  <div class="extra-small text-muted">
                    {{ destino_contrato }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_data }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_turno }}
                  </div>
                  <div class="extra-small text-muted">
                    {{ destino_horario }}
                  </div>
                </td>

                <td class="mensagem-col">
                  {% set raw_msg = t.mensagem or '' %}
                  {% if 'AFETACAO_JSON' in raw_msg %}
                    <div class="extra-small text-muted">
                      Sem mensagem adicional.
                    </div>
                  {% elif raw_msg %}
                    <div class="extra-small text-muted">
                      {{ raw_msg }}
                    </div>
                  {% else %}
                    <div class="extra-small text-muted">
                      Sem mensagem adicional.
                    </div>
                  {% endif %}
                </td>

                <td>
                  <div class="extra-small text-muted">
                    {% if t.aplicada_em %}
                      {% if t.aplicada_em.strftime is defined %}
                        {{ t.aplicada_em.strftime('%d/%m/%Y %H:%M') }}
                      {% else %}
                        {{ t.aplicada_em }}
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center text-muted mt-2">
        Sem trocas aplicadas.
      </div>
    {% endif %}
  </div>

  <!-- Modal visualizar escala do cooperado -->
  <div class="modal fade" id="modalEscalas" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header border-0 pb-0">
          <div>
            <h5 class="modal-title section-title">Escala do Cooperado</h5>
            <small class="section-subtitle" id="modalEscalaCoopNome">Detalhamento da escala selecionada.</small>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body pt-2">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0 table-escalas">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Turno</th>
                  <th>Horário</th>
                  <th>Contrato</th>
                </tr>
              </thead>
              <tbody id="tbody-escala"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .section-title {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .section-subtitle {
    font-size: 0.78rem;
    color: #6c757d;
  }

  .card {
    border-radius: 0.75rem;
    border: 1px solid #e4e7f0;
  }

  .badge-soft {
    background: #eef2ff;
    color: #3047d6;
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    font-size: 0.75rem;
  }

  .extra-small {
    font-size: 0.74rem;
    line-height: 1.1;
  }

  .text-muted-2 {
    color: #9aa0ac;
  }

  .btn-xs {
    padding: 0.18rem 0.5rem;
    font-size: 0.74rem;
    border-radius: 999px;
  }

  .escala-upload-card {
    background: linear-gradient(135deg, #f5f7ff 0%, #ffffff 100%);
  }

  .escala-search-box {
    min-width: 240px;
    max-width: 260px;
    padding: 0.6rem 0.75rem;
    border-radius: 0.75rem;
    background: #f8f9ff;
    border: 1px solid #e0e4ff;
  }

  .search-input::placeholder {
    font-size: 0.78rem;
  }

  .escalas-wrapper {
    max-height: 420px;
    overflow-y: auto;
  }

  .table-escalas {
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-escalas thead th {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background-color: #f5f7fb;
    border-bottom: 1px solid #e4e7f0;
  }

  .table-escalas th,
  .table-escalas td {
    padding: 0.4rem 0.55rem;
    vertical-align: middle;
    font-size: 0.78rem;
  }

  .badge-doc {
    font-size: 0.68rem;
    border-radius: 999px;
    padding: 0.15rem 0.55rem;
    border: 1px solid transparent;
  }

  .badge-doc-ok {
    background: #e9f9ee;
    color: #1c7c3c;
    border-color: #b7e4c7;
  }

  .badge-doc-pend {
    background: #fff0f0;
    color: #b02a37;
    border-color: #f5c2c7;
  }

  .badge-doc-na {
    background: #f2f3f7;
    color: #6c757d;
    border-color: #dde1ee;
  }

  /* Trocas – mesmo padrão visual */
  .troca-pendentes-wrapper,
  .troca-historico-wrapper {
    max-height: 380px;
    overflow-y: auto;
  }

  .table-troca {
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-troca thead th {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background-color: #f5f7fb;
    border-bottom: 1px solid #e4e7f0;
  }

  .table-troca th,
  .table-troca td {
    padding: 0.4rem 0.55rem;
    vertical-align: middle;
    font-size: 0.78rem;
  }

  .mensagem-col {
    max-width: 220px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
</style>

<script>
  // Filtro por nome / placa / CNH (somente ativos já renderizados no template)
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('filtroCooperado');
    const tabela = document.getElementById('tabela-escalas');

    if (input && tabela) {
      const linhas = tabela.querySelectorAll('tbody tr[data-coop-nome]');

      input.addEventListener('input', function () {
        const termo = (this.value || '').toLowerCase().trim();

        linhas.forEach(function (tr) {
          const nome  = (tr.getAttribute('data-coop-nome')  || '').toLowerCase();
          const cnh   = (tr.getAttribute('data-coop-cnh')   || '').toLowerCase();
          const placa = (tr.getAttribute('data-coop-placa') || '').toLowerCase();

          const ok = (!termo || nome.includes(termo) || cnh.includes(termo) || placa.includes(termo));
          tr.style.display = ok ? '' : 'none';
        });
      });
    }
  });
</script>

  <!-- MODAIS =================================================== -->
  <div class="modal fade" id="modalEditLancamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Lançamento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-md-4">
            <label class="form-label">Restaurante</label>
            <select class="form-select" name="restaurante_id" required>
              {% for r in restaurantes %}<option value="{{ r.id }}">{{ r.nome }} ({{ r.periodo }})</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Cooperado</label>
            <select class="form-select" name="cooperado_id" required>
              {% for c in cooperados %}<option value="{{ c.id }}">{{ c.nome }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Descrição</label>
            <input type="text" class="form-control" name="descricao" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Valor (R$)</label>
            <input type="number" step="0.01" class="form-control" name="valor" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Data</label>
            <input type="date" class="form-control" name="data" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Horário</label>
            <div class="input-group">
              <input type="time" class="form-control" name="hora_inicio">
              <span class="input-group-text">às</span>
              <input type="time" class="form-control" name="hora_fim">
            </div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditReceita" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Receita (Cooperativa)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="text" class="form-control" name="descricao" required></div>
          <div class="col-12"><input type="number" step="0.01" class="form-control" name="valor" required></div>
          <div class="col-12"><input type="date" class="form-control" name="data" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditDespesa" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Despesa (Cooperativa)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="text" class="form-control" name="descricao" required></div>
          <div class="col-12"><input type="number" step="0.01" class="form-control" name="valor" required></div>
          <div class="col-12"><input type="date" class="form-control" name="data" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditReceitaCoop" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Receita (Cooperado)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12">
            <select class="form-select" name="cooperado_id" required>
              {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-12"><input type="text" class="form-control" name="descricao" required></div>
          <div class="col-12"><input type="number" step="0.01" class="form-control" name="valor" required></div>
          <div class="col-12"><input type="date" class="form-control" name="data" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditDespesaCoop" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Despesa (Cooperado)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12">
            <select class="form-select" name="cooperado_id" required>
              {% for coop in cooperados %}<option value="{{ coop.id }}">{{ coop.nome }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-12"><input type="text" class="form-control" name="descricao" required></div>
          <div class="col-12"><input type="number" step="0.01" class="form-control" name="valor" required></div>
          <div class="col-12"><input type="date" class="form-control" name="data" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditCooperado" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Cooperado</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="text" class="form-control" name="nome" required></div>
          <div class="col-12"><input type="text" class="form-control" name="usuario" required></div>
          <div class="col-12"><input type="file" class="form-control" name="foto"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalResetSenhaCooperado" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Redefinir Senha (Cooperado)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="password" class="form-control" name="nova_senha" placeholder="Nova senha" required></div>
          <div class="col-12"><input type="password" class="form-control" name="confirmar_senha" placeholder="Confirmar senha" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Atualizar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalEditRestaurante" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Editar Estabelecimento</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="text" class="form-control" name="nome" required></div>
          <div class="col-12">
            <select class="form-select" name="periodo" required>
              <option value="seg-dom">Seg a Dom</option>
              <option value="sab-sex">Sáb a Sex</option>
              <option value="sex-qui">Sex a Qui</option>
            </select>
          </div>
          <div class="col-12"><input type="text" class="form-control" name="usuario" required></div>
          <div class="col-12"><input type="file" class="form-control" name="foto"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Salvar</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalResetSenhaRestaurante" tabindex="-1">
    <div class="modal-dialog">
      <form method="POST" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Redefinir Senha (Estabelecimento)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body row g-2 px-3">
          <input type="hidden" name="id">
          <div class="col-12"><input type="password" class="form-control" name="nova_senha" placeholder="Nova senha" required></div>
          <div class="col-12"><input type="password" class="form-control" name="confirmar_senha" placeholder="Confirmar senha" required></div>
        </div>
        <div class="modal-footer"><button class="btn btn-royal"><i class="bi bi-save"></i> Atualizar</button></div>
      </form>
    </div>
  </div>

  <!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  // Confirmar exclusão
  document.addEventListener('click', function (e) {
    if (e.target.closest('.btn-del')) {
      if (!confirm('Tem certeza que deseja excluir?')) e.preventDefault();
    }
  });

  // Preenche modais a partir dos data-*
  function bindModal(modalId, mapFields) {
    const el = document.getElementById(modalId);
    if (!el) return;

    el.addEventListener('show.bs.modal', (ev) => {
      const btn = ev.relatedTarget;
      const form = el.querySelector('form');
      const ds = btn?.dataset || {};

      if (form && ds.url) form.setAttribute('action', ds.url);

      Object.keys(mapFields).forEach((k) => {
        const name = mapFields[k];
        const input = form?.querySelector(`[name="${name}"]`);
        if (!input) return;

        const val = ds[k] ?? '';
        if (input.tagName === 'SELECT') {
          [...input.options].forEach((o) => (o.selected = (String(o.value) === String(val))));
        } else {
          input.value = val;
        }
      });
    });
  }

  bindModal('modalEditLancamento',   { id:'id', restaurante:'restaurante_id', cooperado:'cooperado_id', descricao:'descricao', valor:'valor', data:'data', hora_inicio:'hora_inicio', hora_fim:'hora_fim' });
  bindModal('modalEditReceita',      { id:'id', descricao:'descricao', valor:'valor', data:'data' });
  bindModal('modalEditDespesa',      { id:'id', descricao:'descricao', valor:'valor', data:'data' });
  bindModal('modalEditReceitaCoop',  { id:'id', cooperado:'cooperado_id', descricao:'descricao', valor:'valor', data:'data' });
  bindModal('modalEditDespesaCoop',  { id:'id', cooperado:'cooperado_id', descricao:'descricao', valor:'valor', data:'data' });
  bindModal('modalEditCooperado',    { id:'id', nome:'nome', usuario:'usuario' });
  bindModal('modalResetSenhaCooperado', { id:'id' });
  bindModal('modalEditRestaurante',  { id:'id', nome:'nome', periodo:'periodo', usuario:'usuario' });
  bindModal('modalResetSenhaRestaurante', { id:'id' });

  // ===== Gráficos =====
  const rawLancCoop   = {{ (chart_data_lancamentos_coop or {'labels':[], 'values':[]}) | tojson }};
  const rawLancCooper = {{ (chart_data_lancamentos_cooperados or {'labels':[], 'values':[]}) | tojson }};

  const totalProducoesFallback = parseFloat('{{ total_producoes|default(0) }}') || 0;

  const fallbackLancCoop   = { labels: ['Total'], values: [totalProducoesFallback] };
  const fallbackLancCooper = { labels: ['Total'], values: [totalProducoesFallback] };

  const dataLancCoop = (rawLancCoop?.labels?.length && rawLancCoop?.values?.length) ? rawLancCoop : fallbackLancCoop;
  const dataLancCooperados = (rawLancCooper?.labels?.length && rawLancCooper?.values?.length) ? rawLancCooper : fallbackLancCooper;

  function buildLineChart(canvasId, labels, values, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    new Chart(canvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: values,
          tension: .25,
          borderWidth: 2,
          pointRadius: 3,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (v) => 'R$ ' + Number(v).toLocaleString('pt-BR')
            }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (c) => 'R$ ' + Number(c.parsed.y).toLocaleString('pt-BR', { minimumFractionDigits: 2 })
            }
          }
        }
      }
    });
  }

  buildLineChart('chartLancCoop', dataLancCoop.labels, dataLancCoop.values, 'Lançamentos/Produções');
  buildLineChart('chartLancCooperados', dataLancCooperados.labels, dataLancCooperados.values, 'Lançamentos/Produções');

  // ===== Preservar aba ativa via ?tab= =====
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(location.search);
    const targetTab = params.get('tab');

    if (targetTab) {
      const link = document.querySelector(`.sidebar .nav-link[href="#${targetTab}"]`);
      if (link) new bootstrap.Tab(link).show();
    }

    document.querySelectorAll('.sidebar .nav-link[data-bs-toggle="tab"]').forEach(a => {
      a.addEventListener('shown.bs.tab', (e) => {
        const id = e.target.getAttribute('href')?.slice(1) || '';
        if (!id) return;

        const p = new URLSearchParams(location.search);
        p.set('tab', id);
        history.replaceState(null, '', location.pathname + '?' + p.toString() + e.target.getAttribute('href'));
      });
    });

    // Contagem regressiva até 31/12 (aba Escalas)
    const anoSpan = document.getElementById('prazoAno');
    const diasSpan = document.getElementById('prazoDias');

    function updatePrazo() {
      const now = new Date();
      let target = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
      if (now > target) target = new Date(now.getFullYear() + 1, 11, 31, 23, 59, 59);

      const diff = target - now;
      const dias = Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));

      if (anoSpan) anoSpan.textContent = target.getFullYear();
      if (diasSpan) diasSpan.textContent = dias;
    }

    updatePrazo();
    setInterval(updatePrazo, 60 * 1000);
  });
</script>

<!-- ==== ESCALAS: horário & cores (robusto) ==== -->
<script>
  const ESCALAS = {{ escalas_por_coop|default({})|tojson }};
  const modalEsc = document.getElementById('modalEscalas');

  const norm = (s) => String(s || '')
    .normalize('NFD').replace(/\p{Diacritic}/gu, '')
    .toLowerCase().replace(/[^a-z0-9]/g, '');

  function pick(obj, aliases) {
    const keys = Object.keys(obj || {});
    for (const name of aliases) {
      const target = norm(name);
      for (const k of keys) {
        if (norm(k).includes(target)) {
          const v = obj[k];
          if (v !== undefined && v !== null && String(v).trim() !== '') return v;
        }
      }
    }
    return '';
  }

  function resolveCores(row) {
    const spec = pick(row, ['cor_linha', 'cores', 'cor', 'color', 'row_color', 'linha_cor', 'bg', 'background', 'style']) || '';

    function normColor(c) {
      if (!c) return null;
      c = String(c).trim();

      // AARRGGBB (8 hex sem #)
      if (/^[0-9A-Fa-f]{8}$/.test(c)) {
        const a = parseInt(c.slice(0, 2), 16) / 255;
        const r = parseInt(c.slice(2, 4), 16);
        const g = parseInt(c.slice(4, 6), 16);
        const b = parseInt(c.slice(6, 8), 16);
        return `rgba(${r},${g},${b},${a.toFixed(3)})`;
      }

      // RRGGBB (6 hex sem #)
      if (/^[0-9A-Fa-f]{6}$/.test(c)) return `#${c}`;

      // #RRGGBB ou #AARRGGBB
      if (/^#[0-9A-Fa-f]{6,8}$/.test(c)) {
        if (c.length === 9) {
          const a = parseInt(c.slice(1, 3), 16) / 255;
          const r = parseInt(c.slice(3, 5), 16);
          const g = parseInt(c.slice(5, 7), 16);
          const b = parseInt(c.slice(7, 9), 16);
          return `rgba(${r},${g},${b},${a.toFixed(3)})`;
        }
        return c;
      }

      const map = {
        'amarelo': '#fff3cd', 'vermelho': '#f8d7da', 'verde': '#d1e7dd',
        'azul': '#cfe2ff', 'cinza': '#e9ecef', 'laranja': '#ffe5b4',
        'roxo': '#e0d1ff', 'rosa': '#ffd6e7'
      };
      const low = c.toLowerCase();
      if (map[low]) return map[low];
      return c;
    }

    function parseColorSpec(spec) {
      const out = { rowBg: null, rowFg: null, colBg: [null, null, null, null], colFg: [null, null, null, null] };
      if (!spec) return out;

      if (Array.isArray(spec)) {
        const parts = spec.map(normColor);
        if (parts.length === 1) { out.rowBg = parts[0]; return out; }
        if (parts.length === 2) { out.rowBg = parts[0]; out.rowFg = parts[1]; return out; }
        if (parts.length >= 4) {
          out.colBg = [parts[0], parts[1], parts[2], parts[3]];
          if (parts.length >= 8) out.colFg = [parts[4], parts[5], parts[6], parts[7]];
          return out;
        }
      }

      if (typeof spec === 'string') {
        try {
          const t = spec.trim();
          if (t.startsWith('[') || t.startsWith('{')) return parseColorSpec(JSON.parse(t));
        } catch (_) { }

        const parts = spec.split('|').map(s => normColor(s.trim())).filter(Boolean);
        if (parts.length === 1) { out.rowBg = parts[0]; return out; }
        if (parts.length === 2) { out.rowBg = parts[0]; out.rowFg = parts[1]; return out; }
        if (parts.length >= 4) {
          out.colBg = [parts[0], parts[1], parts[2], parts[3]];
          if (parts.length >= 8) out.colFg = [parts[4], parts[5], parts[6], parts[7]];
          return out;
        }

        out.rowBg = normColor(spec);
        return out;
      }

      if (typeof spec === 'object') {
        if (spec.rowBg || spec.rowFg || spec.colBg || spec.colFg) {
          out.rowBg = normColor(spec.rowBg);
          out.rowFg = normColor(spec.rowFg);
          out.colBg = (spec.colBg || []).map(normColor).concat([null, null, null, null]).slice(0, 4);
          out.colFg = (spec.colFg || []).map(normColor).concat([null, null, null, null]).slice(0, 4);
          return out;
        }

        const bgData = normColor(spec.bgData || spec.data || spec.bg_data);
        const bgTurno = normColor(spec.bgTurno || spec.turno || spec.bg_turno);
        const bgHorario = normColor(spec.bgHorario || spec.horario || spec.bg_horario || spec.hora);
        const bgContrato = normColor(spec.bgContrato || spec.contrato || spec.bg_contrato);

        const fgData = normColor(spec.fgData || spec.textData);
        const fgTurno = normColor(spec.fgTurno || spec.textTurno);
        const fgHorario = normColor(spec.fgHorario || spec.textHorario || spec.textHora);
        const fgContrato = normColor(spec.fgContrato || spec.textContrato);

        if (bgData || bgTurno || bgHorario || bgContrato) {
          out.colBg = [bgData, bgTurno, bgHorario, bgContrato];
          out.colFg = [fgData, fgTurno, fgHorario, fgContrato];
        }
        return out;
      }

      return out;
    }

    return parseColorSpec(spec);
  }

  function fmtHorario(h) {
    if (!h) return '';
    let s = String(h).trim().replace(/\s*–\s*/g, '-').replace(/\s*-\s*/g, '-');
    return s.split(/\s*\/\s*/).map(seg => seg.trim().replace(/\s*(?:-|a|as|às)\s*/i, ' às ')).join(' / ');
  }

  if (modalEsc) {
    modalEsc.addEventListener('show.bs.modal', (ev) => {
      const coopId = ev.relatedTarget?.dataset?.coopid;
      const tbody = modalEsc.querySelector('#tbody-escala');
      if (!tbody) return;

      tbody.innerHTML = '';

      const raw = ESCALAS[String(coopId)] || [];
      if (!raw.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Nenhuma escala</td></tr>`;
        return;
      }

      const grouped = new Map();

      for (const e of raw) {
        const data = pick(e, ['data', 'dt', 'dia', 'date']) || '';
        const turno = pick(e, ['turno', 'periodo', 'shift']) || '';
        const contrato = pick(e, ['contrato', 'setor', 'unidade', 'contr', 'local']) || '';

        let horario = pick(e, ['horário', 'horario', 'hora', 'horas', 'turno/horario', 'escala', 'jornada']);
        if (!horario) {
          for (const v of Object.values(e || {})) {
            const s = String(v ?? '').trim();
            if (s && /\b\d{1,2}:\d{2}/.test(s)) { horario = s; break; }
          }
        }

        const key = [data, turno, contrato].map(v => String(v).toLowerCase()).join('|');
        const cur = grouped.get(key);
        const val = { data, turno, contrato, horario: fmtHorario(horario), src: e };

        if (!cur) grouped.set(key, val);
        else if (!cur.horario && val.horario) grouped.set(key, val);
      }

      for (const { data, turno, contrato, horario, src } of grouped.values()) {
        const cores = resolveCores(src);

        const tr = document.createElement('tr');
        if (cores.rowBg) tr.style.background = cores.rowBg;
        if (cores.rowFg) tr.style.color = cores.rowFg;

        tr.innerHTML = `
          <td class="cel-data">${data}</td>
          <td class="cel-turno">${turno}</td>
          <td class="cel-horario">${horario || ''}</td>
          <td class="cel-contrato">${contrato}</td>
        `;

        const cols = [
          tr.querySelector('.cel-data'),
          tr.querySelector('.cel-turno'),
          tr.querySelector('.cel-horario'),
          tr.querySelector('.cel-contrato')
        ];

        cols.forEach((td, i) => {
          if (!td) return;
          if (cores.colBg[i]) td.style.background = cores.colBg[i];
          if (cores.colFg[i]) td.style.color = cores.colFg[i];
          if (cores.colBg[i] || cores.colFg[i]) {
            td.style.borderRadius = '6px';
            td.style.padding = '6px 8px';
          }
        });

        tbody.appendChild(tr);
      }
    });
  }
</script>

<!-- ==== BENEFÍCIOS: prévia + cálculo do TOTAL antes de enviar ==== -->
<script>
  (function () {
    const sec = document.getElementById('beneficios');
    if (!sec) return; // só roda nesta aba

    const TOTAL_COOPS = {{ cooperados|length or 0 }};

    // ===== Utils =====
    function valNum(inp) {
      const n = parseFloat(String(inp?.value ?? '').replace(',', '.'));
      return isFinite(n) ? n : 0;
    }
    function idsFromSelect(sel) {
      return Array.from(sel?.selectedOptions || []).map(o => String(o.value));
    }
    function money(v) {
      return 'R$ ' + Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function setBadge(el, txt) { if (el) el.textContent = txt; }

    // ===== Prévia por tipo (hosp/farm/alim) =====
    function calcPreview(prefix) {
      const unit = sec.querySelector(`#${prefix}_valor_unit`);
      const bensSel = sec.querySelector(`#${prefix}_beneficiarios`);
      const isenSel = sec.querySelector(`#${prefix}_isencoes`);
      const badge = sec.querySelector(`#${prefix}_badge`);
      if (!unit || !bensSel || !isenSel || !badge) return;

      const vUnit = Math.max(0, valNum(unit));
      const bens = idsFromSelect(bensSel);
      const isen = idsFromSelect(isenSel);

      // regra do seu texto: union(bens + isen) = "quem não paga"
      const uniqueNaoPagam = new Set([...bens, ...isen]);
      const numBens = bens.length;
      const numIsen = isen.length;
      const pagantes = Math.max(0, TOTAL_COOPS - uniqueNaoPagam.size);

      const total = vUnit * numBens;
      const porPag = pagantes > 0 ? (total / pagantes) : 0;

      setBadge(
        badge,
        `Recebem: ${numBens} · Isentos: ${numIsen} · Pagantes: ${pagantes} · Total a ratear: ${money(total)} · Cobrança por pagante: ${money(porPag)}`
      );
    }

    ['hosp', 'farm', 'alim'].forEach(p => {
      sec.querySelector(`#${p}_valor_unit`)?.addEventListener('input', () => calcPreview(p));
      sec.querySelector(`#${p}_beneficiarios`)?.addEventListener('change', () => calcPreview(p));
      sec.querySelector(`#${p}_isencoes`)?.addEventListener('change', () => calcPreview(p));
      calcPreview(p);
    });

    // ===== Cálculo dos totais no submit + garantir IDs dos hidden =====
    const form = sec.querySelector('#form-beneficios');
    if (form) {
      // garante IDs dos hidden esperados (se existir só name="")
      (function ensureHiddenIds() {
        const map = { hosp: 'hosp_valor_total', farm: 'farm_valor_total', alim: 'alim_valor_total' };
        Object.entries(map).forEach(([p, id]) => {
          if (!sec.querySelector(`#${id}`)) {
            const i = sec.querySelector(`input[name="${p}_valor"]`);
            if (i) i.id = id;
          }
        });
      })();

      function setTotal(prefix) {
        const unit = sec.querySelector(`#${prefix}_valor_unit`);
        const bensSel = sec.querySelector(`#${prefix}_beneficiarios`);
        const hidden = sec.querySelector(`#${prefix}_valor_total`) || sec.querySelector(`input[name="${prefix}_valor"]`);

        const count = (bensSel?.selectedOptions?.length) ? bensSel.selectedOptions.length : 0;
        const total = Math.max(0, valNum(unit) * count);

        if (hidden) hidden.value = total.toFixed(2);
      }

      form.addEventListener('submit', function () {
        ['hosp', 'farm', 'alim'].forEach(setTotal);
      });
    }

    // ===== Seleção em massa + modal de exclusão (tabela) =====
    try {
      const tbl = sec.querySelector('#tabela-beneficios');
      const checkAll = sec.querySelector('#check_all');
      const bulkBtn = sec.querySelector('#btn-bulk-delete');
      const modal = document.getElementById('modalExcluirBeneficio'); // modal pode ficar fora da aba

      const allChecks = () => (tbl ? tbl.querySelectorAll('tbody .chk-beneficio') : []);
      const checkedCount = () => (tbl ? tbl.querySelectorAll('tbody .chk-beneficio:checked').length : 0);

      function toggleBulkBtn() { if (bulkBtn) bulkBtn.disabled = checkedCount() === 0; }
      function updateHeaderState() {
        if (!checkAll) return;
        const items = allChecks();
        const total = items.length;
        const checked = checkedCount();

        if (checked === 0) { checkAll.checked = false; checkAll.indeterminate = false; }
        else if (checked === total) { checkAll.checked = true; checkAll.indeterminate = false; }
        else { checkAll.checked = false; checkAll.indeterminate = true; }
      }

      checkAll?.addEventListener('change', () => {
        allChecks().forEach(ch => { ch.checked = checkAll.checked; });
        toggleBulkBtn();
        updateHeaderState();
      });

      tbl?.addEventListener('change', (e) => {
        if (e.target && e.target.classList?.contains('chk-beneficio')) {
          toggleBulkBtn();
          updateHeaderState();
        }
      });

      toggleBulkBtn();
      updateHeaderState();

      // Modal individual (exclusão)
      if (modal) {
        modal.addEventListener('show.bs.modal', function (ev) {
          const btn = ev.relatedTarget;
          const id = btn ? btn.getAttribute('data-beneficio-id') : '';
          const label = btn ? (btn.getAttribute('data-beneficio-label') || '—') : '—';

          const labelNode = modal.querySelector('#beneficio_label_preview');
          if (labelNode) labelNode.textContent = label;

          const hidden = modal.querySelector('#beneficio_id_hidden');
          if (hidden) hidden.value = id || '';
        });
      }
    } catch (err) {
      console.error('[beneficios-js]', err);
    }
  })();
</script>
</body>
</html>
