<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Avisos do Cooperado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- <meta name="csrf-token" content="{{ csrf_token() if csrf_token is defined else '' }}"> -->

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Bootstrap (inclua s√≥ UMA vez o bundle) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --royal:#2747d9; --royal-2:#3b61e3; --bg:#f7f9fc; --ink:#111827;
      --soft:#eef2ff; --ok:#10b981; --warn:#c0392b; --muted:#6b7280;
      --card:#ffffff; --ring:#e5e7eb;
    }
    html,body{height:100%;}
    body{background:var(--bg); color:var(--ink); font-family:'Roboto',sans-serif;}

    /* Topbar */
    .topbar{
      background:linear-gradient(90deg,var(--royal),var(--royal-2));
      color:#fff; position:sticky; top:0; z-index:20; box-shadow:0 2px 12px #0002;
    }
    .brand{font-family:'Orbitron',sans-serif; letter-spacing:1px; font-size:1.05rem;}

    /* Layout mobile 6" */
    .mobile-wrap{max-width:420px; margin:0 auto;} /* ~6" */
    @media (min-width:480px){ .mobile-wrap{max-width:520px;} }

    /* Bot√µes */
    .btn-royal{background:var(--royal); color:#fff; border:none; border-radius:12px;}
    .btn-royal:hover{background:var(--royal-2); color:#fff;}
    .btn-outline-success{border-radius:12px;}

    /* Cart√µes/Avisos */
    .card{border:0; border-radius:18px; box-shadow:0 8px 22px #00000010;}
    .aviso-card{overflow:hidden; border:1px solid var(--ring); background:var(--card);}
    .aviso-unread{border-color:#ffd2d2; box-shadow:0 8px 24px #ff000010;}
    .aviso-head{
      background:var(--card); border-bottom:1px solid var(--soft);
      display:flex; align-items:center; gap:.6rem; justify-content:space-between; padding:12px 14px;
    }
    .aviso-title{ font-weight:800; font-size:1rem; display:flex; align-items:center; gap:.5rem; line-height:1.2; }
    .aviso-title i{color:var(--royal);}
    .aviso-meta{font-size:.86rem; color:var(--muted);}
    .aviso-body{background:var(--card); padding:12px 14px;}
    .aviso-content{ white-space:pre-wrap; font-size:.98rem; line-height:1.45; }

    /* Badges/Pills */
    .badge-soft{background:var(--soft); color:#1f2937; border-radius:999px; padding:.2rem .6rem;}
    .badge-novo{background:#ffe5e5; color:var(--warn); border-radius:999px; padding:.15rem .55rem; font-weight:700;}
    .pill{border-radius:999px; padding:.2rem .6rem;}

    /* Links */
    .btn-link-royal{ color:var(--royal); text-decoration:none; font-weight:700; }
    .btn-link-royal:hover{color:var(--royal-2); text-decoration:underline;}

    /* Acessibilidade/touch */
    .tap-lg{min-height:44px; min-width:44px;}

    /* Accordion bot√£o custom */
    .accordion-button-custom{
      background:transparent; border:0; padding:0; display:flex; align-items:center; gap:.5rem; color:inherit;
    }
    .accordion-button-custom:focus{outline:2px solid transparent; box-shadow:none;}

    /* Toast: canto inferior */
    .toast-container{position:fixed; bottom:12px; right:12px; z-index:1080;}
  </style>
</head>
<body>

  <!-- TOPO -->
  <header class="topbar">
    <div class="mobile-wrap d-flex align-items-center justify-content-between p-2">
      <a href="{{ url_for('portal_cooperado') }}" class="btn btn-light btn-sm tap-lg">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
      <div class="brand fw-bold">Avisos</div>
      <div class="text-end">
        <span class="badge-soft">Total: <span id="total-avisos">{{ avisos|length if avisos else 0 }}</span></span>
      </div>
    </div>
  </header>

  <main class="mobile-wrap p-3">

    <!-- Barra superior -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="d-flex align-items-center gap-2">
        {% set unread = (avisos_nao_lidos_count or avisos_unread_count) | default(0) %}
        {% if unread > 0 %}
          <span id="badge-nao-lidos" class="badge rounded-pill bg-danger">{{ unread }} n√£o lido(s)</span>
        {% else %}
          <span id="badge-nao-lidos" class="badge-soft">Voc√™ est√° em dia üéâ</span>
        {% endif %}
      </div>

      {% if unread > 0 %}
      <form method="POST" action="{{ url_for('marcar_todos_avisos_lidos') }}">
        <button type="submit" class="btn btn-sm btn-royal tap-lg">
          <i class="bi bi-check2-all"></i> Marcar todos
        </button>
      </form>
      {% endif %}
    </div>

    <!-- Lista -->
    {% if avisos %}
      {% for a in avisos %}
        {% set cid = 'avisoCollapse_' ~ a.id %}
        {% set is_prior = (a.prioridade_alta if a.prioridade_alta is defined else (a.prioridade if a.prioridade is defined else false)) %}
        <div class="card aviso-card {% if not a.lido %}aviso-unread{% endif %} mb-3" id="aviso-{{ a.id }}" data-aviso-id="{{ a.id }}">
          <div class="aviso-head">
            <div class="flex-grow-1">
              <button class="accordion-button-custom tap-lg"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#{{ cid }}"
                      aria-expanded="{{ 'true' if not a.lido else 'false' }}"
                      aria-controls="{{ cid }}">
                <div class="aviso-title">
                  <i class="bi bi-megaphone-fill"></i>
                  <span>
                    {% if is_prior %}<span class="text-danger">[PRIORIDADE]</span> {% endif %}
                    {{ a.titulo }}
                  </span>
                </div>
              </button>

              <div class="aviso-meta mt-1">
                <i class="bi bi-clock"></i>
                {{ a.criado_em.strftime('%d/%m/%Y %H:%M') if a.criado_em else '' }}
                <span class="mx-1">¬∑</span>
                <span class="estado-leitura">
                  {% if not a.lido %}
                    <span class="badge-novo">n√£o lido</span>
                  {% else %}
                    <span class="text-success"><i class="bi bi-check2-circle"></i> lido</span>
                  {% endif %}
                </span>
              </div>
            </div>

            {% if not a.lido %}
              <button
                type="button"
                class="btn btn-sm btn-outline-success js-mark-read tap-lg"
                data-url="{{ url_for('marcar_aviso_lido', aviso_id=a.id) }}"
                aria-label="Marcar aviso como lido">
                <i class="bi bi-check2"></i> Marcar
              </button>
            {% endif %}
          </div>

          <div id="{{ cid }}" class="collapse {% if not a.lido %}show{% endif %}">
            <div class="aviso-body">
              {% set conteudo = a.corpo_html if a.corpo_html is defined and a.corpo_html
                                 else (a.corpo if a.corpo is defined and a.corpo
                                 else (a.mensagem if a.mensagem is defined and a.mensagem
                                 else (a.resumo if a.resumo is defined and a.resumo else ''))) %}
              {% if conteudo|trim %}
                <div class="mb-2 aviso-content">{{ conteudo|safe }}</div>
              {% else %}
                <div class="text-muted fst-italic">Este aviso n√£o tem conte√∫do salvo.</div>
              {% endif %}

              <div class="d-flex align-items-center justify-content-between">
                <a class="btn-link-royal tap-lg" data-bs-toggle="collapse" href="#{{ cid }}" role="button" aria-expanded="true" aria-controls="{{ cid }}">
                  <i class="bi bi-arrows-collapse"></i> Recolher
                </a>

                {% if not a.lido %}
                  <button
                    type="button"
                    class="btn btn-royal btn-sm js-mark-read tap-lg"
                    data-url="{{ url_for('marcar_aviso_lido', aviso_id=a.id) }}"
                    aria-label="Marcar aviso como lido">
                    <i class="bi bi-check2"></i> Marcar como lido
                  </button>
                {% else %}
                  <span class="text-success small"><i class="bi bi-check2-circle"></i> Voc√™ j√° leu este aviso</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center text-muted py-5">
        <i class="bi bi-inbox"></i> Nenhum aviso dispon√≠vel.
      </div>
    {% endif %}

    <div class="text-center mt-3 mb-2">
      <small class="text-muted">¬© {{ current_year|default('') }} Coopex</small>
    </div>
  </main>

  <!-- TOAST: novos avisos -->
  <div class="toast-container">
    <div id="toastAvisos" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-autohide="true" data-bs-delay="8000">
      <div class="toast-header">
        <i class="bi bi-megaphone-fill me-2"></i>
        <strong class="me-auto">Novos avisos</strong>
        <small>agora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
      <div class="toast-body">
        Voc√™ tem {{ unread|default(0) }} aviso(s) n√£o lido(s).
        <a href="#topo" class="link-primary fw-semibold">Ver agora</a>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- L√≥gica da p√°gina -->
  <script>
    (function(){
      // Unifica e blinda o valor de 'unread'
      const UNREAD = parseInt('{{ unread|default(0) }}', 10) || 0;

      // 1) Scroll para o primeiro n√£o lido
      document.addEventListener('DOMContentLoaded', function(){
        const firstUnread = document.querySelector('.aviso-unread');
        if(firstUnread){
          setTimeout(() => firstUnread.scrollIntoView({behavior:'smooth', block:'start'}), 140);
        }
      });

      // 2) Toast ao carregar se houver n√£o lidos
      document.addEventListener('DOMContentLoaded', function () {
        if (UNREAD > 0) {
          const el = document.getElementById('toastAvisos');
          if (el && window.bootstrap?.Toast) {
            const t = new bootstrap.Toast(el);
            t.show();
          }
        }
      });

      // 3) √Åudio de notifica√ß√£o (respeitando autoplay)
      // Coloque seu arquivo em: static/sounds/notify.mp3
      const audio = new Audio("{{ url_for('static', filename='sounds/notify.mp3') }}");
      let soundReady = false;

      function armAudioOnce() {
        if (soundReady) return;
        audio.play().then(() => {
          audio.pause(); audio.currentTime = 0;
          soundReady = true;
          window.removeEventListener('click', armAudioOnce, true);
          window.removeEventListener('keydown', armAudioOnce, true);
          window.removeEventListener('touchstart', armAudioOnce, true);
        }).catch(()=>{ /* aguardando intera√ß√£o */ });
      }
      window.addEventListener('click', armAudioOnce, true);
      window.addEventListener('keydown', armAudioOnce, true);
      window.addEventListener('touchstart', armAudioOnce, true);

      // Toca quando o toast aparecer (se j√° liberado pelo usu√°rio)
      document.addEventListener('DOMContentLoaded', function () {
        if (UNREAD > 0) {
          const el = document.getElementById('toastAvisos');
          if (el) {
            el.addEventListener('shown.bs.toast', () => {
              audio.play().catch(()=>{ /* sem intera√ß√£o ainda ‚Äî tocar√° ao pr√≥ximo gesto */ });
            });
          }
        }
      });

      // 4) Utilit√°rio: pega CSRF de meta (se existir)
      function getCSRFToken(){
        const m = document.querySelector('meta[name="csrf-token"]');
        return m ? m.getAttribute('content') : null;
      }

      // 5) Atualiza UI ao marcar lido
      function atualizarUIComoLido(card){
        if(!card) return;
        card.classList.remove('aviso-unread');

        const estado = card.querySelector('.estado-leitura');
        if(estado){
          estado.innerHTML = '<span class="text-success"><i class="bi bi-check2-circle"></i> lido</span>';
        }

        card.querySelectorAll('.js-mark-read').forEach(btn => btn.remove());

        const badge = document.getElementById('badge-nao-lidos');
        if(badge){
          const n = parseInt((badge.textContent || '').replace(/\D+/g,'') || '0', 10);
          if(!isNaN(n) && n > 0){
            const novo = n - 1;
            if(novo > 0){
              badge.classList.remove('badge-soft');
              badge.classList.add('bg-danger','badge','rounded-pill');
              badge.textContent = `${novo} n√£o lido(s)`;
            } else {
              badge.classList.remove('bg-danger','badge','rounded-pill');
              badge.classList.add('badge-soft');
              badge.textContent = 'Voc√™ est√° em dia üéâ';
            }
          }
        }
      }

      async function marcarComoLido(url, card){
        if(!url || !card) return;

        try{
          const headers = { 'X-Requested-With': 'XMLHttpRequest' };
          // const csrf = getCSRFToken();
          // if(csrf) headers['X-CSRFToken'] = csrf;

          const resp = await fetch(url, { method:'POST', headers });
          if(resp.ok){
            let ok = true;
            try{
              const data = await resp.json();
              ok = (data && (data.ok === true || data.status === 'ok')) || resp.status === 204;
            }catch(e){ /* pode ser 204 */ }

            if(ok){ atualizarUIComoLido(card); }
            else { console.warn('Resposta inesperada ao marcar como lido.'); }
          }else{
            console.error('Falha no POST marcar_aviso_lido:', resp.status);
          }
        }catch(err){
          console.error('Erro ao marcar como lido:', err);
        }
      }

      // 6) Liga os bot√µes "Marcar"
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.js-mark-read').forEach(btn=>{
          btn.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            const url = this.getAttribute('data-url');
            const card = this.closest('.aviso-card');
            marcarComoLido(url, card);
          }, { passive:false });
        });
      });
    })();
  </script>

  <!-- EMISSOR: envia total de n√£o lidos para o dashboard via BroadcastChannel -->
  <script>
    (function () {
      // Canal compartilhado com o dashboard
      const ch = new BroadcastChannel('coopex_avisos');

      // Valor inicial vindo do servidor
      const UNREAD = parseInt('{{ unread|default(0) }}', 10) || 0;

      // Envia para ouvintes (dashboard e afins)
      function notifyUnread(n) {
        try { ch.postMessage({ source: 'avisos', unread: Number(n) || 0 }); } catch (_) {}
        try { if (window.opener?.coopAvisosNotify) window.opener.coopAvisosNotify(Number(n) || 0); } catch (_) {}
      }

      // Notifica na carga
      document.addEventListener('DOMContentLoaded', function () {
        notifyUnread(UNREAD);
      });

      // Recalcula n√£o lidos a partir do badge ou dos cards
      function recalcUnreadAndNotify() {
        const badge = document.getElementById('badge-nao-lidos');
        let n;
        if (badge) {
          const m = (badge.textContent || '').match(/\d+/);
          n = m ? parseInt(m[0], 10) : 0;
        } else {
          n = document.querySelectorAll('.aviso-card.aviso-unread').length;
        }
        notifyUnread(n);
      }

      // Observa cliques nos bot√µes "Marcar" para reagir quando virar "lido"
      document.addEventListener('click', function (ev) {
        const btn = ev.target.closest('.js-mark-read');
        if (!btn) return;
        const card = btn.closest('.aviso-card');
        if (!card) return;

        // Quando a classe .aviso-unread sumir, dispara atualiza√ß√£o
        const obs = new MutationObserver(() => {
          if (!card.classList.contains('aviso-unread')) {
            obs.disconnect();
            recalcUnreadAndNotify();
          }
        });
        obs.observe(card, { attributes: true, attributeFilter: ['class'] });
      }, { passive: true });

      // Opcional: quando o toast local abrir (h√° n√£o lidos), tamb√©m notifica
      document.getElementById('toastAvisos')?.addEventListener('shown.bs.toast', recalcUnreadAndNotify);
    })();
  </script>
</body>
</html>
