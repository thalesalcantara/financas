<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Tabelas do Contrato — {{ restaurante.nome or login_nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap (leve e com cache de CDN) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

  <!-- Ícones -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <!-- Fonte sem carregar peso exagerado -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#8a94a6;
      --primary:#3b82f6;
      --primary-600:#2563eb;
      --ring:#1e293b;
      --ok:#16a34a;
    }
    html,body{height:100%;}
    body{
      background:linear-gradient(180deg,#0b1220 0%, #0e1422 60%, #0b1220 100%);
      color:#e5e7eb;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1120px;margin:38px auto;padding:0 18px;}
    .page-title{
      font-weight:600; letter-spacing:.2px; font-size:clamp(1.2rem,1.6vw,1.6rem);
      display:flex; align-items:center; gap:.6rem; color:#fff;
    }
    .card-white{
      background:rgba(15,23,42,.72);
      border:1px solid rgba(148,163,184,.12);
      border-radius:16px; padding:18px;
      backdrop-filter: blur(6px);
      box-shadow:0 6px 24px rgba(0,0,0,.25);
    }
    .chip{display:inline-flex;align-items:center;gap:.45rem;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:.35rem .7rem;font-size:.8rem;}
    .muted{color:var(--muted);}
    .btn-primary{background:var(--primary);border-color:var(--primary);}
    .btn-primary:hover{background:var(--primary-600);border-color:var(--primary-600);}
    .btn-success{background:var(--ok);border-color:var(--ok);}
    .panel{
      display:grid;grid-template-columns:1fr;gap:18px;
    }
    @media(min-width:992px){ .panel{grid-template-columns:360px 1fr;} }
    .meta{
      border:1px solid rgba(148,163,184,.14);
      border-radius:14px; padding:16px; background:#0b1220;
    }
    .meta .k{color:var(--muted);font-size:.9rem;}
    .pdf-wrap{
      position:relative; border-radius:12px; overflow:hidden; background:#0b1220;
      border:1px solid rgba(148,163,184,.14);
      min-height:60vh;
    }
    .pdf-frame{ width:100%; height:78vh; border:0; display:block; }
    .skeleton{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(90deg,#0b1220 0%, #10182a 50%, #0b1220 100%);
      background-size:200% 100%; animation:shimmer 1.2s infinite linear;
      color:#cbd5e1; font-size:.95rem;
    }
    @keyframes shimmer{0%{background-position:0 0}100%{background-position:200% 0}}
    .toolbar{
      display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .divider{height:1px;background:#1f2937;margin:10px 0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="page-title">
        <i class="bi bi-table"></i> Tabelas do Contrato
      </h1>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('portal_restaurante', view='lancar') }}">
        <i class="bi bi-arrow-left"></i> Voltar ao painel
      </a>
    </div>

    <div class="card-white">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
        <div class="toolbar">
          <span class="chip"><i class="bi bi-building"></i> {{ restaurante.nome or '—' }}</span>
          {% if login_nome %}
            <span class="chip"><i class="bi bi-person-badge"></i> login: {{ login_nome }}</span>
          {% endif %}
        </div>
      </div>

      {% if not tabela %}
        <div class="alert alert-warning d-flex align-items-start" role="alert">
          <i class="bi bi-exclamation-triangle me-2 fs-5"></i>
          <div>
            Nenhuma tabela correspondente para <b>{{ login_nome or restaurante.nome }}</b>.<br />
            Publique uma tabela cujo <u>título</u> seja exatamente o nome/login do restaurante (acentos e maiúsculas não importam).
          </div>
        </div>
        <div class="muted">
          Dica: “{{ (restaurante.nome or login_nome) ~ ' - Tabela 2025' }}” também funciona; o sistema procura igual após normalização.
        </div>

      {% else %}
        {% set nome_arquivo = tabela.arquivo_nome or '' %}
        {% set is_pdf = nome_arquivo.lower().endswith('.pdf') %}
        <div class="panel">
          <!-- Coluna de metadados e ações -->
          <div class="meta">
            <div class="mb-2"><span class="k">Título</span><br /><strong>{{ tabela.titulo }}</strong></div>
            <div class="mb-2"><span class="k">Descrição</span><br />{{ tabela.descricao or '—' }}</div>
            <div class="mb-2"><span class="k">Arquivo</span><br />{{ tabela.arquivo_nome or '—' }}</div>
            <div class="mb-3"><span class="k">Enviado em</span><br />{{ tabela.enviado_em.strftime('%d/%m/%Y %H:%M') if tabela.enviado_em else '—' }}</div>

            <div class="divider"></div>

            <div class="d-grid gap-2">
              <a class="btn btn-primary" href="{{ url_for('tabela_abrir', tab_id=tabela.id) }}" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right"></i> Abrir em nova aba
              </a>
              <a class="btn btn-success" href="{{ url_for('rest_tabela_download', tabela_id=tabela.id) }}">
                <i class="bi bi-download"></i> Baixar
              </a>
            </div>

            <div class="mt-3 small text-secondary">
              A visualização embutida abaixo é otimizada para PDF. Outros formatos devem ser abertos/baixados.
            </div>
          </div>

          <!-- Coluna de visualização -->
          <div class="pdf-wrap">
            {% if is_pdf %}
              <div id="pdfSkeleton" class="skeleton">
                <span><i class="bi bi-file-earmark-pdf me-2"></i>Carregando visualização…</span>
              </div>
              <iframe
                class="pdf-frame"
                src="{{ url_for('tabela_abrir', tab_id=tabela.id) }}"
                loading="lazy"
                onload="document.getElementById('pdfSkeleton')?.remove();"
              ></iframe>
            {% else %}
              <div class="p-5 text-center">
                <i class="bi bi-file-earmark-text fs-2 d-block mb-2"></i>
                <p class="mb-1">Pré-visualização disponível apenas para PDF.</p>
                <p class="text-secondary small mb-0">Use “Abrir em nova aba” ou “Baixar”.</p>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
</body>
</html>
