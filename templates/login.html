<!doctype html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <title>Entrar · Coopex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- DNS Prefetch / Preconnect -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- Preload do logo -->
  <link rel="preload" as="image" href="{{ url_for('static', filename='img/logo.png') }}">

  <!-- Google Fonts: não bloqueante -->
  <link rel="preload" as="style"
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap">
  <link rel="stylesheet" media="print"
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap"
        onload="this.media='all'">
  <noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400;700&display=swap">
  </noscript>

  <!-- Bootstrap & Icons (non-blocking) -->
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"></noscript>

  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"></noscript>

  <!-- CSS crítico da dobra (leve e suficiente p/ render imediato) -->
  <style>
    :root{
      --royal:#2747d9; --royal-2:#3b61e3; --bg:#f4f7ff;
      --glass:rgba(255,255,255,0.32); --glass-border:rgba(70,90,255,0.13);
      --shadow:0 6px 36px 0 rgba(39,71,217,0.13); --green:#23bb75;
    }
    html,body{height:100%}
    body{
      min-height:100vh; margin:0;
      background:linear-gradient(120deg,#f2f6ff 0%,#d2e1ff 100%);
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex; align-items:center; justify-content:center;
    }
    .login-wrap{width:100vw; min-height:100vh; display:flex; align-items:center; justify-content:center}
    .glass-card{
      max-width:410px; width:98vw; border-radius:24px; background:var(--glass);
      backdrop-filter:blur(22px) saturate(130%); -webkit-backdrop-filter:blur(22px) saturate(130%);
      border:1.8px solid var(--glass-border); box-shadow:var(--shadow);
      overflow:hidden; padding:0; position:relative; display:flex; flex-direction:column;
      contain:content; will-change:transform,opacity;
    }
    /* Fallback rápido para dispositivos lentos/conexão ruim */
    @media (max-width:600px), (prefers-reduced-transparency: reduce){
      .glass-card{ backdrop-filter:none; -webkit-backdrop-filter:none; background:rgba(255,255,255,.9) }
    }
    .card-top{
      background:linear-gradient(135deg,var(--royal),var(--royal-2)); color:#fff; text-align:center;
      padding:38px 24px 30px; border-bottom-left-radius:50% 26px; border-bottom-right-radius:50% 26px;
      box-shadow:0 8px 22px 0 #2747d91b;
    }
    .brand{display:flex; flex-direction:column; align-items:center; gap:8px}
    .brand-logo{width:92px; height:92px; border-radius:50%; object-fit:contain; border:4px solid #fff; box-shadow:0 3px 24px 0 #2747d950}
    .brand-title{font-family:'Orbitron',sans-serif; font-size:1.23rem; letter-spacing:2px; font-weight:600}
    .small-note{font-size:.96rem; color:#e6ecfa; opacity:.91; margin-top:4px}
    .credentials-vault{
      margin:16px auto 0; width:82%; min-height:54px; background:rgba(255,255,255,0.44);
      border:2px solid var(--royal-2); border-radius:16px; box-shadow:0 3px 24px 0 #3b61e325;
      display:flex; align-items:center; gap:15px; padding:10px 16px 10px 14px;
    }
    .vault-icon{font-size:1.5rem; color:var(--royal-2); opacity:.75}
    .vault-text{font-size:1.08rem; color:#234; font-weight:500; line-height:1.2}
    .vault-mini{font-size:.92rem; color:#456; opacity:.78}
    .card-body{padding:30px 28px 22px}
    .form-label{font-weight:600; color:#334}
    .btn-royal{background:var(--royal); color:#fff; font-weight:600; border-radius:10px; box-shadow:0 3px 16px #3b61e313}
    .btn-royal:hover{background:var(--royal-2); color:#fff; box-shadow:0 6px 22px #3b61e337}
    .role-info{font-size:.99rem; color:var(--green); background:#e8fcf2; border-radius:12px; padding:10px 12px; margin-top:12px; font-weight:600}
    .form-control:focus{border-color:var(--royal-2); box-shadow:0 0 0 2px #3b61e344}
    .input-group-lg>.form-control,.input-group-lg>.btn{font-size:1.14rem; border-radius:10px}
    .alert{border-radius:10px; margin-bottom:18px}
    .form-check-label{font-size:.98rem; color:#446; margin-left:6px; user-select:none}
    .marca-sistema{color:#1a1a1a; text-align:center; margin:16px auto 8px; font-size:1.04rem; font-weight:500}
    @media (max-width:550px){ .glass-card{max-width:99vw} .brand-logo{width:70px; height:70px} .credentials-vault{width:98%; padding:8px} .marca-sistema{font-size:.97rem} }
    @media (prefers-reduced-motion: reduce){ *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important} }
  </style>
</head>
<body>
  <div class="login-wrap">
    <div class="glass-card">
      <div class="card-top">
        <div class="brand">
          <img src="{{ url_for('static', filename='img/logo.png') }}"
               class="brand-logo" alt="Logo Coopex"
               decoding="async" fetchpriority="high" width="92" height="92">
          <div class="brand-title">Kratos System</div>
        </div>
        <div class="credentials-vault">
          <span class="vault-icon"><i class="bi bi-shield-lock-fill"></i></span>
          <span class="vault-text">
            Suas credenciais estão protegidas
            <span class="vault-mini">Acesso criptografado e seguro</span>
          </span>
        </div>
        <div class="small-note"><b>Acesso Seguro</b></div>
      </div>

      <div class="card-body">
        {% with msgs = get_flashed_messages() %}
          {% if msgs %}
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i> {{ msgs[0] }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
          {% endif %}
        {% endwith %}

        {% if erro_login %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-x-octagon me-1"></i> {{ erro_login }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('login') }}" class="needs-validation" novalidate autocomplete="on" id="loginForm">
          <div class="mb-3">
            <label class="form-label" for="usuario">Usuário</label>
            <input class="form-control form-control-lg" id="usuario" name="usuario" required
                   autocomplete="username" autocapitalize="none" spellcheck="false" inputmode="text" enterkeyhint="go"
                   placeholder="ex.: coopex" autofocus>
            <div class="invalid-feedback">Informe seu usuário.</div>
          </div>
          <div class="mb-2">
            <label class="form-label" for="senha">Senha</label>
            <div class="input-group input-group-lg">
              <input type="password" class="form-control" id="senha" name="senha" required
                     autocomplete="current-password" inputmode="text" enterkeyhint="go" placeholder="••••••••">
              <button class="btn btn-outline-secondary" type="button" id="togglePass" title="Mostrar/ocultar senha" aria-label="Mostrar ou ocultar senha">
                <i class="bi bi-eye" aria-hidden="true"></i>
              </button>
              <div class="invalid-feedback">Informe sua senha.</div>
            </div>
          </div>

          <div class="form-check mb-3 mt-3">
            <input class="form-check-input" type="checkbox" id="saveCreds">
            <label class="form-check-label" for="saveCreds">Salvar credenciais para próximos acessos</label>
          </div>

          <div class="role-info mt-2">
            <i class="bi bi-shield-lock"></i>
            Acesso permitido para <span style="color:#23bb75;font-weight:700;">Administrador</span>, <span style="color:#23bb75;font-weight:700;">Estabelecimento</span> e <span style="color:#23bb75;font-weight:700;">Cooperado</span>.
          </div>

          <button class="btn btn-royal w-100 btn-lg mt-4" id="btnEntrar">
            <i class="bi bi-box-arrow-in-right me-1"></i> Entrar
          </button>
        </form>

        <div class="marca-sistema">© 2025 Criado por — kratos System</div>
      </div>
    </div>
  </div>

  <!-- JS não bloqueante -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script>
    // Ative para auto-login imediato quando credenciais salvas estiverem presentes.
    // Mantive DESLIGADO por padrão para não surpreender.
    const AUTO_LOGIN = false;

    window.addEventListener('DOMContentLoaded', () => {
      // validação bootstrap
      document.querySelectorAll('.needs-validation').forEach(form=>{
        form.addEventListener('submit', ev=>{
          if(!form.checkValidity()){ ev.preventDefault(); ev.stopPropagation(); }
          form.classList.add('was-validated');
        });
      });

      const usuarioInput = document.getElementById('usuario');
      const senhaInput   = document.getElementById('senha');
      const saveCreds    = document.getElementById('saveCreds');
      const loginForm    = document.getElementById('loginForm');
      const btnEntrar    = document.getElementById('btnEntrar');

      // Mostrar/ocultar senha
      document.getElementById('togglePass')?.addEventListener('click', ()=>{
        const isPwd = senhaInput.type === 'password';
        senhaInput.type = isPwd ? 'text' : 'password';
        event.currentTarget.innerHTML = isPwd ? '<i class="bi bi-eye-slash" aria-hidden="true"></i>' : '<i class="bi bi-eye" aria-hidden="true"></i>';
        senhaInput.focus();
      });

      // Enter em qualquer campo envia
      [usuarioInput, senhaInput].forEach(el=>{
        el.addEventListener('keydown', e=>{
          if(e.key === 'Enter'){ e.preventDefault(); loginForm.requestSubmit(); }
        });
      });

      // Preencher credenciais salvas
      const savedUser = localStorage.getItem('coopex_user');
      const savedPwd  = localStorage.getItem('coopex_pwd');
      if(savedUser && savedPwd){
        usuarioInput.value = savedUser;
        senhaInput.value   = savedPwd;
        saveCreds.checked  = true;
        // foco direto no botão para "Enter" imediato
        btnEntrar.focus();
        // Auto-login opcional
        if (AUTO_LOGIN) loginForm.requestSubmit();
      }

      // Salvar ao enviar
      loginForm.addEventListener('submit', ()=>{
        if(saveCreds.checked){
          localStorage.setItem('coopex_user', usuarioInput.value);
          localStorage.setItem('coopex_pwd',  senhaInput.value);
        } else {
          localStorage.removeItem('coopex_user');
          localStorage.removeItem('coopex_pwd');
        }
      });
    });
  </script>
</body>
</html>
