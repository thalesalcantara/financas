<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Kratos System Finan√ßas Pessoais</title><link rel="icon" href="/static/logo.png"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script><script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script><style>:root{--azul:#163772;--azul-claro:#2a4172;--preto:#0b101e;--card-dark:#182336;--cinza:#232a39;--verde:#24c176;--vermelho:#e14c54;--amarelo:#ffd26e;--text-dark:#e6eefc;--sidebar:#131b2d;--sidebar-active:#222b44;}html,body{margin:0;padding:0;height:100%}body{font-family:'Segoe UI',Arial,sans-serif;background:var(--cinza);min-height:100vh;color:var(--text-dark);box-sizing:border-box}#authLayer,#mainApp{width:100vw}.auth-bg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--cinza)}.auth-card{background:var(--sidebar-active);padding:2.3rem 1.7rem 1.2rem;border-radius:1.4rem;min-width:300px;box-shadow:0 8px 32px #0002;display:flex;flex-direction:column;align-items:center}.auth-card img{width:64px;margin-bottom:1rem}.auth-card h2{margin-bottom:.4rem}.auth-card form label{display:block;margin-bottom:1rem}.auth-card input[type=password],.auth-card input[type=text]{padding:.6rem;border-radius:.7rem;border:1px solid #2b3552;background:#171f2e;color:var(--text-dark);width:98%;margin-bottom:.3rem}.auth-card button{background:var(--azul);color:#fff;border:none;border-radius:1rem;font-size:1.08rem;padding:.6rem 1.5rem;cursor:pointer;margin-top:.7rem}.auth-card .alt-link{color:var(--verde);cursor:pointer;text-decoration:underline;margin-top:.8rem}.auth-card small{display:block;color:#aaa;margin-top:1.5rem}.container{display:flex;min-height:100vh;width:100vw;overflow-x:hidden}aside.sidebar{background:var(--sidebar);color:#e6eefc;width:230px;min-width:160px;padding:2.2rem 1rem 1rem;display:flex;flex-direction:column;align-items:center;transition:left .2s;z-index:10;position:relative}.logo{width:56px;margin-bottom:1rem;border-radius:50%;background:#fff}.sidebar h1{font-size:1.18rem;margin:0 0 .2rem}.sidebar h2{font-size:1.01rem;margin-bottom:1.1rem;font-weight:400}.sidebar nav ul{list-style:none;padding:0;width:100%}.sidebar nav li{padding:.67rem 1rem;border-radius:1rem;margin-bottom:.37rem;text-align:center;cursor:pointer;transition:background .15s}.sidebar nav li.active,.sidebar nav li:hover{background:var(--sidebar-active);font-weight:bold;color:var(--amarelo)}.sidebar .logout-btn{background:var(--vermelho);color:#fff;border:none;border-radius:1rem;margin-top:2rem;padding:.5rem 1.2rem;cursor:pointer;font-weight:bold;width:100%}.main{flex:1;padding:2.2rem 1rem;min-width:0;width:100%}.panel{display:none}.panel.active{display:block;animation:fadeIn .4s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.resume-cards{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.7rem}.card{background:var(--card-dark);padding:.8rem 1.4rem;border-radius:1.2rem;box-shadow:0 2px 10px #0001;min-width:120px;flex:1 0 120px;display:flex;flex-direction:column;align-items:center}.card.receita{border-bottom:3px solid var(--verde)}.card.despesa{border-bottom:3px solid var(--vermelho)}.card.total{border-bottom:3px solid var(--azul)}.card span{color:#8c9fc5;margin-bottom:.3rem}.card strong{font-size:1.24rem}.transactions-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.7rem}.transactions-header button{background:var(--azul);color:#fff;border:none;padding:.36rem 1rem;border-radius:.9rem;font-size:.98rem;cursor:pointer}.filters{display:flex;gap:.6rem;margin-bottom:.7rem;flex-wrap:wrap}.filters input,.filters select{padding:.37rem;border-radius:.7rem;border:1px solid #2b3552;font-size:1rem;background:#131a2b;color:var(--text-dark)}#transactionsTable{width:100%;background:var(--card-dark);border-radius:1rem;box-shadow:0 2px 10px #0001;overflow:hidden}#transactionsTable th,#transactionsTable td{padding:.63rem .3rem;text-align:left;font-size:1rem}#transactionsTable th{background:var(--azul-claro);color:var(--amarelo)}#transactionsTable td button{background:none;border:none;color:var(--azul);cursor:pointer;font-size:1.07rem}#transactionsTable tr.income td{color:var(--verde)}#transactionsTable tr.expense td{color:var(--vermelho)}.modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:#000b;align-items:center;justify-content:center;z-index:50}.modal-bg.active{display:flex}.modal{background:var(--card-dark);color:var(--text-dark);border-radius:1rem;padding:1.5rem 1rem;min-width:290px;box-shadow:0 8px 32px #0003;display:flex;flex-direction:column;gap:1rem;max-width:95vw}.modal form label{display:flex;flex-direction:column;gap:.2rem;margin-bottom:.7rem;font-weight:500}.modal form input,.modal form select,.modal form textarea{padding:.4rem;border-radius:.5rem;border:1px solid #2b3552;font-size:1rem;background:#192132;color:var(--text-dark)}.modal form button{padding:.6rem 1.4rem;border-radius:.9rem;border:none;background:var(--azul);color:#fff;font-size:1rem;margin-right:.5rem;cursor:pointer;margin-top:.4rem}.modal form button[type=button]{background:#333;color:#eee}.fab{position:fixed;bottom:2.2rem;right:2rem;z-index:110;background:var(--azul);color:#fff;width:58px;height:58px;border-radius:50%;font-size:2.4rem;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 16px #246bfd30;cursor:pointer}.fab:hover{background:#193b70}@media (max-width:750px){.container{flex-direction:column}aside.sidebar{position:fixed;left:-100vw;top:0;bottom:0;height:100vh;width:77vw;max-width:320px;min-width:160px;border-radius:0 1.7rem 1.7rem 0;box-shadow:8px 0 20px #0003;transition:left .22s;z-index:99}.main{padding:1.2rem .3rem}.resume-cards{flex-direction:column}.fab{bottom:1.3rem;right:1.3rem}}@media (max-width:420px){aside.sidebar{padding:1.5rem .5rem}.card{padding:.7rem .6rem}.auth-card{min-width:95vw}}.settings-group{margin-bottom:1.4rem}.settings-group button,.settings-group label,.settings-group input{font-size:1.04rem}.custom-file{display:inline-block;position:relative}.custom-file input[type=file]{opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer}</style></head><body><div id="authLayer"></div><div class="container" id="mainApp" style="display:none"></div><div class="fab" id="fabBtn" style="display:none;" title="Adicionar lan√ßamento" onclick="openModal()">+</div><div id="modal" class="modal-bg" onclick="closeModal(event)"></div><div id="alertaBox" style="display:none;position:fixed;top:10px;right:10px;z-index:9999;background:#e14c54;color:#fff;padding:1rem 2rem;border-radius:.7rem;font-weight:bold;box-shadow:0 2px 12px #0005;"></div><script>
const firebaseConfig={apiKey:"AIzaSyD32JNIb-IplbuAM8WD-Nw_P3gA5wNSNwY",authDomain:"kratosfinancas.firebaseapp.com",projectId:"kratosfinancas",storageBucket:"kratosfinancas.firebasestorage.app",messagingSenderId:"740158664268",appId:"1:740158664268:web:9e4583e75c94cbd90c0ee9"};firebase.initializeApp(firebaseConfig);const db=firebase.firestore(),auth=firebase.auth();let appData=null,userEmail=null;const MENUS=[{id:"dashboard",label:"Dashboard",icon:"üìä"},{id:"transactions",label:"Lan√ßamentos",icon:"üí∏"},{id:"metas",label:"Metas",icon:"üéØ"},{id:"contas",label:"Contas",icon:"üè¶"},{id:"categorias",label:"Categorias",icon:"üè∑Ô∏è"},{id:"relatorios",label:"Relat√≥rios",icon:"üìà"},{id:"configuracoes",label:"Configura√ß√µes",icon:"‚öôÔ∏è"}];function renderLogin(){document.getElementById("authLayer").innerHTML=`<div class="auth-bg"><div class="auth-card"><img src="/static/logo.png" alt="Logo Kratos"><h2>Kratos System</h2><form id="loginForm"><label>Email:<br><input type="text" id="loginEmail" required autocomplete="username"></label><label>Senha:<br><input type="password" id="loginSenha" required autocomplete="current-password"></label><button type="submit">Entrar</button></form><div class="alt-link" onclick="renderRegister()">Cadastrar nova conta</div><small>Seus dados ficam protegidos na nuvem com Firebase</small></div></div>`;document.getElementById("authLayer").style.display="block";document.getElementById("mainApp").style.display="none";document.getElementById("loginForm").onsubmit=function(e){e.preventDefault();const email=document.getElementById("loginEmail").value.trim(),senha=document.getElementById("loginSenha").value;auth.signInWithEmailAndPassword(email,senha).then(()=>{startApp()}).catch(e=>alert("Erro: "+(e.message||e)))}}
function renderRegister(){document.getElementById("authLayer").innerHTML=`<div class="auth-bg"><div class="auth-card"><img src="/static/logo.png" alt="Logo Kratos"><h2>Nova Conta</h2><form id="registerForm"><label>Email:<br><input type="text" id="regEmail" required autocomplete="username"></label><label>Senha:<br><input type="password" id="regSenha" required autocomplete="new-password"></label><button type="submit">Cadastrar</button></form><div class="alt-link" onclick="renderLogin()">J√° tem conta? Entrar</div></div></div>`;document.getElementById("registerForm").onsubmit=function(e){e.preventDefault();const email=document.getElementById("regEmail").value.trim(),senha=document.getElementById("regSenha").value;auth.createUserWithEmailAndPassword(email,senha).then(()=>{startApp()}).catch(e=>alert("Erro: "+(e.message||e)))}}
function logoutUser(){auth.signOut().then(()=>{renderLogin()})}
function getModeloZerado(){return{user:userEmail,contas:[{nome:"Carteira",saldo:0,cor:"#246bfd"}],categorias:[{nome:"Sal√°rio",tipo:"income",cor:"#21bf73"},{nome:"Alimenta√ß√£o",tipo:"expense",cor:"#e94f37"}],transacoes:[],metas:[],config:{theme:"dark",alertas:[],limites:{},excelSep:";"},anexos:{}}}
function saveData(){db.collection("usuarios").doc(userEmail).set(appData)}
auth.onAuthStateChanged(user=>{user?(userEmail=user.email,startApp()):renderLogin()});function startApp(){userEmail=auth.currentUser.email,db.collection("usuarios").doc(userEmail).get().then(doc=>{appData=doc.exists?doc.data():getModeloZerado(),renderApp()})}
function renderApp(){document.getElementById("mainApp").innerHTML=`<aside class="sidebar" id="sidebar"><img src="/static/logo.png" alt="Logo Kratos" class="logo" onerror="this.style.display='none'"><h1>Kratos System</h1><h2>Finan√ßas Pessoais</h2><nav><ul id="menuList"></ul></nav><button class="logout-btn" onclick="logoutUser()">Sair</button></aside><main class="main" id="mainPainel"><section id="dashboard" class="panel active"></section><section id="transactions" class="panel"></section><section id="metas" class="panel"></section><section id="contas" class="panel"></section><section id="categorias" class="panel"></section><section id="relatorios" class="panel"></section><section id="configuracoes" class="panel"></section></main>`;document.getElementById("mainApp").style.display="flex",renderMenu(),showPanel("dashboard"),renderAllPainels(),document.getElementById("fabBtn").style.display="flex"}
function renderMenu(){let ul=document.getElementById("menuList");ul.innerHTML="",MENUS.forEach(m=>{ul.innerHTML+=`<li id="menu-${m.id}" onclick="showPanel('${m.id}')">${m.icon} ${m.label}</li>`})}
function showPanel(p){document.querySelectorAll(".panel").forEach(sec=>sec.classList.remove("active"));let el=document.getElementById(p);el&&el.classList.add("active"),document.querySelectorAll(".sidebar nav li").forEach(li=>li.classList.remove("active"));let menu=document.getElementById("menu-"+p);menu&&menu.classList.add("active"),window.innerWidth<750&&toggleMenu(!0),window["render_"+p]&&window["render_"+p]()}
function toggleMenu(e){const t=document.getElementById("sidebar");t&&(e?t.classList.remove("open"):t.classList.toggle("open"))}
window.addEventListener("resize",()=>{if(window.innerWidth>=750){let e=document.getElementById("sidebar");e&&e.classList.remove("open")}}),document.addEventListener("keydown",function(e){"Escape"===e.key&&closeModal()});
// ...demais JS dos pain√©is vai aqui (dashboard, transactions, metas, contas, categorias, relat√≥rios, configura√ß√µes, utilit√°rios, modais). N√£o cabe TUDO aqui minificado, mas voc√™ pode pedir bloco por bloco (minificado) ou gerar com ferramentas como https://www.toptal.com/developers/javascript-minifier 
</script></body></html>window.render_dashboard=function(){let e=document.getElementById("dashboard");if(!e)return;let t=(appData.contas||[]).reduce((e,t)=>e+Number(t.saldo||0),0),a=(appData.transacoes||[]).filter(e=>"income"===e.type).reduce((e,t)=>e+Number(t.value||0),0),n=(appData.transacoes||[]).filter(e=>"expense"===e.type).reduce((e,t)=>e+Number(t.value||0),0),r=[];t<0&&r.push("<b>Saldo negativo!</b> Voc√™ est√° no vermelho."),Object.entries(appData.config.limites||{}).forEach(([e,t])=>{let a=(appData.transacoes||[]).filter(a=>a.category===e&&"expense"===a.type).reduce((e,t)=>e+Number(t.value),0);t>0&&a>t&&r.push(`Aten√ß√£o: categoria <b>${e}</b> j√° passou do limite (${a.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})} / ${Number(t).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})`)}),e.innerHTML=`<h2>Resumo Financeiro</h2><div class="resume-cards"><div class="card total"><span>Saldo Atual</span><strong id="totalBalance">${t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</strong></div><div class="card receita"><span>Receitas</span><strong id="totalIncome">${a.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</strong></div><div class="card despesa"><span>Despesas</span><strong id="totalExpense">${n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</strong></div></div>${r.length?`<div style="margin-bottom:1rem;padding:1rem;background:#e94f37;color:#fff;border-radius:1rem;"><ul style="margin:0;padding-left:1.3rem">${r.map(e=>`<li>${e}</li>`).join("")}</ul></div>`:""}<canvas id="chart" width="350" height="160" style="max-width:99vw;"></canvas><div style="margin-top:1.6rem;"><b>Dicas r√°pidas:</b><ul style="color:#246bfd;line-height:1.7"><li>Clique no bot√£o ‚Äú+‚Äù para registrar rapidamente uma receita, despesa ou transfer√™ncia.</li><li>Acompanhe suas <b>metas</b> na aba Metas üéØ e veja seu progresso mensal.</li><li>Adicione <b>contas</b> para controlar saldo em bancos, cart√µes, ou dinheiro f√≠sico.</li><li>Personalize categorias e defina <b>limites</b> para receber alertas.</li><li>Baixe backups regulares em <b>Configura√ß√µes</b> para nunca perder seus dados.</li></ul></div>`;let o={};(appData.transacoes||[]).filter(e=>"expense"===e.type).forEach(e=>{o[e.category]=(o[e.category]||0)+Number(e.value)});let l=document.getElementById("chart");window.dashChart&&window.dashChart.destroy(),window.dashChart=new Chart(l,{type:"doughnut",data:{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:Object.keys(o).map((e,t)=>["#246bfd","#21bf73","#e94f37","#fdc40d","#9b59b6","#16a085","#aaa"][t%7])}]},options:{plugins:{legend:{display:!0}}}})};
window.render_transactions=function(){let e=document.getElementById("transactions");if(!e)return;let t='<option value="">Todos</option><option value="income">Receitas</option><option value="expense">Despesas</option><option value="transfer">Transfer√™ncias</option>',a='<option value="">Todas</option>'+(appData.contas||[]).map(e=>`<option value="${e.nome}">${e.nome}</option>`).join(""),n='<option value="">Todas</option>'+(appData.categorias||[]).map(e=>`<option value="${e.nome}">${e.nome}</option>`).join(""),r=window.filtroTipoTx||"",o=window.filtroContaTx||"",l=window.filtroCatTx||"",d=window.filtroMesTx||"",c=window.filtroBuscaTx||"";e.innerHTML=`<div class="transactions-header"><h2>Lan√ßamentos</h2><button onclick="openModal()">+ Novo</button></div><div class="filters"><select id="filtroTipoTx">${t}</select><select id="filtroContaTx">${a}</select><select id="filtroCatTx">${n}</select><input type="month" id="filtroMesTx" style="max-width:150px"><input type="text" id="filtroBuscaTx" placeholder="Buscar..." style="max-width:150px"></div><table id="transactionsTable"><thead><tr><th>Tipo</th><th>Conta</th><th>Categoria</th><th>Descri√ß√£o</th><th>Data</th><th>Valor</th><th></th></tr></thead><tbody id="transactionsTBody"></tbody></table>`,document.getElementById("filtroTipoTx").value=r,document.getElementById("filtroContaTx").value=o,document.getElementById("filtroCatTx").value=l,document.getElementById("filtroMesTx").value=d,document.getElementById("filtroBuscaTx").value=c,document.getElementById("filtroTipoTx").onchange=e=>{window.filtroTipoTx=e.target.value,render_transactions()},document.getElementById("filtroContaTx").onchange=e=>{window.filtroContaTx=e.target.value,render_transactions()},document.getElementById("filtroCatTx").onchange=e=>{window.filtroCatTx=e.target.value,render_transactions()},document.getElementById("filtroMesTx").onchange=e=>{window.filtroMesTx=e.target.value,render_transactions()},document.getElementById("filtroBuscaTx").oninput=e=>{window.filtroBuscaTx=e.target.value,render_transactions()};let s=appData.transacoes||[];window.filtroTipoTx&&(s=s.filter(e=>e.type===window.filtroTipoTx)),window.filtroContaTx&&(s=s.filter(e=>e.account===window.filtroContaTx||e.accountTo===window.filtroContaTx)),window.filtroCatTx&&(s=s.filter(e=>e.category===window.filtroCatTx)),window.filtroMesTx&&(s=s.filter(e=>e.date&&e.date.startsWith(window.filtroMesTx))),window.filtroBuscaTx&&(s=s.filter(e=>(e.category||"").toLowerCase().includes(window.filtroBuscaTx.toLowerCase())||(e.description||"").toLowerCase().includes(window.filtroBuscaTx.toLowerCase())||(e.account||"").toLowerCase().includes(window.filtroBuscaTx.toLowerCase()))),s=s.slice().sort((e,t)=>t.date.localeCompare(e.date));let i=document.getElementById("transactionsTBody");i.innerHTML="",s.length?s.forEach((t,a)=>{let n="income"===t.type?"üü¢":"expense"===t.type?"üî¥":"üîÑ",r="income"===t.type?"var(--verde)":"expense"===t.type?"var(--vermelho)":"#aaa",o=Number(t.value).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}),l=t.anexoId?`<button title="Ver anexo" onclick="verAnexo('${t.anexoId}')">üìé</button>`:"",d=t.notes?`<button title="Ver nota" onclick="verNota('${t.notes.replace(/'/g,"\\'")}')">üìù</button>`:"";i.innerHTML+=`<tr><td>${n}</td><td>${t.account||""}${t.accountTo?" ‚Üí "+t.accountTo:""}</td><td>${t.category||""}</td><td>${t.description||""}</td><td>${t.date||""}</td><td style="color:${r}">${o}</td><td>${l} ${d}<button title="Editar" onclick="openModal(${appData.transacoes.indexOf(t)})">‚úèÔ∏è</button><button title="Excluir" onclick="deleteTransaction(${appData.transacoes.indexOf(t)})">üóëÔ∏è</button></td></tr>`}):i.innerHTML='<tr><td colspan="7" style="text-align:center;color:#888">Nenhum lan√ßamento.</td></tr>'};
function verAnexo(e){let t=appData.anexos&&appData.anexos[e];if(!t)return alert("Arquivo n√£o encontrado.");let a=window.open();a.document.write(`<html><body style="margin:0;text-align:center;background:#000"><img src="${t}" style="max-width:99vw;max-height:99vh"></body></html>`)}
function verNota(e){alert(e)}
function openModal(e){let t="number"==typeof e,a=t?appData.transacoes[e]:{},n=a&&"transfer"===a.type;document.getElementById("modal").innerHTML=`<div class="modal" onclick="event.stopPropagation()"><form id="transactionForm" onsubmit="saveTransaction(event)"><h3 id="modalTitle">${t?"Editar Lan√ßamento":"Nova Receita/Despesa"}</h3><label>Tipo:<select id="type" required><option value="income"${"income"===a.type?" selected":""}>Receita</option><option value="expense"${"expense"===a.type?" selected":""}>Despesa</option><option value="transfer"${"transfer"===a.type?" selected":""}>Transfer√™ncia</option></select></label><label>Conta:<select id="account" required>${(appData.contas||[]).map(e=>`<option ${a.account===e.nome?"selected":""}>${e.nome}</option>`).join("")}</select></label><label id="accountToGroup" style="display:${"transfer"===a.type?"block":"none"};">Para Conta (Transfer√™ncia):<select id="accountTo">${(appData.contas||[]).map(e=>`<option ${a.accountTo===e.nome?"selected":""}>${e.nome}</option>`).join("")}</select></label><label>Categoria:<select id="category" required>${(appData.categorias||[]).map(e=>`<option ${a.category===e.nome?"selected":""}>${e.nome}</option>`).join("")}<option value="_new">+ Nova Categoria</option></select><input type="text" id="newCategory" placeholder="Nova categoria" style="display:none; margin-top:.5rem;"></label><label>Descri√ß√£o:<input type="text" id="description" required maxlength="40" value="${a.description||""}"></label><label>Data:<input type="date" id="date" required value="${a.date||new Date().toISOString().slice(0,10)}"></label><label>Valor:<input type="number" id="value" step="0.01" required value="${a.value||""}"></label><label>Parcelas:<input type="number" id="parcelas" min="1" max="36" value="${a.parcelas||1}"><select id="periodicidade"><option value="unico"${"unico"===a.periodicidade?" selected":""}>√önico</option><option value="mensal"${"mensal"===a.periodicidade?" selected":""}>Mensal</option><option value="anual"${"anual"===a.periodicidade?" selected":""}>Anual</option></select></label><label>Anexar arquivo/comprovante:<input type="file" id="anexoInput" accept="image/*,application/pdf"></label><label>Notas:<textarea id="notes" maxlength="120" placeholder="Informa√ß√µes extras">${a.notes||""}</textarea></label><button type="submit">Salvar</button><button type="button" onclick="closeModal()">Cancelar</button></form></div>`,document.getElementById("modal").classList.add("active"),document.getElementById("modal").style.display="flex",document.getElementById("type").onchange=function(){let e=this.value;document.getElementById("accountToGroup").style.display="transfer"===e?"block":"none",document.getElementById("category").value="",document.getElementById("value").value=""},document.getElementById("category").onchange=function(){"_new"===this.value?(document.getElementById("newCategory").style.display="block",document.getElementById("newCategory").focus()):document.getElementById("newCategory").style.display="none"},window.editTxIdx=t?e:null}
function closeModal(e){e&&e.target&&e.target.classList&&!e.target.classList.contains("modal-bg")||(document.getElementById("modal").classList.remove("active"),document.getElementById("modal").style.display="none",renderAllPainels())}
function saveTransaction(e){e.preventDefault();let t=document.getElementById("type").value,a=document.getElementById("account").value,n=document.getElementById("category").value,r=document.getElementById("description").value.trim(),o=document.getElementById("date").value,l=Number(document.getElementById("value").value),d=Number(document.getElementById("parcelas").value)||1,c=document.getElementById("periodicidade").value,s=document.getElementById("notes").value.trim(),i="transfer"===t?document.getElementById("accountTo").value:null;if("_new"===n){let e=document.getElementById("newCategory").value.trim();if(e.length<2)return alert("Digite um nome v√°lido para a nova categoria.");appData.categorias=appData.categorias||[],appData.categorias.push({nome:e,tipo:"income"===t?"income":"expense",cor:"#21bf73"}),n=e}let u=document.getElementById("anexoInput").files[0],m=null;if(u){let f=new FileReader;return f.onload=function(e){m="anexo_"+Date.now(),appData.anexos=appData.anexos||{},appData.anexos[m]=e.target.result,saveLctoFinal(m)},f.readAsDataURL(u),void 0}saveLctoFinal(m);function saveLctoFinal(u){let f=[];for(let v=0;v<d;v++){let g=new Date(o);"mensal"===c&&g.setMonth(g.getMonth()+v),"anual"===c&&g.setFullYear(g.getFullYear()+v);let h=g.toISOString().slice(0,10);f.push({type:t,account:a,accountTo:i,category:n,description:r+(d>1?` (${v+1}/${d})`:""),date:h,value:l,notes:s,anexoId:u})}null!=window.editTxIdx?(appData.transacoes[window.editTxIdx]=f[0],window.editTxIdx=null):appData.transacoes=(appData.transacoes||[]).concat(f),atualizaSaldos(),saveData(),closeModal(),render_transactions(),render_dashboard(),render_contas(),render_metas(),render_relatorios()}}
function deleteTransaction(e){confirm("Excluir lan√ßamento?")&&(appData.transacoes.splice(e,1),atualizaSaldos(),saveData(),render_transactions(),render_dashboard(),render_contas(),render_metas(),render_relatorios())}
function atualizaSaldos(){(appData.contas||[]).forEach(e=>e.saldo=0),(appData.transacoes||[]).forEach(e=>{let t=appData.contas.find(t=>t.nome===e.account);t&&("income"===e.type?t.saldo+=Number(e.value):"expense"===e.type&&(t.saldo-=Number(e.value))),"transfer"===e.type&&(t&&"income"!==e.type&&"expense"!==e.type&&(t.saldo-=Number(e.value)),appData.contas.find(a=>a.nome===e.accountTo)&&(appData.contas.find(a=>a.nome===e.accountTo).saldo+=Number(e.value)))})}
function renderAllPainels(){document.getElementById("dashboard").classList.contains("active")&&window.render_dashboard(),document.getElementById("transactions").classList.contains("active")&&window.render_transactions(),document.getElementById("metas").classList.contains("active")&&window.render_metas(),document.getElementById("contas").classList.contains("active")&&window.render_contas(),document.getElementById("categorias").classList.contains("active")&&window.render_categorias(),document.getElementById("relatorios").classList.contains("active")&&window.render_relatorios(),document.getElementById("configuracoes").classList.contains("active")&&window.render_configuracoes()}window.render_metas=function(){let e=document.getElementById("metas");if(!e)return;let t=new Date().toISOString().slice(0,10),a='<h2>Metas de Economia</h2><form id="formMeta" onsubmit="salvarMeta(event)" style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1.3rem;align-items:flex-end;"><label>Nome da Meta<br><input type="text" id="metaNome" required maxlength="32" placeholder="Ex: Reserva de Emerg√™ncia"></label><label>Valor Alvo<br><input type="number" id="metaValor" min="1" step="0.01" required placeholder="R$"></label><label>Data Limite<br><input type="date" id="metaData" required min="'+t+'"></label><label>Conta<br><select id="metaConta" required>'+(appData.contas||[]).map(e=>"<option>"+e.nome+"</option>").join("")+'</select></label><button type="submit">Salvar Meta</button></form>',n=appData.metas||[],r=n.length?"":'<div style="color:#888;margin-top:1.4rem;">Nenhuma meta cadastrada.<br>Use o formul√°rio acima para criar sua primeira meta!</div>';n.forEach((t,a)=>{let n=(appData.transacoes||[]).filter(e=>e.account===t.conta&&"income"===e.type).reduce((e,t)=>e+Number(t.value),0),o=Math.min(100,Math.round(100*n/Number(t.valorAlvo||1))),i=t.dataLimite&&new Date(t.dataLimite)<new Date;r+='<div style="background:#232a39;'+(i?"opacity:.7;":"")+'border-radius:1.2rem;padding:1rem 1.3rem;margin-bottom:1.1rem;box-shadow:0 2px 10px #0001;max-width:99vw;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><b style="font-size:1.1rem;">üéØ '+t.nome+'</b><br><span style="color:#246bfd">'+t.conta+'</span></div><div><button onclick="editarMeta('+a+')" title="Editar">‚úèÔ∏è</button><button onclick="excluirMeta('+a+')" title="Excluir">üóëÔ∏è</button></div></div><div style="margin:.9rem 0 .5rem 0;"><div style="height:13px;border-radius:8px;background:#2a4172;width:100%;overflow:hidden;"><div style="background:#24c176;height:13px;width:'+o+'%;transition:.6s;"></div></div><span style="font-size:.98rem;">'+n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})+" / "+Number(t.valorAlvo).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})+" ("+o+"%)"+(i?'<span style="color:#e14c54;margin-left:8px;">Vencida</span>':"")+'</span></div><div style="font-size:.95rem;color:#888">At√©: '+(t.dataLimite||"-")+"</div></div>"}),e.innerHTML=a+r},window.salvarMeta=function(e){e.preventDefault();let t=document.getElementById("metaNome").value.trim(),a=Number(document.getElementById("metaValor").value),n=document.getElementById("metaData").value,r=document.getElementById("metaConta").value,o=appData.metas||[];null!=window.metaEditIdx?(o[window.metaEditIdx]={nome:t,valorAlvo:a,dataLimite:n,conta:r},window.metaEditIdx=null):o.push({nome:t,valorAlvo:a,dataLimite:n,conta:r}),appData.metas=o,saveData(),render_metas(),document.getElementById("formMeta").reset()},window.editarMeta=function(e){let t=appData.metas[e];document.getElementById("metaNome").value=t.nome,document.getElementById("metaValor").value=t.valorAlvo,document.getElementById("metaData").value=t.dataLimite,document.getElementById("metaConta").value=t.conta,window.metaEditIdx=e},window.excluirMeta=function(e){confirm("Excluir esta meta?")&&(appData.metas.splice(e,1),saveData(),render_metas())};
window.render_contas=function(){let e=document.getElementById("contas");if(!e)return;let t='<h2>Contas</h2><form id="formConta" onsubmit="salvarConta(event)" style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1.3rem;align-items:flex-end;"><label>Nome da Conta<br><input type="text" id="contaNome" required maxlength="24" placeholder="Ex: Banco do Brasil"></label><label>Cor<br><input type="color" id="contaCor" value="#246bfd"></label><label>Saldo Inicial<br><input type="number" id="contaSaldo" step="0.01" required value="0"></label><button type="submit">Salvar Conta</button></form><button onclick="abrirTransferencia()" style="margin-bottom:1.6rem;background:#246bfd;color:#fff;border:none;padding:.5rem 1.2rem;border-radius:.9rem;">Transferir entre contas</button>',a=appData.contas||[],n=a.length?"":'<div style="color:#888;margin-top:1.4rem;">Nenhuma conta cadastrada.<br>Use o formul√°rio acima para criar sua primeira conta!</div>',r=a.reduce((e,t)=>e+Number(t.saldo||0),0);a.forEach((e,t)=>{n+='<div style="background:#232a39;border-radius:1.2rem;padding:1.2rem 1.3rem;margin-bottom:1.1rem;box-shadow:0 2px 10px #0001;max-width:99vw;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><span style="display:inline-block;width:14px;height:14px;background:'+e.cor+';border-radius:3px;margin-right:8px;"></span><b style="font-size:1.05rem;">'+e.nome+'</b></div><div><button onclick="editarConta('+t+')" title="Editar">‚úèÔ∏è</button><button onclick="excluirConta('+t+')" title="Excluir">üóëÔ∏è</button></div></div><div style="margin-top:.7rem;font-size:1.07rem;"><b>Saldo:</b> '+Number(e.saldo).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})+"</div></div>"}),e.innerHTML=t+`<div style="font-size:1.07rem;margin-bottom:.5rem;"><b>Saldo geral:</b> ${r.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</div>`+n},window.salvarConta=function(e){e.preventDefault();let t=document.getElementById("contaNome").value.trim(),a=document.getElementById("contaCor").value,n=Number(document.getElementById("contaSaldo").value);if(!t)return;let r=appData.contas||[];null!=window.contaEditIdx?(r[window.contaEditIdx]={nome:t,cor:a,saldo:n},window.contaEditIdx=null):r.push({nome:t,cor:a,saldo:n}),appData.contas=r,saveData(),render_contas(),document.getElementById("formConta").reset()},window.editarConta=function(e){let t=appData.contas[e];document.getElementById("contaNome").value=t.nome,document.getElementById("contaCor").value=t.cor,document.getElementById("contaSaldo").value=t.saldo,window.contaEditIdx=e},window.excluirConta=function(e){if(confirm("Excluir esta conta? Isso pode apagar lan√ßamentos ligados a ela!")){let t=appData.contas[e]?.nome;appData.contas.splice(e,1),appData.transacoes=(appData.transacoes||[]).filter(e=>e.account!==t&&e.accountTo!==t),saveData(),render_contas()}},window.abrirTransferencia=function(){let e=appData.contas||[];if(e.length<2)return void alert("Cadastre pelo menos duas contas!");let t='<form onsubmit="fazerTransferencia(event)"><h3>Transfer√™ncia entre contas</h3><label>De:<select id="transfDe" required>'+e.map(e=>"<option>"+e.nome+"</option>").join("")+'</select></label><label>Para:<select id="transfPara" required>'+e.map(e=>"<option>"+e.nome+"</option>").join("")+'</select></label><label>Valor:<input type="number" id="transfValor" min="0.01" step="0.01" required></label><button type="submit">Transferir</button><button type="button" onclick="closeModal()">Cancelar</button></form>',a=document.getElementById("modal");a.innerHTML='<div class="modal" onclick="event.stopPropagation()">'+t+"</div>",a.classList.add("active"),a.style.display="flex"},window.fazerTransferencia=function(e){e.preventDefault();let t=document.getElementById("transfDe").value,a=document.getElementById("transfPara").value,n=Number(document.getElementById("transfValor").value);if(t===a)return alert("Contas devem ser diferentes.");let r=appData.contas.find(e=>e.nome===t),o=appData.contas.find(e=>e.nome===a);if(!r||!o)return alert("Conta n√£o encontrada.");if(n<=0||r.saldo<n)return alert("Saldo insuficiente.");r.saldo-=n,o.saldo+=n,appData.transacoes=appData.transacoes||[],appData.transacoes.push({type:"transfer",account:t,accountTo:a,category:"Transfer√™ncia",description:"Transfer√™ncia entre contas",date:new Date().toISOString().slice(0,10),value:n}),saveData(),closeModal(),render_contas(),render_dashboard()};
window.render_categorias=function(){let e=document.getElementById("categorias");if(!e)return;let t='<h2>Categorias</h2><form id="formCat" onsubmit="salvarCategoria(event)" style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:1.3rem;align-items:flex-end;"><label>Nome da Categoria<br><input type="text" id="catNome" required maxlength="24" placeholder="Ex: Lazer"></label><label>Tipo<br><select id="catTipo" required><option value="income">Receita</option><option value="expense">Despesa</option></select></label><label>Cor<br><input type="color" id="catCor" value="#21bf73"></label><label>Limite Mensal<br><input type="number" id="catLimite" min="0" step="0.01" placeholder="Opcional"></label><button type="submit">Salvar Categoria</button></form>',a=appData.categorias||[],n=a.length?"":'<div style="color:#888;margin-top:1.4rem;">Nenhuma categoria cadastrada.<br>Use o formul√°rio acima para criar sua primeira categoria!</div>';a.forEach((e,t)=>{let a="income"===e.tipo?"Receita":"Despesa",r=(appData.transacoes||[]).filter(t=>t.category===e.nome&&t.type===e.tipo).reduce((e,t)=>e+Number(t.value),0),o=e.limite>0?"Limite: "+Number(e.limite).toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"",i=e.limite>0&&r>e.limite?'<span style="color:#e14c54">‚ö†Ô∏è Excedido</span>':"";n+='<div style="background:#232a39;border-radius:1.2rem;padding:1.1rem 1.3rem;margin-bottom:1.1rem;box-shadow:0 2px 10px #0001;max-width:99vw;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><span style="display:inline-block;width:14px;height:14px;background:'+e.cor+';border-radius:3px;margin-right:8px;"></span><b style="font-size:1.05rem;">'+e.nome+'</b> <span style="color:#888">('+a+')</span></div><div><button onclick="editarCategoria('+t+')" title="Editar">‚úèÔ∏è</button><button onclick="excluirCategoria('+t+')" title="Excluir">üóëÔ∏è</button></div></div><div style="margin-top:.7rem;">'+o+i+"</div></div>"}),e.innerHTML=t+n},window.salvarCategoria=function(e){e.preventDefault();let t=document.getElementById("catNome").value.trim(),a=document.getElementById("catTipo").value,n=document.getElementById("catCor").value,r=Number(document.getElementById("catLimite").value)||0;if(!t)return;let o=appData.categorias||[];null!=window.catEditIdx?(o[window.catEditIdx]={nome:t,tipo:a,cor:n,limite:r},window.catEditIdx=null):o.push({nome:t,tipo:a,cor:n,limite:r}),appData.categorias=o,appData.config=appData.config||{},appData.config.limites=appData.config.limites||{},r>0?appData.config.limites[t]=r:delete appData.config.limites[t],saveData(),render_categorias(),document.getElementById("formCat").reset()},window.editarCategoria=function(e){let t=appData.categorias[e];document.getElementById("catNome").value=t.nome,document.getElementById("catTipo").value=t.tipo,document.getElementById("catCor").value=t.cor,document.getElementById("catLimite").value=t.limite||"",window.catEditIdx=e},window.excluirCategoria=function(e){if(confirm("Excluir esta categoria? (N√£o remove lan√ßamentos anteriores)")){let t=appData.categorias[e]?.nome;appData.categorias.splice(e,1),appData.config&&appData.config.limites&&t&&delete appData.config.limites[t],saveData(),render_categorias()}};
window.render_relatorios=function(){let e=document.getElementById("relatorios");if(!e)return;let t=new Date,a=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=a+"-"+n,o=(appData.transacoes||[]).filter(e=>e.date&&e.date.startsWith(r)),i=(appData.contas||[]).reduce((e,t)=>e+Number(t.saldo||0),0),l=o.filter(e=>"income"===e.type).reduce((e,t)=>e+Number(t.value||0),0),d=o.filter(e=>"expense"===e.type).reduce((e,t)=>e+Number(t.value||0),0),c={},s={};(appData.categorias||[]).forEach(e=>{c[e.nome]=0}),(appData.contas||[]).forEach(e=>{s[e.nome]=0}),o.forEach(e=>{null!=c[e.category]&&"expense"===e.type&&(c[e.category]+=Number(e.value)||0),null!=s[e.account]&&"transfer"!==e.type&&(s[e.account]+="income"===e.type?Number(e.value):-Number(e.value)||0)}),e.innerHTML=`<h2>Relat√≥rios</h2><div style="margin-bottom:1.1rem;"><b>Resumo do m√™s atual (${n}/${a}):</b><br>Receitas: <b style="color:var(--verde)">${l.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</b> | Despesas: <b style="color:var(--vermelho)">${d.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</b><br>Saldo final: <b>${i.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</b></div><div style="display:flex;gap:1.2rem;flex-wrap:wrap;"><div><canvas id="relat_cat" width="260" height="160"></canvas><br><small>Despesas por categoria</small></div><div><canvas id="relat_conta" width="260" height="160"></canvas><br><small>Evolu√ß√£o por conta</small></div></div><div style="margin-top:1.2rem;"><b>Resumo dos √∫ltimos 6 meses:</b><canvas id="relat_6meses" width="99%" height="170"></canvas></div>`;let u=Object.keys(c),m=u.map(e=>c[e]);window.relatCatChart&&window.relatCatChart.destroy(),window.relatCatChart=new Chart(document.getElementById("relat_cat"),{type:"doughnut",data:{labels:u,datasets:[{data:m,backgroundColor:u.map((e,t)=>["#246bfd","#21bf73","#e94f37","#fdc40d","#9b59b6","#16a085","#aaa"][t%7])}]},options:{plugins:{legend:{display:!0}}}});let f=Object.keys(s),v=f.map(e=>s[e]);window.relatContaChart&&window.relatContaChart.destroy(),window.relatContaChart=new Chart(document.getElementById("relat_conta"),{type:"bar",data:{labels:f,datasets:[{data:v,label:"Saldo",backgroundColor:"#246bfd"}]},options:{plugins:{legend:{display:!1}}}});let g=[],h=[],p=[],w=new Date;for(let e=5;e>=0;e--){let t=new Date(w.getFullYear(),w.getMonth()-e,1),a=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0");g.push((String(t.getMonth()+1).padStart(2,"0"))+"/"+t.getFullYear());let n=(appData.transacoes||[]).filter(e=>e.date&&e.date.startsWith(a));h.push(n.filter(e=>"income"===e.type).reduce((e,t)=>e+Number(t.value),0)),p.push(n.filter(e=>"expense"===e.type).reduce((e,t)=>e+Number(t.value),0))}window.relat6Chart&&window.relat6Chart.destroy(),window.relat6Chart=new Chart(document.getElementById("relat_6meses"),{type:"line",data:{labels:g,datasets:[{label:"Receitas",data:h,backgroundColor:"var(--verde)",borderColor:"var(--verde)",fill:!1,tension:.4},{label:"Despesas",data:p,backgroundColor:"var(--vermelho)",borderColor:"var(--vermelho)",fill:!1,tension:.4}]},options:{plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0}}}})};
window.render_configuracoes=function(){let e=document.getElementById("configuracoes");if(!e)return;let t=(appData.config&&appData.config.theme)||"dark";e.innerHTML='<h2>Configura√ß√µes</h2><div class="settings-group"><label><input type="checkbox" id="themeToggle" '+("dark"===t?"checked":"")+'>Modo Noturno</label></div><div class="settings-group"><button onclick="backupData()">Exportar Dados (Backup JSON)</button><label class="custom-file">Importar Dados (JSON)<input type="file" accept="application/json" onchange="importData(event)"></label><button onclick="exportarExcel()">Exportar para Excel</button></div><div class="settings-group"><button style="background:#d00;color:#fff" onclick="resetData()">Limpar TODOS os dados</button></div><div class="settings-group"><button onclick="alterarSenha()">Alterar Senha</button><button onclick="logoutUser()">Sair</button></div><div class="settings-group"><label>Precisa de ajuda?<br><button type="button" onclick="enviarAjuda()">Fale com o suporte</button></label></div><small style="color:#888">v1.0 - Kratos System Finan√ßas Pessoais</small>',document.getElementById("themeToggle").onchange=function(){let e=this.checked;appData.config=appData.config||{},appData.config.theme=e?"dark":"light",saveData(),applyTheme()},applyTheme()};
function applyTheme(){let e=(appData.config&&appData.config.theme)||"dark";document.body.classList.toggle("dark","dark"===e)}
function backupData(){let e=new Blob([JSON.stringify(appData)],{type:"application/json"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="kratos_financas_backup.json",t.click()}
function importData(e){let t=e.target.files[0];if(!t)return;let a=new FileReader;a.onload=function(e){try{let t=JSON.parse(e.target.result);if(!t.transacoes)throw"Formato inv√°lido";appData=t,saveData(),alert("Importado com sucesso!"),location.reload()}catch(e){alert("Arquivo inv√°lido!")}},a.readAsText(t)}
function exportarExcel(){let e=appData.transacoes||[];if(!e.length)return alert("Nenhum lan√ßamento!");let t=XLSX.utils.json_to_sheet(e),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,t,"Lan√ßamentos"),XLSX.writeFile(a,"kratos_financas_lancamentos.xlsx")}
function resetData(){confirm("Tem certeza que deseja apagar TODOS os dados?")&&(appData=getModeloZerado(),saveData(),alert("Pronto! O sistema foi zerado."),location.reload())}
function alterarSenha(){let e='<form onsubmit="salvarNovaSenha(event)"><h3>Alterar Senha</h3><label>Nova senha:<input type="password" id="senhaNova" required></label><button type="submit">Salvar</button><button type="button" onclick="closeModal()">Cancelar</button></form>',t=document.getElementById("modal");t.innerHTML='<div class="modal" onclick="event.stopPropagation()">'+e+"</div>",t.classList.add("active"),t.style.display="flex"}
function salvarNovaSenha(e){e.preventDefault();let t=document.getElementById("senhaNova").value;if(t.length<4)return alert("Senha muito curta.");firebase.auth().currentUser.updatePassword(t).then(()=>{closeModal(),alert("Senha alterada!")}).catch(e=>alert("Erro: "+e.message))}
function enviarAjuda(){window.open("mailto:alllcantara@icloud.com?subject=Ajuda%20Kratos%20System%20Finan√ßas%20Pessoais")}
function showAlerta(e,t="#e14c54"){let a=document.getElementById("alertaBox");a.innerText=e,a.style.background=t,a.style.display="block",setTimeout(()=>{a.style.display="none"},2500)}

