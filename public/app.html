<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kratos System Finan√ßas Pessoais</title>
<link rel="icon" href="/static/logo.png" type="image/png" />
<style>
  :root {
    --azul: #163772;
    --azul-claro: #2a4172;
    --preto: #0b101e;
    --card-dark: #182336;
    --cinza: #232a39;
    --verde: #24c176;
    --vermelho: #e14c54;
    --amarelo: #ffd26e;
    --text-dark: #e6eefc;
    --sidebar: #131b2d;
    --sidebar-active: #222b44;
  }
  html, body {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--cinza);
    color: var(--text-dark);
  }
  .container {
    display: flex;
    min-height: 100vh;
    width: 100vw;
    overflow-x: hidden;
  }
  aside.sidebar {
    background: var(--sidebar);
    color: var(--text-dark);
    width: 230px;
    min-width: 160px;
    padding: 2.2rem 1rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 10;
    transition: left 0.2s ease;
  }
  .logo {
    width: 56px;
    margin-bottom: 1rem;
    border-radius: 50%;
    background: #fff;
  }
  .sidebar h1 {
    font-size: 1.18rem;
    margin: 0 0 .2rem 0;
  }
  .sidebar h2 {
    font-size: 1.01rem;
    margin-bottom: 1.1rem;
    font-weight: 400;
  }
  nav ul {
    list-style: none;
    padding: 0;
    width: 100%;
  }
  nav li {
    padding: .67rem 1rem;
    border-radius: 1rem;
    margin-bottom: .37rem;
    text-align: center;
    cursor: pointer;
    transition: background 0.15s ease;
    user-select: none;
  }
  nav li.active, nav li:hover {
    background: var(--sidebar-active);
    font-weight: 700;
    color: var(--amarelo);
  }
  .logout-btn {
    background: var(--vermelho);
    color: white;
    border: none;
    border-radius: 1rem;
    margin-top: 2rem;
    padding: .5rem 1.2rem;
    cursor: pointer;
    font-weight: 700;
    width: 100%;
  }
  main.main {
    flex: 1;
    padding: 2.2rem 1rem;
    min-width: 0;
    width: 100%;
    overflow-y: auto;
  }
  .panel {
    display: none;
  }
  .panel.active {
    display: block;
    animation: fadeIn 0.4s ease forwards;
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  /* FAB button */
  .fab {
    position: fixed;
    bottom: 2.2rem;
    right: 2rem;
    z-index: 110;
    background: var(--azul);
    color: white;
    width: 58px;
    height: 58px;
    border-radius: 50%;
    font-size: 2.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 16px #246bfd30;
    cursor: pointer;
    display: none;
  }
  .fab:hover {
    background: #193b70;
  }
  /* Modal */
  .modal-bg {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    align-items: center;
    justify-content: center;
    z-index: 50;
  }
  .modal-bg.active {
    display: flex;
  }
  .modal {
    background: var(--card-dark);
    color: var(--text-dark);
    border-radius: 1rem;
    padding: 1.5rem 1rem;
    min-width: 320px;
    max-width: 90vw;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .modal form label {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    margin-bottom: 0.7rem;
    font-weight: 500;
  }
  .modal form input, .modal form select, .modal form textarea {
    padding: 0.4rem;
    border-radius: 0.5rem;
    border: 1px solid #2b3552;
    font-size: 1rem;
    background: #192132;
    color: var(--text-dark);
  }
  .modal form button {
    padding: 0.6rem 1.4rem;
    border-radius: 0.9rem;
    border: none;
    background: var(--azul);
    color: white;
    font-size: 1rem;
    margin-right: 0.5rem;
    cursor: pointer;
    margin-top: 0.4rem;
  }
  .modal form button[type=button] {
    background: #333;
    color: #eee;
  }
</style>
</head>
<body>

<div class="container">
  <aside class="sidebar" id="sidebar">
    <img src="/static/logo.png" alt="Logo Kratos" class="logo" />
    <h1>Kratos System</h1>
    <h2>Finan√ßas Pessoais</h2>
    <nav>
      <ul id="menuList"></ul>
    </nav>
    <button class="logout-btn" id="logoutBtn">Sair</button>
  </aside>

  <main class="main" id="mainPainel">
    <section id="dashboard" class="panel active"></section>
    <section id="transactions" class="panel"></section>
    <section id="metas" class="panel"></section>
    <section id="contas" class="panel"></section>
    <section id="categorias" class="panel"></section>
    <section id="relatorios" class="panel"></section>
    <section id="configuracoes" class="panel"></section>
  </main>
</div>

<div class="fab" id="fabBtn" title="Adicionar lan√ßamento">+</div>

<div class="modal-bg" id="modal"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD32JNIb-IplbuAM8WD-Nw_P3gA5wNSNwY",
    authDomain: "kratosfinancas.firebaseapp.com",
    projectId: "kratosfinancas",
    storageBucket: "kratosfinancas.firebasestorage.app",
    messagingSenderId: "740158664268",
    appId: "1:740158664268:web:9e4583e75c94cbd90c0ee9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let appData = null;
  let userEmail = null;

  const mainPainel = document.getElementById('mainPainel');
  const fabBtn = document.getElementById('fabBtn');
  const modalContainer = document.getElementById('modal');

  const MENUS = [
    { id: "dashboard", label: "Dashboard", icon: "üìä" },
    { id: "transactions", label: "Lan√ßamentos", icon: "üí∏" },
    { id: "metas", label: "Metas", icon: "üéØ" },
    { id: "contas", label: "Contas", icon: "üè¶" },
    { id: "categorias", label: "Categorias", icon: "üè∑Ô∏è" },
    { id: "relatorios", label: "Relat√≥rios", icon: "üìà" },
    { id: "configuracoes", label: "Configura√ß√µes", icon: "‚öôÔ∏è" }
  ];

  // Renderiza menu no DOM
  function renderMenu() {
    const menuList = document.getElementById('menuList');
    menuList.innerHTML = '';
    MENUS.forEach(menu => {
      const li = document.createElement('li');
      li.textContent = `${menu.icon} ${menu.label}`;
      li.dataset.panel = menu.id;
      li.style.userSelect = "none";
      li.onclick = () => {
        document.querySelectorAll('#menuList li').forEach(i => i.classList.remove('active'));
        li.classList.add('active');
        loadPanel(menu.id);
      };
      menuList.appendChild(li);
    });
  }

  // Carrega o painel espec√≠fico
  function loadPanel(panelId) {
    fabBtn.style.display = 'none'; // por padr√£o oculta fab
    mainPainel.innerHTML = '';

    if (panelId === 'dashboard') {
      fetch('dashboard.html').then(res => res.text()).then(html => {
        mainPainel.innerHTML = html;
        renderDashboard();
        fabBtn.style.display = 'none'; // N√£o mostra fab aqui (exemplo)
      });
    } 
    else if (panelId === 'transactions') {
      fetch('transactions.html').then(res => res.text()).then(html => {
        mainPainel.innerHTML = html;
        renderTransactions();
        setupFabForTransactions();
      });
    }
    else {
      mainPainel.innerHTML = `<section><h2>${panelId}</h2><p>Conte√∫do n√£o implementado ainda.</p></section>`;
    }
  }

  // Fun√ß√£o exemplo para dashboard (implemente conforme sua necessidade)
  function renderDashboard() {
    const dash = document.getElementById('dashboard');
    if (!dash) return;
    dash.innerHTML = `<h2>Dashboard</h2><p>Bem-vindo, ${userEmail}!</p>`;
  }

  // Fun√ß√£o exemplo para transa√ß√µes (implemente conforme sua necessidade)
  function renderTransactions() {
    const trans = document.getElementById('transactions');
    if (!trans) return;
    trans.innerHTML = `<h2>Transa√ß√µes</h2><p>Aqui vai a tabela e filtros.</p>`;
    // TODO: preencher tabela, filtros, eventos
  }

  // Configura bot√£o flutuante no painel transa√ß√µes
  function setupFabForTransactions() {
    fabBtn.style.display = 'flex';
    fabBtn.onclick = () => openTransactionModal();
  }

  // Abre modal de lan√ßamento novo ou edi√ß√£o
  function openTransactionModal(transactionIndex = null) {
    fetch('modal.html')
      .then(r => r.text())
      .then(html => {
        modalContainer.innerHTML = html;
        modalContainer.classList.add('active');
        modalContainer.style.display = 'flex';

        // Preencher selects com contas e categorias
        const txAccount = document.getElementById('txAccount');
        const txAccountTo = document.getElementById('txAccountTo');
        const txCategory = document.getElementById('txCategory');
        const accountToContainer = document.getElementById('accountToContainer');
        const txType = document.getElementById('txType');

        if (txAccount) txAccount.innerHTML = appData.contas.map(c => `<option>${c.nome}</option>`).join('');
        if (txAccountTo) txAccountTo.innerHTML = appData.contas.map(c => `<option>${c.nome}</option>`).join('');
        if (txCategory) txCategory.innerHTML = appData.categorias.map(c => `<option>${c.nome}</option>`).join('');

        txType.onchange = () => {
          if (!accountToContainer) return;
          accountToContainer.style.display = txType.value === 'transfer' ? 'block' : 'none';
        };
        txType.onchange();

        // Se for edi√ß√£o preenche os dados
        if (transactionIndex !== null && appData.transacoes && appData.transacoes[transactionIndex]) {
          const tx = appData.transacoes[transactionIndex];
          document.getElementById('modalTitle').textContent = 'Editar Lan√ßamento';
          txType.value = tx.type;
          txAccount.value = tx.account;
          txAccountTo.value = tx.accountTo || '';
          txCategory.value = tx.category;
          document.getElementById('txDescription').value = tx.description || '';
          document.getElementById('txDate').value = tx.date || new Date().toISOString().slice(0, 10);
          document.getElementById('txValue').value = tx.value;
          document.getElementById('txNotes').value = tx.notes || '';
          txType.onchange();
        } else {
          document.getElementById('modalTitle').textContent = 'Novo Lan√ßamento';
        }

        // Form submit
        const form = document.getElementById('transactionForm');
        form.onsubmit = e => {
          e.preventDefault();
          saveTransaction(transactionIndex);
        };

        // Cancelar modal
        document.getElementById('btnCancel').onclick = closeModal;
      });
  }

  // Fecha modal
  function closeModal() {
    modalContainer.classList.remove('active');
    modalContainer.style.display = 'none';
    modalContainer.innerHTML = '';
  }

  // Salvar transa√ß√£o (novo ou editar)
  function saveTransaction(transactionIndex) {
    const type = document.getElementById('txType').value;
    const account = document.getElementById('txAccount').value;
    const accountTo = document.getElementById('txAccountTo').value;
    const category = document.getElementById('txCategory').value;
    const description = document.getElementById('txDescription').value.trim();
    const date = document.getElementById('txDate').value;
    const value = parseFloat(document.getElementById('txValue').value);
    const notes = document.getElementById('txNotes').value.trim();

    if (!account || (type === 'transfer' && !accountTo) || !category || !date || !value) {
      alert('Por favor preencha todos os campos obrigat√≥rios.');
      return;
    }

    // Atualiza saldo contas
    const contaOrigem = appData.contas.find(c => c.nome === account);
    if (!contaOrigem) {
      alert('Conta de origem inv√°lida');
      return;
    }
    let contaDestino = null;
    if (type === 'transfer') {
      contaDestino = appData.contas.find(c => c.nome === accountTo);
      if (!contaDestino) {
        alert('Conta destino inv√°lida');
        return;
      }
    }

    // Reverter saldo transa√ß√£o anterior (se edi√ß√£o)
    if (transactionIndex !== null) {
      const oldTx = appData.transacoes[transactionIndex];
      if (oldTx.type === 'income') {
        const c = appData.contas.find(c => c.nome === oldTx.account);
        if (c) c.saldo -= oldTx.value;
      } else if (oldTx.type === 'expense') {
        const c = appData.contas.find(c => c.nome === oldTx.account);
        if (c) c.saldo += oldTx.value;
      } else if (oldTx.type === 'transfer') {
        const cFrom = appData.contas.find(c => c.nome === oldTx.account);
        const cTo = appData.contas.find(c => c.nome === oldTx.accountTo);
        if (cFrom && cTo) {
          cFrom.saldo += oldTx.value;
          cTo.saldo -= oldTx.value;
        }
      }
    }

    // Aplica saldo com novos valores
    if (type === 'income') {
      contaOrigem.saldo += value;
    } else if (type === 'expense') {
      contaOrigem.saldo -= value;
    } else if (type === 'transfer') {
      contaOrigem.saldo -= value;
      contaDestino.saldo += value;
    }

    const transactionObj = {
      type,
      account,
      accountTo: type === 'transfer' ? accountTo : undefined,
      category,
      description,
      date,
      value,
      notes,
    };

    if (transactionIndex !== null) {
      appData.transacoes[transactionIndex] = transactionObj;
    } else {
      if (!appData.transacoes) appData.transacoes = [];
      appData.transacoes.push(transactionObj);
    }

    saveData();
    closeModal();
    loadPanel('transactions');
  }

  // Salva dados no Firestore
  function saveData() {
    db.collection("usuarios").doc(userEmail).set(appData);
  }

  // Carrega dados do usu√°rio
  function loadUserData() {
    db.collection("usuarios").doc(userEmail).get().then(doc => {
      if (doc.exists) {
        appData = doc.data();
      } else {
        appData = getModeloZerado();
        saveData();
      }
      renderMenu();
      // Carrega painel inicial
      const firstMenuId = MENUS[0].id;
      // Marca primeiro menu ativo visualmente
      document.querySelectorAll('#menuList li').forEach(li => {
        li.classList.toggle('active', li.dataset.panel === firstMenuId);
      });
      loadPanel(firstMenuId);
      fabBtn.style.display = 'flex';
    });
  }

  // Modelo inicial caso n√£o exista dados
  function getModeloZerado() {
    return {
      user: userEmail,
      contas: [{ nome: "Carteira", saldo: 0, cor: "#246bfd" }],
      categorias: [
        { nome: "Sal√°rio", tipo: "income", cor: "#24c176" },
        { nome: "Alimenta√ß√£o", tipo: "expense", cor: "#e14c54" }
      ],
      transacoes: [],
      metas: [],
      config: { theme: "dark", alertas: [], limites: {}, excelSep: ";" },
      anexos: {}
    };
  }

  // Autentica√ß√£o Firebase - controla redirecionamento se n√£o logado
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    userEmail = user.email;
    loadUserData();
  });

  // Bot√£o sair logout
  document.getElementById('logoutBtn').onclick = () => {
    auth.signOut().then(() => {
      window.location.href = 'login.html';
    });
  };

  // Fecha modal ao clicar fora
  modalContainer.onclick = (e) => {
    if (e.target === modalContainer) closeModal();
  };
</script>

</body>
</html>
