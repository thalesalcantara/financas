<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Configurações - Kratos System</title>
<style>
  body {
    margin: 0; padding: 2rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #232a39;
    color: #e6eefc;
  }
  h2 {
    margin-bottom: 1rem;
  }
  .settings-group {
    margin-bottom: 1.5rem;
  }
  label {
    display: block;
    font-size: 1.05rem;
    margin-bottom: 0.5rem;
  }
  button {
    background: #163772;
    color: white;
    border: none;
    padding: 0.5rem 1.2rem;
    border-radius: 0.9rem;
    cursor: pointer;
    font-size: 1rem;
  }
  input[type="file"] {
    margin-top: 0.3rem;
  }
  input[type="number"] {
    width: 100px;
    padding: 0.3rem;
    border-radius: 0.5rem;
    border: 1px solid #2b3552;
    background: #131a2b;
    color: #e6eefc;
    font-size: 1rem;
  }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
</head>
<body>

<h2>Configurações</h2>

<div class="settings-group">
  <label>
    Backup manual<br />
    <button onclick="exportBackup()">Baixar backup (.json)</button>
  </label>
</div>

<div class="settings-group">
  <label>
    Importar backup<br />
    <input type="file" accept=".json" onchange="importBackup(event)" />
  </label>
</div>

<div class="settings-group">
  <label>
    Limites de gasto por categoria<br />
    <div id="limitesContainer"></div>
  </label>
</div>

<!-- Nova seção de ajuda -->
<div class="settings-group">
  <label>
    Precisa de ajuda? Envie uma mensagem para o suporte<br />
    <button onclick="enviarEmail()">Enviar Email para Suporte</button>
  </label>
</div>

<script>
  // Config Firebase - substitua com seu config real
  const firebaseConfig = {
    apiKey: "AIzaSyD32JNIb-IplbuAM8WD-Nw_P3gA5wNSNwY",
    authDomain: "kratosfinancas.firebaseapp.com",
    projectId: "kratosfinancas",
    storageBucket: "kratosfinancas.firebasestorage.app",
    messagingSenderId: "740158664268",
    appId: "1:740158664268:web:9e4583e75c94cbd90c0ee9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let userEmail = null;

  // Estrutura padrão do appData
  let appData = {
    categorias: [
      { nome: "Alimentação", tipo: "expense" },
      { nome: "Transporte", tipo: "expense" },
      { nome: "Salário", tipo: "income" }
    ],
    config: { limites: {} }
  };

  // Renderiza inputs dos limites
  function renderLimits() {
    const container = document.getElementById('limitesContainer');
    container.innerHTML = '';
    appData.categorias.filter(c => c.tipo === 'expense').forEach(cat => {
      const div = document.createElement('div');
      div.innerHTML = `
        <b>${cat.nome}:</b> 
        <input type="number" min="0" value="${appData.config.limites[cat.nome] || ''}" 
          onchange="saveLimit('${cat.nome}', this.value)" placeholder="R$" />
      `;
      container.appendChild(div);
    });
  }

  // Salva o limite no appData e Firestore
  function saveLimit(catName, val) {
    if (!appData.config.limites) appData.config.limites = {};
    appData.config.limites[catName] = Number(val);
    alert(`Limite salvo para ${catName}: R$ ${val}`);

    if (!userEmail) {
      alert("Usuário não autenticado. Faça login para salvar os dados.");
      return;
    }

    const userDoc = db.collection('usuarios').doc(userEmail);
    userDoc.update({
      'config.limites': appData.config.limites
    }).then(() => {
      console.log('Limites salvos com sucesso no Firestore.');
    }).catch((error) => {
      console.error('Erro ao salvar limites:', error);
    });
  }

  // Exporta backup JSON
  function exportBackup() {
    const dataStr = JSON.stringify(appData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'backup_kratos_financas.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Importa backup JSON
  function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return alert('Nenhum arquivo selecionado');
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.categorias) throw new Error('Backup inválido');
        // Atualiza local e Firestore
        appData = data;
        renderLimits();

        if (userEmail) {
          db.collection('usuarios').doc(userEmail).set(appData).then(() => {
            alert('Backup importado e salvo com sucesso!');
          }).catch(() => {
            alert('Backup importado, mas falha ao salvar no Firestore.');
          });
        } else {
          alert('Backup importado localmente. Faça login para salvar.');
        }
      } catch {
        alert('Erro ao importar backup!');
      }
    };
    reader.readAsText(file);
  }

  // Função para abrir cliente de email com texto pronto para suporte
  function enviarEmail() {
    const assunto = encodeURIComponent("Ajuda no desenvolvimento - Kratos System");
    const corpo = encodeURIComponent(
      "Olá Thales,\n\nEstou com um problema ou dúvida no sistema Kratos System.\n\n" +
      "Por favor, poderia me ajudar?\n\n" +
      "Descreva aqui o seu problema...\n\n" +
      "Obrigado!"
    );

    const email = "alllcantara@icloud.com";

    window.location.href = `mailto:${email}?subject=${assunto}&body=${corpo}`;
  }

  // Carregar dados do usuário ao autenticar
  auth.onAuthStateChanged(user => {
    if (user) {
      userEmail = user.email;
      db.collection('usuarios').doc(userEmail).get().then(doc => {
        if (doc.exists) {
          appData = doc.data();
          renderLimits();
        }
      });
    } else {
      userEmail = null;
      alert("Faça login para carregar suas configurações.");
    }
  });

  // Renderiza inicialmente
  renderLimits();
</script>

</body>
</html>
